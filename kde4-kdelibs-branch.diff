Index: khtml/khtmladaptorpart.desktop
===================================================================
--- khtml/khtmladaptorpart.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/khtmladaptorpart.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -22,6 +22,7 @@
 Name[gl]=Adaptador de extensión de KHTML
 Name[gu]=KHTML એક્સટેન્સન સ્વિકારનાર
 Name[he]=מתאם הרחבה של KHTML
+Name[hne]=केएचटीएमएल विस्तार एडाप्टर
 Name[hu]=KHTML kiterjesztésadapter
 Name[is]=Aðlögun KHTML-endinga
 Name[it]=Adattatore estensione KHTML
Index: khtml/kmultipart/kmultipart.desktop
===================================================================
--- khtml/kmultipart/kmultipart.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/kmultipart/kmultipart.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,7 @@
 Name[gu]=multipart/mixed માટે જડિત ભાગ
 Name[he]=רכיב בר־שיבוץ עבור multipart/mixed
 Name[hi]=मल्टीपार्ट/मिक्स्ड के लिए अंतर्निर्मित अवयव
+Name[hne]=मल्टीपार्ट/मिक्स्ड बर भीतर मं बने अवयव
 Name[hr]=Ugradiva komponenta za multipart/mixed
 Name[hsb]=Integrujomna komponenta za multipart/mixed
 Name[hu]=Beágyazható komponens a multipart/mixed adattípushoz
Index: khtml/misc/borderarcstroker.cpp
===================================================================
--- khtml/misc/borderarcstroker.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/misc/borderarcstroker.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -347,7 +347,7 @@
     const KCubicBezier inner(innerPath.elementAt(0), innerPath.elementAt(1), innerPath.elementAt(2), innerPath.elementAt(3));
     const KCubicBezier outer(outerPath.elementAt(0), outerPath.elementAt(1), outerPath.elementAt(2), outerPath.elementAt(3));
 
-    qreal a = std::fmod(angle, 360.0);
+    qreal a = std::fmod(angle, qreal(360.0));
     if (a < 0)
         a += 360.0;
 
Index: khtml/misc/loader.cpp
===================================================================
--- khtml/misc/loader.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/misc/loader.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -85,6 +85,8 @@
 
 #include "blocked_icon.cpp"
 
+#include <QPaintEngine>
+
 using namespace khtml;
 using namespace DOM;
 using namespace khtmlImLoad;
@@ -613,18 +615,20 @@
     int w = i->size().width();
     int h = i->size().height();
 
-    if (i->hasAlpha()) {
+    QPixmap pm(w, h);
+    if (i->hasAlpha() && !pm.paintEngine()->hasFeature(QPaintEngine::PorterDuff)) {
         QImage im(w, h, QImage::Format_ARGB32_Premultiplied);
 
         QPainter paint(&im);
-        paint.setCompositionMode(QPainter::CompositionMode_Source);
         ImagePainter pi(i);
         pi.paint(0, 0, &paint);
         paint.end();
         return QPixmap::fromImage( im );
     } else {
-        QPixmap pm(w, h);
+        pm.fill(Qt::transparent);
         QPainter paint(&pm);
+        if (i->hasAlpha())
+             paint.setCompositionMode(QPainter::CompositionMode_Source);
         ImagePainter pi(i);
         pi.paint(0, 0, &paint);
         paint.end();
Index: khtml/khtml_part.cpp
===================================================================
--- khtml/khtml_part.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/khtml_part.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -291,16 +291,26 @@
   if ( prof == BrowserViewGUI ) {
     d->m_paViewDocument = new KAction( i18n( "View Do&cument Source" ), this );
     actionCollection()->addAction( "viewDocumentSource", d->m_paViewDocument );
-    d->m_paViewDocument->setShortcut( QKeySequence(Qt::CTRL + Qt::Key_U) );
     connect( d->m_paViewDocument, SIGNAL( triggered( bool ) ), this, SLOT( slotViewDocumentSource() ) );
+    if (!parentPart()) {
+        d->m_paViewDocument->setShortcut( QKeySequence(Qt::CTRL + Qt::Key_U) );
+        d->m_paViewDocument->setShortcutContext( Qt::WidgetWithChildrenShortcut );
+    }
 
     d->m_paViewFrame = new KAction( i18n( "View Frame Source" ), this );
     actionCollection()->addAction( "viewFrameSource", d->m_paViewFrame );
     connect( d->m_paViewFrame, SIGNAL( triggered( bool ) ), this, SLOT( slotViewFrameSource() ) );
+    if (!parentPart()) {
+        d->m_paViewFrame->setShortcut( QKeySequence(Qt::CTRL + Qt::SHIFT + Qt::Key_U) );
+        d->m_paViewFrame->setShortcutContext( Qt::WidgetWithChildrenShortcut );
+    }
 
     d->m_paViewInfo = new KAction( i18n( "View Document Information" ), this );
     actionCollection()->addAction( "viewPageInfo", d->m_paViewInfo );
-    d->m_paViewInfo->setShortcut( QKeySequence(Qt::CTRL+Qt::Key_I) );
+    if (!parentPart()) {
+        d->m_paViewInfo->setShortcut( QKeySequence(Qt::CTRL+Qt::Key_I) );
+        d->m_paViewInfo->setShortcutContext( Qt::WidgetWithChildrenShortcut );
+    }
     connect( d->m_paViewInfo, SIGNAL( triggered( bool ) ), this, SLOT( slotViewPageInfo() ) );
 
     d->m_paSaveBackground = new KAction( i18n( "Save &Background Image As..." ), this );
@@ -461,7 +471,7 @@
   d->m_paSelectAll = actionCollection()->addAction( KStandardAction::SelectAll, "selectAll",
                                                     this, SLOT( slotSelectAll() ) );
   d->m_paSelectAll->setShortcutContext( Qt::WidgetWithChildrenShortcut );
-  if ( parentPart() )
+  if ( parentPart() ) // Only the frameset has the shortcut, but the slot uses the current frame.
       d->m_paSelectAll->setShortcuts( KShortcut() ); // avoid clashes
 
   d->m_paToggleCaretMode = new KToggleAction(i18n("Toggle Caret Mode"), this );
Index: khtml/khtml.desktop
===================================================================
--- khtml/khtml.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/khtml.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -30,6 +30,7 @@
 Comment[gu]=જડિત HTML દર્શક ભાગ
 Comment[he]=רכיב בר־שיבוץ לתצוגת HTML
 Comment[hi]=अंतर्निर्मित एचटीएमएल प्रदर्शक अवयव
+Comment[hne]=भीतर मं बने एचटीएमएल प्रदर्सक अवयव
 Comment[hr]=Ugrađeni komponenta za pregledavanje HTML
 Comment[hsb]=Integrowana HTML-komponenta
 Comment[hu]=Beágyazható HTML-néző komponens
@@ -87,6 +88,7 @@
 Icon=konqueror
 Name=KHTML
 Name[hi]=के-एचटीएमएल
+Name[hne]=के-एचटीएमएल
 Name[kn]=ಕೆಹೆಚ್ ಟಿ ಎಮ್ ಎಲ್
 Name[mai]=के-एचटीएमएल
 Name[ml]=കെഎച്ച്ടിഎംഎല്‍
Index: khtml/khtmlimage.desktop
===================================================================
--- khtml/khtmlimage.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/khtmlimage.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -30,6 +30,7 @@
 Comment[gu]=જડિત ચિત્ર દર્શક ભાગ
 Comment[he]=רכיב בר־שיבוץ לתצוגת תמונות
 Comment[hi]=अंतर्निर्मित छवि प्रदर्शक अवयव
+Comment[hne]=भीतर मं बने फोटू प्रदर्सक अवयव
 Comment[hr]=Ugradiva komponenta za pregledavanje slika
 Comment[hsb]=Integrujomna komponenta za wobrazy
 Comment[hu]=Beágyazható képnéző komponens
@@ -114,6 +115,7 @@
 Name[gu]=જડિત ચિત્ર દર્શક
 Name[he]=מציג תמונות הניתן לשיבוץ
 Name[hi]=अंतर्निर्मित छवि प्रदर्शक
+Name[hne]=भीतर मं बने फोटू प्रदर्सक
 Name[hr]=Ugradivi preglednik slika
 Name[hsb]=Integrowany wobhladowar za wobrazy
 Name[hu]=Beágyazható képnézegető
Index: khtml/html/html_headimpl.cpp
===================================================================
--- khtml/html/html_headimpl.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/html/html_headimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -604,6 +604,12 @@
 void HTMLStyleElementImpl::insertedIntoDocument()
 {
     HTMLElementImpl::insertedIntoDocument();
+    
+    // If we're empty, we have to call parseText here, since we won't get childrenChanged();
+    // but we still want a CSSOM object
+    if (!firstChild())
+        parseText();
+    
     if (m_sheet)
         document()->updateStyleSelector();
 }
@@ -619,6 +625,11 @@
 {
     HTMLElementImpl::childrenChanged();
 
+    parseText();
+}
+
+void HTMLStyleElementImpl::parseText()
+{
     DOMString text = "";
 
     for (NodeImpl *c = firstChild(); c != 0; c = c->nextSibling()) {
Index: khtml/html/html_objectimpl.cpp
===================================================================
--- khtml/html/html_objectimpl.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/html/html_objectimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -789,9 +789,7 @@
 
 DocumentImpl* HTMLObjectElementImpl::contentDocument() const
 {
-    if ( !m_render ) return 0;
-    if ( !m_render->isWidget() ) return 0;
-    QWidget* widget = static_cast<RenderWidget*>( m_render )->widget();
+    QWidget* widget = childWidget();
     if( widget && qobject_cast<KHTMLView*>( widget ) )
         return static_cast<KHTMLView*>( widget )->part()->xmlDocImpl();
     return 0;
Index: khtml/html/html_baseimpl.cpp
===================================================================
--- khtml/html/html_baseimpl.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/html/html_baseimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -542,22 +542,10 @@
     noresize = false;
 
     m_resizing = false;
-
-    m_onLoad = m_onUnLoad = 0;
 }
 
 HTMLFrameSetElementImpl::~HTMLFrameSetElementImpl()
 {
-    //### this is likely not quite right since we may be effectively "overriding" some old value,
-    //which needs to be recomputed, but this is better than crashing...
-    if (document()) {
-        if (m_onLoad && document()->getHTMLEventListener(EventImpl::LOAD_EVENT) == m_onLoad)
-            document()->setHTMLEventListener(EventImpl::LOAD_EVENT, 0);
-
-        if (m_onUnLoad && document()->getHTMLEventListener(EventImpl::UNLOAD_EVENT) == m_onUnLoad)
-            document()->setHTMLEventListener(EventImpl::UNLOAD_EVENT, 0);
-    }
-
     delete [] m_rows;
     delete [] m_cols;
 }
@@ -600,12 +588,12 @@
             frameborder = false;
         break;
     case ATTR_ONLOAD:
-        m_onLoad = document()->createHTMLEventListener(attr->value().string(), "onload", this);
-        document()->setHTMLEventListener(EventImpl::LOAD_EVENT, m_onLoad);
+        document()->setHTMLWindowEventListener(EventImpl::LOAD_EVENT,
+            document()->createHTMLEventListener(attr->value().string(), "onload", NULL));
         break;
     case ATTR_ONUNLOAD:
-        m_onUnLoad = document()->createHTMLEventListener(attr->value().string(), "onunload", this);
-        document()->setHTMLEventListener(EventImpl::UNLOAD_EVENT, m_onUnLoad);
+        document()->setHTMLWindowEventListener(EventImpl::UNLOAD_EVENT,
+            document()->createHTMLEventListener(attr->value().string(), "onunload", NULL));
         break;
     default:
         HTMLElementImpl::parseAttribute(attr);
Index: khtml/html/html_headimpl.h
===================================================================
--- khtml/html/html_headimpl.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/html/html_headimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -205,6 +205,8 @@
     virtual bool checkRemovePendingSheet();
 
 protected:
+    void parseText();
+    
     CSSStyleSheetImpl *m_sheet;
     DOMString m_type;
     QString m_media;
Index: khtml/html/html_baseimpl.h
===================================================================
--- khtml/html/html_baseimpl.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/html/html_baseimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -163,9 +163,6 @@
     bool frameBorderSet : 1;
     bool noresize : 1;
     bool m_resizing : 1;  // is the user resizing currently
-    
-    EventListener* m_onLoad;
-    EventListener* m_onUnLoad;
 };
 
 // -------------------------------------------------------------------------
Index: khtml/ecma/debugger/debugwindow.cpp
===================================================================
--- khtml/ecma/debugger/debugwindow.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/debugger/debugwindow.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -350,6 +350,12 @@
     }
 }
 
+void DebugWindow::forceStopAtNext()
+{
+    DebugWindow* self = window();
+    self->m_breakAtNext = true;
+}
+
 void DebugWindow::stopAtNext()
 {
     m_breakAtNext = m_stopAct->isChecked();
@@ -628,12 +634,14 @@
 
 bool DebugWindow::exception(ExecState *exec, int sourceId, int lineNo, JSValue *exceptionObj)
 {
+    InterpreterContext* ic = m_contexts[exec->dynamicInterpreter()];
+
     // Don't report it if error reporting is not on
     KParts::ReadOnlyPart *part = static_cast<ScriptInterpreter*>(exec->dynamicInterpreter())->part();
     KHTMLPart *khtmlpart = qobject_cast<KHTMLPart*>(part);
     
     if (khtmlpart && !khtmlpart->settings()->isJavaScriptErrorReportingEnabled() || !m_catchExceptions)
-        return shouldContinue(m_contexts[exec->dynamicInterpreter()]);
+        return shouldContinue(ic);
 
     QString exceptionMsg = exceptionToString(exec, exceptionObj);
 
@@ -662,11 +670,16 @@
         m_catchExceptionsAction->setChecked(false);
     }
     
-    if (dlg.debugSelected())
-        // We want to stop at the current line, to see what's going on.
-        enterDebugSession(exec, doc.get(), lineNo);
+    if (dlg.debugSelected()) {
+        // We generally want to stop at the current line, to see what's going on... There is one exception, though:
+        // in case we've got a parse error, we can't actually stop, but we want to still display stuff.
+        if (ic->hasActiveDocument())
+            enterDebugSession(exec, doc.get(), lineNo);
+        else
+            displayScript(doc.get(), lineNo);
+    }
 
-    return shouldContinue(m_contexts[exec->dynamicInterpreter()]);
+    return shouldContinue(ic);
 }
 
 
@@ -900,6 +913,9 @@
 
 void DebugWindow::displayScript(DebugDocument* document, int line)
 {
+    if (!isVisible())
+        show();
+
     if (m_tabWidget->isHidden())
         m_tabWidget->show();
 
Index: khtml/ecma/debugger/interpreter_ctx.cpp
===================================================================
--- khtml/ecma/debugger/interpreter_ctx.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/debugger/interpreter_ctx.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -54,6 +54,11 @@
     return callStack.top().doc;
 }
 
+bool InterpreterContext::hasActiveDocument() const
+{
+    return !callStack.isEmpty();
 }
 
+}
+
 // kate: indent-width 4; replace-tabs on; tab-width 4; space-indent on;
Index: khtml/ecma/debugger/debugwindow.h
===================================================================
--- khtml/ecma/debugger/debugwindow.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/debugger/debugwindow.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -113,6 +113,9 @@
     // Called by KJSProxy when we navigate away from a page
     void clearInterpreter(KJS::Interpreter* interp);
 
+    // Hook for activating the debugger from gdb or such
+    static void forceStopAtNext();
+
 public Q_SLOTS:
     void stopAtNext();
     void continueExecution();
Index: khtml/ecma/debugger/interpreter_ctx.h
===================================================================
--- khtml/ecma/debugger/interpreter_ctx.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/debugger/interpreter_ctx.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -72,6 +72,8 @@
     DebugDocument::Ptr activeDocument();
     int                activeLine();
 
+    bool hasActiveDocument() const;
+
     InterpreterContext() : mode(Normal), depthAtSkip(0)
     {}
 
Index: khtml/ecma/kjs_range.cpp
===================================================================
--- khtml/ecma/kjs_range.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_range.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -61,7 +61,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMRangeProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMRangeProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMRange",DOMRangeProto,DOMRangeProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMRange",DOMRangeProto,DOMRangeProtoFunc,ObjectPrototype)
 
 DOMRange::DOMRange(ExecState *exec, DOM::RangeImpl* r)
  : m_impl(r)
Index: khtml/ecma/kjs_audio.cpp
===================================================================
--- khtml/ecma/kjs_audio.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_audio.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -64,7 +64,7 @@
 
 KJS_DEFINE_PROTOTYPE(AudioProto)
 KJS_IMPLEMENT_PROTOFUNC(AudioProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("Audio", AudioProto, AudioProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("Audio", AudioProto, AudioProtoFunc, ObjectPrototype)
 
 const ClassInfo Audio::info = { "Audio", 0, &AudioTable, 0 };
 
Index: khtml/ecma/kjs_binding.h
===================================================================
--- khtml/ecma/kjs_binding.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_binding.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -35,6 +35,7 @@
 #include <kjs/lookup.h>
 #include <kjs/function.h>
 #include <kjs/JSVariableObject.h>
+#include <kjs/object_object.h>
 
 #include <stdlib.h> // for abort
 
@@ -358,6 +359,8 @@
 #define IMPLEMENT_PSEUDO_CONSTRUCTOR_IMP(Class,ClassName,ProtoClass,ParentProto) \
     const ClassInfo Class::info = { ClassName, 0, 0, 0 }; \
     Class::Class(ExecState* exec): DOMObject(ParentProto) {\
+        /* Since ProtoClass ctor might need us, make sure we're registered */ \
+        exec->lexicalInterpreter()->globalObject()->put(exec, "[[" ClassName ".constructor]]", this, KJS::Internal | KJS::DontEnum); \
         JSObject* proto = ProtoClass::self(exec); \
         putDirect(exec->propertyNames().prototype, proto, DontDelete|ReadOnly); \
     }\
Index: khtml/ecma/kjs_dom.cpp
===================================================================
--- khtml/ecma/kjs_dom.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_dom.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -101,7 +101,16 @@
 @end
 */
 KJS_IMPLEMENT_PROTOFUNC(DOMNodeProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMNode", DOMNodeProto, DOMNodeProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE_IMP("DOMNode", DOMNodeProto, DOMNodeProtoFunc, DOMNodeConstants)
+{
+    // We need to setup the constructor property to the ctor here, but NodeConstructor::self
+    // will try to make us again, since we're in the middle of cacheGlobalObject.
+    // To workaround that, register ourselves so the re-entry of cacheGlobalObject
+    // will pick us. NodeCtor ctor does the same already, to fix the problem 
+    // in the other direction.
+    exec->lexicalInterpreter()->globalObject()->put(exec, *name(), this, KJS::Internal | KJS::DontEnum);
+    putDirect(exec->propertyNames().constructor, NodeConstructor::self(exec), DontEnum);
+}
 
 const ClassInfo DOMNode::info = { "Node", 0, &DOMNodeTable, 0 };
 
@@ -655,15 +664,15 @@
       static_cast<DOM::DocumentFragmentImpl*>(range->createContextualFragment(args[1]->toString(exec).domString(), exception).handle());
       if (exception.triggered()) return jsUndefined();
 
-      DOMString where = args[0]->toString(exec).domString();
+      DOMString where = args[0]->toString(exec).domString().lower();
 
-      if (where == "beforeBegin" || where == "BeforeBegin")
+      if (where == "beforebegin")
         node.parentNode()->insertBefore(docFrag.get(), &node, exception);
-      else if (where == "afterBegin" || where == "AfterBegin")
+      else if (where == "afterbegin")
         node.insertBefore(docFrag.get(), node.firstChild(), exception);
-      else if (where == "beforeEnd" || where == "BeforeEnd")
+      else if (where == "beforeend")
         return getDOMNode(exec, node.appendChild(docFrag.get(), exception));
-      else if (where == "afterEnd" || where == "AfterEnd")
+      else if (where == "afterend")
         if (node.nextSibling())
 	  node.parentNode()->insertBefore(docFrag.get(), node.nextSibling(),exception);
 	else
@@ -691,7 +700,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMNodeListProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMNodeListProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMNodeList",DOMNodeListProto,DOMNodeListProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMNodeList",DOMNodeListProto,DOMNodeListProtoFunc, ObjectPrototype)
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR(NodeListPseudoCtor, "NodeList", DOMNodeListProto)
 
@@ -917,7 +926,7 @@
 */
 
 KJS_IMPLEMENT_PROTOFUNC(DOMDocumentProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMDocument",DOMDocumentProto, DOMDocumentProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMDocument",DOMDocumentProto, DOMDocumentProtoFunc, DOMNodeProto)
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR(DocumentPseudoCtor, "Document", DOMDocumentProto)
 
@@ -1187,7 +1196,7 @@
 @end
 */
 KJS_IMPLEMENT_PROTOFUNC(DOMElementProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMElement",DOMElementProto,DOMElementProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMElement",DOMElementProto,DOMElementProtoFunc,DOMNodeProto)
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR(ElementPseudoCtor, "Element", DOMElementProto)
 
@@ -1376,7 +1385,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMDOMImplementationProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMDOMImplementationProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMImplementation",DOMDOMImplementationProto,DOMDOMImplementationProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMImplementation",DOMDOMImplementationProto,DOMDOMImplementationProtoFunc,ObjectPrototype)
 
 const ClassInfo DOMDOMImplementation::info = { "DOMImplementation", 0, 0, 0 };
 
@@ -1508,7 +1517,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMNamedNodeMapProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMNamedNodeMapProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("NamedNodeMap",DOMNamedNodeMapProto,DOMNamedNodeMapProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("NamedNodeMap",DOMNamedNodeMapProto,DOMNamedNodeMapProtoFunc,ObjectPrototype)
 
 const ClassInfo DOMNamedNodeMap::info = { "NamedNodeMap", 0, &DOMNamedNodeMapTable, 0 };
 
@@ -1903,9 +1912,9 @@
   replaceData	DOMCharacterData::ReplaceData	DontDelete|Function 2
 @end
 */
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMCharacterDataProto, DOMNodeProto)
+KJS_DEFINE_PROTOTYPE(DOMCharacterDataProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMCharacterDataProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMCharacterData",DOMCharacterDataProto,DOMCharacterDataProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMCharacterData",DOMCharacterDataProto,DOMCharacterDataProtoFunc,DOMNodeProto)
 
 DOMCharacterData::DOMCharacterData(ExecState *exec, DOM::CharacterDataImpl* d)
  : DOMNode(exec, d)
@@ -1987,9 +1996,9 @@
   replaceWholeText DOMText::ReplaceWholeText DontDelete|Function 1
 @end
 */
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMTextProto, DOMCharacterDataProto)
+KJS_DEFINE_PROTOTYPE(DOMTextProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMTextProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMText",DOMTextProto,DOMTextProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMText",DOMTextProto,DOMTextProtoFunc,DOMCharacterDataProto)
 
 DOMText::DOMText(ExecState *exec, DOM::TextImpl* t)
   : DOMCharacterData(exec, t)
Index: khtml/ecma/xmlserializer.cpp
===================================================================
--- khtml/ecma/xmlserializer.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/xmlserializer.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -39,7 +39,7 @@
 namespace KJS {
 KJS_DEFINE_PROTOTYPE(XMLSerializerProto)
 KJS_IMPLEMENT_PROTOFUNC(XMLSerializerProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("XMLSerializer", XMLSerializerProto,XMLSerializerProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("XMLSerializer", XMLSerializerProto,XMLSerializerProtoFunc, ObjectPrototype)
 
 XMLSerializerConstructorImp::XMLSerializerConstructorImp(ExecState* exec)
     : JSObject(exec->lexicalInterpreter()->builtinObjectPrototype())
Index: khtml/ecma/kjs_css.cpp
===================================================================
--- khtml/ecma/kjs_css.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_css.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -135,7 +135,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMCSSStyleDeclarationProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMCSSStyleDeclarationProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMCSSStyleDeclaration", DOMCSSStyleDeclarationProto, DOMCSSStyleDeclarationProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMCSSStyleDeclaration", DOMCSSStyleDeclarationProto, DOMCSSStyleDeclarationProtoFunc, ObjectPrototype)
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR(CSSStyleDeclarationPseudoCtor, "DOMCSSStyleDeclaration",DOMCSSStyleDeclarationProto)
 
@@ -495,7 +495,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMMediaListProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMMediaListProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMMediaList", DOMMediaListProto, DOMMediaListProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMMediaList", DOMMediaListProto, DOMMediaListProtoFunc, ObjectPrototype)
 
 DOMMediaList::DOMMediaList(ExecState *exec, DOM::MediaListImpl* ml)
   : m_impl(ml)
@@ -593,7 +593,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMCSSStyleSheetProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMCSSStyleSheetProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMCSSStyleSheet",DOMCSSStyleSheetProto,DOMCSSStyleSheetProtoFunc) // warning, use _WITH_PARENT if DOMStyleSheet gets a proto
+KJS_IMPLEMENT_PROTOTYPE("DOMCSSStyleSheet",DOMCSSStyleSheetProto,DOMCSSStyleSheetProtoFunc, ObjectPrototype) // warning, give a parent if DOMStyleSheet gets a proto
 
 DOMCSSStyleSheet::DOMCSSStyleSheet(ExecState *exec, DOM::CSSStyleSheetImpl* ss): DOMStyleSheet(exec, ss)
 {
@@ -1119,7 +1119,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMCSSPrimitiveValueProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMCSSPrimitiveValueProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMCSSPrimitiveValue",DOMCSSPrimitiveValueProto,DOMCSSPrimitiveValueProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMCSSPrimitiveValue",DOMCSSPrimitiveValueProto,DOMCSSPrimitiveValueProtoFunc,ObjectPrototype)
 
 DOMCSSPrimitiveValue::DOMCSSPrimitiveValue(ExecState *exec, DOM::CSSPrimitiveValueImpl* v)
   : DOMCSSValue(exec, v) {
Index: khtml/ecma/kjs_views.cpp
===================================================================
--- khtml/ecma/kjs_views.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_views.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -40,7 +40,7 @@
 
 KJS_DEFINE_PROTOTYPE(DOMAbstractViewProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMAbstractViewProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMAbstractView", DOMAbstractViewProto,DOMAbstractViewProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMAbstractView", DOMAbstractViewProto,DOMAbstractViewProtoFunc,ObjectPrototype)
 
 DOMAbstractView::DOMAbstractView(ExecState *exec, DOM::AbstractViewImpl* av)
   : m_impl(av)
Index: khtml/ecma/xmlhttprequest.cpp
===================================================================
--- khtml/ecma/xmlhttprequest.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/xmlhttprequest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -68,7 +68,7 @@
 
 KJS_DEFINE_PROTOTYPE(XMLHttpRequestProto)
 KJS_IMPLEMENT_PROTOFUNC(XMLHttpRequestProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("XMLHttpRequest", XMLHttpRequestProto,XMLHttpRequestProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("XMLHttpRequest", XMLHttpRequestProto,XMLHttpRequestProtoFunc, ObjectPrototype)
 
 
 XMLHttpRequestQObject::XMLHttpRequestQObject(XMLHttpRequest *_jsObject)
Index: khtml/ecma/kjs_traversal.cpp
===================================================================
--- khtml/ecma/kjs_traversal.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_traversal.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -61,7 +61,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMNodeIteratorProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMNodeIteratorProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMNodeIterator",DOMNodeIteratorProto,DOMNodeIteratorProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMNodeIterator",DOMNodeIteratorProto,DOMNodeIteratorProtoFunc,ObjectPrototype)
 
 DOMNodeIterator::DOMNodeIterator(ExecState *exec, DOM::NodeIteratorImpl* ni)
   : DOMObject(DOMNodeIteratorProto::self(exec)), m_impl(ni) {}
@@ -194,7 +194,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMTreeWalkerProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMTreeWalkerProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMTreeWalker",DOMTreeWalkerProto,DOMTreeWalkerProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMTreeWalker",DOMTreeWalkerProto,DOMTreeWalkerProtoFunc,ObjectPrototype)
 
 DOMTreeWalker::DOMTreeWalker(ExecState *exec, DOM::TreeWalkerImpl* tw)
   : m_impl(tw) {
@@ -208,6 +208,7 @@
 
 void DOMTreeWalker::mark()
 {
+  JSObject::mark();
   JSNodeFilter* filt = JSNodeFilter::fromDOMFilter(impl()->getFilter());
   if (filt)
     filt->mark();
Index: khtml/ecma/kjs_html.cpp
===================================================================
--- khtml/ecma/kjs_html.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_html.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -73,9 +73,9 @@
 
 namespace KJS {
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLDocumentProto, DOMDocumentProto)
+KJS_DEFINE_PROTOTYPE(HTMLDocumentProto)
 KJS_IMPLEMENT_PROTOFUNC(HTMLDocFunction)
-KJS_IMPLEMENT_PROTOTYPE("HTMLDocument", HTMLDocumentProto, HTMLDocFunction)
+KJS_IMPLEMENT_PROTOTYPE("HTMLDocument", HTMLDocumentProto, HTMLDocFunction, DOMDocumentProto)
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLDocumentPseudoCtor, "HTMLDocument", HTMLDocumentProto)
 
@@ -444,7 +444,7 @@
   switch (token) {
     case Body: {
       DOM::NodeImpl* body = toNode(value);
-      if (body->isHTMLElement())
+      if (body && body->isHTMLElement())
         doc.setBody(static_cast<DOM::HTMLElementImpl*>(body), exception);
       return;
     }
@@ -2575,8 +2575,8 @@
 
 
 //Prototype mess for this...
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLElementProto, DOMElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLElement", HTMLElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLElement", HTMLElementProto, HTMLElementFunction, DOMElementProto )
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLElementPseudoCtor, "HTMLElement", HTMLElementProto)
 
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLHtmlElement", HTMLHtmlElementProto, HTMLElementProto)
@@ -2603,16 +2603,16 @@
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLStyleElement", HTMLStyleElementProto, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLStyleElementPseudoCtor, "HTMLStyleElement", HTMLStyleElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLBodyElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLBodyElement", HTMLBodyElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLBodyElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLBodyElement", HTMLBodyElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLBodyElementPseudoCtor, "HTMLBodyElement", HTMLBodyElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLFormElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLFormElement", HTMLFormElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLFormElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLFormElement", HTMLFormElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLFormElementPseudoCtor, "HTMLFormElement", HTMLFormElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLSelectElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLSelectElement", HTMLSelectElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLSelectElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLSelectElement", HTMLSelectElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLSelectElementPseudoCtor, "HTMLSelectElement", HTMLSelectElementProto)
 
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLOptGroupElement", HTMLOptGroupElementProto, HTMLElementProto)
@@ -2621,16 +2621,16 @@
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLOptionElement", HTMLOptionElementProto, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLOptionElementPseudoCtor, "HTMLOptionElement", HTMLOptionElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLInputElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLInputElement", HTMLInputElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLInputElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLInputElement", HTMLInputElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLInputElementPseudoCtor, "HTMLInputElement", HTMLInputElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLTextAreaElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLTextAreaElement", HTMLTextAreaElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLTextAreaElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLTextAreaElement", HTMLTextAreaElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLTextAreaElementPseudoCtor, "HTMLTextAreaElement", HTMLTextAreaElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLButtonElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLButtonElement", HTMLButtonElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLButtonElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLButtonElement", HTMLButtonElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLButtonElementPseudoCtor, "HTMLButtonElement", HTMLButtonElementProto)
 
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLLabelElement", HTMLLabelElementProto, HTMLElementProto)
@@ -2693,8 +2693,8 @@
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLModElement", HTMLModElementProto, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLModElementPseudoCtor, "HTMLModElement", HTMLModElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLAnchorElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLAnchorElement", HTMLAnchorElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLAnchorElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLAnchorElement", HTMLAnchorElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLAnchorElementPseudoCtor, "HTMLAnchorElement", HTMLAnchorElementProto)
 
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLImageElement", HTMLImageElementProto, HTMLElementProto)
@@ -2718,8 +2718,8 @@
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLScriptElement", HTMLScriptElementProto, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLScriptElementPseudoCtor, "HTMLScriptElement", HTMLScriptElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLTableElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLTableElement", HTMLTableElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLTableElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLTableElement", HTMLTableElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLTableElementPseudoCtor, "HTMLTableElement", HTMLTableElementProto)
 
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLTableCaptionElement", HTMLTableCaptionElementProto, HTMLElementProto)
@@ -2728,12 +2728,12 @@
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLTableColElement", HTMLTableColElementProto, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLTableColElementPseudoCtor, "HTMLTableColElement", HTMLTableColElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLTableSectionElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLTableSectionElement", HTMLTableSectionElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLTableSectionElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLTableSectionElement", HTMLTableSectionElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLTableSectionElementPseudoCtor, "HTMLTableSectionElement", HTMLTableSectionElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLTableRowElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLTableRowElement", HTMLTableRowElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLTableRowElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLTableRowElement", HTMLTableRowElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLTableRowElementPseudoCtor, "HTMLTableRowElement", HTMLTableRowElementProto)
 
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLTableCellElement", HTMLTableCellElementProto, HTMLElementProto)
@@ -2751,12 +2751,12 @@
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLIFrameElement", HTMLIFrameElementProto, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLIFrameElementPseudoCtor, "HTMLIFrameElement", HTMLIFrameElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLMarqueeElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLMarqueeElement", HTMLMarqueeElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLMarqueeElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLMarqueeElement", HTMLMarqueeElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLMarqueeElementPseudoCtor, "HTMLMarqueeElement", HTMLMarqueeElementProto)
 
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLCanvasElementProto, HTMLElementProto)
-KJS_IMPLEMENT_PROTOTYPE("HTMLCanvasElement", HTMLCanvasElementProto, HTMLElementFunction)
+KJS_DEFINE_PROTOTYPE(HTMLCanvasElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLCanvasElement", HTMLCanvasElementProto, HTMLElementFunction, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLCanvasElementPseudoCtor, "HTMLCanvasElement", HTMLCanvasElementProto)
 
 
@@ -2900,7 +2900,7 @@
 */
 KJS_DEFINE_PROTOTYPE(HTMLCollectionProto)
 KJS_IMPLEMENT_PROTOFUNC(HTMLCollectionProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("HTMLCollection", HTMLCollectionProto,HTMLCollectionProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("HTMLCollection", HTMLCollectionProto, HTMLCollectionProtoFunc, ObjectPrototype)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLCollectionPseudoCtor, "HTMLCollection", HTMLCollectionProto)
 
 const ClassInfo KJS::HTMLCollection::info = { "HTMLCollection", 0, 0, 0 };
@@ -3130,9 +3130,9 @@
   add		HTMLSelectCollection::Add		DontDelete|Function 2
 @end
 */
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLSelectCollectionProto, HTMLCollectionProto)
+KJS_DEFINE_PROTOTYPE(HTMLSelectCollectionProto)
 KJS_IMPLEMENT_PROTOFUNC(HTMLSelectCollectionProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("HTMLOptionsCollection", HTMLSelectCollectionProto, HTMLSelectCollectionProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("HTMLOptionsCollection", HTMLSelectCollectionProto, HTMLSelectCollectionProtoFunc, HTMLCollectionProto)
 
 const ClassInfo KJS::HTMLSelectCollection::info = { "HTMLOptionsCollection", &HTMLCollection::info, 0, 0 };
 
Index: khtml/ecma/kjs_events.cpp
===================================================================
--- khtml/ecma/kjs_events.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_events.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -255,7 +255,7 @@
 */
 KJS_DEFINE_PROTOTYPE(DOMEventProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMEventProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMEvent", DOMEventProto, DOMEventProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMEvent", DOMEventProto, DOMEventProtoFunc,ObjectPrototype)
 
 DOMEvent::DOMEvent(ExecState *exec, DOM::EventImpl* e)
   : m_impl(e) {
@@ -476,9 +476,9 @@
   initUIEvent	DOMUIEvent::InitUIEvent	DontDelete|Function 5
 @end
 */
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMUIEventProto,DOMEventProto)
+KJS_DEFINE_PROTOTYPE(DOMUIEventProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMUIEventProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMUIEvent",DOMUIEventProto,DOMUIEventProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMUIEvent",DOMUIEventProto,DOMUIEventProtoFunc,DOMEventProto)
 
 DOMUIEvent::DOMUIEvent(ExecState *exec, DOM::UIEventImpl* ue) :
   DOMEvent(DOMUIEventProto::self(exec), ue) {}
@@ -575,9 +575,9 @@
   initMouseEvent	DOMMouseEvent::InitMouseEvent	DontDelete|Function 15
 @end
 */
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMMouseEventProto,DOMUIEventProto)
+KJS_DEFINE_PROTOTYPE(DOMMouseEventProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMMouseEventProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMMouseEvent",DOMMouseEventProto,DOMMouseEventProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMMouseEvent",DOMMouseEventProto,DOMMouseEventProtoFunc,DOMUIEventProto)
 
 DOMMouseEvent::DOMMouseEvent(ExecState *exec, DOM::MouseEventImpl* me) :
   DOMUIEvent(DOMMouseEventProto::self(exec), me) {}
@@ -765,9 +765,9 @@
   # Missing: initTextEventNS
 @end
 */
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMTextEventProto,DOMUIEventProto)//Note: no proto in KeyBase
+KJS_DEFINE_PROTOTYPE(DOMTextEventProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMTextEventProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMTextEvent", DOMTextEventProto,DOMTextEventProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMTextEvent", DOMTextEventProto,DOMTextEventProtoFunc,DOMUIEventProto)//Note: no proto in KeyBase
 
 DOMTextEvent::DOMTextEvent(ExecState *exec, DOM::TextEventImpl* ke) :
   DOMKeyEventBase(DOMTextEventProto::self(exec), ke) {}
@@ -826,9 +826,9 @@
   getModifierState      DOMKeyboardEvent::GetModifierState      DontDelete|Function 1
 @end
 */
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMKeyboardEventProto, DOMUIEventProto) //Note: no proto in
+KJS_DEFINE_PROTOTYPE(DOMKeyboardEventProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMKeyboardEventProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMKeyboardEvent",DOMKeyboardEventProto,DOMKeyboardEventProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMKeyboardEvent",DOMKeyboardEventProto,DOMKeyboardEventProtoFunc, DOMUIEventProto) //Note: no proto in KeyBase
 
 DOMKeyboardEvent::DOMKeyboardEvent(ExecState *exec, DOM::KeyboardEventImpl* ke) :
   DOMKeyEventBase(DOMKeyboardEventProto::self(exec), ke) {}
@@ -959,9 +959,9 @@
   initMutationEvent	DOMMutationEvent::InitMutationEvent	DontDelete|Function 8
 @end
 */
-KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMMutationEventProto,DOMEventProto)
+KJS_DEFINE_PROTOTYPE(DOMMutationEventProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMMutationEventProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMMutationEvent",DOMMutationEventProto,DOMMutationEventProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMMutationEvent",DOMMutationEventProto,DOMMutationEventProtoFunc,DOMEventProto)
 
 DOMMutationEvent::DOMMutationEvent(ExecState *exec, DOM::MutationEventImpl* me) :
   DOMEvent(DOMMutationEventProto::self(exec), me) {}
Index: khtml/ecma/kjs_window.cpp
===================================================================
--- khtml/ecma/kjs_window.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_window.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -266,7 +266,7 @@
 # IE extension
   navigate	Window::Navigate	DontDelete|Function 1
 # Mozilla extension
-  sidebar	Window::SideBar		DontDelete|ReadOnly
+  sidebar	Window::SideBar		DontDelete|DontEnum
   getComputedStyle	Window::GetComputedStyle	DontDelete|Function 2
 
 # Warning, when adding a function to this object you need to add a case in Window::get
@@ -725,12 +725,6 @@
     case Status:
       return jsString(UString(part->jsStatusBarText()));
     case Document:
-      if (!part->xmlDocImpl()) {
-        kDebug(6070) << "Document.write: adding <HTML><BODY> to create document";
-        part->begin();
-        part->write("<HTML><BODY>");
-        part->end();
-      }
       return getDOMNode(exec, part->xmlDocImpl());
     case FrameElement:
       if (m_frame->m_partContainerElement)
Index: khtml/ecma/kjs_context2d.cpp
===================================================================
--- khtml/ecma/kjs_context2d.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_context2d.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -74,7 +74,7 @@
 
 KJS_DEFINE_PROTOTYPE(Context2DProto)
 KJS_IMPLEMENT_PROTOFUNC(Context2DFunction)
-KJS_IMPLEMENT_PROTOTYPE("CanvasRenderingContext2DProto", Context2DProto, Context2DFunction)
+KJS_IMPLEMENT_PROTOTYPE("CanvasRenderingContext2DProto", Context2DProto, Context2DFunction, ObjectPrototype)
 
 /*
    @begin Context2DProtoTable 48
@@ -658,7 +658,7 @@
 
 KJS_DEFINE_PROTOTYPE(CanvasGradientProto)
 KJS_IMPLEMENT_PROTOFUNC(CanvasGradientFunction)
-KJS_IMPLEMENT_PROTOTYPE("CanvasGradientProto", CanvasGradientProto, CanvasGradientFunction)
+KJS_IMPLEMENT_PROTOTYPE("CanvasGradientProto", CanvasGradientProto, CanvasGradientFunction, ObjectPrototype)
 
 /*
    @begin CanvasGradientProtoTable 1
@@ -696,7 +696,7 @@
 // Provide an empty prototype in case people want to hack it
 KJS_DEFINE_PROTOTYPE(CanvasPatternProto)
 KJS_IMPLEMENT_PROTOFUNC(CanvasPatternFunction)
-KJS_IMPLEMENT_PROTOTYPE("CanvasPatternProto", CanvasPatternProto, CanvasPatternFunction)
+KJS_IMPLEMENT_PROTOTYPE("CanvasPatternProto", CanvasPatternProto, CanvasPatternFunction, ObjectPrototype)
 
 /*
    @begin CanvasPatternProtoTable 0
Index: khtml/ecma/kjs_dom.h
===================================================================
--- khtml/ecma/kjs_dom.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/kjs_dom.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -65,7 +65,7 @@
            OnResize, OnScroll, OnSelect, OnSubmit, OnUnload,
            OffsetLeft, OffsetTop, OffsetWidth, OffsetHeight, OffsetParent,
            ClientLeft, ClientTop, ClientWidth, ClientHeight, ScrollLeft, ScrollTop,
-	   ScrollWidth, ScrollHeight, SourceIndex, TextContent };
+           ScrollWidth, ScrollHeight, SourceIndex, TextContent };
 
     //### toNode? virtual
     DOM::NodeImpl* impl() const { return m_impl.get(); }
@@ -74,7 +74,7 @@
   };
 
   DEFINE_CONSTANT_TABLE(DOMNodeConstants)
-  KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMNodeProto, DOMNodeConstants)
+  KJS_DEFINE_PROTOTYPE(DOMNodeProto)
   DEFINE_PSEUDO_CONSTRUCTOR(NodeConstructor)
 
   class DOMNodeList : public DOMObject {
@@ -137,7 +137,7 @@
     DOM::DocumentImpl* impl() { return static_cast<DOM::DocumentImpl*>(m_impl.get()); }
   };
   
-  KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMDocumentProto, DOMNodeProto)
+  KJS_DEFINE_PROTOTYPE(DOMDocumentProto)
 
   DEFINE_PSEUDO_CONSTRUCTOR(DocumentPseudoCtor)
 
@@ -181,7 +181,7 @@
   DOM::AttrImpl    *toAttr   (JSValue *); // returns 0 if passed-in value is not a DOMAtt object
   DOM::ElementImpl *toElement(JSValue *); // returns 0 if passed-in value is not a DOMElement object
 
-  KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMElementProto, DOMNodeProto)
+  KJS_DEFINE_PROTOTYPE(DOMElementProto)
   DEFINE_PSEUDO_CONSTRUCTOR(ElementPseudoCtor)
 
   class DOMDOMImplementation : public DOMObject {
Index: khtml/ecma/domparser.cpp
===================================================================
--- khtml/ecma/domparser.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/ecma/domparser.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -44,7 +44,7 @@
 
 KJS_DEFINE_PROTOTYPE(DOMParserProto)
 KJS_IMPLEMENT_PROTOFUNC(DOMParserProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("DOMParser",DOMParserProto,DOMParserProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMParser",DOMParserProto,DOMParserProtoFunc,ObjectPrototype)
 
 
 DOMParserConstructorImp::DOMParserConstructorImp(ExecState* exec, DOM::DocumentImpl *d)
Index: khtml/java/kjavaappletviewer.desktop
===================================================================
--- khtml/java/kjavaappletviewer.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/java/kjavaappletviewer.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,7 @@
 Name[gu]=જડિત જાવા એપ્લેટ દર્શક
 Name[he]=מציג יישומוני Java משובץ
 Name[hi]=अंतर्निर्मित जावा ऐप्लेट प्रदर्शक
+Name[hne]=भीतर मं बने जावा ऐप्लेट प्रदर्सक
 Name[hr]=Ugrađeni preglednik Java appleta
 Name[hsb]=Integrowany wuwjedowar za Java Applets
 Name[hu]=Beágyazott megjelenítőprogram Java kisalkalmazásokhoz
Index: khtml/css/css_stylesheetimpl.h
===================================================================
--- khtml/css/css_stylesheetimpl.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/css/css_stylesheetimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -27,6 +27,7 @@
 #include "css/css_base.h"
 #include "misc/loader_client.h"
 #include "xml/dom_docimpl.h"
+#include <QPointer>
 
 namespace khtml {
     class CachedCSSStyleSheet;
@@ -133,7 +134,9 @@
 class StyleSheetListImpl : public khtml::Shared<StyleSheetListImpl>
 {
 public:
-    StyleSheetListImpl() {}
+    // the manager argument should be passed only when this is 
+    // document.styleSheets.
+    StyleSheetListImpl(DocumentImpl* manager = 0): managerDocument(manager) {}
     ~StyleSheetListImpl();
 
     // the following two ignore implicit stylesheets
@@ -144,6 +147,11 @@
     void remove(StyleSheetImpl* s);
 
     QList<StyleSheetImpl*> styleSheets;
+    
+    // we need the document pointer to make it update the stylesheet list
+    // if needed for the global list. Luckily, we don't care about that if the 
+    // document dies, so we use QPointer to break the cycle
+    QPointer<DocumentImpl> managerDocument;
 };
 
 // ----------------------------------------------------------------------------
Index: khtml/css/css_stylesheetimpl.cpp
===================================================================
--- khtml/css/css_stylesheetimpl.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/css/css_stylesheetimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -349,6 +349,12 @@
 
 void StyleSheetListImpl::add( StyleSheetImpl* s )
 {
+    if (managerDocument)
+        managerDocument->ensureStyleSheetListUpToDate();
+
+    // ### in cases this is document.styleSheets, maybe 
+    // we should route to DocumentImpl::addStyleSheets?
+
     if ( !styleSheets.contains( s ) ) {
         s->ref();
         styleSheets.append( s );
@@ -357,12 +363,18 @@
 
 void StyleSheetListImpl::remove( StyleSheetImpl* s )
 {
+    if (managerDocument)
+        managerDocument->ensureStyleSheetListUpToDate();
+
     if ( styleSheets.removeAll( s ) )
         s->deref();
 }
 
 unsigned long StyleSheetListImpl::length() const
 {
+    if (managerDocument)
+        managerDocument->ensureStyleSheetListUpToDate();
+
     // hack so implicit BODY stylesheets don't get counted here
     unsigned long l = 0;
     foreach (StyleSheetImpl* sh, styleSheets) {
@@ -374,6 +386,9 @@
 
 StyleSheetImpl *StyleSheetListImpl::item ( unsigned long index )
 {
+    if (managerDocument)
+        managerDocument->ensureStyleSheetListUpToDate();
+
     unsigned long l = 0;
     foreach (StyleSheetImpl* sh, styleSheets) {
         if (!sh->isCSSStyleSheet() || !static_cast<CSSStyleSheetImpl*>(sh)->implicit()) {
Index: khtml/xml/dom_docimpl.h
===================================================================
--- khtml/xml/dom_docimpl.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/xml/dom_docimpl.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -282,10 +282,16 @@
      * in existing sheets, then set this argument to true for efficiency.
      */
     void updateStyleSelector(bool shallow=false);
+    
+    void ensureStyleSheetListUpToDate() { if (m_styleSheetListDirty) rebuildStyleSheetList(true); }
 
     bool readyForLayout() const;
-    void recalcStyleSelector();
-    void rebuildStyleSelector();
+    
+private:    
+    void rebuildStyleSheetList(bool force = false);
+    void rebuildStyleSelector ();
+    bool m_styleSheetListDirty;
+public:
 
     // Tries to restore the elements value from the doc state,
     // if it seems like the same thing
Index: khtml/xml/dom2_rangeimpl.cpp
===================================================================
--- khtml/xml/dom2_rangeimpl.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/xml/dom2_rangeimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -1181,16 +1181,21 @@
 DocumentFragment RangeImpl::createContextualFragment ( const DOMString &html, int &exceptioncode )
 {
    if (m_detached) {
-        exceptioncode = DOMException::INVALID_STATE_ERR;
-        return DocumentFragment();
+	exceptioncode = DOMException::INVALID_STATE_ERR;
+	return DocumentFragment();
     }
 
-    if (! m_startContainer->isHTMLElement()) {
+    DOM::NodeImpl* start = m_startContainer;
+
+    if (start->isDocumentNode())
+	start = static_cast<DocumentImpl*>(start)->documentElement();
+
+    if (!start || !start->isHTMLElement()) {
 	exceptioncode = DOMException::NOT_SUPPORTED_ERR;
 	return DocumentFragment();
     }
 
-    HTMLElementImpl *e = static_cast<HTMLElementImpl *>(m_startContainer);
+    HTMLElementImpl *e = static_cast<HTMLElementImpl *>(start);
     DocumentFragment fragment = e->createContextualFragment(html);
     if (fragment.isNull()) {
 	exceptioncode = DOMException::NOT_SUPPORTED_ERR;
@@ -1685,10 +1690,4 @@
     return false;
 }
 
-
-
-
-
-
-
-
+// kate: indent-width 4; replace-tabs off; tab-width 8; space-indent off;
Index: khtml/xml/dom_docimpl.cpp
===================================================================
--- khtml/xml/dom_docimpl.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ khtml/xml/dom_docimpl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -422,12 +422,13 @@
     m_defaultView = new AbstractViewImpl(this);
     m_defaultView->ref();
     m_listenerTypes = 0;
-    m_styleSheets = new StyleSheetListImpl;
+    m_styleSheets = new StyleSheetListImpl(this);
     m_styleSheets->ref();
     m_addedStyleSheets = 0;
     m_inDocument = true;
     m_styleSelectorDirty = false;
     m_styleSelector = 0;
+    m_styleSheetListDirty = true;
 
     m_inStyleRecalc = false;
     m_pendingStylesheets = 0;
@@ -2205,13 +2206,19 @@
 //    kDebug() << "PENDING " << m_pendingStylesheets;
 
     // Don't bother updating, since we haven't loaded all our style info yet.
-    if (m_pendingStylesheets > 0)
+    if (m_pendingStylesheets > 0) {
+        // ... however, if the list of stylesheets changed, mark it as dirty
+        // so DOM ops can get an up-to-date version.
+        if (!shallow)
+            m_styleSheetListDirty = true;
         return;
+    }
+    
+    if (!shallow)
+        rebuildStyleSheetList();
 
-    if (shallow)
-        rebuildStyleSelector();
-    else
-        recalcStyleSelector();
+    rebuildStyleSelector();
+    
     recalcStyle(Force);
 #if 0
 
@@ -2226,11 +2233,19 @@
     return renderer() && haveStylesheetsLoaded() && (!isHTMLDocument() || (body() && body()->renderer()));
 }
 
-void DocumentImpl::recalcStyleSelector()
+void DocumentImpl::rebuildStyleSheetList(bool force)
 {
-    if ( !m_render || !attached() ) return;
+    if ( !m_render || !attached() ) {
+        // Unless we're forced due to CSS DOM ops, we don't have to compute info
+        // when there is nothing to display
+        if (!force) {
+            m_styleSheetListDirty = true;
+            return;
+        }
+    }
 
-    assert(m_pendingStylesheets==0);
+    // Mark us as clean, as we can call add on the list below, forcing us to re-enter
+    m_styleSheetListDirty = false;
 
     QList<StyleSheetImpl*> oldStyleSheets = m_styleSheets->styleSheets;
     m_styleSheets->styleSheets.clear();
@@ -2370,12 +2385,13 @@
     // De-reference all the stylesheets in the old list
     foreach ( StyleSheetImpl* sh, oldStyleSheets)
         sh->deref();
-
-    rebuildStyleSelector();
 }
 
 void DocumentImpl::rebuildStyleSelector()
 {
+    if ( !m_render || !attached() )
+        return;
+
     // Create a new style selector
     delete m_styleSelector;
     QString usersheet = m_usersheet;
Index: cmake/modules/FindGMP.cmake
===================================================================
--- cmake/modules/FindGMP.cmake	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ cmake/modules/FindGMP.cmake	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -15,7 +15,7 @@
 endif (GMP_INCLUDE_DIR AND GMP_LIBRARIES)
 
 find_path(GMP_INCLUDE_DIR NAMES gmp.h )
-find_library(GMP_LIBRARIES NAMES gmp )
+find_library(GMP_LIBRARIES NAMES gmp libgmp)
 
 include(FindPackageHandleStandardArgs)
 FIND_PACKAGE_HANDLE_STANDARD_ARGS(GMP DEFAULT_MSG GMP_INCLUDE_DIR GMP_LIBRARIES)
Index: cmake/modules/FindKDE4Internal.cmake
===================================================================
--- cmake/modules/FindKDE4Internal.cmake	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ cmake/modules/FindKDE4Internal.cmake	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -260,6 +260,13 @@
 cmake_policy(SET CMP0003 OLD)
 # CMP0005: keep escaping behaviour for definitions added via add_definitions()
 cmake_policy(SET CMP0005 OLD)
+# since cmake 2.6.3: NEW behaviour is that setting policies doesn't "escape" the file 
+# where this is done, macros and functions are executed with the policies as they
+# were when the were defined. Keep the OLD behaviour so we can set the policies here
+# for all KDE software without the big warning
+if(POLICY CMP0011)
+   cmake_policy(SET CMP0011 OLD)
+endif(POLICY CMP0011)
 
 
 # Only do something if it hasn't been found yet
Index: interfaces/kimproxy/interface/dbusinstantmessenger.desktop
===================================================================
--- interfaces/kimproxy/interface/dbusinstantmessenger.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ interfaces/kimproxy/interface/dbusinstantmessenger.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -28,6 +28,7 @@
 Comment[gu]=D-Bus ઇન્ટરફેસ સાથે ઇન્સ્ટન્ટ મેસેન્જર
 Comment[he]=תוכנת מסרים מידיים עם ממשק D-Bus
 Comment[hi]=डी-बस इंटरफ़ेस के साथ इंस्टैंट मैसेंजर
+Comment[hne]=डी-बस इंटरफेस के साथ इंस्टैंट मैसेंजर
 Comment[hsb]=Instant Messenger z DCOP-interfejsom
 Comment[hu]=Azonnali üzenetküldő DBus felülettel
 Comment[is]=Spjallforrit með D-Bus viðmóti
@@ -44,6 +45,7 @@
 Comment[mk]=Инстант гласник (Messenger) со D-Bus интерфејс
 Comment[ml]=ഡി-ബസ് വിനിമയതലമുള്ള ഇന്‍സ്റ്റന്റ് മെസഞ്ചര്‍
 Comment[mr]=D-Bus संवादपटरहीत जलद संदेशवाहक
+Comment[ms]=Utusan Segera dengan antaramuka D-Bus
 Comment[nb]=Lynmeldingsprogram med D-Bus-grensesnitt
 Comment[nds]=Kortnarichten-Maker mit en D-Bus-Koppelsteed
 Comment[ne]=D-Bus इन्टरफेससँग इन्सट्यान्ट मेसेन्जर
Index: interfaces/kimproxy/interface/kcm_instantmessenger.desktop
===================================================================
--- interfaces/kimproxy/interface/kcm_instantmessenger.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ interfaces/kimproxy/interface/kcm_instantmessenger.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -24,6 +24,7 @@
 Name[gu]=ઇન્સ્ટન્ટ મેસેન્જર
 Name[he]=מסרים מידיים
 Name[hi]=इंसटैंट मैसेंजर
+Name[hne]=इंसटैंट मैसेंजर
 Name[hu]=Azonnali üzenetküldő
 Name[is]=Spjallforrit
 Name[it]=Messaggistica istantanea
@@ -100,6 +101,7 @@
 Comment[gu]=ઇન્સ્ટન્ટ મેસેન્જર એ બે જણાં અને સમૂહોને દ્રિ-પક્ષી વાતચીત કરવાની સુવિધા આપે છે.
 Comment[he]=תוכנת מסרים מידיים מאפשרת לשוחח ברשת בין שני אנשים או יותר.
 Comment[hi]=दो व्यक्तियों या समूहों के बीच दो-तरफ़ा गपशप की सुविधा इंस्टैंट मैसेंजर से मिलती है.
+Comment[hne]=दू मनखे या समूह मन के बीच दू-तरफा गपसप के सुविधा इंस्टैंट मैसेंजर से मिलथे.
 Comment[hr]=Trenutne poruke omogućuju dvosmjerno brbljanje između pojedinaca i grupa.
 Comment[hsb]=Instant messenger zmóžni jednotliwcam a skupinam spěšnu wuměnu zdźělenkow.
 Comment[hu]=Interaktív társalgást tesz lehetővé az interneten keresztül két személy vagy csoport között.
@@ -130,7 +132,7 @@
 Comment[pt_BR]=O mensageiro instantâneo possibilita o bate-papo entre indivíduos e grupos.
 Comment[ro]=Aplicația de mesagerie instantanee permite convorbiri între persoane sau grupuri de persoane.
 Comment[ru]=Клиент обмена сообщениями служит для обмена сообщениями между людьми и между группами.
-Comment[se]=Šleađgadiehtoprográmma gos olbmot ja joavkkut sáhttet buillardallat (chat).
+Comment[se]=Šleađgadiehtoprográmma gos olbmot ja joavkkut sáhttet buillardit (Chat).
 Comment[sk]=Instant messenger umožňuje rozhovor medzi rôznymi osobami a skupinami.
 Comment[sl]=Takojšni sporočilnik omogoča dvosmeren klepet med posamezniki in skupinami.
 Comment[sr]=Брзим гласником можете ћаскати са другим појединцима и у групама.
Index: interfaces/kspeech/dbustexttospeech.desktop
===================================================================
--- interfaces/kspeech/dbustexttospeech.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ interfaces/kspeech/dbustexttospeech.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -28,6 +28,7 @@
 Comment[gu]=D-Bus ઇન્ટરફેસ સાથે લખાણ-થી-ધ્વનિ સેવા
 Comment[he]=שירות טקסט לדיבור עם ממשק D-Bus
 Comment[hi]=डी-बस इंटरफ़ेस के साथ पाठ-से-वार्ता सेवा
+Comment[hne]=डी-बस इंटरफेस के साथ पाठ-से-वार्ता सेवा
 Comment[hsb]=konwertowanje teksta na rěč z D-Bus-interfejsom
 Comment[hu]=Szövegfelolvasó szolgáltatás D-Bus felülettel
 Comment[is]=Texti-í-tal þjónusta með D-Bus viðmóti
@@ -44,6 +45,7 @@
 Comment[mk]=Сервис за текст-во-говор со D-Bus-интерфејс
 Comment[ml]=ഡി-ബസ് വിനിമയതലമുള്ള അക്ഷരങ്ങളെ ശബ്ദത്തിലേയ്ക്കു് മാറ്റുന്ന സേവനം
 Comment[mr]=D-Bus संवाद पाठ्य भाष्य सेवा
+Comment[ms]=Servis Teks-ke-Tutur dengan antaramuka D-Bus
 Comment[nb]=Tekst til tale-program med D-Bus-grensesnitt
 Comment[nds]=Vörleesdeenst mit en DBUS-Koppelsteed
 Comment[ne]=D-Bus इन्टरफेससँग पाठ-बाट-बोली सेवा
@@ -55,7 +57,7 @@
 Comment[pt_BR]=Serviço de conversão de texto para fala com interface D-Bus
 Comment[ro]=Serviciu text-vorbire cu interfață D-Bus
 Comment[ru]=Служба синтеза речи с интерфейсом D-Bus
-Comment[se]=Hupmejuvvon-teaksta-bálválus mas lea D-Bus-lákta
+Comment[se]=Hubmon-teaksta-bálvalus mas lea D-Bus-lákta
 Comment[sk]=Služba prevodu textu na reč s rozhraním D-Bus
 Comment[sl]=Servis, ki spremeni besedilo v govor, z vmesnikom D-Bus
 Comment[sr]=Текст‑у‑говор сервис са д‑бус сучељем
Index: interfaces/ktexteditor/ktexteditor.desktop
===================================================================
--- interfaces/ktexteditor/ktexteditor.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ interfaces/ktexteditor/ktexteditor.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
 Comment[gu]=જડિત લખાણ સંપાદક ભાગ (Doc/View અલગ પાડેલ સાથે)
 Comment[he]=רכיב עורך טקסט הניתן לשיבוץ (עם הפרדה בין מסמך לתצוגה)
 Comment[hi]=अंतर्निर्मित पाठ संपादक अवयव (डॉक/दृश्य विभाजन के साथ)
+Comment[hne]=भीतर मं बने पाठ संपादक अवयव (डाक/दृस्य विभाजन के साथ)
 Comment[hr]=Ugradiva komponenta obrade teksta (s Doc/View razdvajanjem)
 Comment[hsb]=Komponenta za integrowane wobdźěłanje teksta
 Comment[hu]=Beágyazható szövegszerkesztő (dokumentum/nézet modellel)
Index: interfaces/ktexteditor/ktexteditor_loadsavefiltercheckplugin.desktop
===================================================================
--- interfaces/ktexteditor/ktexteditor_loadsavefiltercheckplugin.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ interfaces/ktexteditor/ktexteditor_loadsavefiltercheckplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -21,6 +21,7 @@
 Comment[gl]=Extensión de cargar/gardar o filtro/comprobación para KTextEditor
 Comment[gu]=KTextEditor લાવવા/સંગ્રહ ગાળક/ચકાસણી પ્લગઇન
 Comment[he]=תוסף לשמירה וטעינה או בדיקה של תוסף עבור KTextEditor
+Comment[hne]=के-टैक्स्ट-एडीटर लोड/सहेज फिल्टर/जांच प्लगइन
 Comment[hsb]=KTextEditor plugin za wočinjenje/zawěsćenje
 Comment[hu]=KTextEditor betöltési/mentési/szűrési/ellenőrzési bővítmény
 Comment[is]=KTextEditor hlaða/vista sía/prófa íforrit
@@ -30,9 +31,11 @@
 Comment[kn]=ಕೆಟೆಕ್ಸ್ಟ್ ಎಡಿಟರ್ ಉತ್ಥಾಪಿಸು/ಉಳಿಸು ಶೋಧಿಸು/ಪರಿಶೀಲಿಸಿ ಮಿಳಿತಾನ್ವಯ (ಪ್ಲಗಿನ್)
 Comment[ko]=KTextEditor 필터/검사 불러오기/저장 플러그인
 Comment[ku]=KEdîtoraNivîsê pêveka barbike/tomarbike parzûnbike/kontrolbike
+Comment[lt]=KTextEditor įkėlimo/įrašymo filtro/tikrinimo priedas
 Comment[lv]=KTextEditor ielādēšanas/saglabāšanas  filtrs/pārbaudīšanas spraudnis
 Comment[mai]=KTextEditor लोड/सहेज फिल्टर/जाँच प्लगइन
 Comment[ml]=കെടെക്സ്റ്റ്എഡിറ്റര്‍ ചേര്‍ക്കുക/സൂക്ഷിയ്ക്കുക ഫില്‍ടര്‍/പരിശോദിയ്ക്കുക എന്നതിനുള്ള സംയോജകം
+Comment[ms]=Plugin muat/simpan tapis/periksa KTextEditor
 Comment[nb]=KTextEditor programtillegg for laste/lagre filter/sjekk
 Comment[nds]=KTextEditor-Moduul för't Filtern/Pröven bi't Laden un Sekern
 Comment[nl]=KTextEditor-plugin voor laden/opslaan filteren/controleren
@@ -42,7 +45,8 @@
 Comment[pt]='Plugin' de filtragem/verificação do carregamento/gravação do KTextEditor
 Comment[pt_BR]=Plug-in de carregamento/gravação e filtro/verificação do KTextEditor
 Comment[ro]=Modul de încărcare/salvare filtrare/verificare pentru KTextEditor
-Comment[ru]=Расширение фильтра загрузки и сохранения файла для KTextEditor
+Comment[ru]=Загрузка и сохранение фильтров для KTextEditor
+Comment[se]=KDE-čállinprográmma raba/vurke sillen/iskan-lassemodula
 Comment[sk]=KTextEditor nahrať/uložiť filtrovať/skontrolovať rozšírenie
 Comment[sr]=Прикључак уређивача текста за филтрирање и проверу на учитавању и уписивању
 Comment[sr@latin]=Priključak uređivača teksta za filtriranje i proveru na učitavanju i upisivanju
Index: interfaces/ktexteditor/codecompletionmodelcontrollerinterface.cpp
===================================================================
--- interfaces/ktexteditor/codecompletionmodelcontrollerinterface.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ interfaces/ktexteditor/codecompletionmodelcontrollerinterface.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -19,6 +19,8 @@
 
 #include "codecompletionmodelcontrollerinterface.h"
 
+#include <QtCore/QModelIndex>
+
 #include <ktexteditor/view.h>
 #include <ktexteditor/document.h>
 
Index: interfaces/ktexteditor/ktexteditorplugin.desktop
===================================================================
--- interfaces/ktexteditor/ktexteditorplugin.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ interfaces/ktexteditor/ktexteditorplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
 Comment[gu]=KTextEditor પ્લગઇન
 Comment[he]=תוסף KTextEditor
 Comment[hi]=के-टैक्स्ट-एडीटर प्लगइन
+Comment[hne]=के-टैक्स्ट-एडीटर प्लगइन
 Comment[hr]=KTextEditor dodatak
 Comment[hsb]=KTextEditor zašćěpka
 Comment[hu]=KTextEditor-bővítőmodul
@@ -62,7 +63,7 @@
 Comment[pt_BR]=Plug-in do KTextEditor
 Comment[ro]=Modul editor de text
 Comment[ru]=Расширение KTextEditor
-Comment[se]=KDE-čállinprográmma lassemoduvla
+Comment[se]=KDE-čállinprográmma lassemodula
 Comment[sk]=Modul KTextEditor
 Comment[sl]=Vstavek KTextEditor
 Comment[sr]=Прикључак за уређивање текста
Index: interfaces/ktexteditor/kcm_ktexteditor.desktop
===================================================================
--- interfaces/ktexteditor/kcm_ktexteditor.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ interfaces/ktexteditor/kcm_ktexteditor.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -28,6 +28,7 @@
 Name[gu]=જડિત લખાણ સંપાદક
 Name[he]=עורך טקסט משובץ
 Name[hi]=अंतर्निर्मित पाठ संपादक
+Name[hne]=भीतर मं बने पाठ संपादक
 Name[hr]=Ugrađeni uređivač teksta
 Name[hsb]=Integrowane wobdźěłanje tekstow
 Name[hu]=Beágyazott szövegszerkesztő
@@ -109,6 +110,7 @@
 Comment[gu]=લખાણ સંપાદક સેવા કાર્યક્રમોને લખાણ દર્શક અને સંપાદક પૂરૂં પાડે છે. KDE કાર્યક્રમો જે લખાણ સંપાદન સુવિધાઓ ઉપયોગ કરે છે તેમને આ સેવા ઉપયોગ કરવી જોઇએ.
 Comment[he]=שירות עורך הטקסט מספק לתוכניות יכולות הצגה ועריכת טקסט. תוכנות של KDE שמספקות אמצעים לעריכת טקסט ישתמשו בשירות זה.
 Comment[hi]=पाठ संपादक सेवा में पाठ प्रदर्शक तथा संपादक अनुप्रयोग मिलते हैं. केडीई अनुप्रयोग जो पाठ संपादन सुविधा प्रदान करते हैं उन्हें यह सेवा प्रयोग करना चाहिए.
+Comment[hne]=पाठ संपादक सेवा मं पाठ प्रदर्सक अउ संपादक अनुपरयोग मिलथे. केडीई अनुपरयोग जऊन पाठ संपादन सुविधा प्रदान करथे ओ मन ल ए सेवा परयोग करना चाही.
 Comment[hr]=Usluga tekstualnog uređivača aplikacijama omugućuje pregledavanje i uređivanje teksta. KDE aplikacije koje omogućuju uređivanje teksta trebale bi upotrebljavati ovo sučelje.
 Comment[hsb]=Wobdźěłanje teksta staji programam wobdźěłarja a wobhladowarja teksta k dispoziciji. KDE-aplikacije, kiž tajke něšto trjebaja, měli tutón serwis wužiwać.
 Comment[hu]=A szövegszerkesztő szolgáltatáson keresztül az alkalmazások szövegek megtekintését és szerkesztését végezhetik el. A KDE szövegszerkesztő programjai használhatják.
@@ -139,7 +141,7 @@
 Comment[pt_BR]=O serviço de edição de texto fornece um visualizador e editor de texto aos aplicativos.  Os aplicativos KDE que fornecem recursos de edição de texto devem utilizar este serviço.
 Comment[ro]=Serviciul de editare text asigură aplicațiilor un vizualizor de text și un editor. Aplicațiile KDE care oferă capabilități de editare de text ar trebui să utilizeze acest serviciu.
 Comment[ru]=Служба текстового редактора для приложений, в которых требуется просмотр и редактирование текста. Её должны использовать приложения KDE, в которых требуется редактирование текста.
-Comment[se]=Čállinprográmmabálvalus fállá teakstačájeheami ja -doaimmaheaheami. KDE-prográmmat, mat fállet teakstadoaimmahanvejolašvuođaid, galggašedje geavahit dán bálvalusa.
+Comment[se]=Čállinprográmmabálvalus fállá teakstačájeheami ja -doaimmaheami. KDE-prográmmat, mat fállet teakstadoaimmahanvejolašvuođaid, galggašedje geavahit dán bálvalusa.
 Comment[sk]=Služba textového editora poskytuje aplikáciám prehliadač a editor textových súborov. Aplikácie KDE, ktoré podporujú úpravu textu, by mali používať túto službu.
 Comment[sl]=Storitev urejevalnika besedila omogoča programom dostop do pregledovalnika in urejevalnika besedil. Programi za KDE, ki omogočajo urejanje besedila, naj bi uporabljali to storitev.
 Comment[sr]=Сервис уређивача текста пружа програмима начин за приказивање и уређивање текстова. Требало би да га користе сви КДЕ програми којима је то потребно.
Index: knotify/tests/knotifytest.notifyrc
===================================================================
--- knotify/tests/knotifytest.notifyrc	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ knotify/tests/knotifytest.notifyrc	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -26,6 +26,7 @@
 Comment[gu]=Knotify માટે ચકાસણી
 Comment[he]=בדיקה עבור Knotify
 Comment[hi]=के-नोटिफ़ाई के लिए जाँच
+Comment[hne]=के-नोटिफाई बर जांच
 Comment[hsb]=Test za Knotify
 Comment[hu]=A KNotify tesztelése
 Comment[is]=Prófun á Knotify
@@ -99,6 +100,7 @@
 Name[gu]=જૂથ
 Name[he]=קבוצה
 Name[hi]=समूह
+Name[hne]=समूह
 Name[hsb]=Skupina
 Name[hu]=Csoport
 Name[is]=Hópur
@@ -170,6 +172,7 @@
 Comment[gu]=સમૂહ
 Comment[he]=הקבוצה
 Comment[hi]=समूह 
+Comment[hne]=समूह 
 Comment[hsb]=Skupina
 Comment[hu]=A csoport
 Comment[is]=Hópurinn
@@ -240,6 +243,7 @@
 Name[gu]=ઓનલાઈન
 Name[he]=מחובר
 Name[hi]=ऑनलाइन
+Name[hne]=आनलाइन
 Name[is]=Tengd(ur)
 Name[it]=In linea
 Name[ja]=オンライン
@@ -306,6 +310,7 @@
 Comment[gu]=સંપર્ક હવે જોડાયેલ છે
 Comment[he]=איש הקשר מחובר כעת
 Comment[hi]=संपर्क जुड़ गया है
+Comment[hne]=संपर्क जुड़ गे हे
 Comment[hsb]=Kontakt je nětko nawjazany
 Comment[hu]=A partner csatlakozott (online állapotú)
 Comment[is]=Tengiliðurinn er tengdur núna
@@ -381,6 +386,7 @@
 Name[gu]=સંદેશો મળ્યો છે
 Name[he]=ההודעה התקבלה
 Name[hi]=संदेश प्राप्त
+Name[hne]=संदेस प्राप्त
 Name[hsb]=Powěsć dóstata
 Name[hu]=Üzenet érkezett
 Name[hy]=Հաղորդագրությունը ստացված է
@@ -454,6 +460,7 @@
 Comment[gu]=સંદેશો મેળવવામાં આવ્યો છે
 Comment[he]=ההודעה נשלחה
 Comment[hi]=संदेश प्राप्त हो गया है
+Comment[hne]=संदेस प्राप्त हो गे हे
 Comment[hsb]=Powěsć je so dóstała
 Comment[hu]=Üzenet érkezett
 Comment[is]=Tekið hefur verið á móti skilaboðum
Index: knotify/config/knotifyconfigactionswidget.cpp
===================================================================
--- knotify/config/knotifyconfigactionswidget.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ knotify/config/knotifyconfigactionswidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -103,7 +103,7 @@
 
 	config->writeEntry( "Sound" , m_ui.Sound_select->url().url() );
 	config->writeEntry( "Logfile" , m_ui.Logfile_select->url().url() );
-	config->writeEntry( "Execute" , m_ui.Execute_select->url().url() );
+	config->writeEntry( "Execute" , m_ui.Execute_select->url().path() );
 	switch(m_ui.KTTS_combo->currentIndex())
 	{
 		case 0:
Index: kate/plugins/kdatatool/ktexteditor_kdatatool.desktop
===================================================================
--- kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -39,6 +39,7 @@
 Name[gu]=માહિતી સાધનો
 Name[he]=כלי נתונים
 Name[hi]=डेटा औजार
+Name[hne]=डाटा औजार
 Name[hsb]=Datowe nastroje
 Name[hu]=Adatkezelő programok
 Name[is]=Gagnatól
@@ -64,7 +65,8 @@
 Name[pt]=Ferramentas de Dados
 Name[pt_BR]=Ferramentas de dados
 Name[ro]=Utilitare de date
-Name[ru]=Работа с данными
+Name[ru]=Обработка данных
+Name[se]=Dáhtareaiddut
 Name[sk]=Dátové nástroje
 Name[sl]=Podatkovna orodja
 Name[sr]=Алатке за податке
@@ -108,6 +110,7 @@
 Comment[gu]=થીસોરસ અને જોડણી ચકાસણી જેવા માહિતી સાધનો દાખલ કરો (જો સ્થાપિત હોય)
 Comment[he]=מאפשר שימוש בכלי נתונים כגון אגרון מילים ובודק איות (אם מותקנים כלים כאלה)
 Comment[hi]=डाटा औजार जैसे कि थिसॉरस और वर्तनी जांचक (यदि संस्थापित हैं) को सक्षम करें
+Comment[hne]=डाटा औजार जइसन कि थिसारस अउ हिज्जा जांचक (यदि इनस्टाल हे) ल सक्छम करव
 Comment[hr]=Omogućavanje alata poput tezaurusa i provjere pravopisa (ako su instalirani)
 Comment[hsb]=Staja graty kaž tezawrus abo prawopisnu kontrolu k dispoziciji (jeli instalowane)
 Comment[hu]=Adatkezelő eszközök (pl. szinonimaszótár, helyesírás-ellenőrző) támogatása
@@ -137,7 +140,7 @@
 Comment[pt]=Activa as ferramentas de dados como os sinónimos e a verificação ortográfica (se estiverem instalados)
 Comment[pt_BR]=Habilita ferramentas de dados, como dicionário de sinônimos e verificador ortográfico (se instalados)
 Comment[ro]=Activează utilitare de date precum dicționarul și verificarea ortografică (dacă sînt instalate)
-Comment[ru]=Расширения типа словаря и проверки орфографии (если они установлены)
+Comment[ru]=Обработка данных, например, показ синонимов и проверка орфографии (если они установлены)
 Comment[se]=Geavat diehtoreaidduid nugo synonymasátnelisttu ja čállindárkkisteami (jos leat sajáiduhttojuvvon)
 Comment[sk]=Podpora dátových nástrojov, ako je thesaurus a kontrola pravopisu (ak sú nainštalované)
 Comment[sl]=Omogoči orodja za podatke, kot so slovar sopomenk in preverjanje črkovanja (če so nameščena)
Index: kate/plugins/insertfile/ktexteditor_insertfile.desktop
===================================================================
--- kate/plugins/insertfile/ktexteditor_insertfile.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/plugins/insertfile/ktexteditor_insertfile.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -42,6 +42,7 @@
 Name[gu]=ફાઇલ ઉમેરો
 Name[he]=הוספת קובץ
 Name[hi]=फ़ाइल प्रविष्ट करें
+Name[hne]=फाइल घुसाव
 Name[hsb]=Dokument zasunyć
 Name[hu]=Fájl beszúrása
 Name[is]=Skjóta inn skrá
@@ -118,6 +119,7 @@
 Comment[gu]=કર્સર સ્થિતિ પર કોઇપણ વાંચી શકાય તેવી ફાઇલ દાખલ કરો
 Comment[he]=מוסיף כל קובץ הניתן לקריאה במיקום הסמן
 Comment[hi]=संकेतक के स्थान पर कोई भी पढ़ने योग्य फ़ाइल प्रविष्ट करें
+Comment[hne]=संकेतक के जगह फेर कोनो पढ़े जा सके फाइल घुसाव
 Comment[hr]=Na položaju pokazivača umetnite bilo koju čitljivu datoteku
 Comment[hsb]=Zasunje lubowólnu čitajomnu dataju na poziciji cursora
 Comment[hu]=Tetszőleges olvasható fájl beszúrása a kurzorpozíciónál
Index: kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop
===================================================================
--- kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -37,6 +37,7 @@
 Name[gu]=આપમેળેબુકમાર્ક કરનાર
 Name[he]=מוסיף סימניות אוטומטי
 Name[hi]=आटोबुकमार्कर
+Name[hne]=आटोबुकमार्कर
 Name[hsb]=Awtobookmarker
 Name[hu]=Automatikus könyvjelzők
 Name[is]=Sjálfvirkur bókamerkjari
@@ -109,6 +110,7 @@
 Comment[gu]=જ્યારે દસ્તાવેજ લાવવામાં આવે ત્યારે મેળ ખાતી લીટીઓ પર બુકમાર્કો ગોઠવો
 Comment[he]=מוסיף סימניות בשורות המתאימות לתבנית מסויימת בעת טעינת מסמך
 Comment[hi]=जब दस्तावेज लोड होते हैं तो पैटर्न से मिलते जुलते बुकमार्क लाइनों में सेट करें
+Comment[hne]=जब कागद लोड होथे तो पैटर्न से मिलत जुलत निसानी लाइन मन मं सेट करव
 Comment[hr]=Pri učitavanju dokumenta postavlja oznake na redovima koji odgovaraju određenom uzorku.
 Comment[hsb]=Staja při začitanju dokumenta znamjenja na linki, kiž wěstemu mustrej wotpowěduja.
 Comment[hu]=Fájl betöltésekor könyvjelzők automatikus létrehozása minta alapján
Index: kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop
===================================================================
--- kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -43,6 +43,7 @@
 Name[gu]=શબ્દ પૂર્તિ
 Name[he]=השלמת מילים אוטומטית
 Name[hi]=शब्द पूर्णता
+Name[hne]=सब्द पूरा करना
 Name[hsb]=Wudospołnjenje słowow
 Name[hu]=Szókiegészítő
 Name[is]=Klára orð
@@ -71,7 +72,7 @@
 Name[pt]=Completação de Palavras
 Name[pt_BR]=Complementação de palavras
 Name[ro]=Modul de completare cuvinte
-Name[ru]=Дополнение слов
+Name[ru]=Завершение слов
 Name[se]=Sátneollášuhttin
 Name[sk]=Dokončenie slova
 Name[sl]=Dopolnjevanje besed
@@ -117,6 +118,7 @@
 Comment[gu]=દસ્તાવેજમાં દિશાસૂચક અથવા પોપ-અપ આધારિત શબ્દોમાંથી પૂર્તિ
 Comment[he]=השלמת מילים כיווניות או מבוססת תפריט מוקפץ עבור מילים במסמך
 Comment[hi]=दस्तावेज़ में शब्दों को डायरेक्शनल या पॉपअप आधारित भरना
+Comment[hne]=कागद मं सब्द मन ल डायरेक्सनल या पापअप आधारित भरना
 Comment[hr]=Usmjereno ili pop-up zasnovano dovršavanje iz riječi u dokumentu
 Comment[hsb]=Direktionalne abo na pop-up bazowace wudospołnjowanje za słowa w dokumenće
 Comment[hu]=Irány szerinti vagy felbukkanó ablakos kiegészítés egy dokumentum szavai alapján
@@ -146,7 +148,7 @@
 Comment[pt]=Completação direccional ou por lista de palavras no documento
 Comment[pt_BR]=Complementação direcional ou baseada em popup, a partir de palavras do documento
 Comment[ro]=Propune completarea cuvintelor din document dintr-o listă popup sau direcțională
-Comment[ru]=Автодополнение слов в документе
+Comment[ru]=Автозавершение слов в документе
 Comment[sk]=Dopĺňanie slov v dokumente priame alebo pomocou dialógu
 Comment[sl]=Neposredno ali pojavno dopolnjevanje iz besed v dokumentu
 Comment[sr]=Дирекционо или искачуће допуњавање према речима из документа
Index: kate/plugins/wordcompletion/ktexteditor_docwordcompletion_config.desktop
===================================================================
--- kate/plugins/wordcompletion/ktexteditor_docwordcompletion_config.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/plugins/wordcompletion/ktexteditor_docwordcompletion_config.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -36,6 +36,7 @@
 Name[gu]=વર્તણૂક
 Name[he]=פעולה
 Name[hi]=बर्ताव
+Name[hne]=बर्ताव
 Name[hsb]=Zadźerženje
 Name[hu]=Működés
 Name[is]=Hegðun
Index: kate/plugins/pythonencoding/ktexteditor_python-encoding.desktop
===================================================================
--- kate/plugins/pythonencoding/ktexteditor_python-encoding.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/plugins/pythonencoding/ktexteditor_python-encoding.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -18,6 +18,7 @@
 Name[gl]=Comprobador/Adicionador da codificación para Python
 Name[gu]=પાયથોન એનકોડિંગ ચકાસનાર/ઉમેરનાર
 Name[he]=בודק/מוסיף קידוד Python 
+Name[hne]=पायथन एनकोडिंग जंचइया/जोड़इया
 Name[hu]=Python kódolásellenőrző
 Name[is]=Python kóðaprófun/línuendingar
 Name[it]=Controllo/aggiunta codifica per Python
@@ -39,7 +40,8 @@
 Name[pt]=Verificação/adição da codificação em Python
 Name[pt_BR]=Verificação/adição da codificação em Python
 Name[ro]=Verificator/adăugător de codări Python 
-Name[ru]=Поддержка кодировки для Python
+Name[ru]=Проверка кодировки исходного кода на Python
+Name[se]=Pythonkodera iskkadeaddji/lasideaddji
 Name[sk]=Python manažér kódovania
 Name[sr]=Оверивач и додавач кодирања у питону
 Name[sr@latin]=Overivač i dodavač kodiranja u Pythonu
@@ -69,6 +71,7 @@
 Comment[gl]=Comproba a codificación ao gardar ficheiros python e engade unha liña de codificación
 Comment[gu]=પાયથોન ફાઇલો સંગ્રહ કરતી વખતે એનકોડિંગ ચકાસો અને એનકોડિંગ વાક્ય ઉમેરો
 Comment[he]=בעת שמירה בדוק את הקידוד של קבצי פייתון והוסף שורת קידוד
+Comment[hne]=पायथन फाइल के एनकोडिंग जांचे अऊ एनकोडिंग लाइन जोड़े के बेरा में
 Comment[hsb]=Přepruwuje koděrowanje python-datajow a doda linku z informaciju wo koděrowanju
 Comment[hu]=Mentéskor ellenőrzi vagy létrehozza a kódolást megadó sort
 Comment[is]=Þegar python skrár eru vistaðar er farið yfir kóðann og bætt við endalínum
@@ -91,7 +94,8 @@
 Comment[pt]=Ao gravar, verifica a codificação dos ficheiros em Python e adiciona uma linha de codificação
 Comment[pt_BR]=Ao salvar, verifica a codificação dos arquivos em python e adiciona uma linha de codificação
 Comment[ro]=Verifică codarea fișierelor python în timpul salvării și adaugă o linie de codare
-Comment[ru]=Добавление строки с кодировкой при записи файлов с кодом Python
+Comment[ru]=Проверка кодировки при сохранении файла исходного кода на Python и вставка кодировки в текст
+Comment[se]=Vurkedettiin pythonfiillaid, iskka kodema ja lasit kodenlinnjá
 Comment[sk]=Pri ukladaní kontroluje kódovanie pythonových súborov a pridáva záznam o kódovaní
 Comment[sl]=Med shranjevanje datotek pythona preveri kodiranje in doda kodno vrstico
 Comment[sr]=При уписивању питонских фајлова, проверава и додаје ред о кодирању
Index: kate/plugins/timedate/ktexteditor_timedate_config.desktop
===================================================================
--- kate/plugins/timedate/ktexteditor_timedate_config.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/plugins/timedate/ktexteditor_timedate_config.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
 Name[gu]=સમય & તારીખ ઉમેરાનું બંધારણ
 Name[he]=הגדרות תבנית התאריך והשעה המוספים
 Name[hi]=समय व तिथि भरने का फ़ॉर्मेट
+Name[hne]=समय व तारीक भरे के फारमेट
 Name[hsb]=Format časa a datuma, kiž so zasunjetej
 Name[hu]=A beszúrt dátum és idő formátuma
 Name[is]=Snið innskotins tíma- og dagsetningar
Index: kate/plugins/timedate/ktexteditor_timedate.desktop
===================================================================
--- kate/plugins/timedate/ktexteditor_timedate.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/plugins/timedate/ktexteditor_timedate.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -43,6 +43,7 @@
 Name[gu]=સમય & તારીખ
 Name[he]=תאריך ושעה
 Name[hi]=समय व तिथि
+Name[hne]=समय व तारीक
 Name[hsb]=Čas a datum
 Name[hu]=Dátum és idő
 Name[hy]=Ժամ և Ամսաթիվ
@@ -116,11 +117,12 @@
 Comment[gu]=હાલનો સમય & તારીખ ઉમેરો
 Comment[he]=הוספת התאריך והשעה הנוכחיים
 Comment[hi]=वर्तमान समय व तिथि प्रविष्ट करें
+Comment[hne]=अभी हाल के समय व तारीक घुसाव
 Comment[hsb]=Zasunje aktualny čas a datum
 Comment[hu]=Az aktuális dátum és idő beszúrása
 Comment[hy]=Մտցրեք ընթացիք Ժամը և Ամսաթիվը
 Comment[is]=Setja inn núverandi tíma- og dagsetningu
-Comment[it]=Inserisce la data e ora correnti
+Comment[it]=Inserisce la data e ora attuali
 Comment[ja]=現在の日付と時間を挿入
 Comment[kk]=Уақыт пен күн белгісін қою
 Comment[km]=បញ្ចូល​ពេលវេលា និង​កាលបរិច្ឆេទ​បច្ចុប្បន្ន
Index: kate/vimode/katevinormalmode.cpp
===================================================================
--- kate/vimode/katevinormalmode.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/vimode/katevinormalmode.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -471,167 +471,6 @@
   return false;
 }
 
-KateViRange KateViNormalMode::motionWordForward()
-{
-  KTextEditor::Cursor c( m_view->cursorPosition() );
-  KateViRange r( c.line(), c.column(), ViMotion::ExclusiveMotion );
-
-  // Special case: If we're already on the very last character in the document, the motion should be
-  // inclusive so the last character gets included
-  if ( c.line() == m_doc->lines()-1 && c.column() == m_doc->lineLength( c.line() )-1 ) {
-    r.motionType = ViMotion::InclusiveMotion;
-  } else {
-    for ( unsigned int i = 0; i < getCount(); i++ ) {
-      c = findNextWordStart( c.line(), c.column() );
-
-      // stop when at the last char in the document
-      if ( c.line() == m_doc->lines()-1 && c.column() == m_doc->lineLength( c.line() )-1 ) {
-        // if we still haven't "used up the count", make the motion inclusive, so that the last char
-        // is included
-        if ( i < getCount() ) {
-          r.motionType = ViMotion::InclusiveMotion;
-        }
-        break;
-      }
-    }
-  }
-
-  r.endColumn = c.column();
-  r.endLine = c.line();
-
-  return r;
-}
-
-KateViRange KateViNormalMode::motionWordBackward()
-{
-  KTextEditor::Cursor c( m_view->cursorPosition() );
-  KateViRange r( c.line(), c.column(), ViMotion::ExclusiveMotion );
-
-  for ( unsigned int i = 0; i < getCount(); i++ ) {
-    c = findPrevWordStart( c.line(), c.column() );
-
-    // stop when at the first char in the document
-    if ( c.line() == 0 && c.column() == 0 ) {
-      break;
-    }
-  }
-
-  r.endColumn = c.column();
-  r.endLine = c.line();
-
-  return r;
-}
-
-KateViRange KateViNormalMode::motionWORDForward()
-{
-  KTextEditor::Cursor c( m_view->cursorPosition() );
-  KateViRange r( c.line(), c.column(), ViMotion::ExclusiveMotion );
-
-  for ( unsigned int i = 0; i < getCount(); i++ ) {
-    c = findNextWORDStart( c.line(), c.column() );
-
-    // stop when at the last char in the document
-    if ( c.line() == m_doc->lines()-1 && c.column() == m_doc->lineLength( c.line() )-1 ) {
-      break;
-    }
-  }
-
-  r.endColumn = c.column();
-  r.endLine = c.line();
-
-  return r;
-}
-
-KateViRange KateViNormalMode::motionWORDBackward()
-{
-  KTextEditor::Cursor c( m_view->cursorPosition() );
-  KateViRange r( c.line(), c.column(), ViMotion::ExclusiveMotion );
-
-  for ( unsigned int i = 0; i < getCount(); i++ ) {
-    c = findPrevWORDStart( c.line(), c.column() );
-
-    // stop when at the first char in the document
-    if ( c.line() == 0 && c.column() == 0 ) {
-      break;
-    }
-  }
-
-  r.endColumn = c.column();
-  r.endLine = c.line();
-
-  return r;
-}
-
-KateViRange KateViNormalMode::motionToEndOfWord()
-{
-    KTextEditor::Cursor c( m_view->cursorPosition() );
-    KateViRange r( c.line(), c.column(), ViMotion::InclusiveMotion );
-
-    for ( unsigned int i = 0; i < getCount(); i++ ) {
-        c = findWordEnd( c.line(), c.column() );
-    }
-
-    r.endColumn = c.column();
-    r.endLine = c.line();
-
-    return r;
-}
-
-KateViRange KateViNormalMode::motionToEndOfWORD()
-{
-    KTextEditor::Cursor c( m_view->cursorPosition() );
-    KateViRange r( c.line(), c.column(), ViMotion::InclusiveMotion );
-
-    for ( unsigned int i = 0; i < getCount(); i++ ) {
-        c = findWORDEnd( c.line(), c.column() );
-    }
-
-    r.endColumn = c.column();
-    r.endLine = c.line();
-
-    return r;
-}
-
-KateViRange KateViNormalMode::motionToEndOfPrevWord()
-{
-    KTextEditor::Cursor c( m_view->cursorPosition() );
-    KateViRange r( c.line(), c.column(), ViMotion::InclusiveMotion );
-
-    for ( unsigned int i = 0; i < getCount(); i++ ) {
-      c = findPrevWordEnd( c.line(), c.column() );
-
-      // stop when at the first char in the document
-      if ( c.line() == 0 && c.column() == 0 ) {
-        break;
-      }
-    }
-
-    r.endColumn = c.column();
-    r.endLine = c.line();
-
-    return r;
-}
-
-KateViRange KateViNormalMode::motionToEndOfPrevWORD()
-{
-    KTextEditor::Cursor c( m_view->cursorPosition() );
-    KateViRange r( c.line(), c.column(), ViMotion::InclusiveMotion );
-
-    for ( unsigned int i = 0; i < getCount(); i++ ) {
-      c = findPrevWORDEnd( c.line(), c.column() );
-
-      // stop when at the first char in the document
-      if ( c.line() == 0 && c.column() == 0 ) {
-        break;
-      }
-    }
-
-    r.endColumn = c.column();
-    r.endLine = c.line();
-
-    return r;
-}
-
 bool KateViNormalMode::commandDeleteLine()
 {
   KTextEditor::Cursor c( m_view->cursorPosition() );
@@ -1392,6 +1231,183 @@
   return r;
 }
 
+KateViRange KateViNormalMode::motionWordForward()
+{
+  KTextEditor::Cursor c( m_view->cursorPosition() );
+  KateViRange r( c.line(), c.column(), ViMotion::ExclusiveMotion );
+
+  m_stickyColumn = -1;
+
+  // Special case: If we're already on the very last character in the document, the motion should be
+  // inclusive so the last character gets included
+  if ( c.line() == m_doc->lines()-1 && c.column() == m_doc->lineLength( c.line() )-1 ) {
+    r.motionType = ViMotion::InclusiveMotion;
+  } else {
+    for ( unsigned int i = 0; i < getCount(); i++ ) {
+      c = findNextWordStart( c.line(), c.column() );
+
+      // stop when at the last char in the document
+      if ( c.line() == m_doc->lines()-1 && c.column() == m_doc->lineLength( c.line() )-1 ) {
+        // if we still haven't "used up the count", make the motion inclusive, so that the last char
+        // is included
+        if ( i < getCount() ) {
+          r.motionType = ViMotion::InclusiveMotion;
+        }
+        break;
+      }
+    }
+  }
+
+  r.endColumn = c.column();
+  r.endLine = c.line();
+
+  return r;
+}
+
+KateViRange KateViNormalMode::motionWordBackward()
+{
+  KTextEditor::Cursor c( m_view->cursorPosition() );
+  KateViRange r( c.line(), c.column(), ViMotion::ExclusiveMotion );
+
+  m_stickyColumn = -1;
+
+  for ( unsigned int i = 0; i < getCount(); i++ ) {
+    c = findPrevWordStart( c.line(), c.column() );
+
+    // stop when at the first char in the document
+    if ( c.line() == 0 && c.column() == 0 ) {
+      break;
+    }
+  }
+
+  r.endColumn = c.column();
+  r.endLine = c.line();
+
+  return r;
+}
+
+KateViRange KateViNormalMode::motionWORDForward()
+{
+  KTextEditor::Cursor c( m_view->cursorPosition() );
+  KateViRange r( c.line(), c.column(), ViMotion::ExclusiveMotion );
+
+  m_stickyColumn = -1;
+
+  for ( unsigned int i = 0; i < getCount(); i++ ) {
+    c = findNextWORDStart( c.line(), c.column() );
+
+    // stop when at the last char in the document
+    if ( c.line() == m_doc->lines()-1 && c.column() == m_doc->lineLength( c.line() )-1 ) {
+      break;
+    }
+  }
+
+  r.endColumn = c.column();
+  r.endLine = c.line();
+
+  return r;
+}
+
+KateViRange KateViNormalMode::motionWORDBackward()
+{
+  KTextEditor::Cursor c( m_view->cursorPosition() );
+  KateViRange r( c.line(), c.column(), ViMotion::ExclusiveMotion );
+
+  m_stickyColumn = -1;
+
+  for ( unsigned int i = 0; i < getCount(); i++ ) {
+    c = findPrevWORDStart( c.line(), c.column() );
+
+    // stop when at the first char in the document
+    if ( c.line() == 0 && c.column() == 0 ) {
+      break;
+    }
+  }
+
+  r.endColumn = c.column();
+  r.endLine = c.line();
+
+  return r;
+}
+
+KateViRange KateViNormalMode::motionToEndOfWord()
+{
+    KTextEditor::Cursor c( m_view->cursorPosition() );
+    KateViRange r( c.line(), c.column(), ViMotion::InclusiveMotion );
+
+    m_stickyColumn = -1;
+
+    for ( unsigned int i = 0; i < getCount(); i++ ) {
+        c = findWordEnd( c.line(), c.column() );
+    }
+
+    r.endColumn = c.column();
+    r.endLine = c.line();
+
+    return r;
+}
+
+KateViRange KateViNormalMode::motionToEndOfWORD()
+{
+    KTextEditor::Cursor c( m_view->cursorPosition() );
+    KateViRange r( c.line(), c.column(), ViMotion::InclusiveMotion );
+
+    m_stickyColumn = -1;
+
+    for ( unsigned int i = 0; i < getCount(); i++ ) {
+        c = findWORDEnd( c.line(), c.column() );
+    }
+
+    r.endColumn = c.column();
+    r.endLine = c.line();
+
+    return r;
+}
+
+KateViRange KateViNormalMode::motionToEndOfPrevWord()
+{
+    KTextEditor::Cursor c( m_view->cursorPosition() );
+    KateViRange r( c.line(), c.column(), ViMotion::InclusiveMotion );
+
+    m_stickyColumn = -1;
+
+    for ( unsigned int i = 0; i < getCount(); i++ ) {
+      c = findPrevWordEnd( c.line(), c.column() );
+
+      // stop when at the first char in the document
+      if ( c.line() == 0 && c.column() == 0 ) {
+        break;
+      }
+    }
+
+    r.endColumn = c.column();
+    r.endLine = c.line();
+
+    return r;
+}
+
+KateViRange KateViNormalMode::motionToEndOfPrevWORD()
+{
+    KTextEditor::Cursor c( m_view->cursorPosition() );
+    KateViRange r( c.line(), c.column(), ViMotion::InclusiveMotion );
+
+    m_stickyColumn = -1;
+
+    for ( unsigned int i = 0; i < getCount(); i++ ) {
+      c = findPrevWORDEnd( c.line(), c.column() );
+
+      // stop when at the first char in the document
+      if ( c.line() == 0 && c.column() == 0 ) {
+        break;
+      }
+    }
+
+    r.endColumn = c.column();
+    r.endLine = c.line();
+
+    return r;
+}
+
 KateViRange KateViNormalMode::motionToEOL()
 {
   m_stickyColumn = -1;
@@ -1428,6 +1444,8 @@
   KTextEditor::Cursor cursor ( m_view->cursorPosition() );
   QString line = getLine();
 
+  m_stickyColumn = -1;
+
   int matchColumn = cursor.column();
 
   for ( unsigned int i = 0; i < getCount(); i++ ) {
@@ -1451,6 +1469,8 @@
   KTextEditor::Cursor cursor ( m_view->cursorPosition() );
   QString line = getLine();
 
+  m_stickyColumn = -1;
+
   int matchColumn = -1;
 
   unsigned int hits = 0;
@@ -1479,6 +1499,8 @@
   KTextEditor::Cursor cursor ( m_view->cursorPosition() );
   QString line = getLine();
 
+  m_stickyColumn = -1;
+
   int matchColumn = cursor.column()+1;
 
   for ( unsigned int i = 0; i < getCount(); i++ ) {
@@ -1500,6 +1522,8 @@
   KTextEditor::Cursor cursor ( m_view->cursorPosition() );
   QString line = getLine();
 
+  m_stickyColumn = -1;
+
   int matchColumn = -1;
 
   unsigned int hits = 0;
@@ -1573,6 +1597,8 @@
 {
   KateViRange r;
 
+  m_stickyColumn = -1;
+
   QChar reg = m_keys.at( m_keys.size()-1 );
 
   // ` and ' is the same register (position before jump)
@@ -1600,6 +1626,8 @@
   KateViRange r = motionToMark();
   r.endColumn = 0; // FIXME: should be first non-blank on line
 
+  m_stickyColumn = -1;
+
   r.jump = true;
 
   return r;
@@ -1614,6 +1642,8 @@
   int n1 = l.indexOf( m_matchItemRegex, c.column() );
   int n2;
 
+  m_stickyColumn = -1;
+
   if ( n1 == -1 ) {
     r.valid = false;
     return r;
@@ -1717,6 +1747,8 @@
 {
   KateViRange r;
 
+  m_stickyColumn = -1;
+
   int line = findLineStartingWitchChar( '{', getCount() );
 
   if ( line == -1 ) {
@@ -1735,6 +1767,8 @@
 {
   KateViRange r;
 
+  m_stickyColumn = -1;
+
   int line = findLineStartingWitchChar( '{', getCount(), false );
 
   if ( line == -1 ) {
@@ -1753,6 +1787,8 @@
 {
   KateViRange r;
 
+  m_stickyColumn = -1;
+
   int line = findLineStartingWitchChar( '}', getCount() );
 
   if ( line == -1 ) {
@@ -1771,6 +1807,8 @@
 {
   KateViRange r;
 
+  m_stickyColumn = -1;
+
   int line = findLineStartingWitchChar( '{', getCount(), false );
 
   if ( line == -1 ) {
Index: kate/syntax/data/lilypond.xml
===================================================================
--- kate/syntax/data/lilypond.xml	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/syntax/data/lilypond.xml	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -8,7 +8,7 @@
   <!ENTITY scripts "\d+|accent|marcato|staccat(issim)?o|espressivo|tenuto|portato|(up|down)(bow|mordent|prall)|flageolet|thumb|[lr](heel|toe)|open|stopped|turn|reverseturn|trill|mordent|prall(prall|mordent|down|up)?|lineprall|signumcongruentiae|(short|long|verylong)?fermata|segno|(var)?coda">
   <!ENTITY keywords "accepts|alias|consists|defaultchild|denies|description|grobdescriptions|include|invalid|name|objectid|once|remove|sequential|simultaneous|type|version|score|book|bookpart">
   <!ENTITY deprecatedkeywords "consistsend">
-  <!ENTITY commands "acciaccatura|addQuote|afterGrace|aikenHeads|allowPageTurn|alternative|apply(Context|Music|Output)|appoggiatura|arpeggio(Arrow(Down|Up)|Bracket|Normal|Parenthesis)?|(a|de)scendens|auctum|augmentum|autoBeamO(ff|n)|autochange|balloon(Grob)?Text|bar|barNumberCheck|bendAfter|breathe|break|cadenzaO(ff|n)|cavum|clef(\s+(treble|violin|G|alto|C|(sub)?bass|F|french|(mezzo)?soprano|(var)?baritone|percussion|tab))?|(end)?(de)?cr|cresc(TextCresc|Hairpin)|(cue|transposedCue)During|default|deminutum|dim(Text(Decresc|Decr|Dim)|Hairpin)|display(Lily)?Music|divisio(Maior|Maxima|Minima)|(dynamic|dots|phrasingSlur|slur|stem|tie|tuplet)(Down|Neutral|Up)|(balloon|text)LengthO(ff|n)|featherDurations|figure(mode|s)|finalis|flexa|(french|german|italian|semiGerman)Chords|glissando|grace|harmonic|(unH|h)ideNotes|(hide|show)StaffSwitch|inclinatum|(keep|remove)WithTag|key(\s+&pitch;)?|killCues|label|laissezVibrer|linea|mark|maxima|melisma(End)?|newSpacingSection|no(Beam|Break|PageBreak|PageTurn)|normalsize|octaveCheck|oneVoice|oriscus|ottava|page(-ref|Break|Turn)|parallelMusic|parenthesize|partcombine|partial(\s*&duration;)?|pes|pitchedTrill|pointAndClickO(ff|n)|quilisma|quoteDuring|relative(\s+&pitch;)?|RemoveEmptyStaffContext|repeat(\s+(unfold|volta|tremolo|percent)(\s+\d+)?)?|repeatTie|resetRelativeOctave|rest|sacredHarpHeads|scaleDurations|scoreTweak|easyHeadsO(ff|n)|shift(Durations|Off|On{1,3})|(slur|tie)(Both|Dashed|Dotted|Solid)|small|spacingTweaks|(start|stop)(Group|(Text|Trill)Span|Staff)|stemBoth|stropha|super|(sustain|sostenuto)O(ff|n)|table-of-contents|tag|times?(\s*\d+/\d+)?|tiny|tocItem|transpose(\s+&pitch;\s*&pitch;)?|transposition(\s+&pitch;)|tweak|unfoldRepeats|virg(ul)?a|voice(One|Two|Three|Four)|withMusicProperty|cm|mm|in|pt|major|minor|ionian|locrian|aeolian|mixolydian|lydian|phrygian|dorian">
+  <!ENTITY commands "acciaccatura|addQuote|afterGrace|aikenHeads|allowPageTurn|alternative|apply(Context|Music|Output)|appoggiatura|arpeggio(Arrow(Down|Up)|Bracket|Normal|Parenthesis)?|(a|de)scendens|auctum|augmentum|autoBeamO(ff|n)|autochange|balloon(Grob)?Text|bar|barNumberCheck|bendAfter|breathe|break|cadenzaO(ff|n)|cavum|clef(\s+(treble|violin|G|alto|C|(sub)?bass|F|french|(mezzo)?soprano|(var)?baritone|percussion|tab))?|(end)?(de)?cr|cresc(TextCresc|Hairpin)|(cue|transposedCue)During|default|deminutum|dim(Text(Decresc|Decr|Dim)|Hairpin)|display(Lily)?Music|divisio(Maior|Maxima|Minima)|(dynamic|dots|phrasingSlur|slur|stem|tie|tuplet)(Down|Neutral|Up)|(balloon|text)LengthO(ff|n)|featherDurations|figure(mode|s)|finalis|flexa|(french|german|italian|semiGerman)Chords|glissando|grace|harmonic|(unH|h)ideNotes|(hide|show)StaffSwitch|inclinatum|(keep|remove)WithTag|key(\s+&pitch;)?|killCues|label|laissezVibrer|linea|mark|maxima|melisma(End)?|newSpacingSection|no(Beam|Break|PageBreak|PageTurn)|normalsize|numericTimeSignature|octaveCheck|oneVoice|oriscus|ottava|page(-ref|Break|Turn)|parallelMusic|parenthesize|partcombine|partial(\s*&duration;)?|pes|pitchedTrill|pointAndClickO(ff|n)|quilisma|quoteDuring|relative(\s+&pitch;)?|RemoveEmptyStaffContext|repeat(\s+(unfold|volta|tremolo|percent)(\s+\d+)?)?|repeatTie|resetRelativeOctave|rest|sacredHarpHeads|scaleDurations|scoreTweak|easyHeadsO(ff|n)|shift(Durations|Off|On{1,3})|(slur|tie)(Both|Dashed|Dotted|Solid)|small|spacingTweaks|(start|stop)(Group|(Text|Trill)Span|Staff)|stemBoth|stropha|super|(sustain|sostenuto)O(ff|n)|table-of-contents|tag|times?(\s*\d+/\d+)?|tiny|tocItem|transpose(\s+&pitch;\s*&pitch;)?|transposition(\s+&pitch;)|tweak|unfoldRepeats|virg(ul)?a|voice(One|Two|Three|Four)|withMusicProperty|cm|mm|in|pt|major|minor|ionian|locrian|aeolian|mixolydian|lydian|phrygian|dorian">
   <!ENTITY deprecatedcommands "arpeggio(Up|Down|Neutral)|newpage|script(Up|Down|Both)|(empty|fat)Text|setEasyHeads|(default|voice|modernVoice|piano|forget)Accidentals|(modern(Voice)?|piano)Cautionaries|noResetKey|compressMusic|octave|(sustain|sostenuto)(Down|Up)|set(Hairpin|Text)(Cresc|Decresc|Dim)|setTextDecr">
   <!ENTITY markupnotextargs "arrow-head|beam|char|(semi|sesqui|double)?(flat|sharp)|draw-(circle|line)|epsfile|filled-box|fret-diagram(-terse|-verbose)?|fromproperty|harp-pedal|(justify|wordwrap)-(field|string)|lookup|markalphabet|markletter|musicglyph|natural|note-by-number|note|null|simple|(back)?slashed-digit|stencil|strut|tied-lyric|triangle|verbatim-file">
   <!ENTITY markupwithtextargs "markup|bold|(rounded-)?box|bracket|caps|(center|general|left|right)-align|circle|((center|dir|left|right)-)?column|combine|concat|dynamic|fill-line|finger|fontCaps|(abs-)?fontsize|fraction|halign|hbracket|hcenter-in|hcenter|hspace|huge|italic|justify|larger?|line|lower|magnify|medium|normal-size-(sub|super)|normal-text|normalsize|number|on-the-fly|override|pad-(around|markup|to-box|x)|page-ref|postscript|put-adjacent|raise|roman|rotate|sans|small(er)?|smallCaps|sub|super|teeny|text|tiny|translate(-scaled)?|transparent|typewriter|underline|upright|vcenter|whiteout|with-(color|dimensions|url)|wordwrap|(markup|column-|justified-|override-|wordwrap-)lines|wordwrap-(string-)?internal">
@@ -24,7 +24,7 @@
   <!ENTITY schemename "[a-zA-Z#][^\s(){}[\];$&quot;]*">
   <!ENTITY schemefunc "\b(define|defined\?|define\*(-public)?|define-(\*|builtin-markup-(list-)?command|class|(extra-)?display-method|fonts?|grob-property|ly-syntax(-loc|-simple)?|macro(-public)?|markup-(list-)command|method|module|music-function|post-event-display-method|public(-macro|-toplevel)?|safe-public|span-event-display-method)|defmacro(\*(-public)?)?|lambda\*?|and|or|if|cond|case|let\*?|letrec|begin|do|delay|set!|else|(quasi)?quote|unquote(-splicing)?|(define|let|letrec)-syntax|syntax-rules|not|boolean\?|eq\?|eqv\?|equal\?|pair\?|cons|set-c[ad]r!|c[ad]{1,4}r|null\?|list\?|list|length|append|reverse|list-ref|mem[qv]|member|ass[qv]|assoc|symbol\?|symbol-&gt;string|string-&gt;symbol|number\?|complex\?|real\?|rational\?|integer\?|exact\?|inexact\?|zero\?|positive\?|negative\?|odd\?|even\?|max|min|abs|quotient|remainder|modulo|gcd|lcm|numerator|denominator|floor|ceiling|truncate|round|rationalize|exp|log|sin|cos|tan|asin|acos|atan|sqrt|expt|make-rectangular|make-polar|real-part|imag-part|magnitude|angle|exact-&gt;inexact|inexact-&gt;exact|number-&gt;string|string-&gt;number|char((-ci)?(=\?|&lt;\?|&gt;\?|&lt;=\?|&gt;=\?)|-alphabetic\?|\?|-numeric\?|-whitespace\?|-upper-case\?|-lower-case\?|-&gt;integer|-upcase|-downcase|-ready\?)|integer-&gt;char|make-string|string(\?|-copy|-fill!|-length|-ref|-set!|(-ci)?(=\?|&lt;\?|&gt;\?|&lt;=\?|&gt;=\?)|-append)|substring|make-vector|vector(\?|-length|-ref|-set!|-fill!)?|procedure\?|apply|map|for-each|force|call-with-(current-continuation|(in|out)put-file)|(in|out)put-port\?|current-(in|out)put-port|open-(in|out)put-file|close-(in|out)put-port|eof-object\?|read|(read|peek)-char|write(-char)?|display|newline|call/cc|list-tail|string-&gt;list|list-&gt;string|vector-&gt;list|list-&gt;vector|with-input-from-file|with-output-to-file|load|transcript-(on|off)|eval|dynamic-wind|port\?|values|call-with-values|(scheme-report-|null-|interaction-)environment)(?=($|\s|\)))">
 ]>
-<language name="LilyPond" section="Other" style="lilypond" version="3.01" kateversion="3.0" extensions="*.ly;*.LY;*.ily;*.ILY;*.lyi;*.LYI" mimetype="text/x-lilypond" author="Wilbert Berendsen (info@wilbertberendsen.nl)" license="LGPL">
+<language name="LilyPond" section="Other" style="lilypond" version="3.02" kateversion="3.0" extensions="*.ly;*.LY;*.ily;*.ILY;*.lyi;*.LYI" mimetype="text/x-lilypond" author="Wilbert Berendsen (info@wilbertberendsen.nl)" license="LGPL">
 
   <!--
     
Index: kate/syntax/data/debianchangelog.xml
===================================================================
--- kate/syntax/data/debianchangelog.xml	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/syntax/data/debianchangelog.xml	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -53,12 +53,18 @@
             <item>hardy-updates</item>
             <item>hardy-backports</item>
             <item>hardy-partner</item>
-            <item>ibex</item>
-            <item>ibex-security</item>
-            <item>ibex-proposed</item>
-            <item>ibex-updates</item>
-            <item>ibex-backports</item>
-            <item>ibex-partner</item>
+            <item>intrepid</item>
+            <item>intrepid-security</item>
+            <item>intrepid-proposed</item>
+            <item>intrepid-updates</item>
+            <item>intrepid-backports</item>
+            <item>intrepid-partner</item>
+            <item>jaunty</item>
+            <item>jaunty-security</item>
+            <item>jaunty-proposed</item>
+            <item>jaunty-updates</item>
+            <item>jaunty-backports</item>
+            <item>jaunty-partner</item>
         </list>
 
         <list name="urgencies">
Index: kate/syntax/data/latex.xml
===================================================================
--- kate/syntax/data/latex.xml	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/syntax/data/latex.xml	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -1,20 +1,25 @@
-<?xml version="1.01" encoding="UTF-8"?>
+<?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="LaTeX" version="1.30" section="Markup" kateversion="2.3" priority="10" extensions="*.tex; *.ltx; *.dtx; *.sty; *.cls;" mimetype="text/x-tex" casesensitive="1" author="Jeroen Wijnhout (Jeroen.Wijnhout@kdemail.net)+Holger Danielsson (holger.danielsson@versanet.de)+Michel Ludwig (michel.ludwig@kdemail.net)+Thomas Braun (braun@physik.fu-berlin.de)" license="LGPL" >
+	  <language name="LaTeX" version="1.31" section="Markup" kateversion="2.3" priority="10" extensions="*.tex; *.ltx; *.dtx; *.sty; *.cls;" mimetype="text/x-tex" casesensitive="1" author="Jeroen Wijnhout (Jeroen.Wijnhout@kdemail.net)+Holger Danielsson (holger.danielsson@versanet.de)+Michel Ludwig (michel.ludwig@kdemail.net)+Thomas Braun (braun@physik.fu-berlin.de)" license="LGPL" >
   <highlighting>
     <contexts>
       <!-- Normal text -->
       <context name="Normal Text" attribute="Normal Text" lineEndContext="#stay">
         <RegExpr String="\\begin(?=[^a-zA-Z])" attribute="Structure" context="FindEnvironment" beginRegion="block" />
         <RegExpr String="\\end(?=[^a-zA-Z])" attribute="Structure" context="FindEnvironment" endRegion="block" />
-        <RegExpr String="\\(label|pageref|autoref|ref|vpageref|vref|cite)(?=[^a-zA-Z])" attribute="Structure" context="Label"/>
+	<RegExpr String="\\(cite|parencite|autocite|Autocite|citetitle)\*(?=[^a-zA-Z])" attribute="Structure" context="Label"/>
+	<RegExpr String="\\(cites|Cites|parencites|Parencites|autocites|Autocites|supercites|footcites|Footcites)(?=[^a-zA-Z])" attribute="Structure" context="FancyLabel"/>
+	<RegExpr String="\\(cite|nocite|Cite|parencite|Parencite|footcite|Footcite|textcite|Textcite|supercite|autocite|Autocite|citeauthor|Citeauthor|citetitle|citeyear|citeurl|nocite|fullcite|footfullcite)(?=[^a-zA-Z])" attribute="Structure" context="Label"/>
+	<RegExpr String="\\(subref\*?|cref\*?|label|pageref|autoref|ref|vpageref|vref|pagecite)(?=[^a-zA-Z])" attribute="Structure" context="Label"/>
         <RegExpr String="\\(part|chapter|section|subsection|subsubsection|paragraph|subparagraph)\*?\s*(?=[\{\[])" attribute="Structure" context="Sectioning"/>
         <RegExpr String="\\(footnote)\*?\s*(?=[\{\[])" attribute="Footnote" context="Footnoting"/>
-        <RegExpr String="\\(re)?newcommand(?=[^a-zA-Z])" attribute="Keyword" context="NewCommand"/>
+	<RegExpr String="\\(renewcommand|providenewcommand|newcommand)\*?(?=[^a-zA-Z])" attribute="Keyword" context="NewCommand"/>
         <RegExpr String="\\(e|g|x)?def(?=[^a-zA-Z])" attribute="Keyword" context="DefCommand"/>
 	<RegExpr String="&lt;&lt;.*&gt;&gt;=" attribute="Normal Text" context="NoWeb" />
         <StringDetect String="\(" attribute="Math" context="MathMode" beginRegion="mathMode" />
         <StringDetect String="\[" attribute="Math" context="MathModeEquation" beginRegion="mathMode" />
+	<StringDetect String="\iffalse" attribute="Comment" context="Multiline Comment"/>
+	<StringDetect String="\ensuremath{" attribute="Math" context="MathModeEnsure"/>
         <DetectChar char="\" attribute="Keyword" context="ContrSeq"/>
         <StringDetect String="$$" attribute="Math" context="MathModeDisplay" beginRegion="mathMode" />
         <DetectChar char="$" attribute="Math" context="MathMode" beginRegion="mathMode" />
@@ -134,7 +139,7 @@
         <StringDetect String="verb*" attribute="Keyword" context="Verb"/>
         <RegExpr String="verb(?=[^a-zA-Z])" attribute="Keyword" context="Verb"/>
         <DetectChar char="&#xd7;" attribute="Bullet" context="#stay"/>
-        <RegExpr String="[a-zA-Z]+(\+?|\*{0,3})" attribute="Keyword" context="#pop"/>
+        <RegExpr String="[a-zA-Z@]+(\+?|\*{0,3})" attribute="Keyword" context="#pop"/>
         <RegExpr String="[^a-zA-Z]" attribute="Keyword" context="#pop" />
       </context>
       <context name="ToEndOfLine" attribute="Normal Text" lineEndContext="#pop">
@@ -171,6 +176,27 @@
         <RegExpr String="\s*\}\s*" attribute="Normal Text" context="#pop#pop"/>
       </context>
 
+      <!-- labels from biblatex commands -->
+      <context name="FancyLabel" attribute="Normal Text" lineEndContext="#stay" fallthrough="true" fallthroughContext="#pop">
+	      <RegExpr String="\s*\{\s*" attribute="Normal Text" context="FancyLabelParameter"/>
+	      <RegExpr String="\s*\[\s*" attribute="Normal Text" context="LabelOption"/>
+	      <RegExpr String="\s*\(\s*" attribute="Normal Text" context="FancyLabelRoundBrackets"/>
+      </context>
+
+      <context name="FancyLabelParameter" attribute="Environment" lineEndContext="#stay">
+	      <DetectChar char="&#xd7;" attribute="Bullet" context="#stay"/>
+	      <RegExpr String="\s*\}\s*" attribute="Normal Text" context="#pop"/>
+      </context>
+
+      <context name="FancyLabelRoundBrackets" attribute="Normal Text" lineEndContext="#stay">
+	      <StringDetect String="\(" attribute="Math" context="MathMode" beginRegion="mathMode" />
+	      <DetectChar char="\" attribute="Keyword" context="ContrSeq"/>
+	      <DetectChar char="$" attribute="Math" context="MathMode" beginRegion="mathMode" />
+	      <DetectChar char="%" attribute="Comment" context="Comment"/>
+	      <DetectChar char="&#xd7;" attribute="Bullet" context="#stay"/>
+	      <RegExpr String="\s*\)\s*" attribute="Normal Text" context="#pop"/>
+      </context>
+
       <!-- start of an environment -->
       <context name="FindEnvironment" attribute="Normal Text" lineEndContext="#stay">
         <DetectChar char="{" attribute="Normal Text" context="Environment"/>
@@ -183,7 +209,7 @@
         <RegExpr String="(verbatim|boxedverbatim)" attribute="Environment" context="VerbatimEnv"/>
         <RegExpr String="(alignat|xalignat|xxalignat)" attribute="Environment" context="MathEnvParam"/>
         <RegExpr String="(equation|displaymath|eqnarray|subeqnarray|math|multline|gather|align|flalign)" attribute="Environment" context="MathEnv"/>
-        <RegExpr String="(tabular|supertabular|mpsupertabular|xtabular|mpxtabular|longtable)" attribute="Environment" context="TabEnv"/>
+        <RegExpr String="(tabularx|tabular|supertabular|mpsupertabular|xtabular|mpxtabular|longtable)" attribute="Environment" context="TabEnv"/>
         <DetectChar char="&#xd7;" attribute="Bullet" context="#stay"/>
         <RegExpr String="[a-zA-Z]" attribute="Environment" context="LatexEnv"/>
         <RegExpr String="\s+" attribute="Error" context="#pop"/>
@@ -262,6 +288,7 @@
         <StringDetect String="$$" attribute="Error" context="#stay" />
         <DetectChar char="$" attribute="Error" context="#stay" />
         <DetectChar char="%" attribute="Comment" context="Comment"/>
+	<DetectChar char="&#xd7;" attribute="Bullet" context="#stay"/>
         <RegExpr String="%\s*BEGIN.*$" attribute="Region Marker" context="#stay" beginRegion="regionMarker" firstNonSpace="true"/>
         <RegExpr String="%\s*END.*$" attribute="Region Marker" context="#stay" endRegion="regionMarker" firstNonSpace="true"/>
       </context>
@@ -283,15 +310,22 @@
       <!-- parse tabular text -->
       <context name="Tab" attribute="Tab" lineEndContext="#stay">
 	<DetectChar char="&amp;" attribute="Ampersand" context="#stay"/>
-	<RegExpr String="@\{.*\}" minimal="true" attribute="Column Separator" context="#stay"/>
-        <RegExpr String="\\end(?=\s*\{(tabular|supertabular|mpsupertabular|xtabular|mpxtabular|longtable)\*?\})" attribute="Structure"  context="TabFindEnd"/>
+	<StringDetect String="@{" attribute="Column Separator" context="Column Separator"/>
+        <RegExpr String="\\end(?=\s*\{(tabularx|tabular|supertabular|mpsupertabular|xtabular|mpxtabular|longtable)\*?\})" attribute="Structure"  context="TabFindEnd"/>
 	<IncludeRules context="Normal Text" />
       </context>
+      
+      <context name="Column Separator" attribute="Column Separator" lineEndContext="#stay">
+	      <DetectChar char="{" attribute="Column Separator" context="Column Separator"/>
+	      <DetectChar char="}" attribute="Column Separator" context="#pop"/>
+	      <RegExpr String="." attribute="Column Separator"  context="#stay"/> 
+<!-- 	 the last regexp is very stupid. Suggestions are welcome! Fallthrough did not help-->
+      </context>
 
       <!-- end of tabular environment -->
       <context name="TabFindEnd" attribute="Normal Text" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop">
         <RegExpr String="\s*\{" attribute="Normal Text" context="#stay"/>
-        <RegExpr String="(tabular|supertabular|mpsupertabular|xtabular|mpxtabular|longtable)\*?" attribute="Environment" context="#stay"/>
+        <RegExpr String="(tabularx|tabular|supertabular|mpsupertabular|xtabular|mpxtabular|longtable)\*?" attribute="Environment" context="#stay"/>
         <DetectChar char="}" attribute="Normal Text" context="#pop#pop#pop#pop#pop" endRegion="block"/>
       </context>
 
@@ -322,6 +356,13 @@
         <IncludeRules context="MathModeCommon" />
       </context>
 
+      <!-- math mode: \ensuremath{...} !-->
+      <context name="MathModeEnsure" attribute="Math" lineEndContext="#stay">
+	      <DetectChar char="{" attribute="Math" context="MathModeEnsure" />
+	      <DetectChar char="}" attribute="Math" context="#pop" />
+	      <IncludeRules context="MathModeCommon" />
+      </context>
+
       <!-- math mode common -->
       <context name="MathModeCommon" attribute="Math" lineEndContext="#stay">
         <RegExpr String="\\(begin|end)\s*\{(equation|displaymath|eqnarray|subeqnarray|math|multline|gather|align|flalign|alignat|xalignat|xxalignat)\*?\}" attribute="Error" context="#stay"/>
@@ -350,6 +391,7 @@
       <context name="MathModeTextParameterStart" attribute="Normal Text" lineEndContext="#stay" >
         <RegExpr String="\\." attribute="Normal Text" context="#stay"/> 
         <DetectChar char="&#xd7;" attribute="Bullet" context="#stay"/>
+	<RegExpr String="\$.*\$" minimal="true" attribute="Math" context="#stay"/>
         <DetectChar char="{" attribute="Normal Text" context="MathModeTextParameter"/>
         <DetectChar char="}" attribute="Normal Text" context="#pop#pop"/>
         <DetectChar char="%" attribute="Comment" context="Comment"/>
@@ -363,10 +405,17 @@
         <DetectChar char="%" attribute="Comment" context="Comment"/>
       </context>
 
+     <!--    iffalse aka multiline comment    -->
+	<context name="Multiline Comment" attribute="Comment" lineEndContext="#stay">
+		<StringDetect String="\fi" attribute="Comment" context="#pop"/>
+		<StringDetect String="\else" attribute="Comment" context="#pop"/>
+	</context>
+
      <!-- comment -->
       <context name="Comment" attribute="Comment" lineEndContext="#pop">
       	<RegExpr String="(FIXME|TODO):?" attribute="Alert" context="#stay"/>
-        <DetectChar char="&#xd7;" attribute="Bullet" context="#stay"/>
+	<StringDetect String="\KileResetHL" attribute="Comment" context="Normal Text"/>
+	<StringDetect String="\KateResetHL" attribute="Comment" context="Normal Text"/>
       </context>
     </contexts>
 
Index: kate/utils/katevimodebar.cpp
===================================================================
--- kate/utils/katevimodebar.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/utils/katevimodebar.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -27,6 +27,7 @@
 #include <QtGui/QLabel>
 #include <QtGui/QHBoxLayout>
 #include <QTimer>
+#include <QTextDocument>
 
 #include "klocale.h"
 
@@ -51,7 +52,6 @@
 
   m_labelStatus->setTextFormat(Qt::PlainText);
   m_labelCommand->setTextFormat(Qt::PlainText);
-  m_labelMessage->setTextFormat(Qt::PlainText);
 }
 
 KateViModeBar::~KateViModeBar()
@@ -82,7 +82,7 @@
   if ( m_timer ) {
     m_timer->stop();
   }
-  m_labelMessage->setText(QString("<font color=\"red\">")+msg+"</font>");
+  m_labelMessage->setText(QString("<font color=\"red\">")+Qt::escape(msg)+"</font>");
 }
 
 void KateViModeBar::clearMessage()
Index: kate/script/data/CMakeLists.txt
===================================================================
--- kate/script/data/CMakeLists.txt	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/script/data/CMakeLists.txt	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -1,2 +1,2 @@
 # install some javascripts
-install( FILES jstest.js sort.js lisp.js cstyle.js python.js ruby.js DESTINATION ${DATA_INSTALL_DIR}/katepart/script )
+install( FILES jstest.js sort.js lisp.js cstyle.js python.js ruby.js lilypond.js DESTINATION ${DATA_INSTALL_DIR}/katepart/script )
Index: kate/data/katepart.desktop
===================================================================
--- kate/data/katepart.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/data/katepart.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,7 @@
 Name[gu]=જડિત ઉચ્ચ લખાણ સંપાદક
 Name[he]=עורך הטקסט המתקדם המשובץ
 Name[hi]=अंतर्निर्मित उन्नत पाठ संपादक
+Name[hne]=भीतर मं बने उन्नत पाठ संपादक
 Name[hr]=Ugrađena napredna obrada teksta
 Name[hsb]=Integrowany lěpši wobdźěłar teksta
 Name[hu]=Beágyazott Kate szövegszerkesztő
Index: kate/completion/katecompletionmodel.cpp
===================================================================
--- kate/completion/katecompletionmodel.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/completion/katecompletionmodel.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -94,12 +94,13 @@
   if( v.isValid() && v.canConvert(QVariant::Int) ) {
     QVariant value = index.data(v.toInt());
     if(v.toInt() == Qt::DisplayRole) {
-      m_customGroup = value.toString();
+      m_customGroup = index.data(Qt::DisplayRole).toString();
       QVariant sortingKey = index.data(CodeCompletionModel::InheritanceDepth);
       if(sortingKey.canConvert(QVariant::Int))
         m_groupSortingKey = sortingKey.toInt();
     }else{
-      m_roleValues[(CodeCompletionModel::ExtraItemDataRoles)v.toInt()] = value;
+      if(v.toInt() != Qt::DisplayRole)
+        m_roleValues[(CodeCompletionModel::ExtraItemDataRoles)v.toInt()] = value;
     }
   }else{
     kDebug( 13035 ) << "Did not return valid GroupRole in hierarchical completion-model";
@@ -265,11 +266,11 @@
 
   //Returns a nonzero group if this index is the head of a group(A Label in the list)
   Group* g = groupForIndex(index);
-
+  
   if (g && (!g->isEmpty)) {
     switch (role) {
       case Qt::DisplayRole:
-        if (!index.column())
+          //We return the group-header for all columns, ExpandingDelegate will paint them properly over the whole space
           return ' ' + g->title;
         break;
 
@@ -291,20 +292,19 @@
   return QVariant();
 }
 
-int KateCompletionModel::contextMatchQuality(const QModelIndex& idx) const {
-  //Return the best match with any of the argument-hints
+int KateCompletionModel::contextMatchQuality(const QModelIndex& index) const {
+  if(!index.isValid())
+    return 0;
+  Group* g = groupOfParent(index);
+  if(!g || g->filtered.size() < index.row())
+    return 0;
+  
+  return contextMatchQuality(g->filtered[index.row()].sourceRow());
+}
 
-  if( !idx.isValid() )
-    return -1;
-
-  Group* g = groupOfParent(idx);
-  if( !g )
-    return -1;
-
-  ModelRow source = g->filtered[idx.row()].sourceRow();
+int KateCompletionModel::contextMatchQuality(const ModelRow& source) const {
   QModelIndex realIndex = source.second;
 
-
   int bestMatch = -1;
   //Iterate through all argument-hints and find the best match-quality
   foreach( const Item& item, m_argumentHints->filtered )
@@ -328,6 +328,15 @@
         bestMatch = m;
     }
   }
+  
+  if(m_argumentHints->filtered.isEmpty()) {
+    QVariant matchQuality = realIndex.data(CodeCompletionModel::MatchQuality);
+    if( matchQuality.isValid() && matchQuality.type() == QVariant::Int ) {
+      int m = matchQuality.toInt();
+      if( m > bestMatch )
+        bestMatch = m;
+    }
+  }
 
   return bestMatch;
 }
@@ -491,7 +500,7 @@
   return createIndex(row, 0, 0);
 }
 
-void KateCompletionModel::clearGroups( )
+void KateCompletionModel::clearGroups( bool shouldReset )
 {
   clearExpanding();
   m_ungrouped->clear();
@@ -524,7 +533,8 @@
   m_emptyGroups.append(m_bestMatches);
   m_groupHash.insert(BestMatchesProperty, m_bestMatches);
 
-  reset();
+  if(shouldReset)
+    reset();
 }
 
 QSet<KateCompletionModel::Group*> KateCompletionModel::createItems(const HierarchicalModelHandler& _handler, const QModelIndex& i, bool notifyModel) {
@@ -563,7 +573,7 @@
 
 void KateCompletionModel::createGroups()
 {
-  clearGroups();
+  clearGroups(false); //Reset is done below
 
   bool has_groups=false;
   foreach (CodeCompletionModel* sourceModel, m_completionModels) {
@@ -581,9 +591,10 @@
   foreach (Group* g, m_emptyGroups)
     hideOrShowGroup(g);
 
+  updateBestMatches();
+  
   reset();
 
-  updateBestMatches();
   emit contentGeometryChanged();
 }
 
@@ -603,7 +614,7 @@
     g = m_argumentHints;
   } else{
     QString customGroup = handler.customGroup();
-    if(!customGroup.isNull()) {
+    if(!customGroup.isNull() && m_hasGroups) {
       if(m_customGroupHash.contains(customGroup)) {
         g = m_customGroupHash[customGroup];
       }else{
@@ -1527,10 +1538,12 @@
   , matchCompletion(true)
   , matchFilters(true)
 {
+  
   inheritanceDepth = handler.getData(CodeCompletionModel::InheritanceDepth, m_sourceRow.second).toInt();
 
-  m_nameColumn = sr.second.sibling(sr.second.row(), CodeCompletionModel::Name).data(Qt::DisplayRole).toString();
-  
+  QModelIndex nameSibling = sr.second.sibling(sr.second.row(), CodeCompletionModel::Name);
+  m_nameColumn = nameSibling.data(Qt::DisplayRole).toString();
+
   if(doInitialMatch) {
     filter();
     match();
@@ -1967,7 +1980,7 @@
 
   m_currentMatch.remove(model);
 
-  clearGroups();
+  clearGroups(false);
 
   model->disconnect(this);
 
@@ -1978,6 +1991,7 @@
     createGroups();
   }else{
     emit contentGeometryChanged();
+    reset();
   }
 }
 
@@ -1988,6 +2002,46 @@
   //Maps match-qualities to ModelRows paired together with the BestMatchesCount returned by the items.
   typedef QMultiMap<int, QPair<int, ModelRow> > BestMatchMap;
   BestMatchMap matches;
+  
+  if(!hasGroups()) {
+    //If there is no grouping, just change the order of the items, moving the best matching ones to the front
+    QMultiMap<int, int> rowsForQuality;
+    
+    int row = 0;
+    foreach(const Item& item, m_ungrouped->filtered) {
+      ModelRow source = item.sourceRow();
+      
+      QVariant v = source.second.data(CodeCompletionModel::BestMatchesCount);
+
+      if( v.type() == QVariant::Int && v.toInt() > 0 ) {
+        int quality = contextMatchQuality(source);
+        if(quality > 0)
+          rowsForQuality.insert(quality, row);
+      }
+      
+      ++row;
+    }
+    
+    if(!rowsForQuality.isEmpty()) {
+      //Rewrite m_ungrouped->filtered in a new order
+      QSet<int> movedToFront;
+      QList<Item> newFiltered;
+      for(QMultiMap<int, int>::const_iterator it = rowsForQuality.begin(); it != rowsForQuality.end(); ++it) {
+        newFiltered.prepend(m_ungrouped->filtered[it.value()]);
+        movedToFront.insert(it.value());
+      }
+      
+      {
+        uint size = m_ungrouped->filtered.size();
+        for(int a = 0; a < size; ++a)
+          if(!movedToFront.contains(a))
+            newFiltered.append(m_ungrouped->filtered[a]);
+      }
+      m_ungrouped->filtered = newFiltered;
+    }
+    return;
+  }
+  
   ///@todo Cache the CodeCompletionModel::BestMatchesCount
   int maxMatches = 50; //We cannot do too many operations here, because they are all executed whenever a character is added. Would be nice if we could split the operations up somewhat using a timer.
   foreach (Group* g, m_rowTable) {
@@ -1995,12 +2049,14 @@
       continue;
     for( int a = 0; a < g->filtered.size(); a++ )
     {
-      QModelIndex index = indexForGroup(g).child(a,0);
+      ModelRow source = g->filtered[a].sourceRow();
 
-      QVariant v = index.data(CodeCompletionModel::BestMatchesCount);
+      QVariant v = source.second.data(CodeCompletionModel::BestMatchesCount);
 
       if( v.type() == QVariant::Int && v.toInt() > 0 ) {
-        int quality = contextMatchQuality(index);
+        //Return the best match with any of the argument-hints
+
+        int quality = contextMatchQuality(source);
         if( quality > 0 )
           matches.insert(quality, qMakePair(v.toInt(), g->filtered[a].sourceRow()));
         --maxMatches;
@@ -2028,6 +2084,7 @@
   }
 
   m_bestMatches->filtered.clear();
+  
   it = matches.constEnd();
 
   while( it != matches.constBegin() && cnt > 0 )
@@ -2064,8 +2121,6 @@
   m_currentMatch.clear();
 
   clearGroups();
-
-  reset();
 }
 
 #include "katecompletionmodel.moc"
Index: kate/completion/katecompletionmodel.h
===================================================================
--- kate/completion/katecompletionmodel.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/completion/katecompletionmodel.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -166,7 +166,7 @@
     void debugStats();
 
   protected:
-    virtual int contextMatchQuality(const QModelIndex& row) const;
+    virtual int contextMatchQuality(const QModelIndex & index) const;
 
   Q_SIGNALS:
     void expandIndex(const QModelIndex& index);
@@ -189,10 +189,13 @@
     void updateBestMatches();
 
   private:
+    
+    typedef QPair<KTextEditor::CodeCompletionModel*, QModelIndex> ModelRow;
+    virtual int contextMatchQuality(const ModelRow& sourceRow) const;
+    
     QTreeView* treeView() const;
 
     friend class KateArgumentHintModel;
-    typedef QPair<KTextEditor::CodeCompletionModel*, QModelIndex> ModelRow;
     ModelRow modelRowPair(const QModelIndex& index) const;
 
     // Represents a source row; provides sorting method
@@ -278,7 +281,7 @@
     ///i must be an index in the source model
     QSet<Group*> deleteItems(const QModelIndex& i);
     Group* createItem(const HierarchicalModelHandler&, const QModelIndex& i, bool notifyModel = false);
-    void clearGroups();
+    void clearGroups(bool reset = true);
     void hideOrShowGroup(Group* g);
     /// When forceGrouping is enabled, all given attributes will be used for grouping, regardless of the completion settings.
     Group* fetchGroup(int attribute, const QString& scope = QString(), bool forceGrouping = false);
Index: kate/completion/expandingtree/expandingdelegate.cpp
===================================================================
--- kate/completion/expandingtree/expandingdelegate.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/completion/expandingtree/expandingdelegate.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -72,6 +72,8 @@
 {
   QStyleOptionViewItem option(optionOld);
 
+  m_currentIndex = index;
+  
   adjustStyle(index, option);
     
   if( index.column() == 0 )
@@ -91,12 +93,11 @@
   m_cachedHighlights.clear();
   m_backgroundColor = getUsedBackgroundColor(option, index);
 
-  if (!model()->indexIsItem(index) )
-      return QItemDelegate::paint(painter, option, index);
+  if (model()->indexIsItem(index) ) {
+    m_currentColumnStart = 0;
+    m_cachedHighlights = createHighlighting(index, option);
+  }
 
-  m_currentColumnStart = 0;
-  m_cachedHighlights = createHighlighting(index, option);
-
   /*kDebug( 13035 ) << "Highlights for line:";
   foreach (const QTextLayout::FormatRange& fr, m_cachedHighlights)
     kDebug( 13035 ) << fr.start << " len " << fr.length << " format ";*/
@@ -133,11 +134,24 @@
 {
 }
 
-void ExpandingDelegate::drawDisplay( QPainter * painter, const QStyleOptionViewItem & option, const QRect & rect, const QString & text ) const
+void ExpandingDelegate::adjustRect(QRect& rect) const {
+  if (!model()->indexIsItem(m_currentIndex) /*&& m_currentIndex.column() == 0*/) {
+    
+    rect.setLeft(model()->treeView()->columnViewportPosition(0));
+    int columnCount = model()->columnCount(m_currentIndex.parent());
+    
+    if(!columnCount)
+      return;
+    rect.setRight(model()->treeView()->columnViewportPosition(columnCount-1) + model()->treeView()->columnWidth(columnCount-1));
+  }
+}
+
+void ExpandingDelegate::drawDisplay( QPainter * painter, const QStyleOptionViewItem & option, const QRect & _rect, const QString & text ) const
 {
-/*  if (m_cachedRow == -1)
-    return QItemDelegate::drawDisplay(painter, option, rect, text);
-*/
+  QRect rect(_rect);
+
+  adjustRect(rect);
+
   QTextLayout layout(text, option.font, painter->device());
 
   QRect textRect = rect.adjusted(1, 0, -1, 0); // remove width padding
@@ -253,6 +267,11 @@
   //qt_format_text(option.font, textRect, option.displayAlignment, str, 0, 0, 0, 0, painter);
 }
 
+void ExpandingDelegate::drawDecoration(QPainter* painter, const QStyleOptionViewItem& option, const QRect& rect, const QPixmap& pixmap) const {
+  if (model()->indexIsItem(m_currentIndex) )
+    QItemDelegate::drawDecoration(painter, option, rect, pixmap);
+}
+
 void ExpandingDelegate::drawBackground ( QPainter * painter, const QStyleOptionViewItem & option, const QModelIndex & index ) const {
     QStyleOptionViewItemV4 opt = option;
     //initStyleOption(&opt, index);
Index: kate/completion/expandingtree/expandingdelegate.h
===================================================================
--- kate/completion/expandingtree/expandingdelegate.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/completion/expandingtree/expandingdelegate.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -60,9 +60,12 @@
     virtual QSize sizeHint ( const QStyleOptionViewItem & option, const QModelIndex & index ) const;
     virtual bool editorEvent ( QEvent * event, QAbstractItemModel * model, const QStyleOptionViewItem & option, const QModelIndex & index );
     virtual void drawBackground ( QPainter * painter, const QStyleOptionViewItem & option, const QModelIndex & index ) const;
+    virtual void drawDecoration(QPainter* painter, const QStyleOptionViewItem& option, const QRect& rect, const QPixmap& pixmap) const;
     //option can be changed
     virtual QList<QTextLayout::FormatRange> createHighlighting(const QModelIndex& index, QStyleOptionViewItem& option) const;
 
+    void adjustRect(QRect& rect) const;
+    
     /**
      * Creates a list of FormatRanges as should be returned by createHighlighting from a list of QVariants as described in the kde header ktexteditor/codecompletionmodel.h
      * */
@@ -80,6 +83,7 @@
   
     mutable Qt::Alignment m_cachedAlignment;
     mutable QColor m_backgroundColor;
+    mutable QModelIndex m_currentIndex;
   private:
 
     ExpandingWidgetModel* m_model;
Index: kate/completion/katecompletionwidget.cpp
===================================================================
--- kate/completion/katecompletionwidget.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/completion/katecompletionwidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -610,8 +610,6 @@
 
   QModelIndex toExecute;
   
-  KTextEditor::Cursor oldPos = view()->cursorPosition();
-  
   if(index.model() == m_presentationModel)
     toExecute = m_presentationModel->mapToSource(index);
   else
@@ -625,6 +623,8 @@
   // encapsulate all editing as being from the code completion, and undo-able in one step.
   view()->doc()->editStart(true, Kate::CodeCompletionEdit);
 
+  KTextEditor::SmartCursor* oldPos = view()->doc()->smartManager()->newSmartCursor(view()->cursorPosition(), KTextEditor::SmartCursor::StayOnInsert);
+  
   KTextEditor::CodeCompletionModel* model = static_cast<KTextEditor::CodeCompletionModel*>(const_cast<QAbstractItemModel*>(toExecute.model()));
   Q_ASSERT(model);
 
@@ -655,13 +655,18 @@
   view()->sendCompletionExecuted(start, model, toExecute);
   
   KTextEditor::Cursor newPos = view()->cursorPosition();
-  if(newPos > oldPos) {
+
+  if(newPos > *oldPos) {
     m_automaticInvocationAt = newPos;
-    m_automaticInvocationLine = view()->doc()->text(KTextEditor::Range(oldPos, newPos));
+    m_automaticInvocationLine = view()->doc()->text(KTextEditor::Range(*oldPos, newPos));
     kDebug() << "executed, starting automatic invocation with line" << m_automaticInvocationLine;
     m_lastInsertionByUser = false;
     m_automaticInvocationTimer->start();
   }
+  
+  view()->doc()->smartMutex()->lock();
+  delete oldPos;
+  view()->doc()->smartMutex()->unlock();
 }
 
 void KateCompletionWidget::resizeEvent( QResizeEvent * event )
Index: kate/view/kateviewhelpers.cpp
===================================================================
--- kate/view/kateviewhelpers.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/view/kateviewhelpers.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -1672,7 +1672,7 @@
 {
   doc->setEncoding(e);
   //this is done in setEncoding()
-  //doc->setScriptForEncodingAutoDetection(KEncodingDetector::None);
+  //doc->setProberTypeForEncodingAutoDetection(KEncodingProber::None);
   view->reloadFile();
 
 }
Index: kate/document/katedocument.cpp
===================================================================
--- kate/document/katedocument.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kate/document/katedocument.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -5396,6 +5396,7 @@
 
 bool KateDocument::setEncoding (const QString &e)
 {
+  setProberTypeForEncodingAutoDetection(KEncodingProber::None);
   return m_config->setEncoding(e);
 }
 
Index: kjs/array_instance.cpp
===================================================================
--- kjs/array_instance.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/array_instance.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -254,6 +254,13 @@
         if (!map) {
             map = new SparseArrayValueMap;
             storage->m_sparseValueMap = map;
+
+            // If we create a sparse map, we need to ensure that there is at least one spot
+            // in the vector map, however, since the sparse map can't put/get key 0.
+            // It's safe to do it here, since put(0) will always put it in the vector part,
+            // but we have to do it before a get(0) or it will crash
+            if (!m_vectorLength)
+                increaseVectorLength(1);
         }
         map->add(i, value);
         return;
Index: kjs/interpreter.cpp
===================================================================
--- kjs/interpreter.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/interpreter.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -509,16 +509,19 @@
 
     // notify debugger that source has been parsed
     if (m_debugger) {
-        m_debugger->reportSourceParsed(&m_globalExec, progNode.get(), 
+        m_debugger->reportSourceParsed(&m_globalExec, progNode.get(), sourceId, sourceURL, 
                       UString(code, codeLength), startingLineNumber, errLine, errMsg);
     }
 
     // no program node means a syntax error occurred
     if (!progNode) {
         Completion res(Throw, Error::create(&m_globalExec, SyntaxError, errMsg, errLine, sourceId, sourceURL));
-	if (shouldPrintExceptions())
-	  printException(res, sourceURL);
-	return res;
+        if (m_debugger)
+            m_debugger->reportException(&m_globalExec, res.value());
+
+        if (shouldPrintExceptions())
+            printException(res, sourceURL);
+        return res;
     }
 
     m_globalExec.clearException();
@@ -963,3 +966,5 @@
 }
 
 }
+
+// kate: indent-width 2; replace-tabs on; tab-width 4; space-indent on;
Index: kjs/object_object.cpp
===================================================================
--- kjs/object_object.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/object_object.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -56,6 +56,10 @@
     putDirectFunction(new ObjectProtoFunc(exec, funcProto, ObjectProtoFunc::LookupSetter, 1, *lookupSetterPropertyName), DontEnum);
 }
 
+JSObject* ObjectPrototype::self(ExecState* exec)
+{
+    return exec->lexicalInterpreter()->builtinObjectPrototype();
+}
 
 // ------------------------------ ObjectProtoFunc --------------------------------
 
Index: kjs/object.cpp
===================================================================
--- kjs/object.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/object.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -33,6 +33,8 @@
 #include "PropertyNameArray.h"
 #include <math.h>
 
+#include <typeinfo>
+
 // maximum global call stack size. Protects against accidental or
 // malicious infinite recursions. Define to -1 if you want no limit.
 #if PLATFORM(DARWIN)
@@ -43,25 +45,9 @@
 #define KJS_MAX_STACK 900
 #endif
 
-#define JAVASCRIPT_CALL_TRACING 0
+
 #define JAVASCRIPT_MARK_TRACING 0
 
-#if JAVASCRIPT_CALL_TRACING
-static bool _traceJavaScript = false;
-
-extern "C" {
-    void setTraceJavaScript(bool f)
-    {
-        _traceJavaScript = f;
-    }
-
-    static bool traceJavaScript()
-    {
-        return _traceJavaScript;
-    }
-}
-#endif
-
 namespace KJS {
 
 // ------------------------------ Object ---------------------------------------
@@ -73,22 +59,6 @@
 #if KJS_MAX_STACK > 0
   static int depth = 0; // sum of all concurrent interpreters
 
-#if JAVASCRIPT_CALL_TRACING
-    static bool tracing = false;
-    if (traceJavaScript() && !tracing) {
-        tracing = true;
-        for (int i = 0; i < depth; i++)
-            putchar (' ');
-        printf ("*** calling:  %s\n", toString(exec).ascii());
-        for (int j = 0; j < args.size(); j++) {
-            for (int i = 0; i < depth; i++)
-                putchar (' ');
-            printf ("*** arg[%d] = %s\n", j, args[j]->toString(exec).ascii());
-        }
-        tracing = false;
-    }
-#endif
-
   if (++depth > KJS_MAX_STACK) {
     depth -= 11; //Give the debugger some room..
     return throwError(exec, RangeError, "Maximum call stack size exceeded.");
@@ -97,22 +67,18 @@
 #endif
 
   JSValue *ret = callAsFunction(exec,thisObj,args);
-  assert(ret);
 
+#ifndef NDEBUG
+  if (!ret) {
+    fprintf(stderr, "callAsFunction returned 0 on:%s\n", typeid(*this).name());
+    assert(ret);
+  }
+#endif
+
 #if KJS_MAX_STACK > 0
   --depth;
 #endif
 
-#if JAVASCRIPT_CALL_TRACING
-    if (traceJavaScript() && !tracing) {
-        tracing = true;
-        for (int i = 0; i < depth; i++)
-            putchar (' ');
-        printf ("*** returning:  %s\n", ret->toString(exec).ascii());
-        tracing = false;
-    }
-#endif
-
   return ret;
 }
 
Index: kjs/debugger.cpp
===================================================================
--- kjs/debugger.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/debugger.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -48,6 +48,7 @@
 {
   lastLineRan = 0;
   rep = new DebuggerImp();
+  lastSourceParsed = -1;
 }
 
 Debugger::~Debugger()
@@ -124,7 +125,7 @@
 void Debugger::reportException(ExecState *exec, JSValue *exceptionVal)
 {
   if (!hasHandledException(exec, exceptionVal))
-      exception(exec, exec->currentBody()->sourceId(), lastLineRan, exceptionVal);
+      exception(exec, exec->currentBody() ? exec->currentBody()->sourceId() : lastSourceParsed, lastLineRan, exceptionVal);
 }
 
 bool Debugger::enterContext(ExecState * /*exec*/, int /*sourceId*/, int /*lineno*/,
@@ -149,11 +150,13 @@
   return false;
 }
 
-void Debugger::reportSourceParsed(ExecState *exec, FunctionBodyNode *body, const UString &source, 
+void Debugger::reportSourceParsed(ExecState *exec, FunctionBodyNode *body,
+                                  int sourceId, UString sourceURL, const UString &source, 
                                   int startingLineNumber, int errorLine, const UString &errorMsg)
 {
+  lastSourceParsed = sourceId;
   UString code = source;
-  if (shouldReindentSources())
+  if (shouldReindentSources() && body)
     code = body->reindent(startingLineNumber);
-  sourceParsed(exec, body->sourceId(), body->sourceURL(), code, startingLineNumber, errorLine, errorMsg);
+  sourceParsed(exec, sourceId, sourceURL, code, startingLineNumber, errorLine, errorMsg);
 }
Index: kjs/function.cpp
===================================================================
--- kjs/function.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/function.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -873,7 +873,7 @@
 
         Debugger *dbg = exec->dynamicInterpreter()->debugger();
         if (dbg) {
-          dbg->reportSourceParsed(exec, progNode.get(), s, 0, errLine, errMsg);
+          dbg->reportSourceParsed(exec, progNode.get(), sourceId, UString(), s, 0, errLine, errMsg);
         }
 
         // no program node means a syntax occurred
Index: kjs/object_object.h
===================================================================
--- kjs/object_object.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/object_object.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -34,9 +34,14 @@
    * The initial value of Object.prototype (and thus all objects created
    * with the Object constructor
    */
-  class ObjectPrototype : public JSObject {
+  class KJS_EXPORT ObjectPrototype : public JSObject {
   public:
     ObjectPrototype(ExecState *exec, FunctionPrototype *funcProto);
+    
+    // Returns the lexical default object prototype for the given interpreter.
+    // This is just an alias for exec->lexicalInterpreter()->builtinObjectPrototype() 
+    // for uniformity with custom prototypes.
+    static JSObject* self(ExecState* exec);
   };
 
   /**
Index: kjs/function_object.cpp
===================================================================
--- kjs/function_object.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/function_object.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -191,7 +191,7 @@
   Debugger *dbg = exec->dynamicInterpreter()->debugger();
   if (dbg) {
     // make sure to pass in sourceURL, since it's useful for lazy event listeners, and empty for actual function ctor
-    dbg->reportSourceParsed(exec, functionBody.get(), body, lineNumber, errLine, errMsg);
+    dbg->reportSourceParsed(exec, functionBody.get(), sourceId, sourceURL, body, lineNumber, errLine, errMsg);
   }
 
   // no program node == syntax error - throw a syntax error
Index: kjs/debugger.h
===================================================================
--- kjs/debugger.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/debugger.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -222,12 +222,13 @@
     void reportException  (ExecState *exec, JSValue *exception);
 
     // This notifies the debugger of source being parsed, reindenting it if need be.
-    void reportSourceParsed(ExecState *exec, FunctionBodyNode *body,
+    void reportSourceParsed(ExecState *exec, FunctionBodyNode *body, int sourceId, UString sourceURL, 
                               const UString &source, int startingLineNumber, int errorLine, const UString &errorMsg);
   private:
     DebuggerImp *rep;
     HashMap<Interpreter*, ProtectedPtr<JSValue> > latestExceptions;
     int lastLineRan;
+    int lastSourceParsed; // Needed for attributing syntax exceptions at top-level
   public:
     static int debuggersPresent;
   };
Index: kjs/lookup.h
===================================================================
--- kjs/lookup.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kjs/lookup.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -362,31 +362,12 @@
     static const KJS::ClassInfo info; \
     bool getOwnPropertySlot(KJS::ExecState *, const KJS::Identifier&, KJS::PropertySlot&); \
   protected: \
-    ClassProto(KJS::ExecState *exec) \
-      : KJS::JSObject(exec->lexicalInterpreter()->builtinObjectPrototype()) { } \
-    \
+    ClassProto(KJS::ExecState *exec);\
     static KJS::Identifier* s_name;           \
     static KJS::Identifier* name(); \
   };
 
-#define KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(ClassProto, ClassProtoProto) \
-    class ClassProto : public KJS::JSObject { \
-        friend KJS::JSObject* KJS_CACHEGLOBALOBJECT_NS cacheGlobalObject<ClassProto>(KJS::ExecState* exec, const KJS::Identifier& propertyName); \
-    public: \
-        static KJS::JSObject* self(KJS::ExecState* exec); \
-        virtual const KJS::ClassInfo* classInfo() const { return &info; } \
-        static const KJS::ClassInfo info; \
-        bool getOwnPropertySlot(KJS::ExecState*, const KJS::Identifier&, KJS::PropertySlot&); \
-    protected: \
-        ClassProto(KJS::ExecState* exec) \
-            : KJS::JSObject(ClassProtoProto::self(exec)) { } \
-    \
-    static KJS::Identifier* s_name; \
-    static KJS::Identifier* name(); \
-    };
-
-
-#define KJS_IMPLEMENT_PROTOTYPE(ClassName, ClassProto,ClassFunc) \
+#define KJS_IMPLEMENT_PROTOTYPE_IMP(ClassName,ClassProto,ClassFunc,ClassProtoProto) \
     const KJS::ClassInfo ClassProto::info = { ClassName, 0, &ClassProto##Table, 0 }; \
     KJS::Identifier* ClassProto::s_name = 0; \
     KJS::JSObject *ClassProto::self(KJS::ExecState *exec) \
@@ -401,9 +382,12 @@
     { \
       if (!s_name) s_name = new KJS::Identifier("[[" ClassName ".prototype]]"); \
       return s_name; \
-    }
+    }\
+    ClassProto::ClassProto(KJS::ExecState *exec): KJS::JSObject(ClassProtoProto::self(exec))
 
-
+#define KJS_IMPLEMENT_PROTOTYPE(ClassName,ClassProto,ClassFunc,ClassProtoProto) \
+    KJS_IMPLEMENT_PROTOTYPE_IMP(ClassName,ClassProto,ClassFunc,ClassProtoProto) {}
+    
 #define KJS_IMPLEMENT_PROTOFUNC(ClassFunc) \
   class ClassFunc : public KJS::InternalFunctionImp {   \
   public: \
Index: kfile/kfilewidget.cpp
===================================================================
--- kfile/kfilewidget.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kfile/kfilewidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -185,6 +185,7 @@
     void _k_zoomOutIconsSize();
     void _k_zoomInIconsSize();
     void _k_slotIconSizeSliderMoved(int);
+    void _k_slotIconSizeChanged(int);
     void _k_slotViewDoubleClicked(const QModelIndex&);
 
     void addToRecentDocuments();
@@ -460,6 +461,8 @@
     d->iconSizeSlider->installEventFilter(this);
     connect(d->iconSizeSlider, SIGNAL(valueChanged(int)),
             d->ops, SLOT(setIconsZoom(int)));
+    connect(d->iconSizeSlider, SIGNAL(valueChanged(int)),
+            this, SLOT(_k_slotIconSizeChanged(int)));
     connect(d->iconSizeSlider, SIGNAL(sliderMoved(int)),
             this, SLOT(_k_slotIconSizeSliderMoved(int)));
     connect(d->ops, SIGNAL(currentIconSizeChanged(int)),
@@ -1955,7 +1958,7 @@
     _k_slotIconSizeSliderMoved(futValue);
 }
 
-void KFileWidgetPrivate::_k_slotIconSizeSliderMoved(int _value)
+void KFileWidgetPrivate::_k_slotIconSizeChanged(int _value)
 {
     int maxSize = KIconLoader::SizeEnormous - KIconLoader::SizeSmall;
     int value = (maxSize * _value / 100) + KIconLoader::SizeSmall;
@@ -1972,7 +1975,14 @@
             iconSizeSlider->setToolTip(i18n("Icon size: %1 pixels", value));
             break;
     }
+}
 
+void KFileWidgetPrivate::_k_slotIconSizeSliderMoved(int _value)
+{
+    // Force this to be called in case this slot is called first on the
+    // slider move.
+    _k_slotIconSizeChanged(_value);
+
     QPoint global(iconSizeSlider->rect().topLeft());
     global.ry() += iconSizeSlider->height() / 2;
     QHelpEvent toolTipEvent(QEvent::ToolTip, QPoint(0, 0), iconSizeSlider->mapToGlobal(global));
Index: kfile/kdiroperator.cpp
===================================================================
--- kfile/kdiroperator.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kfile/kdiroperator.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2186,11 +2186,11 @@
     // the preview widget is restored
     QList<int> sizes = d->splitter->sizes();
     const bool hasPreview = (sizes.count() == 2);
-    const bool restorePreviewWidth = hasPreview && (d->previewWidth != sizes[1]);
 
     d->splitter->resize(size());
-
     sizes = d->splitter->sizes();
+    
+    const bool restorePreviewWidth = hasPreview && (d->previewWidth != sizes[1]);
     if (restorePreviewWidth) {
         const int availableWidth = sizes[0] + sizes[1];
         sizes[0] = availableWidth - d->previewWidth;
Index: kfile/kurlnavigator.cpp
===================================================================
--- kfile/kurlnavigator.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kfile/kurlnavigator.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -143,7 +143,6 @@
 public:
     Private(KUrlNavigator* q, KFilePlacesModel* placesModel);
 
-    void slotReturnPressed(const QString&);
     void slotReturnPressed();
     void slotRemoteHostActivated();
     void slotProtocolChanged(const QString&);
@@ -194,13 +193,13 @@
     void deleteButtons();
 
     /**
-     * Retrieves the place path for the path \a path.
+     * Retrieves the place path for the current path.
      * E. g. for the path "fish://root@192.168.0.2/var/lib" the string
-     * "fish://root@192.168.0.2/" will be returned, which leads to the
+     * "fish://root@192.168.0.2" will be returned, which leads to the
      * navigation indication 'Custom Path > var > lib". For e. g.
-     * "settings:///System/" the path "settings:///" will be returned.
+     * "settings:///System/" the path "settings://" will be returned.
      */
-    QString retrievePlacePath(const QString& path) const;
+    QString retrievePlacePath() const;
 
     /**
      * Returns true, if the MIME type of the path represents a
@@ -208,7 +207,7 @@
      */
     bool isCompressedPath(const KUrl& path) const;
 
-    void removeTrailingSlash(QString& url);
+    void removeTrailingSlash(QString& url) const;
 
     /**
      * Returns a KUrl for the typed text \a typedUrl.
@@ -302,8 +301,6 @@
     m_pathBox->setCompletionObject(kurlCompletion);
     m_pathBox->setAutoDeleteCompletionObject(true);
 
-    connect(m_pathBox, SIGNAL(returnPressed(QString)),
-            q, SLOT(slotReturnPressed(QString)));
     connect(m_pathBox, SIGNAL(returnPressed()),
             q, SLOT(slotReturnPressed()));
     connect(m_pathBox, SIGNAL(urlActivated(KUrl)),
@@ -330,7 +327,7 @@
     m_layout->insertWidget(m_layout->count() - 1, widget, stretch);
 }
 
-void KUrlNavigator::Private::slotReturnPressed(const QString& text)
+void KUrlNavigator::Private::slotReturnPressed()
 {
     // Parts of the following code have been taken
     // from the class KateFileSelector located in
@@ -339,7 +336,7 @@
     // Copyright (C) 2001 Joseph Wenninger <jowenn@kde.org>
     // Copyright (C) 2001 Anders Lund <anders.lund@lund.tdcadsl.dk>
 
-    const KUrl typedUrl = adjustedUrl(text);
+    const KUrl typedUrl = q->uncommittedUrl();
     QStringList urls = m_pathBox->urls();
     urls.removeAll(typedUrl.url());
     urls.prepend(typedUrl.url());
@@ -360,12 +357,6 @@
     }
 }
 
-void KUrlNavigator::Private::slotReturnPressed()
-{
-    const QString text = q->uncommittedUrl().prettyUrl();
-    slotReturnPressed(text);
-}
-
 void KUrlNavigator::Private::slotRemoteHostActivated()
 {
     KUrl u = q->url();
@@ -428,12 +419,11 @@
     KMenu* popup = new KMenu(q);
     popup->setLayoutDirection(Qt::LeftToRight);
 
-    const QString path = q->url().pathOrUrl();
-    QString placePath = retrievePlacePath(path);
-    removeTrailingSlash(placePath);
+    const QString placePath = retrievePlacePath();
     int idx = placePath.count('/'); // idx points to the first directory
                                     // after the place path
 
+    const QString path = q->url().pathOrUrl();
     QString dirName = path.section('/', idx, idx);
     if (dirName.isEmpty()) {
         dirName = QChar('/');
@@ -523,13 +513,9 @@
             placeUrl = m_placesSelector->selectedPlaceUrl();
         }
 
-        QString placePath = placeUrl.isValid() ? placeUrl.pathOrUrl() : retrievePlacePath(path);
+        QString placePath = placeUrl.isValid() ? placeUrl.pathOrUrl() : retrievePlacePath();
         removeTrailingSlash(placePath);
 
-        // calculate the start point for the URL navigator buttons by counting
-        // the slashs inside the place URL
-        const int slashCount = placePath.count('/');
-
         const KUrl currentUrl = q->url();
         if (currentUrl.isLocalFile() || placeUrl.isValid()) {
             m_protocols->hide();
@@ -554,7 +540,7 @@
                                (KProtocolInfo::protocolClass(protocol) != ":local"));
         }
 
-        updateButtons(path, slashCount);
+        updateButtons(path, placePath.count('/'));
     }
 }
 
@@ -704,9 +690,10 @@
         button->show();
     }
 
-    if (m_showFullPath) {
-        m_dropDownButton->setVisible(hasHiddenButtons);
-    }
+    const int startIndex = retrievePlacePath().count('/');
+    const bool showDropDownButton = hasHiddenButtons ||
+                                    (!hasHiddenButtons && (m_navButtons.front()->index() > startIndex));
+    m_dropDownButton->setVisible(showDropDownButton);
 }
 
 void KUrlNavigator::Private::switchToBreadcrumbMode()
@@ -723,8 +710,9 @@
     m_navButtons.clear();
 }
 
-QString KUrlNavigator::Private::retrievePlacePath(const QString& path) const
+QString KUrlNavigator::Private::retrievePlacePath() const
 {
+    const QString path = q->url().pathOrUrl();
     int idx = path.indexOf(QLatin1String("///"));
     if (idx >= 0) {
         idx += 3;
@@ -732,7 +720,10 @@
         idx = path.indexOf(QLatin1String("//"));
         idx = path.indexOf(QLatin1Char('/'), (idx < 0) ? 0 : idx + 2);
     }
-    return (idx < 0) ? path : path.left(idx);
+    
+    QString placePath = (idx < 0) ? path : path.left(idx);
+    removeTrailingSlash(placePath);
+    return placePath;
 }
 
 bool KUrlNavigator::Private::isCompressedPath(const KUrl& url) const
@@ -748,7 +739,7 @@
             mime->is("application/x-archive");
 }
 
-void KUrlNavigator::Private::removeTrailingSlash(QString& url)
+void KUrlNavigator::Private::removeTrailingSlash(QString& url) const
 {
     const int length = url.length();
     if ((length > 0) && (url.at(length - 1) == QChar('/'))) {
@@ -954,24 +945,28 @@
     return d->m_showPlacesSelector;
 }
 
-void KUrlNavigator::setUrl(const KUrl& url)
+void KUrlNavigator::setUrl(const KUrl& newUrl)
 {
-    QString urlStr(KUrlCompletion::replacedPath(url.pathOrUrl(), true, true));
-
-    if (urlStr.length() > 0 && urlStr.at(0) == '~') {
+    if (newUrl == url()) {
+        return;
+    }
+    
+    QString urlStr(KUrlCompletion::replacedPath(newUrl.pathOrUrl(), true, true));
+    
+    if ((urlStr.length() > 0) && (urlStr.at(0) == '~')) {
         // replace '~' by the home directory
         urlStr.remove(0, 1);
         urlStr.insert(0, QDir::homePath());
     }
 
-    if ((url.protocol() == "tar") || (url.protocol() == "zip")) {
+    if ((newUrl.protocol() == "tar") || (newUrl.protocol() == "zip")) {
         // The URL represents a tar- or zip-file. Check whether
         // the URL is really part of the tar- or zip-file, otherwise
         // replace it by the local path again.
-        bool insideCompressedPath = d->isCompressedPath(url);
+        bool insideCompressedPath = d->isCompressedPath(newUrl);
         if (!insideCompressedPath) {
-            KUrl prevUrl = url;
-            KUrl parentUrl = url.upUrl();
+            KUrl prevUrl = newUrl;
+            KUrl parentUrl = newUrl.upUrl();
             while (parentUrl != prevUrl) {
                 if (d->isCompressedPath(parentUrl)) {
                     insideCompressedPath = true;
@@ -984,7 +979,7 @@
         if (!insideCompressedPath) {
             // drop the tar: or zip: protocol since we are not
             // inside the compressed path anymore
-            urlStr = url.path();
+            urlStr = newUrl.path();
         }
     }
 
Index: kfile/kfilepreviewgenerator.cpp
===================================================================
--- kfile/kfilepreviewgenerator.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kfile/kfilepreviewgenerator.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -16,6 +16,7 @@
  *   the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,      *
  *   Boston, MA 02110-1301, USA.                                               *
  *******************************************************************************/
+#include <config.h> // for HAVE_XRENDER
 
 #include "kfilepreviewgenerator.h"
 
@@ -40,7 +41,7 @@
 #include <QScrollBar>
 #include <QIcon>
 
-#ifdef Q_WS_X11
+#if defined(Q_WS_X11) && defined(HAVE_XRENDER)
 #  include <QX11Info>
 #  include <X11/Xlib.h>
 #  include <X11/extensions/Xrender.h>
@@ -703,7 +704,7 @@
 void KFilePreviewGenerator::Private::limitToSize(QPixmap& icon, const QSize& maxSize)
 {
     if ((icon.width() > maxSize.width()) || (icon.height() > maxSize.height())) {
-#ifdef Q_WS_X11
+#if defined(Q_WS_X11) && defined(HAVE_XRENDER)
         // Assume that the texture size limit is 2048x2048
         if ((icon.width() <= 2048) && (icon.height() <= 2048) && icon.x11PictureHandle()) {
             QSize size = icon.size();
Index: kfile/kfileplacesmodel.cpp
===================================================================
--- kfile/kfileplacesmodel.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kfile/kfileplacesmodel.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -567,7 +567,7 @@
 
             KBookmark bookmark = KFilePlacesItem::createBookmark(d->bookmarkManager,
                                                                  url.fileName(), url,
-                                                                 mimetype->iconName());
+                                                                 mimetype->iconName(url));
             group.moveBookmark(bookmark, afterBookmark);
             afterBookmark = bookmark;
         }
Index: kfile/kfilewidget.h
===================================================================
--- kfile/kfilewidget.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kfile/kfilewidget.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -466,6 +466,7 @@
     Q_PRIVATE_SLOT(d, void _k_zoomOutIconsSize())
     Q_PRIVATE_SLOT(d, void _k_zoomInIconsSize())
     Q_PRIVATE_SLOT(d, void _k_slotIconSizeSliderMoved(int))
+    Q_PRIVATE_SLOT(d, void _k_slotIconSizeChanged(int))
     Q_PRIVATE_SLOT(d, void _k_slotViewDoubleClicked(const QModelIndex&))
 };
 
Index: kfile/kurlnavigator.h
===================================================================
--- kfile/kurlnavigator.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kfile/kurlnavigator.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -347,7 +347,6 @@
     virtual bool eventFilter(QObject* watched, QEvent* event);
 
 private:
-    Q_PRIVATE_SLOT(d, void slotReturnPressed(const QString& text))
     Q_PRIVATE_SLOT(d, void slotReturnPressed())
     Q_PRIVATE_SLOT(d, void slotRemoteHostActivated())
     Q_PRIVATE_SLOT(d, void slotProtocolChanged(const QString& protocol))
Index: kdoctools/customization/fr/user.entities
===================================================================
--- kdoctools/customization/fr/user.entities	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdoctools/customization/fr/user.entities	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -212,6 +212,10 @@
 <!ENTITY traducteurArnaudMuchembled   '<othercredit role="translator"><firstname>Arnaud</firstname><surname>Muchembled</surname><affiliation><address><email>arno.muchembled@orange.fr</email></address></affiliation><contrib>Traduction française&nbsp;</contrib></othercredit>'>
 <!ENTITY relecteurArnaudMuchembled    '<othercredit role="reviewer"><firstname>Arnaud</firstname><surname>Muchembled</surname><affiliation><address><email>arno.muchembled@orange.fr</email></address></affiliation><contrib>Relecture de la documentation française&nbsp;</contrib></othercredit>'>
 
+<!ENTITY traducteurMathieuSchopfer   '<othercredit role="translator"><firstname>Mathieu</firstname><surname>Schopfer</surname><affiliation><address><email>mat.schopfer@bluewin.ch</email></address></affiliation><contrib>Traduction française&nbsp;</contrib></othercredit>'>
+<!ENTITY relecteurMathieuSchopfer    '<othercredit role="reviewer"><firstname>Mathieu</firstname><surname>Schopfer</surname><affiliation><address><email>mat.schopfer@bluewin.ch</email></address></affiliation><contrib>Relecture de la documentation française&nbsp;</contrib></othercredit>'>
+
+
 <!ENTITY traducteurPenelopeSorveyron   '<othercredit role="translator"><firstname>Pénélope</firstname><surname>Sorveyron</surname><affiliation><address><email></email>goneri@free.fr</address></affiliation><contrib>Traduction française&nbsp;</contrib></othercredit>'>
 <!ENTITY relecteurPenelopeSorveyron    '<othercredit role="reviewer"><firstname>Pénélope</firstname><surname>Sorveyron</surname><affiliation><address><email>goneri@free.fr</email></address></affiliation><contrib>Relecture de la documentation française&nbsp;</contrib></othercredit>'>
 
@@ -303,6 +307,7 @@
 <!ENTITY BriceRothschild 'Brice Rothschild <email>brice.rothschild@gmail.com</email>'>
 <!ENTITY MickaelSibelle 'Mickaël Sibelle <email>kimael@gmail.com</email>'>
 <!ENTITY ArnaudMuchembled 'Arnaud Muchembled <email>arno.muchembled@orange.fr</email>'>
+<!ENTITY MathieuSchopfer 'Mathieu Schopfer <email>mat.schopfer@bluewin.ch</email>'>
 <!ENTITY PenelopeSorveyron 'Pénélope Sorveyron <email>goneri@free.fr</email>'>
 <!ENTITY NicolasTernissien   'Nicolas Ternissien <email>nicolast@libertysurf.fr</email>'>
 <!ENTITY GillesThioliere   'Gilles Thiolière <email>zhovirax@wanadoo.fr</email>'>
Index: kdoctools/customization/nl/user.entities
===================================================================
--- kdoctools/customization/nl/user.entities	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdoctools/customization/nl/user.entities	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -150,3 +150,4 @@
 <!ENTITY khc     "<application>KDE Helpcentrum</application>">
 <!ENTITY kic     "<application>KDE Informatiecentrum</application>">
 <!ENTITY palm     "PalmOS(tm)-apparaat">
+<!ENTITY systemsettings "<application>Systeeminstellingen</application>">
Index: kdoctools/customization/pl/user.entities
===================================================================
--- kdoctools/customization/pl/user.entities	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdoctools/customization/pl/user.entities	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -147,6 +147,11 @@
 <!ENTITY kwallet-biernik    '<application>Portfel &kde;</application>'>
 <!ENTITY kwallet    '&kwallet-mianownik;'>
 
+<!ENTITY ksnapshot-mianownik    '<application>Zrzuty ekranu</application>'>
+<!ENTITY ksnapshot-dopelniacz    '<application>Zrzutów ekranu</application>'>
+<!ENTITY ksnapshot-biernik    '<application>Zrzutom ekranu</application>'>
+<!ENTITY ksnapshot    '&ksnapshot-mianownik;'>
+
 <!ENTITY kwalletmanager-mianownik    '<application>Menedżer portfeli &kde;</application>'>
 <!ENTITY kwalletmanager-dopelniacz    '<application>Menedżera portfeli &kde;</application>'>
 <!ENTITY kwalletmanager    '&kwalletmanager-mianownik;'>
Index: kdoctools/customization/entities/general.entities
===================================================================
--- kdoctools/customization/entities/general.entities	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdoctools/customization/entities/general.entities	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -170,7 +170,7 @@
 <!ENTITY kapptemplate	"<application>KAppTemplate</application>">
 <!ENTITY kaphorism	"<application>KAphorism</application>">
 <!ENTITY karbon14	"<application>Karbon14</application>">
-<!ENTITY karm	"<application>ktimetracker</application>">
+<!ENTITY karm	"<application>KTimetracker</application>">
 <!ENTITY kasteroids	"<application>KAsteroids</application>">
 <!ENTITY kate	"<application>Kate</application>">
 <!ENTITY katomic	"<application>KAtomic</application>">
@@ -343,7 +343,7 @@
 <!ENTITY kthesaurus	"<application>KThesaurus</application>">
 <!ENTITY ktimemon	"<application>KTimemon</application>">
 <!ENTITY ktimer	"<application>KTimer</application>">
-<!ENTITY ktimetracker	"<application>ktimetracker</application>">
+<!ENTITY ktimetracker	"<application>KTimetracker</application>">
 <!ENTITY ktip	"<application>KTip</application>">
 <!ENTITY ktouch	"<application>KTouch</application>">
 <!ENTITY ktron	"<application>KTron</application>">
Index: kdoctools/customization/et/user.entities
===================================================================
--- kdoctools/customization/et/user.entities	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdoctools/customization/et/user.entities	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -50,6 +50,7 @@
 <!ENTITY dpi    '<acronym>dpi</acronym>'>
 <!ENTITY FAQ    '<acronym>KKK</acronym>'>
 <!ENTITY OS     "operatsioonisüsteem">		<!-- <acronym>OS</acronym>-->
+<!ENTITY systemsettings	"<application>Süsteemi seadistused</application>">
 <!ENTITY kcontrolcenter	    "KDE juhtimiskeskus">
 
 <!-- Custom entities -->
Index: kparts/krop.desktop
===================================================================
--- kparts/krop.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kparts/krop.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -32,6 +32,7 @@
 Comment[gu]=KDE ભાગ
 Comment[he]=רכיב של KDE
 Comment[hi]=केडीई अवयव
+Comment[hne]=केडीई अवयव
 Comment[hr]=KDE komponenta
 Comment[hsb]=KDE-komponenta
 Comment[hu]=KDE-komponens
Index: kparts/krwp.desktop
===================================================================
--- kparts/krwp.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kparts/krwp.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -32,6 +32,7 @@
 Comment[gu]=KDE ભાગ
 Comment[he]=רכיב של KDE
 Comment[hi]=केडीई अवयव
+Comment[hne]=केडीई अवयव
 Comment[hr]=KDE komponenta
 Comment[hsb]=KDE-komponenta
 Comment[hu]=KDE-komponens
Index: kparts/tests/notepad.desktop
===================================================================
--- kparts/tests/notepad.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kparts/tests/notepad.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,7 @@
 Name[gu]=નોટપેડ (ઉદાહરણ)
 Name[he]=פנקס רשימות (דוגמה)
 Name[hi]=नोटपैड (उदाहरण)
+Name[hne]=नोटपैड (उदाहरन)
 Name[hr]=Notepad (primjer)
 Name[hsb]=Zapisnik (přikład)
 Name[hu]=Jegyzettömb (példa)
Index: kparts/browserview.desktop
===================================================================
--- kparts/browserview.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kparts/browserview.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -32,6 +32,7 @@
 Name[gu]=બ્રાઉઝર દેખાવ
 Name[he]=תצוגת דפדפן
 Name[hi]=ब्राउज़र दृश्य
+Name[hne]=ब्राउजर दृस्य
 Name[hr]=Pogled pretraživača
 Name[hsb]=Browserowy napohlad
 Name[hu]=Böngészőnézet
Index: kparts/kpart.desktop
===================================================================
--- kparts/kpart.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kparts/kpart.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
 Comment[gu]=KDE ભાગ
 Comment[he]=רכיב של KDE
 Comment[hi]=केडीई अवयव
+Comment[hne]=केडीई अवयव
 Comment[hr]=KDE komponenta
 Comment[hsb]=KDE-komponenta
 Comment[hu]=KDE-komponens
Index: doc/kioslave/ftp/index.docbook
===================================================================
--- doc/kioslave/ftp/index.docbook	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ doc/kioslave/ftp/index.docbook	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -5,7 +5,7 @@
 <!ENTITY % English "INCLUDE" > <!-- change language only here -->
 ]>
 	
-<article id="ftp">
+<article lang="&language;" id="ftp">
 <title>&FTP;</title>
 <articleinfo>
 <authorgroup>
Index: sonnet/plugins/aspell/kspell_aspell.desktop
===================================================================
--- sonnet/plugins/aspell/kspell_aspell.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ sonnet/plugins/aspell/kspell_aspell.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -16,6 +16,7 @@
 Name[bn]=এ-স্পেল
 Name[gu]=એસ્પેલ
 Name[hi]=आस्पेल
+Name[hne]=आस्पेल
 Name[kn]=ಎಸ್ಪೆಲ್
 Name[mai]=आस्पेल
 Name[ml]=ആസ്പെല്‍
Index: sonnet/plugins/enchant/kspell_enchant.desktop
===================================================================
--- sonnet/plugins/enchant/kspell_enchant.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ sonnet/plugins/enchant/kspell_enchant.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -16,6 +16,7 @@
 Name[bn]=এনচান্ট
 Name[gu]=એન્ચાન્ટ
 Name[hi]=एनचैंट
+Name[hne]=एनचैंट
 Name[kn]=ಎಂಚಾಂಟ್
 Name[mai]=एनचैंट
 Name[ml]=എന്‍ചാന്റ്
Index: sonnet/plugins/hspell/kspell_hspell.desktop
===================================================================
--- sonnet/plugins/hspell/kspell_hspell.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ sonnet/plugins/hspell/kspell_hspell.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -16,6 +16,7 @@
 Name[bn]=এইচ-স্পেল
 Name[gu]=હસ્પેલ
 Name[hi]=एचस्पेल
+Name[hne]=एचस्पेल
 Name[kn]=ಎಚ್ ಸ್ಪೆಲ್
 Name[mai]=एचस्पेल
 Name[ml]=എച്ച്സ്പെല്‍
Index: includes/DNSSD/ServiceTypeBrowser
===================================================================
--- includes/DNSSD/ServiceTypeBrowser	(.../tags/KDE/4.2.0/kdelibs)	(wersja 0)
+++ includes/DNSSD/ServiceTypeBrowser	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -0,0 +1 @@
+#include "../../dnssd/servicetypebrowser.h"
Index: includes/CMakeLists.txt
===================================================================
--- includes/CMakeLists.txt	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ includes/CMakeLists.txt	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -484,6 +484,7 @@
   DNSSD/ServiceBase
   DNSSD/ServiceBrowser
   DNSSD/ServiceModel
+  DNSSD/ServiceTypeBrowser
 DESTINATION ${INCLUDE_INSTALL_DIR}/KDE/DNSSD COMPONENT Devel)
 
 
Index: kded/kdedmodule.desktop
===================================================================
--- kded/kdedmodule.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kded/kdedmodule.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -30,6 +30,7 @@
 Comment[gu]=KDED મોડ્યુલ
 Comment[he]=מודול KDED
 Comment[hi]=केडीईडी मॉड्यूल
+Comment[hne]=केडीईडी माड्यूल
 Comment[hr]=KDED modul
 Comment[hsb]=KDED modul
 Comment[hu]=KDED modul
Index: kded/kded.cpp
===================================================================
--- kded/kded.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kded/kded.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -115,9 +115,8 @@
    KToolInvocation::kdeinitExecWait( "kdontchangethehostname", args );
 }
 
-Kded::Kded(bool checkUpdates)
-  : b_checkUpdates(checkUpdates),
-    m_needDelayedCheck(false)
+Kded::Kded()
+  : m_needDelayedCheck(false)
 {
   _self = this;
 
@@ -280,7 +279,7 @@
     KSharedConfig::Ptr config = KGlobal::config();
     // Ensure the service exists.
     KService::Ptr service = KService::serviceByDesktopPath("kded/"+obj+".desktop");
-    if (!service) 
+    if (!service)
         return;
     KConfigGroup cg(config, QString("Module-%1").arg(service->desktopEntryName()));
     cg.writeEntry("autoload", autoload);
@@ -290,7 +289,7 @@
 bool Kded::isModuleAutoloaded(const QString &obj) const
 {
     KService::Ptr s = KService::serviceByDesktopPath("kded/"+obj+".desktop");
-    if (!s) 
+    if (!s)
         return false;
     return isModuleAutoloaded(s);
 }
@@ -307,7 +306,7 @@
 bool Kded::isModuleLoadedOnDemand(const QString &obj) const
 {
     KService::Ptr s = KService::serviceByDesktopPath("kded/"+obj+".desktop");
-    if (!s) 
+    if (!s)
         return false;
     return isModuleLoadedOnDemand(s);
 }
@@ -446,7 +445,7 @@
 
 void Kded::updateDirWatch()
 {
-  if (!b_checkUpdates) return;
+  if (!bCheckUpdates) return;
 
   delete m_pDirWatch;
   m_pDirWatch = new KDirWatch;
@@ -471,7 +470,7 @@
 {
   delete KSycoca::self();
 
-  if (!b_checkUpdates) return;
+  if (!bCheckUpdates) return;
 
   if (delayedCheck) return;
 
@@ -921,7 +920,7 @@
      checkStamps = cg.readEntry("CheckFileStamps", true);
      delayedCheck = cg.readEntry("DelayedCheck", false);
 
-     Kded *kded = new Kded(false); // Build data base
+     Kded *kded = new Kded(); // Build data base
 
      KDE_signal(SIGTERM, sighandler);
      KDE_signal(SIGHUP, sighandler);
Index: kded/kbuildsycoca.cpp
===================================================================
--- kded/kbuildsycoca.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kded/kbuildsycoca.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -514,7 +514,7 @@
 
    // Calculate per-servicetype/mimetype data
    mimeTypeFactory->parseSubclasses();
-   serviceFactory->populateServiceTypes();
+   serviceFactory->postProcessServices();
 
    // Write factory data....
    for(KSycocaFactoryList::Iterator factory = factories()->begin();
Index: kded/kbuildservicefactory.cpp
===================================================================
--- kded/kbuildservicefactory.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kded/kbuildservicefactory.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -193,13 +193,50 @@
     }
 }
 
+void KBuildServiceFactory::postProcessServices()
+{
+    // By doing all this here rather than in addEntry (and removing when replacing
+    // with local override), we only do it for the final applications.
 
+    // For every service...
+    KSycocaEntryDict::Iterator itserv = m_entryDict->begin();
+    const KSycocaEntryDict::Iterator endserv = m_entryDict->end();
+    for( ; itserv != endserv ; ++itserv ) {
+
+        KSycocaEntry::Ptr entry = *itserv;
+        KService::Ptr service = KService::Ptr::staticCast(entry);
+
+        if (!service->isDeleted()) {
+            const QString parent = service->parentApp();
+            if (!parent.isEmpty())
+                m_serviceGroupFactory->addNewChild(parent, KSycocaEntry::Ptr::staticCast(service));
+        }
+
+        const QString name = service->desktopEntryName();
+        m_nameDict->add(name, entry);
+        m_nameMemoryHash.insert(name, service);
+
+        const QString relName = service->entryPath();
+        //kDebug(7021) << "adding service" << service.data() << service->menuId() << "name=" << name << "relName=" << relName;
+        m_relNameDict->add(relName, entry);
+        m_relNameMemoryHash.insert(relName, service); // for KMimeAssociations
+
+        const QString menuId = service->menuId();
+        if (!menuId.isEmpty()) { // empty for services, non-empty for applications
+            m_menuIdDict->add(menuId, entry);
+            m_menuIdMemoryHash.insert(menuId, service); // for KMimeAssociations
+        }
+    }
+    populateServiceTypes();
+}
+
 void KBuildServiceFactory::populateServiceTypes()
 {
     // For every service...
     KSycocaEntryDict::Iterator itserv = m_entryDict->begin();
     const KSycocaEntryDict::Iterator endserv = m_entryDict->end();
     for( ; itserv != endserv ; ++itserv ) {
+
         KService::Ptr service = KService::Ptr::staticCast(*itserv);
         QVector<KService::ServiceTypeAndPreference> serviceTypeList = service->_k_accessServiceTypes();
         //bool hasAllAll = false;
@@ -336,30 +373,18 @@
     if (m_dupeDict.contains(newEntry))
         return;
 
-    KSycocaFactory::addEntry(newEntry);
-
     const KService::Ptr service = KService::Ptr::staticCast( newEntry );
     m_dupeDict.insert(newEntry);
 
-    if (!service->isDeleted()) {
-        const QString parent = service->parentApp();
-        if (!parent.isEmpty())
-            m_serviceGroupFactory->addNewChild(parent, KSycocaEntry::Ptr::staticCast(service));
+    KSycocaEntry::Ptr oldEntry = m_entryDict->value(newEntry->storageId());
+    if (oldEntry) {
+        // Already exists -> replace
+        //KService::Ptr oldService = KService::Ptr::staticCast(oldEntry);
+        // We found a more-local override, e.g. ~/.local/share/applications/kde4/foo.desktop
+        // So forget about the more global file.
+        //kDebug(7021) << "removing" << oldService.data() << oldService->entryPath() << "because of" << service->entryPath();
+        KSycocaFactory::removeEntry(newEntry->storageId());
     }
 
-    const QString name = service->desktopEntryName();
-    m_nameDict->add( name, newEntry );
-    m_nameMemoryHash.insert(name, service);
-
-    const QString relName = service->entryPath();
-    //kDebug(7021) << "adding service" << service->menuId() << "name=" << name << "relName=" << relName;
-    m_relNameDict->add( relName, newEntry );
-    m_relNameMemoryHash.insert(relName, service); // for KMimeAssociations
-
-    const QString menuId = service->menuId();
-    if (!menuId.isEmpty()) {
-        m_menuIdDict->add( menuId, newEntry );
-        m_menuIdMemoryHash.insert(menuId, service); // for KMimeAssociations
-    }
+    KSycocaFactory::addEntry(newEntry);
 }
-
Index: kded/kded.h
===================================================================
--- kded/kded.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kded/kded.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -41,7 +41,7 @@
 {
   Q_OBJECT
 public:
-   Kded(bool checkUpdates);
+   Kded();
    virtual ~Kded();
 
    static Kded *self() { return _self;}
@@ -186,8 +186,6 @@
     */
    KDirWatch* m_pDirWatch;
 
-   bool b_checkUpdates;
-
    /**
     * When a desktop file is updated, a timer is started (5 sec)
     * before rebuilding the binary - so that multiple updates result
Index: kded/vfolder_menu.cpp
===================================================================
--- kded/vfolder_menu.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kded/vfolder_menu.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -349,7 +349,7 @@
 VFolderMenu::addApplication(const QString &id, KService::Ptr service)
 {
    service->setMenuId(id);
-   m_appsInfo->applications.insert(id, service);
+   m_appsInfo->applications.insert(id, service); // replaces, if already there
    m_serviceFactory->addEntry(KSycocaEntry::Ptr::staticCast(service));
 }
 
@@ -1029,7 +1029,7 @@
 void
 VFolderMenu::processKDELegacyDirs()
 {
-kDebug(7021) << "processKDELegacyDirs()";
+    kDebug(7021);
 
    QHash<QString,KService::Ptr> items;
    QString prefix = "kde4-";
@@ -1091,7 +1091,7 @@
 void
 VFolderMenu::processLegacyDir(const QString &dir, const QString &relDir, const QString &prefix)
 {
-kDebug(7021).nospace() << "processLegacyDir(" << dir << ", " << relDir << ", " << prefix << ")";
+    kDebug(7021).nospace() << "processLegacyDir(" << dir << ", " << relDir << ", " << prefix << ")";
 
    QHash<QString,KService::Ptr> items;
    // We look for a set of files.
Index: kded/kbuildservicefactory.h
===================================================================
--- kded/kbuildservicefactory.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kded/kbuildservicefactory.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -83,9 +83,10 @@
      */
     static QStringList resourceTypes();
 
-    void populateServiceTypes();
+    void postProcessServices();
 
 private:
+    void populateServiceTypes();
     void saveOfferList(QDataStream &str);
     void collectInheritedServices();
     void collectInheritedServices(KMimeType::Ptr mime, QSet<KMimeType::Ptr>& visitedMimes);
Index: solid/solid/backends/hal/halstorageaccess.cpp
===================================================================
--- solid/solid/backends/hal/halstorageaccess.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ solid/solid/backends/hal/halstorageaccess.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -314,6 +314,8 @@
             options<<"utf8";
         else if (halOptions.contains("iocharset="))
             options<<"iocharset=utf8";
+        if (halOptions.contains("shortname="))
+            options<<"shortname=mixed";
     }
     // pass our locale to the ntfs-3g driver so it can translate local characters
     else if ( halOptions.contains("locale=") ) {
Index: mimetypes/kde.xml
===================================================================
--- mimetypes/kde.xml	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ mimetypes/kde.xml	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -395,6 +395,48 @@
     <glob pattern="*.wsz"/>
   </mime-type>
 
+  <mime-type type="application/x-mplayer2"> <!-- fdo #19671 -->
+    <comment>Microsoft Media Format</comment>
+    <sub-class-of type="video/x-ms-wmv"/>
+    <alias type="video/mediaplayer"/>
+    <alias type="video/x-ms-wmp"/>
+    <glob pattern="*.wmp"/>
+  </mime-type>
+  <mime-type type="application/vnd.ms-asf"> <!-- fdo #19671 -->
+    <comment>Microsoft Media Format</comment>
+    <sub-class-of type="video/x-ms-wmv"/>
+  </mime-type>
+  <mime-type type="application/x-ogg"> <!-- fdo #19671 -->
+    <comment>Ogg multimedia file</comment>
+    <sub-class-of type="application/ogg"/>
+  </mime-type>
+  <mime-type type="audio/m3u"> <!-- fdo #19671 -->
+    <comment>MP3 audio</comment>
+    <sub-class-of type="audio/x-mpegurl"/>
+    <alias type="audio/x-m3u"/>
+  </mime-type>
+  <mime-type type="audio/vorbis"> <!-- fdo #19671 -->
+    <comment>Vorbis audio</comment>
+    <sub-class-of type="audio/ogg"/>
+    <alias type="audio/x-vorbis"/>
+  </mime-type>
+  <mime-type type="audio/x-mp2"> <!-- fdo #19671 -->
+    <comment>MP2 audio</comment>
+    <sub-class-of type="audio/mp2"/>
+  </mime-type>
+  <mime-type type="audio/x-oggflac"> <!-- fdo #19671 -->
+    <comment>MP2 audio</comment>
+    <sub-class-of type="audio/x-flac+ogg"/>
+  </mime-type>
+  <mime-type type="video/x-ogm"> <!-- fdo #19671 -->
+    <comment>Ogg/Ogm Video</comment>
+    <sub-class-of type="video/x-ogm+ogg"/>
+  </mime-type>
+  <mime-type type="video/x-theora"> <!-- fdo #19671 -->
+    <comment>Ogg/Ogm Video</comment>
+    <sub-class-of type="video/x-theora+ogg"/>
+  </mime-type>
+
   <mime-type type="application/x-kexiproject-shortcut">
     <comment>shortcut to Kexi project on database server</comment>
     <glob pattern="*.kexis"/>
Index: CMakeLists.txt
===================================================================
--- CMakeLists.txt	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ CMakeLists.txt	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -51,6 +51,11 @@
 find_package(Strigi REQUIRED)
 
 #optional features
+if(X11_FOUND)
+  #X11_Xrender discovery is done by FindX11
+  macro_log_feature(X11_Xrender_FOUND "X Rendering extension" "an X Window System extension for image compositing" "http://www.x.org" FALSE "" "STRONGLY RECOMMENDED: For compositing, rendering operations, and alpha-blending.")
+endif(X11_FOUND)
+
 macro_optional_find_package(BZip2)
 macro_log_feature(BZIP2_FOUND "BZip2" "A high-quality data compressor" "http://www.bzip.org" FALSE "" "STRONGLY RECOMMENDED: Provides the ability to read and write bzip2 compressed data files.")
 
Index: kioslave/file/file.cpp
===================================================================
--- kioslave/file/file.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kioslave/file/file.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -241,7 +241,7 @@
     kDebug(7101) << "mkdir(): " << _path << ", permission = " << permissions;
 
     KDE_struct_stat buff;
-    if ( KDE_stat( _path.data(), &buff ) == -1 ) {
+    if ( KDE_lstat( _path.data(), &buff ) == -1 ) {
         if ( KDE_mkdir( _path.data(), 0777 /*umask will be applied*/ ) != 0 ) {
             if ( errno == EACCES ) {
           error( KIO::ERR_ACCESS_DENIED, _path );
Index: kioslave/http/kcookiejar/kcookiejar.desktop
===================================================================
--- kioslave/http/kcookiejar/kcookiejar.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kioslave/http/kcookiejar/kcookiejar.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,7 @@
 Name[gu]=KDED કૂકી જાર મોડ્યુલ
 Name[he]=מודול צנצנת העוגיות של KDED
 Name[hi]=केडीईडी कुकी जार मॉड्यूल
+Name[hne]=केडीईडी कुकी जार माड्यूल
 Name[hr]=KDED modul za čuvanje kolačića
 Name[hsb]=KDED Plackowy modul
 Name[hu]=KDED cookie-modul
@@ -109,6 +110,7 @@
 Comment[gu]=સિસ્ટમની બધી કૂકીઓની નજર રાખે છે
 Comment[he]=עוקב אחר כל העוגיות במערכת
 Comment[hi]=तंत्र में सभी कुकी का अता-पता बनाए रखता है
+Comment[hne]=तंत्र मं सब्बो कुकी के अता-पता बनाए रखथे 
 Comment[hr]=Vođenje evidencije o svim kolačićima na sustavu
 Comment[hsb]=Stara so wo wšě placki w systemje
 Comment[hu]=Nyomon követi a rendszerben létrejövő cookie-kat
Index: kioslave/http/http.cpp
===================================================================
--- kioslave/http/http.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kioslave/http/http.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -5,7 +5,7 @@
    Copyright (C) 2001,2002 Hamish Rodda <rodda@kde.org>
    Copyright (C) 2007      Nick Shaforostoff <shafff@ukr.net>
    Copyright (C) 2007      Daniel Nicoletti <mirttex@users.sourceforge.net>
-   Copyright (C) 2008      Andreas Hartmetz <ahartmetz@gmail.com>
+   Copyright (C) 2008,2009 Andreas Hartmetz <ahartmetz@gmail.com>
 
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
@@ -27,7 +27,6 @@
 #include "http.h"
 
 #include <config.h>
-#include <config-gssapi.h>
 
 #include <fcntl.h>
 #include <utime.h>
@@ -90,6 +89,8 @@
 
 //string parsing helpers and HeaderTokenizer implementation
 #include "parsinghelpers.cpp"
+//authentication handlers
+#include "httpauthentication.cpp"
 
 using namespace KIO;
 
@@ -174,6 +175,16 @@
     return p == "https" || p == "webdavs"; 
 }
 
+static bool isValidProxy(const KUrl &u)
+{
+    return u.isValid() && u.hasHost();
+}
+
+static bool isHttpProxy(const KUrl &u)
+{
+    return isValidProxy(u) && u.protocol() == "http";
+}
+
 static QString methodString(HTTP_METHOD m)
 {
     switch(m) {
@@ -244,6 +255,10 @@
     , m_maxCacheAge(DEFAULT_MAX_CACHE_AGE)
     , m_maxCacheSize(DEFAULT_MAX_CACHE_SIZE/2)
     , m_protocol(protocol)
+    , m_wwwAuth(0)
+    , m_proxyAuth(0)
+    , m_socketProxyAuth(0)
+    , m_isError(false)
     , m_remoteRespTimeout(DEFAULT_RESPONSE_TIMEOUT)
 {
     reparseConfiguration();
@@ -261,15 +276,14 @@
 {
     kDebug(7113);
 
-    m_proxyAuth.realm.clear();
-    m_proxyAuth.authorization.clear();
-    m_proxyAuth.scheme = AUTH_None;
+    delete m_proxyAuth;
+    delete m_wwwAuth;
+    m_proxyAuth = 0;
+    m_wwwAuth = 0;
     m_request.proxyUrl.clear(); //TODO revisit
 
     if (isEncryptedHttpVariety(m_protocol))
         m_defaultPort = DEFAULT_HTTPS_PORT;
-    else if (m_protocol == "ftp")
-        m_defaultPort = DEFAULT_FTP_PORT;
     else
         m_defaultPort = DEFAULT_HTTP_PORT;
 }
@@ -278,8 +292,6 @@
 {
   m_isEOF = false;
   m_isError = false;
-  m_auth.authCount = 0;
-  m_proxyAuth.authCount = 0;
 }
 
 void HTTPProtocol::resetResponseParsing()
@@ -305,6 +317,7 @@
   KUrl proxy ( config()->readEntry("UseProxy") );
   QNetworkProxy::ProxyType proxyType = QNetworkProxy::NoProxy;
 
+#if 0
   if ( m_proxyAuth.realm.isEmpty() || !proxy.isValid() ||
        m_request.proxyUrl.host() != proxy.host() ||
        m_request.proxyUrl.port() != proxy.port() ||
@@ -313,12 +326,17 @@
   {
     m_request.proxyUrl = proxy;
 
-    kDebug(7113) << "Using proxy:" << m_request.proxyUrl.isValid()
+    kDebug(7113) << "Using proxy:" << m_request.useProxy()
                  << "URL: " << m_request.proxyUrl.url()
                  << "Realm: " << m_proxyAuth.realm;
   }
+#endif
+    m_request.proxyUrl = proxy;
+    kDebug(7113) << "Using proxy:" << isValidProxy(m_request.proxyUrl)
+                 << "URL: " << m_request.proxyUrl.url();
+                 //<< "Realm: " << m_proxyAuth.realm;
 
-  if (m_request.proxyUrl.isValid() && m_request.proxyUrl.hasHost()) {
+  if (isValidProxy(m_request.proxyUrl)) {
       if (m_request.proxyUrl.protocol() == "socks") {
           // Let Qt do SOCKS because it's already implemented there...
           proxyType = QNetworkProxy::Socks5Proxy;
@@ -336,11 +354,12 @@
                          m_request.proxyUrl.user(), m_request.proxyUrl.pass());
   QNetworkProxy::setApplicationProxy(appProxy);
 
+  if (isHttpProxy(m_request.proxyUrl) && !isAutoSsl()) {
+    m_request.isKeepAlive = config()->readEntry("PersistentProxyConnection", false);
+    kDebug(7113) << "Enable Persistent Proxy Connection: "
+                 << m_request.isKeepAlive;
+  }
 
-  m_request.isPersistentProxyConnection = config()->readEntry("PersistentProxyConnection", false);
-  kDebug(7113) << "Enable Persistent Proxy Connection: "
-                << m_request.isPersistentProxyConnection;
-
   m_request.useCookieJar = config()->readEntry("Cookies", false);
   m_request.cacheTag.useCache = config()->readEntry("UseCache", true);
   m_request.preferErrorPage = config()->readEntry("errorPage", true);
@@ -421,9 +440,10 @@
   m_request.responseCode = 0;
   m_request.prevResponseCode = 0;
 
-  m_auth.realm.clear();
-  m_auth.authorization.clear();
-  m_auth.scheme = AUTH_None;
+  delete m_wwwAuth;
+  m_wwwAuth = 0;
+  delete m_socketProxyAuth;
+  m_socketProxyAuth = 0;
 
   // Obtain timeout values
   m_remoteRespTimeout = responseTimeout();
@@ -436,7 +456,6 @@
   // the persistent link has been terminated by the remote end.
   m_request.isKeepAlive = true;
   m_request.keepAliveTimeout = 0;
-  m_isUnauthorized = false;
 
   // A single request can require multiple exchanges with the remote
   // server due to authentication challenges or SSL tunneling.
@@ -561,6 +580,10 @@
           return false;
       }
 
+      if (!m_request.isKeepAlive) {
+          httpCloseConnection();
+      }
+
       // update for the next go-around to have current information
       Q_ASSERT_X(!m_request.cacheTag.readFromCache, "proceedUntilResponseHeader()",
                  "retrying a request even though the result is cached?!");
@@ -577,11 +600,6 @@
   setMetaData("responsecode", QString::number(m_request.responseCode));
   setMetaData("content-type", m_mimeType);
 
-  if (m_request.responseCode < 400 &&
-      (m_request.prevResponseCode == 401 || m_request.prevResponseCode == 407)) {
-      saveAuthorization(m_request.prevResponseCode == 407);
-  }
-
   // At this point sendBody() should have delivered any POST data.
   m_POSTbuf.clear();
 
@@ -1843,6 +1861,8 @@
     m_unreadBuf.clear();
 }
 
+// Note: the implementation of unread/readBuffered assumes that unread will only
+// be used when there is extra data we don't want to handle, and not to wait for more data.
 void HTTPProtocol::unread(char *buf, size_t size)
 {
     // implement LIFO (stack) semantics
@@ -1868,6 +1888,10 @@
             buf[i] = m_unreadBuf.constData()[bufSize - i - 1];
         }
         m_unreadBuf.truncate(bufSize - bytesRead);
+
+        // if we have an unread buffer, return here, since we may already have enough data to
+        // complete the response, so we don't want to wait for more.
+        return bytesRead;
     }
     if (bytesRead < size) {
         int rawRead = TCPSlaveBase::read(buf + bytesRead, size - bytesRead);
@@ -1937,7 +1961,7 @@
   // TODO compare current proxy state against proxy needs of next request,
   // *when* we actually have variable proxy settings!
 
-  if (m_request.proxyUrl.isValid())  {
+  if (isValidProxy(m_request.proxyUrl))  {
       if (m_request.proxyUrl != m_server.proxyUrl ||
           m_request.proxyUrl.user() != m_server.proxyUrl.user() ||
           m_request.proxyUrl.pass() != m_server.proxyUrl.pass()) {
@@ -1967,7 +1991,7 @@
   clearUnreadBuffer();
 
   bool connectOk = false;
-  if (m_request.proxyUrl.isValid() && m_request.proxyUrl.protocol() == "http" && !isAutoSsl()) {
+  if (isHttpProxy(m_request.proxyUrl) && !isAutoSsl()) {
       connectOk = connectToHost(m_request.proxyUrl.protocol(), m_request.proxyUrl.host(), m_request.proxyUrl.port());
   } else {
       connectOk = connectToHost(m_protocol, m_request.url.host(), m_request.url.port());
@@ -1983,6 +2007,7 @@
 #endif
 
   m_isFirstRequest = true;
+  m_server.initFrom(m_request);
   connected();
   return true;
 }
@@ -2000,7 +2025,7 @@
 
         m_request.cacheTag.gzs = checkCacheEntry();
         bool bCacheOnly = (m_request.cacheTag.policy == KIO::CC_CacheOnly);
-        bool bOffline = isOffline(m_request.proxyUrl.isValid() ? m_request.proxyUrl : m_request.url);
+        bool bOffline = isOffline(isValidProxy(m_request.proxyUrl) ? m_request.proxyUrl : m_request.url);
 
         if (bOffline && m_request.cacheTag.policy != KIO::CC_Reload) {
             m_request.cacheTag.policy= KIO::CC_CacheOnly;
@@ -2049,7 +2074,7 @@
     // Only specify protocol, host and port when they are not already clear, i.e. when
     // we handle HTTP proxying ourself and the proxy server needs to know them.
     // Sending protocol/host/port in other cases confuses some servers, and it's not their fault.
-    if (m_request.proxyUrl.isValid() && m_request.proxyUrl.protocol() == "http" && !isAutoSsl()) {
+    if (isHttpProxy(m_request.proxyUrl) && !isAutoSsl()) {
         KUrl u;
 
         QString protocol = m_protocol;
@@ -2206,11 +2231,16 @@
     // purposes as well as performance improvements while giving end
     // users the ability to disable this feature proxy servers that
     // don't not support such feature, e.g. junkbuster proxy server.
-    if (!m_request.proxyUrl.isValid() || m_request.isPersistentProxyConnection) {
-        header += "Connection: Keep-Alive\r\n";
+    if (isHttpProxy(m_request.proxyUrl) && !isAutoSsl()) {
+        header += "Proxy-Connection: ";
     } else {
-        header += "Connection: close\r\n";
+        header += "Connection: ";
     }
+    if (m_request.isKeepAlive) {
+        header += "Keep-Alive\r\n";
+    } else {
+        header += "close\r\n";
+    }
 
     if (!m_request.userAgent.isEmpty())
     {
@@ -2313,17 +2343,11 @@
     // Remember that at least one failed (with 401 or 407) request/response
     // roundtrip is necessary for the server to tell us that it requires
     // authentication.
-    // If we already have cached credentials, or we have obtained authentication
-    // data from the user since the previous attempt, we add that information here.
-    header += wwwAuthenticationHeader();
+    // We proactively add authentication headers if we have cached credentials
+    // to avoid the extra roundtrip where possible.
+    // (TODO: implement this caching)
+    header += authenticationHeader();
 
-    // Do we need to authorize to the proxy server ?
-    if (m_request.proxyUrl.isValid()) {
-      if ( m_request.isPersistentProxyConnection )
-        header += "Proxy-Connection: Keep-Alive\r\n";
-      header += proxyAuthenticationHeader();
-    }
-
     if ( m_protocol == "webdav" || m_protocol == "webdavs" )
     {
       header += davProcessLocks();
@@ -2358,7 +2382,11 @@
   // Now that we have our formatted header, let's send it!
   // Create a new connection to the remote machine if we do
   // not already have one...
-  if ( !isConnected() )
+  // NB: the !m_socketProxyAuth condition is a workaround for a proxied Qt socket sometimes
+  // looking disconnected after receiving the initial 407 response.
+  // I guess the Qt socket fails to hide the effect of  proxy-connection: close after receiving
+  // the 407 header.
+  if ((!isConnected() && !m_socketProxyAuth))
   {
     if (!httpOpenConnection())
     {
@@ -2572,7 +2600,6 @@
     int maxAge = -1; // -1 = no max age, 0 already expired, > 0 = actual time
     static const int maxHeaderSize = 128 * 1024;
 
-    int len = 0;
     char buffer[maxHeaderSize];
     bool cont = false;
     bool cacheValidated = false; // Revalidation was successful
@@ -2623,7 +2650,6 @@
     kDebug(7103) << "============ Received Status Response:";
     kDebug(7103) << QByteArray(buffer, bufPos);
 
-    bool noHeader = true;
     HTTP_REV httpRev = HTTP_None;
     int headerSize = 0;
 
@@ -2700,14 +2726,6 @@
         mayCache = false;
     } else if (m_request.responseCode == 401 || m_request.responseCode == 407) {
         // Unauthorized access
-    
-        // Double authorization requests, i.e. a proxy auth
-        // request followed immediately by a regular auth request.
-        if (m_request.prevResponseCode != m_request.responseCode &&
-            (m_request.prevResponseCode == 401 || m_request.prevResponseCode == 407)) {
-            saveAuthorization(m_request.prevResponseCode == 407);
-        }
-        m_isUnauthorized = true;
         m_request.cacheTag.writeToCache = false; // Don't put in cache
         mayCache = false;
     } else if (m_request.responseCode == 416) {
@@ -2796,6 +2814,29 @@
         cont = true;
     }
 
+
+    {
+        const bool wasAuthError = m_request.prevResponseCode == 401 || m_request.prevResponseCode == 407;
+        const bool isAuthError = m_request.responseCode == 401 || m_request.responseCode == 407;
+        // Not the same authorization error as before and no generic error?
+        // -> save the successful credentials.
+        if (wasAuthError && (m_request.responseCode < 400 ||
+                             (isAuthError && m_request.responseCode != m_request.prevResponseCode))) {
+            KIO::AuthInfo authi;
+            KAbstractHttpAuthentication *auth;
+            if (m_request.prevResponseCode == 401) {
+                auth = m_wwwAuth;
+            } else {
+                auth = m_proxyAuth;
+            }
+            Q_ASSERT(auth);
+            if (auth) {
+                auth->fillKioAuthInfo(&authi);
+                cacheAuthentication(authi);
+            }
+        }
+    }
+
     // done with the first line; now tokenize the other lines
 
   endParsing: //### if we goto here nothing good comes out of it. rethink.
@@ -2963,18 +3004,6 @@
         cookieStr += '\n';
     }
 
-    // check for direct authentication
-    tIt = tokenizer.iterator("www-authenticate");
-    if (tIt.hasNext()) {
-        configAuth(tIt.all(), false);
-    }
-
-    // check for proxy-based authentication
-    tIt = tokenizer.iterator("proxy-authenticate");
-    if (tIt.hasNext()) {
-        configAuth(tIt.all(), true);
-    }
-
     tIt = tokenizer.iterator("upgrade");
     if (tIt.hasNext()) {
         // Now we have to check to see what is offered for the upgrade
@@ -3014,7 +3043,7 @@
     }
     
     tIt = tokenizer.iterator("proxy-connection");
-    if (tIt.hasNext()) {
+    if (tIt.hasNext() && isHttpProxy(m_request.proxyUrl) && !isAutoSsl()) {
         QByteArray pc = tIt.next().toLower();
         if (pc.startsWith("close")) {
             m_request.isKeepAlive = false;
@@ -3074,11 +3103,14 @@
         tIt = tokenizer.iterator("connection");
         while (tIt.hasNext()) {
             QByteArray connection = tIt.next().toLower();
-            if (connection.startsWith("close")) {
-                m_request.isKeepAlive = false;
-            } else if (connection.startsWith("keep-alive")) {
-                m_request.isKeepAlive = true;
-            } else if (connection.startsWith("upgrade")) {
+            if (!(isHttpProxy(m_request.proxyUrl) && !isAutoSsl())) {
+                if (connection.startsWith("close")) {
+                    m_request.isKeepAlive = false;
+                } else if (connection.startsWith("keep-alive")) {
+                    m_request.isKeepAlive = true;
+                }
+            }
+            if (connection.startsWith("upgrade")) {
                 if (m_request.responseCode == 101) {
                     // Ok, an upgrade was accepted, now we must do it
                     upgradeRequired = true;
@@ -3131,18 +3163,6 @@
         }
     }
 
-    // If we do not support the requested authentication method...
-    if ((m_request.responseCode == 401 && m_auth.scheme == AUTH_None) ||
-        (m_request.responseCode == 407 && m_proxyAuth.scheme == AUTH_None)) {
-        m_isUnauthorized = false;
-        if (m_request.preferErrorPage) {
-            errorPage();
-        } else {
-            error( ERR_UNSUPPORTED_ACTION, "Unknown Authorization method!" );
-            return false;
-        }
-    }
-
   // Fixup expire date for clock drift.
   if (expireDate && (expireDate <= dateHeader))
     expireDate = 1; // Already expired.
@@ -3245,46 +3265,120 @@
     return true;
   }
 
-  // We need to try to login again if we failed earlier
-  if (m_isUnauthorized) {
+    // TODO cache the proxy auth data (not doing this means a small performance regression for now)
 
-      kDebug(7113) << "Trace A" << m_request.responseCode << m_request.proxyUrl.prettyUrl();
+    // we may need to send (Proxy or WWW) authorization data
+    bool authRequiresAnotherRoundtrip = false;
+    if (!m_request.doNotAuthenticate && (m_request.responseCode == 401 ||
+                                         m_request.responseCode == 407)) {
+        authRequiresAnotherRoundtrip = true;
 
-      if ((m_request.responseCode == 401) ||
-          (m_request.responseCode == 407 && m_request.proxyUrl.isValid())) {
+        KAbstractHttpAuthentication **auth = &m_wwwAuth;
+        tIt = tokenizer.iterator("www-authenticate");
+        KUrl resource = m_request.url;
+        if (m_request.responseCode == 407) {
+            // make sure that the 407 header hasn't escaped a lower layer when it shouldn't.
+            // this may break proxy chains which were never tested anyway, and AFAIK they are
+            // rare to nonexistent in the wild.
+            Q_ASSERT(QNetworkProxy::applicationProxy().type() == QNetworkProxy::NoProxy);
 
-          kDebug(7113) << "Trace B";
+            auth = &m_proxyAuth;
+            tIt = tokenizer.iterator("proxy-authenticate");
+            resource = m_request.proxyUrl;
+        }
 
-          if (getAuthorization()) {
-              // for NTLM authentication we have to keep the connection open!
-              if (m_auth.scheme == AUTH_NTLM && m_auth.authorization.length() > 4) {
-                  m_request.isKeepAlive = true;
-                  readBody(true);
-              } else if (m_proxyAuth.scheme == AUTH_NTLM && m_proxyAuth.authorization.length() > 4) {
-                  readBody(true);
-              } else {
-                  // discard anything waiting in the read buffers - servers may send
-                  // an explanatory HTML page together with the 40x status code.
-                  // an alternative, more tricky but with less reconnection overhead, is
-                  // readBody(true).
-                  httpCloseConnection();
-              }
-              
-              kDebug(7113) << "Trace C";
-              
-              return false; // Try again.
-          }
+        kDebug(7113) << "parsing authentication request; response code =" << m_request.responseCode;
 
-          if (m_isError) {
-              kDebug(7113) << "Trace D";
-              return false; // Error out
-          }
-      }
-      // readBody(true);   // discard the body to keep processing in sync
-      kDebug(7113) << "Trace E";
-      m_isUnauthorized = false;
-  }
+        QByteArray bestOffer = KAbstractHttpAuthentication::bestOffer(tIt.all());
+        if (*auth) {
+            if (!bestOffer.toLower().startsWith((*auth)->scheme().toLower())) {
+                // huh, the strongest authentication scheme offered has changed.
+                kDebug(7113) << "deleting old auth class, scheme mismatch.";
+                delete *auth;
+                *auth = 0;
+            }
+        }
+        kDebug(7113) << "strongest authentication scheme offered is" << bestOffer;
+        if (!(*auth)) {
+            *auth = KAbstractHttpAuthentication::newAuth(bestOffer);
+        }
+        kDebug(7113) << "pointer to auth class is now" << *auth;
+        if (!(*auth)) {
+            if (m_request.preferErrorPage) {
+                errorPage();
+            } else {
+                error(ERR_UNSUPPORTED_ACTION, "Unknown Authorization method!");
+                return false;
+            }
+            //### return false; ?
+        }
 
+        // remove trailing space from the method string, or digest auth will fail :)
+        QByteArray requestMethod = methodString(m_request.method).toLatin1().trimmed();
+        (*auth)->setChallenge(bestOffer, resource, requestMethod);
+
+        //### (or somehow weave AuthInfo handling into the auth classes!)
+        QString username;
+        QString password;
+        if ((*auth)->needCredentials()) {
+            // try to get credentials from kpasswdserver's cache, then try asking the user.
+            KIO::AuthInfo authi;
+            fillPromptInfo(&authi);
+            bool obtained = checkCachedAuthentication(authi);
+            const bool probablyWrong = m_request.responseCode == m_request.prevResponseCode;
+            if (!obtained || probablyWrong) {
+                QString msg = (m_request.responseCode == 401) ? 
+                                  i18n("Authentication Failed.") :
+                                  i18n("Proxy Authentication Failed.");
+                obtained = openPasswordDialog(authi, msg);
+                if (!obtained) {
+                    kDebug(7103) << "looks like the user canceled"
+                                 << (m_request.responseCode == 401 ? "WWW" : "proxy")
+                                 << "authentication.";
+                    kDebug(7113) << "obtained =" << obtained << "probablyWrong =" << probablyWrong
+                                 << "authInfo username =" << authi.username
+                                 << "authInfo realm =" << authi.realmValue;
+                    error(ERR_USER_CANCELED, resource.host());
+                    return false;
+                }
+            }
+            if (!obtained) {
+                kDebug(7103) << "could not obtain authentication credentials from cache or user!";
+            }
+            username = authi.username;
+            password = authi.password;
+        }
+        (*auth)->generateResponse(username, password);
+
+        kDebug(7113) << "auth state: isError" << (*auth)->isError() 
+                     << "needCredentials" << (*auth)->needCredentials()
+                     << "forceKeepAlive" << (*auth)->forceKeepAlive()
+                     << "forceDisconnect" << (*auth)->forceDisconnect()
+                     << "headerFragment" << (*auth)->headerFragment();
+
+        if ((*auth)->isError()) {
+            if (m_request.preferErrorPage) {
+                errorPage();
+            } else {
+                error(ERR_UNSUPPORTED_ACTION, "Authorization failed!");
+                return false;
+            }
+            //### return false; ?
+        } else if ((*auth)->forceKeepAlive()) {
+            //### think this through for proxied / not proxied
+            m_request.isKeepAlive = true;
+        } else if ((*auth)->forceDisconnect()) {
+            //### think this through for proxied / not proxied
+            m_request.isKeepAlive = false;
+            httpCloseConnection();
+        }
+        if (m_request.isKeepAlive) {
+            // Important: trash data until the next response header starts.
+            readBody(true);
+        }
+
+    }
+
   // We need to do a redirect
   if (!locationStr.isEmpty())
   {
@@ -3295,8 +3389,7 @@
       return false;
     }
     if ((u.protocol() != "http") && (u.protocol() != "https") &&
-       (u.protocol() != "ftp") && (u.protocol() != "webdav") &&
-       (u.protocol() != "webdavs"))
+        (u.protocol() != "webdav") && (u.protocol() != "webdavs"))
     {
       redirection(u);
       error(ERR_ACCESS_DENIED, u.url());
@@ -3346,7 +3439,7 @@
      // Do not cache secure pages or pages
      // originating from password protected sites
      // unless the webserver explicitly allows it.
-     if (isUsingSsl() || (m_auth.scheme != AUTH_None) )
+     if (isUsingSsl() || m_wwwAuth)
      {
         m_request.cacheTag.writeToCache = false;
         mayCache = false;
@@ -3477,7 +3570,7 @@
     }
   }
 
-  return true;
+  return !authRequiresAnotherRoundtrip; // return true if no more credentials need to be sent
 }
 
 static void skipLWS(const QString &str, int &pos)
@@ -3688,9 +3781,7 @@
   // NOTE: we might even want to narrow this down to non-form
   // based submit requests which will require a meta-data from
   // khtml.
-  if (keepAlive && 
-      (!m_request.proxyUrl.isValid() || m_request.isPersistentProxyConnection))
-  {
+  if (keepAlive) {
     if (!m_request.keepAliveTimeout)
        m_request.keepAliveTimeout = DEFAULT_KEEP_ALIVE_TIMEOUT;
     else if (m_request.keepAliveTimeout > 2*DEFAULT_KEEP_ALIVE_TIMEOUT)
@@ -4702,148 +4793,28 @@
 //**************************  AUTHENTICATION CODE ********************/
 
 
-void HTTPProtocol::configAuth(const QList<QByteArray> &l, bool isProxyAuth)
-{
-    AUTH_SCHEME f = AUTH_None;
-    QString strAuth;
-    QByteArray realm;
-
-    QByteArray scheme = l.first().toLower();
-
-    if (scheme.startsWith("basic") || scheme.startsWith("MBS_PWD_COOKIE")) {
-        // MBS_PWD_COOKIE found on http://www.webscription.net/baen/default.asp
-        f = AUTH_Basic;
-        strAuth = "Basic";
-    } else if (scheme.startsWith("digest")) {
-        f = AUTH_Digest;
-        strAuth = "Digest";  // Correct for upper-case variations in input
-
-#ifdef HAVE_LIBGSSAPI
-    } else if (scheme.startsWith("negotiate")) {
-        // if we get two 401 in a row let's assume for now that
-        // Negotiate isn't working and ignore it
-        if (!isProxyAuth && !(m_request.responseCode == 401 && m_request.prevResponseCode == 401))  {
-            f = AUTH_Negotiate;
-            strAuth = "Negotiate";
-        }
-#endif
-
-    } else if (scheme.startsWith("ntlm") && (!isProxyAuth || m_request.isPersistentProxyConnection)) {
-        f = AUTH_NTLM;
-        strAuth = "NTLM";
-        realm = "NTLM"; // set a dummy realm
-    } else  {
-        kWarning(7113) << "Unsupported or invalid authorization type requested";
-
-        if (isProxyAuth) {
-            kWarning(7113) << "Proxy URL: " << m_request.proxyUrl;
-        } else {
-            kWarning(7113) << "URL: " << m_request.url;
-        }
-        kWarning(7113) << "Request Authorization: " << l.first();
-    }
-
-    /*
-     This check ensures the following:
-     1.) Rejection of any unknown/unsupported authentication schemes
-     2.) Usage of the strongest possible authentication schemes if
-         and when multiple Proxy-Authenticate or WWW-Authenticate
-         header field is sent.
-    */
-    if (isProxyAuth) {
-        if (f == AUTH_None || (m_proxyAuth.authCount > 0 && f < m_proxyAuth.scheme)) {
-            // I purposefully made the Proxy-Authentication settings
-            // persistent to reduce the number of round-trips to kdesud we
-            // have to take special care when an unknown/unsupported auth-
-            // scheme is received. This check accomplishes just that...
-            if (m_proxyAuth.authCount == 0) {
-                m_proxyAuth.scheme = f;
-            }
-            kDebug(7113) << "Rejected proxy auth method: " << f;
-            return;
-        }
-        m_proxyAuth.authCount++;
-        kDebug(7113) << "Accepted proxy auth method: " << f;
-    } else {
-        if (f == AUTH_None || (m_auth.authCount > 0 && f < m_auth.scheme)) {
-            kDebug(7113) << "Rejected auth method: " << f;
-            return;
-        }
-        m_auth.authCount++;
-        kDebug(7113) << "Accepted auth method: " << f;
-    }
-
-    if (realm.isEmpty()) {
-        // take the first "realm=", be it before or after a comma
-        int realmIdx = scheme.indexOf("realm=");
-        if (realmIdx != -1) {
-            // we want the original letter cases here
-            realm = l[0].mid(realmIdx + strlen("realm="));
-        } else if ((realmIdx = l[1].toLower().indexOf("realm=")) != -1) {
-            realm = l[1].mid(realmIdx + strlen("realm="));
-        }
-    }
-    //strip quotes
-    if (realm.length() && (realm[0] == '"') && (realm[realm.length() - 1] == '"')) {
-        realm = realm.mid(1, realm.length() - 2);
-    }
-    QString realmStr = QString::fromLatin1(realm);
-    if (KGlobal::locale()->language().contains("ru")) {
-        //for sites like lib.homelinux.org
-        realmStr = QTextCodec::codecForName("CP1251")->toUnicode(realm);
-    }
-
-    //recreate the original header line...
-    QString authorizationStr;
-    foreach (const QByteArray &ba, l) {
-        authorizationStr += QString::fromLatin1(ba);
-        authorizationStr += ", ";
-    }
-    authorizationStr.chop(2);
-
-    if (isProxyAuth) {
-        m_proxyAuth.scheme = f;
-        m_proxyAuth.authorization = authorizationStr;
-        m_proxyAuth.realm = realmStr;
-    } else {
-        m_auth.scheme = f;
-        m_auth.authorization = authorizationStr;
-        m_auth.realm = realmStr;
-    }
-}
-
-
-bool HTTPProtocol::retryPrompt()
-{
-    QString prompt;
-    if (m_request.responseCode == 401) {
-        prompt = i18n("Authentication Failed.");
-    } else {
-        prompt = i18n("Proxy Authentication Failed.");
-    }
-    prompt += i18n(" Do you want to retry?");
-    return messageBox(QuestionYesNo, prompt, i18n("Authentication")) == 3;
-}
-
 void HTTPProtocol::fillPromptInfo(AuthInfo *inf)
 {
   AuthInfo &info = *inf;    //no use rewriting everything below
+
+  info.keepPassword = true; // Prompt the user for persistence as well.
+  info.verifyPath = false;
+      
   if ( m_request.responseCode == 401 )
   {
+    // TODO sort out the data flow of the password
     info.url = m_request.url;
     if ( !m_server.url.user().isEmpty() )
       info.username = m_server.url.user();
-    info.readOnly = !m_request.url.user().isEmpty();
     info.prompt = i18n( "You need to supply a username and a "
                         "password to access this site." );
-    info.keepPassword = true; // Prompt the user for persistence as well.
-    if ( !m_auth.realm.isEmpty() )
+    Q_ASSERT(m_wwwAuth);
+    if (m_wwwAuth)
     {
-      info.realmValue = m_auth.realm;
-      info.verifyPath = false;
-      info.digestInfo = m_auth.authorization;
+      info.realmValue = m_wwwAuth->realm();
+      //TODO info.digestInfo = m_wwwAuth.authorization;
       info.commentLabel = i18n("Site:");
-      info.comment = i18n("<b>%1</b> at <b>%2</b>", m_auth.realm , m_request.url.host());
+      info.comment = i18n("<b>%1</b> at <b>%2</b>", info.realmValue, m_request.url.host());
     }
   }
   else if ( m_request.responseCode == 407 )
@@ -4853,867 +4824,52 @@
     info.prompt = i18n( "You need to supply a username and a password for "
                         "the proxy server listed below before you are allowed "
                         "to access any sites." );
-    info.keepPassword = true;
-    if (!m_proxyAuth.realm.isEmpty())
+    Q_ASSERT(m_proxyAuth);
+    if (m_proxyAuth)
     {
-      info.realmValue = m_proxyAuth.realm;
-      info.verifyPath = false;
-      info.digestInfo = m_proxyAuth.authorization;
+      info.realmValue = m_proxyAuth->realm();
+      //TODO info.digestInfo = m_proxyAuth.authorization;
       info.commentLabel = i18n("Proxy:");
-      info.comment = i18n("<b>%1</b> at <b>%2</b>", m_proxyAuth.realm, m_request.proxyUrl.host());
+      info.comment = i18n("<b>%1</b> at <b>%2</b>", info.realmValue, m_request.proxyUrl.host());
     }
   }
 }
 
-//Helper for (ATM only) HTTProtocol::getAuthorization().
-static int valueForKey(const QString &haystack, const QString &key, int from = 0)
-{
-    int pos = haystack.indexOf(key, from, Qt::CaseInsensitive);
-    if (pos == -1) {
-        return -1;
-    }
-    pos += key.length();
-    const int len = haystack.length();
-    while (pos < len && (haystack[pos] == ' ' || haystack[pos] == '=')) {
-        pos++;
-    }
-    if (pos >= len - 1) {
-        return -1;
-    }
-    return pos;
-}
 
-bool HTTPProtocol::getAuthorization()
+QString HTTPProtocol::authenticationHeader()
 {
-    AuthInfo info;
-    bool result = false;
-
-    kDebug(7113)  << "Current Response: " << m_request.responseCode << ", "
-                  << "Previous Response: " << m_request.prevResponseCode << ", "
-                  << "Authentication: " << m_auth.scheme << ", "
-                  << "ProxyAuthentication: " << m_proxyAuth.scheme;
-
-    if (m_request.doNotAuthenticate) {
-        if (m_request.preferErrorPage) {
-            errorPage();
-        } else {
-            error(ERR_COULD_NOT_LOGIN, i18n("Authentication needed for %1 but "
-                                            "authentication is disabled.",
-                                            m_request.url.host()));
-        }
-        return false;
+    QString ret;
+    // the authentication classes don't know if they are for proxy or webserver authentication...
+    if (m_wwwAuth && !m_wwwAuth->isError()) {
+        ret += "Authorization: ";
+        ret += m_wwwAuth->headerFragment();
     }
-
-    if (m_request.responseCode != 401 && m_request.responseCode != 407) {
-        return false;
+    if (m_proxyAuth && !m_proxyAuth->isError()) {
+        ret += "Proxy-Authorization: ";
+        ret += m_proxyAuth->headerFragment();
     }
-
-    KUrl &authUrl = (m_request.responseCode == 401) ? m_request.url : m_request.proxyUrl;
-    AuthState &authState = (m_request.responseCode == 401) ? m_auth : m_proxyAuth;
-
-    const bool repeatFailure = (m_request.prevResponseCode == m_request.responseCode);
-
-    if (repeatFailure) {
-        bool prompt = true;
-        if (m_auth.scheme == AUTH_Digest || m_proxyAuth.scheme == AUTH_Digest) {
-            bool isStaleNonce = false;
-            const QString auth = authState.authorization;
-
-            int pos = valueForKey(auth, "stale");
-            if (pos != -1 && auth.indexOf("true", pos, Qt::CaseInsensitive) != -1) {
-                isStaleNonce = true;
-                kDebug(7113) << "Stale nonce value. Will retry using same info...";
-            }
-
-            if (isStaleNonce) {
-                prompt = false;
-                result = true;
-
-                info.username = authUrl.user();
-                info.password = authUrl.pass();
-                info.realmValue = authState.realm;
-                info.digestInfo = authState.authorization;
-            }
-        }
-
-        if (m_auth.scheme == AUTH_NTLM || m_proxyAuth.scheme == AUTH_NTLM) {
-            const QString auth = authState.authorization;
-
-            kDebug(7113) << "auth: " << auth;
-            if (auth.length() > 4) {
-                prompt = false;
-                result = true;
-                kDebug(7113) << "NTLM auth second phase, "
-                             << "sending response...";
-
-                info.username = authUrl.user();
-                info.password = authUrl.pass();
-                info.realmValue = authState.realm;
-                info.digestInfo = authState.authorization;
-            }
-        }
-    } else {
-        // !repeatFailure case
-    
-        // At this point we know more details, so use it to find
-        // out if we have a cached version and avoid a re-prompt!
-        // We also do not use verify path unlike the pre-emptive
-        // requests because we already know the realm value...
-        //### that comment sounds like it's exactly wrong(?) --ahartmetz
-
-        if (m_proxyAuth.scheme != AUTH_None) {  //### we actually need some "stale flag".
-            // Reset cached proxy auth
-            m_proxyAuth.scheme = AUTH_None;
-            KUrl proxy(config()->readEntry("UseProxy"));
-            m_request.proxyUrl.setUser(proxy.user());
-            m_request.proxyUrl.setPass(proxy.pass());
-        }
-
-        info.verifyPath = false;
-        info.url = authUrl;
-        info.username = authUrl.user();
-        info.password = authUrl.pass();
-        info.realmValue = authState.realm;
-        info.digestInfo = authState.authorization;
-
-        // If either username or password is not supplied
-        // with the request, check the password cache.
-        if (info.username.isEmpty() || info.password.isEmpty()) {
-            result = checkCachedAuthentication(info);
-        }
-
-        if (m_auth.scheme == AUTH_Digest) {
-            const QString auth = authState.authorization;
-
-            int pos = valueForKey(auth, "stale");
-            if (pos != -1 && auth.indexOf("true", pos, Qt::CaseInsensitive) != -1) {
-                info.digestInfo = auth;
-                kDebug(7113) << "Just a stale nonce value! Retrying "
-                                "using the new nonce sent...";
-            }
-        }
-    }
-
-    if (!result) {
-        // Do not prompt if the username & password are already supplied and
-        // the login attempt did not fail before.
-        if (!repeatFailure &&
-            !info.username.isEmpty() && !info.password.isEmpty()) {
-            result = true;
-        } else {
-            if (m_auth.scheme == AUTH_Negotiate) {
-                if (!repeatFailure) {
-                    result = true;
-                }
-            } else if (!m_request.disablePassDialog)  {
-                kDebug(7113) << "Prompting the user for authorization...";
-                fillPromptInfo(&info);
-                QString msg = (m_request.responseCode == 401) ? 
-                                  i18n("Authentication Failed.") :
-                                  i18n("Proxy Authentication Failed.");
-                result = openPasswordDialog(info, msg);
-            }
-        }
-    }
-
-    if (result) {
-        authUrl.setUser(info.username);
-        authUrl.setPass(info.password);
-        authState.realm = info.realmValue;
-        authState.authorization = info.digestInfo;
-    } else {
-        if (m_request.preferErrorPage) {
-            errorPage();
-        } else {
-            error(ERR_USER_CANCELED, QString());
-        }
-    }
-
-    return result;
+    return ret;
 }
 
-void HTTPProtocol::saveAuthorization(bool isForProxy)
-{
-    if (m_request.prevResponseCode == 407 && !m_request.proxyUrl.isValid()) {
-        return;
-    }
-    AuthInfo info;
-    KUrl &authUrl = isForProxy ? m_request.proxyUrl : m_request.url;
-    AuthState &authState = isForProxy ? m_proxyAuth : m_auth;
 
-    info.url = authUrl;   //### strip username / password?
-    info.username = authUrl.user();
-    info.password = authUrl.pass();
-    info.realmValue = authState.realm;
-    info.digestInfo = authState.authorization;
-
-    cacheAuthentication(info);
-}
-
-#ifdef HAVE_LIBGSSAPI
-QByteArray HTTPProtocol::gssError( int major_status, int minor_status )
-{
-  OM_uint32 new_status;
-  OM_uint32 msg_ctx = 0;
-  gss_buffer_desc major_string;
-  gss_buffer_desc minor_string;
-  OM_uint32 ret;
-  QByteArray errorstr;
-
-  errorstr = "";
-
-  do {
-    ret = gss_display_status(&new_status, major_status, GSS_C_GSS_CODE, GSS_C_NULL_OID, &msg_ctx, &major_string);
-    errorstr += (const char *)major_string.value;
-    errorstr += ' ';
-    ret = gss_display_status(&new_status, minor_status, GSS_C_MECH_CODE, GSS_C_NULL_OID, &msg_ctx, &minor_string);
-    errorstr += (const char *)minor_string.value;
-    errorstr += ' ';
-  } while (!GSS_ERROR(ret) && msg_ctx != 0);
-
-  return errorstr;
-}
-
-QString HTTPProtocol::createNegotiateAuth()
-{
-  QString auth;
-  QByteArray servicename;
-  OM_uint32 major_status, minor_status;
-  OM_uint32 req_flags = 0;
-  gss_buffer_desc input_token = GSS_C_EMPTY_BUFFER;
-  gss_buffer_desc output_token = GSS_C_EMPTY_BUFFER;
-  gss_name_t server;
-  gss_ctx_id_t ctx;
-  gss_OID mech_oid;
-  static gss_OID_desc krb5_oid_desc = {9, (void *) "\x2a\x86\x48\x86\xf7\x12\x01\x02\x02"};
-  static gss_OID_desc spnego_oid_desc = {6, (void *) "\x2b\x06\x01\x05\x05\x02"};
-  int found = 0;
-  unsigned int i;
-  gss_OID_set mech_set;
-  gss_OID tmp_oid;
-
-  ctx = GSS_C_NO_CONTEXT;
-  mech_oid = &krb5_oid_desc;
-
-  // see whether we can use the SPNEGO mechanism
-  major_status = gss_indicate_mechs(&minor_status, &mech_set);
-  if (GSS_ERROR(major_status)) {
-    kDebug(7113) << "gss_indicate_mechs failed: " << gssError(major_status, minor_status);
-  } else {
-    for (i=0; i<mech_set->count && !found; i++) {
-      tmp_oid = &mech_set->elements[i];
-      if (tmp_oid->length == spnego_oid_desc.length &&
-        !memcmp(tmp_oid->elements, spnego_oid_desc.elements, tmp_oid->length)) {
-        kDebug(7113) << "found SPNEGO mech";
-        found = 1;
-        mech_oid = &spnego_oid_desc;
-        break;
-      }
-    }
-    gss_release_oid_set(&minor_status, &mech_set);
-  }
-
-  // the service name is "HTTP/f.q.d.n"
-  servicename = "HTTP@";
-  servicename += m_server.url.host().toAscii();
-
-  input_token.value = (void *)servicename.data();
-  input_token.length = servicename.length() + 1;
-
-  major_status = gss_import_name(&minor_status, &input_token,
-                                 GSS_C_NT_HOSTBASED_SERVICE, &server);
-
-  input_token.value = NULL;
-  input_token.length = 0;
-
-  if (GSS_ERROR(major_status)) {
-    kDebug(7113) << "gss_import_name failed: " << gssError(major_status, minor_status);
-    // reset the auth string so that subsequent methods aren't confused
-    m_auth.authorization.clear();
-    return QString();
-  }
-
-  major_status = gss_init_sec_context(&minor_status, GSS_C_NO_CREDENTIAL,
-                                      &ctx, server, mech_oid,
-                                      req_flags, GSS_C_INDEFINITE,
-                                      GSS_C_NO_CHANNEL_BINDINGS,
-                                      GSS_C_NO_BUFFER, NULL, &output_token,
-                                      NULL, NULL);
-
-
-  if (GSS_ERROR(major_status) || (output_token.length == 0)) {
-    kDebug(7113) << "gss_init_sec_context failed: " << gssError(major_status, minor_status);
-    gss_release_name(&minor_status, &server);
-    if (ctx != GSS_C_NO_CONTEXT) {
-      gss_delete_sec_context(&minor_status, &ctx, GSS_C_NO_BUFFER);
-      ctx = GSS_C_NO_CONTEXT;
-    }
-    // reset the auth string so that subsequent methods aren't confused
-    m_auth.authorization.clear();
-    return QString();
-  }
-
-  auth = "Authorization: Negotiate ";
-  auth += QByteArray::fromRawData((const char *)output_token.value, output_token.length).toBase64();
-  auth += "\r\n";
-
-  // free everything
-  gss_release_name(&minor_status, &server);
-  if (ctx != GSS_C_NO_CONTEXT) {
-    gss_delete_sec_context(&minor_status, &ctx, GSS_C_NO_BUFFER);
-    ctx = GSS_C_NO_CONTEXT;
-  }
-  gss_release_buffer(&minor_status, &output_token);
-
-  return auth;
-}
-#else
-
-// Dummy
-QByteArray HTTPProtocol::gssError( int, int )
-{
-  return QByteArray();
-}
-
-// Dummy
-QString HTTPProtocol::createNegotiateAuth()
-{
-  return QString();
-}
-#endif
-
-QString HTTPProtocol::createNTLMAuth( bool isForProxy )
-{
-  uint len;
-  QString auth, user, domain, passwd;
-  QByteArray strauth;
-  QByteArray buf;
-
-  if ( isForProxy )
-  {
-    auth = "Proxy-Authorization: NTLM ";
-    user = m_request.proxyUrl.user();
-    passwd = m_request.proxyUrl.pass();
-    strauth = m_proxyAuth.authorization.toLatin1();
-    len = m_proxyAuth.authorization.length();
-  }
-  else
-  {
-    auth = "Authorization: NTLM ";
-    user = m_server.url.user();
-    passwd = m_server.url.pass();
-    strauth = m_auth.authorization.toLatin1();
-    len = m_auth.authorization.length();
-  }
-  if ( user.contains('\\') ) {
-    domain = user.section( '\\', 0, 0);
-    user = user.section( '\\', 1 );
-  }
-
-  kDebug(7113) << "NTLM length: " << len;
-  if ( user.isEmpty() || passwd.isEmpty() || len < 4 )
-    return QString();
-
-  if ( len > 4 )
-  {
-    // create a response
-    QByteArray challenge;
-    KCodecs::base64Decode( strauth.right( len - 5 ), challenge );
-    KNTLM::getAuth( buf, challenge, user, passwd, domain,
-		    QHostInfo::localHostName() );
-  }
-  else
-  {
-    KNTLM::getNegotiate( buf );
-  }
-
-  // remove the challenge to prevent reuse
-  if ( isForProxy )
-    m_proxyAuth.authorization = "NTLM";
-  else
-    m_auth.authorization = "NTLM";
-
-  auth += KCodecs::base64Encode( buf );
-  auth += "\r\n";
-
-  return auth;
-}
-
-QString HTTPProtocol::createBasicAuth( bool isForProxy )
-{
-  QString auth;
-  QByteArray user, passwd;
-  if ( isForProxy )
-  {
-    auth = "Proxy-Authorization: Basic ";
-    user = m_request.proxyUrl.user().toLatin1();
-    passwd = m_request.proxyUrl.pass().toLatin1();
-  }
-  else
-  {
-    auth = "Authorization: Basic ";
-    user = m_server.url.user().toLatin1();
-    passwd = m_server.url.pass().toLatin1();
-  }
-
-  if (user.isEmpty() || passwd.isEmpty()) {
-    return QString();    
-  }
-
-  return auth + KCodecs::base64Encode(user + ':' + passwd) + "\r\n";
-}
-
-void HTTPProtocol::calculateResponse( DigestAuthInfo& info, QByteArray& Response )
-{
-  kDebug(7113);
-  KMD5 md;
-  QByteArray HA1;
-  QByteArray HA2;
-
-  // Calculate H(A1)
-  QByteArray authStr = info.username;
-  authStr += ':';
-  authStr += info.realm;
-  authStr += ':';
-  authStr += info.password;
-  md.update( authStr );
-
-  if ( info.algorithm.toLower() == "md5-sess" )
-  {
-    authStr = md.hexDigest();
-    authStr += ':';
-    authStr += info.nonce;
-    authStr += ':';
-    authStr += info.cnonce;
-    md.reset();
-    md.update( authStr );
-  }
-  HA1 = md.hexDigest();
-
-  kDebug(7113) << "A1 => " << HA1;
-
-  // Calcualte H(A2)
-  authStr = info.method;
-  authStr += ':';
-  authStr += m_request.url.encodedPathAndQuery(KUrl::LeaveTrailingSlash,KUrl::AvoidEmptyPath).toLatin1();
-  if ( info.qop == "auth-int" )
-  {
-    authStr += ':';
-    authStr += info.entityBody;
-  }
-  md.reset();
-  md.update( authStr );
-  HA2 = md.hexDigest();
-
-  kDebug(7113) << "A2 => " << HA2;
-
-  // Calcualte the response.
-  authStr = HA1;
-  authStr += ':';
-  authStr += info.nonce;
-  authStr += ':';
-  if ( !info.qop.isEmpty() )
-  {
-    authStr += info.nc;
-    authStr += ':';
-    authStr += info.cnonce;
-    authStr += ':';
-    authStr += info.qop;
-    authStr += ':';
-  }
-  authStr += HA2;
-  md.reset();
-  md.update( authStr );
-  Response = md.hexDigest();
-
-  kDebug(7113) << "Response => " << Response;
-}
-
-QString HTTPProtocol::createDigestAuth( bool isForProxy )
-{
-  const char *p;
-
-  QString auth;
-  QByteArray opaque;
-  QByteArray Response;
-
-  DigestAuthInfo info;
-
-  opaque = "";
-  if ( isForProxy )
-  {
-    auth = "Proxy-Authorization: Digest ";
-    info.username = m_request.proxyUrl.user().toLatin1();
-    info.password = m_request.proxyUrl.pass().toLatin1();
-    p = m_proxyAuth.authorization.toLatin1();
-  }
-  else
-  {
-    auth = "Authorization: Digest ";
-    info.username = m_server.url.user().toLatin1();
-    info.password = m_server.url.pass().toLatin1();
-    p = m_auth.authorization.toLatin1();
-  }
-  if (!p || !*p) {
-    return QString();
-  }
-  p += 6; // Skip "Digest"
-
-  if ( info.username.isEmpty() || info.password.isEmpty() || !p ) {
-    return QString();
-  }
-
-  // info.entityBody = p;  // FIXME: send digest of data for POST action ??
-  info.realm = "";
-  info.algorithm = "MD5";
-  info.nonce = "";
-  info.qop = "";
-
-  // cnonce is recommended to contain about 64 bits of entropy
-  info.cnonce = KRandom::randomString(16).toLatin1();
-
-  // HACK: Should be fixed according to RFC 2617 section 3.2.2
-  info.nc = "00000001";
-
-  // Set the method used...
-  info.method = methodString(m_request.method).toLatin1();
-  info.method.chop(1);  // trim space
-  if (info.method.isEmpty()) {
-      error(ERR_UNSUPPORTED_ACTION, i18n("Unsupported method: authentication will fail. "
-                                         "Please submit a bug report."));
-  }
-
-  // Parse the Digest response....
-  while (*p)
-  {
-    int i = 0;
-    while ( (*p == ' ') || (*p == ',') || (*p == '\t')) { p++; }
-    if (strncasecmp(p, "realm=", 6 )==0)
-    {
-      p+=6;
-      while ( *p == '"' ) p++;  // Go past any number of " mark(s) first
-      while ( p[i] != '"' ) i++;  // Read everything until the last " mark
-      info.realm = QByteArray( p, i );
-    }
-    else if (strncasecmp(p, "algorith=", 9)==0)
-    {
-      p+=9;
-      while ( *p == '"' ) p++;  // Go past any number of " mark(s) first
-      while ( ( p[i] != '"' ) && ( p[i] != ',' ) && ( p[i] != '\0' ) ) i++;
-      info.algorithm = QByteArray(p, i);
-    }
-    else if (strncasecmp(p, "algorithm=", 10)==0)
-    {
-      p+=10;
-      while ( *p == '"' ) p++;  // Go past any " mark(s) first
-      while ( ( p[i] != '"' ) && ( p[i] != ',' ) && ( p[i] != '\0' ) ) i++;
-      info.algorithm = QByteArray(p,i);
-    }
-    else if (strncasecmp(p, "domain=", 7)==0)
-    {
-      p+=7;
-      while ( *p == '"' ) p++;  // Go past any " mark(s) first
-      while ( p[i] != '"' ) i++;  // Read everything until the last " mark
-      int pos;
-      int idx = 0;
-      QByteArray uri(p, i);
-      do
-      {
-        pos = uri.indexOf( ' ', idx );
-        if ( pos != -1 )
-        {
-          KUrl u (m_request.url, uri.mid(idx, pos-idx));
-          if (u.isValid ())
-            info.digestURIs.append( u );
-        }
-        else
-        {
-          KUrl u (m_request.url, uri.mid(idx, uri.length()-idx));
-          if (u.isValid ())
-            info.digestURIs.append( u );
-        }
-        idx = pos+1;
-      } while ( pos != -1 );
-    }
-    else if (strncasecmp(p, "nonce=", 6)==0)
-    {
-      p+=6;
-      while ( *p == '"' ) p++;  // Go past any " mark(s) first
-      while ( p[i] != '"' ) i++;  // Read everything until the last " mark
-      info.nonce = QByteArray(p,i);
-    }
-    else if (strncasecmp(p, "opaque=", 7)==0)
-    {
-      p+=7;
-      while ( *p == '"' ) p++;  // Go past any " mark(s) first
-      while ( p[i] != '"' ) i++;  // Read everything until the last " mark
-      opaque = QByteArray(p,i);
-    }
-    else if (strncasecmp(p, "qop=", 4)==0)
-    {
-      p+=4;
-      while ( *p == '"' ) p++;  // Go past any " mark(s) first
-      while ( p[i] != '"' ) i++;  // Read everything until the last " mark
-      info.qop = QByteArray(p,i);
-    }
-    p+=(i+1);
-  }
-
-  if (info.realm.isEmpty() || info.nonce.isEmpty()) {
-    return QString();
-  }
-
-  // If the "domain" attribute was not specified and the current response code
-  // is authentication needed, add the current request url to the list over which
-  // this credential can be automatically applied.
-  if (info.digestURIs.isEmpty() && (m_request.responseCode == 401 || m_request.responseCode == 407))
-    info.digestURIs.append (m_request.url);
-  else
-  {
-    // Verify whether or not we should send a cached credential to the
-    // server based on the stored "domain" attribute...
-    bool send = true;
-
-    // Determine the path of the request url...
-    QString requestPath = m_request.url.directory(KUrl::AppendTrailingSlash|KUrl::ObeyTrailingSlash);
-    if (requestPath.isEmpty())
-      requestPath = "/";
-
-    foreach (const KUrl &u, info.digestURIs)
-    {
-      send &= (m_request.url.protocol().toLower() == u.protocol().toLower());
-      send &= (m_request.url.host().toLower() == u.host().toLower());
-
-      if (m_request.url.port() > 0 && u.port() > 0)
-        send &= (m_request.url.port() == u.port());
-
-      QString digestPath = u.directory (KUrl::AppendTrailingSlash|KUrl::ObeyTrailingSlash);
-      if (digestPath.isEmpty())
-        digestPath = "/";
-
-      send &= (requestPath.startsWith(digestPath));
-
-      if (send)
-        break;
-    }
-
-    kDebug(7113) << "passed digest authentication credential test: " << send;
-
-    if (!send) {
-      return QString();
-    }
-  }
-
-  kDebug(7113) << "RESULT OF PARSING:";
-  kDebug(7113) << "  algorithm: " << info.algorithm;
-  kDebug(7113) << "  realm:     " << info.realm;
-  kDebug(7113) << "  nonce:     " << info.nonce;
-  kDebug(7113) << "  opaque:    " << opaque;
-  kDebug(7113) << "  qop:       " << info.qop;
-
-  // Calculate the response...
-  calculateResponse( info, Response );
-
-  auth += "username=\"";
-  auth += info.username;
-
-  auth += "\", realm=\"";
-  auth += info.realm;
-  auth += "\"";
-
-  auth += ", nonce=\"";
-  auth += info.nonce;
-
-  auth += "\", uri=\"";
-  auth += m_request.url.encodedPathAndQuery(KUrl::LeaveTrailingSlash,KUrl::AvoidEmptyPath);
-
-  auth += "\", algorithm=\"";
-  auth += info.algorithm;
-  auth +="\"";
-
-  if ( !info.qop.isEmpty() )
-  {
-    auth += ", qop=\"";
-    auth += info.qop;
-    auth += "\", cnonce=\"";
-    auth += info.cnonce;
-    auth += "\", nc=";
-    auth += info.nc;
-  }
-
-  auth += ", response=\"";
-  auth += Response;
-  if ( !opaque.isEmpty() )
-  {
-    auth += "\", opaque=\"";
-    auth += opaque;
-  }
-  auth += "\"\r\n";
-
-  return auth;
-}
-
-QString HTTPProtocol::proxyAuthenticationHeader()
-{
-    kDebug(7113);
-    // We keep proxy authentication locally until they are changed.
-    // Thus, no need to check with the password manager for every
-    // connection.
-    if (m_proxyAuth.realm.isEmpty()) {
-        AuthInfo info;
-        info.url = m_request.proxyUrl;
-        info.username = m_request.proxyUrl.user();
-        info.password = m_request.proxyUrl.pass();
-        info.verifyPath = true;
-
-        // If the proxy URL already contains username
-        // and password simply attempt to retrieve it
-        // without prompting the user...
-        if (!info.username.isEmpty() && !info.password.isEmpty()) {
-            if( m_proxyAuth.authorization.isEmpty() )
-                m_proxyAuth.scheme = AUTH_None;
-            else if( m_proxyAuth.authorization.startsWith("Basic") )
-                m_proxyAuth.scheme = AUTH_Basic;
-            else if( m_proxyAuth.authorization.startsWith("NTLM") )
-                m_proxyAuth.scheme = AUTH_NTLM;
-            else
-                m_proxyAuth.scheme = AUTH_Digest;
-        } else {
-            if (checkCachedAuthentication(info) && !info.digestInfo.isEmpty()) {
-                m_request.proxyUrl.setUser(info.username);
-                m_request.proxyUrl.setPass(info.password);
-                m_proxyAuth.realm = info.realmValue;
-                m_proxyAuth.authorization = info.digestInfo;
-                if (m_proxyAuth.authorization.startsWith("Basic")) {
-                    m_proxyAuth.scheme = AUTH_Basic;
-                } else if (m_proxyAuth.authorization.startsWith("NTLM")) {
-                    m_proxyAuth.scheme = AUTH_NTLM;
-                } else {
-                    m_proxyAuth.scheme = AUTH_Digest;
-                }
-            } else {
-                m_proxyAuth.scheme = AUTH_None;
-            }
-        }
-    }
-
-    if (m_proxyAuth.scheme != AUTH_None) {
-        kDebug(7113) << "Using Proxy Authentication: ";
-        kDebug(7113) << " HOST =" << m_request.proxyUrl.host();
-        kDebug(7113) << " PORT =" << m_request.proxyUrl.port();
-        kDebug(7113) << " USER =" << m_request.proxyUrl.user();
-        kDebug(7113) << " PASSWORD = [protected]";
-        kDebug(7113) << " REALM =" << m_proxyAuth.realm;
-        kDebug(7113) << " EXTRA =" << m_proxyAuth.authorization;
-    } else {
-        kDebug(7113) << "m_proxyAuth.scheme = AUTH_None.";
-    }
-
-    switch (m_proxyAuth.scheme) {
-    case AUTH_Basic:
-        return createBasicAuth(true);
-        break;
-    case AUTH_Digest:
-        return createDigestAuth(true);
-        break;
-    case AUTH_NTLM:
-        if (m_isFirstRequest) {
-            return createNTLMAuth(true);
-        }
-        break;
-    case AUTH_None:
-    default:
-        break;
-    }
-    return QString();
-}
-
-QString HTTPProtocol::wwwAuthenticationHeader()
-{
-    kDebug(7113);
-    // Only check for cached authentication if the previous response was NOT a 401 or 407.
-    // In that case we have already tried the cached authentication in a previous attempt
-    // (because it's the first thing we try) and it did not work.
-    // Also no caching for schemes where challenges become stale.
-    
-    // m_auth *might* already contain useful values from getAuthorization(), continue
-    // and try them in any case.
-    
-    if (!m_request.doNotAuthenticate && m_request.responseCode != 401
-        && m_request.responseCode != 407
-        && m_auth.scheme != AUTH_Negotiate) {
-
-        AuthInfo info;
-        info.url = m_request.url;
-        info.verifyPath = true;
-        if (!m_request.url.user().isEmpty()) {
-            info.username = m_request.url.user();
-        }
-
-        kDebug(7113) << "Calling checkCachedAuthentication";
-        
-        if (checkCachedAuthentication(info) && !info.digestInfo.isEmpty()) {
-            m_auth.scheme = AUTH_Digest;
-            if (info.digestInfo.startsWith("Basic")) {
-                m_auth.scheme = AUTH_Basic;
-            } else if (info.digestInfo.startsWith("NTLM")) {
-                m_auth.scheme = AUTH_NTLM;
-            } else if (info.digestInfo.startsWith("Negotiate")) {
-                m_auth.scheme = AUTH_Negotiate;
-            }
-
-            m_server.url.user() = info.username;
-            m_server.url.pass() = info.password;
-            m_auth.realm = info.realmValue;
-            if (m_auth.scheme != AUTH_NTLM && m_auth.scheme != AUTH_Negotiate) { // don't use the cached challenge
-                m_auth.authorization = info.digestInfo;
-            }
-        }
-    } else {
-        kDebug(7113) << "Not calling checkCachedAuthentication";
-    }
-
-    if (m_auth.scheme != AUTH_None) {
-        kDebug(7113) << "Using Authentication: ";
-        kDebug(7113) << " HOST =" << m_server.url.host();
-        kDebug(7113) << " PORT =" << m_server.url.port();
-        kDebug(7113) << " USER =" << m_server.url.user();
-        kDebug(7113) << " PASSWORD = [protected]";
-        kDebug(7113) << " REALM =" << m_auth.realm;
-        kDebug(7113) << " EXTRA =" << m_auth.authorization;
-    }
-
-    switch (m_auth.scheme) {
-    case AUTH_Basic:
-        return createBasicAuth();
-    case AUTH_Digest:
-        return createDigestAuth();
-#ifdef HAVE_LIBGSSAPI
-    case AUTH_Negotiate:
-        return createNegotiateAuth();
-#endif
-    case AUTH_NTLM:
-        return createNTLMAuth();
-    case AUTH_None:
-    default:
-        break;
-    }
-    return QString();
-}
-
 void HTTPProtocol::proxyAuthenticationForSocket(const QNetworkProxy &proxy, QAuthenticator *authenticator)
 {
+    Q_UNUSED(proxy);
     kDebug(7113) << "Authenticator received -- realm: " << authenticator->realm() << "user:"
                  << authenticator->user();
 
     AuthInfo info;
+    Q_ASSERT(proxy.hostName() == m_request.proxyUrl.host() && proxy.port() == m_request.proxyUrl.port());
     info.url = m_request.proxyUrl;
     info.realmValue = authenticator->realm();
     info.verifyPath = true;    //### whatever
     info.username = authenticator->user();
-    info.password = authenticator->password();  // well...
 
-    if (!checkCachedAuthentication(info)) {
+    const bool haveCachedCredentials = checkCachedAuthentication(info);
+
+    // if m_socketProxyAuth is a valid pointer then authentication has been attempted before,
+    // and it was not successful. see below and saveProxyAuthenticationForSocket().
+    if (!haveCachedCredentials || m_socketProxyAuth) {
         // Save authentication info if the connection succeeds. We need to disconnect
         // this after saving the auth data (or an error) so we won't save garbage afterwards!
         connect(socket(), SIGNAL(connected()),
@@ -5725,24 +4881,44 @@
         info.keepPassword = true;
         info.commentLabel = i18n("Proxy:");
         info.comment = i18n("<b>%1</b> at <b>%2</b>", info.realmValue, m_request.proxyUrl.host());
-        openPasswordDialog(info, i18n("Proxy Authentication Failed."));
+        const bool dataEntered = openPasswordDialog(info, i18n("Proxy Authentication Failed."));
+        if (!dataEntered) {
+            kDebug(7103) << "looks like the user canceled proxy authentication.";
+            error(ERR_USER_CANCELED, m_request.proxyUrl.host());
+        }
     }
     authenticator->setUser(info.username);
     authenticator->setPassword(info.password);
+    
+    if (m_socketProxyAuth) {
+        *m_socketProxyAuth = *authenticator;
+    } else {
+        m_socketProxyAuth = new QAuthenticator(*authenticator);
+    }
 
     m_request.proxyUrl.setUser(info.username);
     m_request.proxyUrl.setPassword(info.password);
-    m_proxyAuth.scheme = AUTH_Basic;    // anything but AUTH_None should be fine
-    m_proxyAuth.realm = info.realmValue;
-    m_proxyAuth.authorization.clear();  // internal to QAbstractSocket and not needed
 }
 
 void HTTPProtocol::saveProxyAuthenticationForSocket()
 {
+    kDebug(7113) << "Saving authenticator";
     disconnect(socket(), SIGNAL(connected()),
                this, SLOT(saveProxyAuthenticationForSocket()));
-    saveAuthorization(true /*isForProxy*/);
+    Q_ASSERT(m_socketProxyAuth);
+    if (m_socketProxyAuth) {
+        kDebug(7113) << "-- realm: " << m_socketProxyAuth->realm() << "user:"
+                     << m_socketProxyAuth->user();
+        KIO::AuthInfo a;
+        a.verifyPath = true;
+        a.url = m_request.proxyUrl;
+        a.realmValue = m_socketProxyAuth->realm();
+        a.username = m_socketProxyAuth->user();
+        a.password = m_socketProxyAuth->password();
+        cacheAuthentication(a);
+    }
+    delete m_socketProxyAuth;
+    m_socketProxyAuth = 0;
 }
 
 #include "http.moc"
-// kate: indent-width 4; replace-tabs on; tab-width 4; space-indent on;
Index: kioslave/http/httpauthentication.cpp
===================================================================
--- kioslave/http/httpauthentication.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 0)
+++ kioslave/http/httpauthentication.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -0,0 +1,735 @@
+/* This file is part of the KDE libraries
+    Copyright (C) 2008, 2009 Andreas Hartmetz <ahartmetz@gmail.com>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+
+#include "httpauthentication.h"
+
+
+// keys on even indexes, values on odd indexes. Reduces code expansion for the templated
+// alternatives.
+static QList<QByteArray> parseChallenge(const QByteArray &ba, QByteArray *scheme)
+{
+    QList<QByteArray> values;
+    const int len = ba.count();
+    const char *b = ba.constData();
+    int start = 0;
+    int end = 0;
+
+    // parse scheme
+    while (start < len && (b[start] == ' ' || b[start] == '\t')) {
+        start++;
+    }
+    end = start;
+    while (end < len && (b[end] != ' ' && b[end] != '\t')) {
+        end++;
+    }
+    if (scheme) {
+        *scheme = QByteArray(b + start, end - start);
+    }
+
+    while (end < len) {
+        start = end;
+        // parse key
+        while (start < len && (b[start] == ' ' || b[start] == '\t')) {
+            start++;
+        }
+        end = start;
+        while (end < len && b[end] != '=') {
+            end++;
+        }
+        values.append(QByteArray(b + start, end - start));
+        if (end == len) {
+            break;
+        }
+
+        // parse value
+        start = end + 1;    //skip '='
+        while (start < len && (b[start] == ' ' || b[start] == '\t')) {
+            start++;
+        }
+        if (start + 1 < len && b[start] == '"') {
+            end = ++start;
+            //quoted string
+            while (end < len && b[end] != '"') {
+                end++;
+            }
+            values.append(QByteArray(b + start, end - start));
+            //the quoted string has ended, but only a comma ends a key-value pair
+            while (end < len && b[end] != ',') {
+                end++;
+            }
+        } else {
+            end = start;
+            //unquoted string
+            while (end < len && b[end] != ',') {
+                end++;
+            }
+            values.append(QByteArray(b + start, end - start));
+        }
+        // end may point beyond the buffer already here
+        end++;  // skip comma
+    }
+    // ensure every key has a value
+    if (values.count() % 2) {
+        values.removeLast();
+    }
+    return values;
+}
+
+
+static QByteArray valueForKey(const QList<QByteArray> &ba, const QByteArray &key)
+{
+    for (int i = 0; i + 1 < ba.count(); i += 2) {
+        if (ba[i] == key) {
+            return ba[i + 1];
+        }
+    }
+    return QByteArray();
+}
+
+
+QByteArray KAbstractHttpAuthentication::bestOffer(const QList<QByteArray> &offers)
+{
+    // choose the most secure auth scheme offered
+    QByteArray negotiateOffer;
+    QByteArray digestOffer;
+    QByteArray ntlmOffer;
+    QByteArray basicOffer;
+    foreach (const QByteArray &offer, offers) {
+        QByteArray scheme = offer.mid(0, 10).toLower();
+#ifdef HAVE_LIBGSSAPI
+        if (scheme.startsWith("negotiate")) {
+            negotiateOffer = offer;
+        } else
+#endif
+        if (scheme.startsWith("digest")) {
+            digestOffer = offer;
+        } else if (scheme.startsWith("ntlm")) {
+            ntlmOffer = offer;
+        } else if (scheme.startsWith("basic")) {
+            basicOffer = offer;
+        }
+    }
+
+    if (!negotiateOffer.isEmpty()) {
+        return negotiateOffer;
+    } else if (!digestOffer.isEmpty()) {
+        return digestOffer;
+    } else if (!ntlmOffer.isEmpty()) {
+        return ntlmOffer;
+    }
+    return basicOffer;  //empty or not...
+}
+
+
+KAbstractHttpAuthentication *KAbstractHttpAuthentication::newAuth(const QByteArray &offer)
+{
+    QByteArray scheme = offer.mid(0, 10).toLower();
+#ifdef HAVE_LIBGSSAPI
+    if (scheme.startsWith("negotiate")) {
+        return new KHttpNegotiateAuthentication();
+    } else
+#endif
+    if (scheme.startsWith("digest")) {
+        return new KHttpDigestAuthentication();
+    } else if (scheme.startsWith("ntlm")) {
+        return new KHttpNtlmAuthentication();
+    } else if (scheme.startsWith("basic")) {
+        return new KHttpBasicAuthentication();
+    }
+    return 0;
+}
+
+
+void KAbstractHttpAuthentication::reset()
+{
+    m_scheme.clear();
+    m_challenge.clear();
+    m_resource.clear();
+    m_httpMethod.clear();
+    m_isError = false;
+    m_needCredentials = true;
+    m_forceKeepAlive = false;
+    m_forceDisconnect = false;
+    m_headerFragment.clear();
+    m_username.clear();
+    m_password.clear();
+}
+
+
+void KAbstractHttpAuthentication::setChallenge(const QByteArray &c, const KUrl &resource,
+                                               const QByteArray &httpMethod)
+{
+    reset();
+    m_challenge = parseChallenge(c, &m_scheme);
+    Q_ASSERT(m_scheme.toLower() == scheme().toLower());
+    m_resource = resource;
+    m_httpMethod = httpMethod;
+}
+
+
+QString KAbstractHttpAuthentication::realm() const
+{
+    QByteArray realm = valueForKey(m_challenge, "realm");
+    if (KGlobal::locale()->language().contains("ru")) {
+        //for sites like lib.homelinux.org
+        return QTextCodec::codecForName("CP1251")->toUnicode(realm);
+    }
+    return QString::fromLatin1(realm);
+}
+
+
+void KAbstractHttpAuthentication::authInfoBoilerplate(KIO::AuthInfo *a) const
+{
+    a->verifyPath = true;  //### research this
+    a->url = m_resource;
+    a->realmValue = realm();
+    a->username = m_username;
+    a->password = m_password;
+}
+
+
+void KAbstractHttpAuthentication::generateResponseCommon(const QString &user, const QString &password)
+{
+    if ((m_needCredentials && (user.isEmpty() || password.isEmpty())) ||
+        m_scheme.isEmpty() || m_httpMethod.isEmpty()) {
+        m_isError = true;
+        return;
+    }
+
+    if (m_needCredentials) {
+        m_username = user;
+        m_password = password;
+    }
+    m_isError = false;
+    // we could leave m_needCredentials value alone; this is just defensive coding.
+    m_needCredentials = true;
+    m_forceKeepAlive = false;
+    m_forceDisconnect = false;
+}
+
+
+QByteArray KHttpBasicAuthentication::scheme() const
+{
+    return "Basic";
+}
+
+
+void KHttpBasicAuthentication::fillKioAuthInfo(KIO::AuthInfo *ai) const
+{
+    authInfoBoilerplate(ai);
+}
+
+
+void KHttpBasicAuthentication::generateResponse(const QString &user, const QString &password)
+{
+    generateResponseCommon(user, password);
+    if (m_isError) {
+        return;
+    }
+
+    m_headerFragment = "Basic ";
+    m_headerFragment += KCodecs::base64Encode(m_username.toLatin1() + ':' + m_password.toLatin1());
+    m_headerFragment += "\r\n";
+    return;
+}
+
+
+QByteArray KHttpDigestAuthentication::scheme() const
+{
+    return "Digest";
+}
+
+
+void KHttpDigestAuthentication::setChallenge(const QByteArray &c, const KUrl &resource,
+                                             const QByteArray &httpMethod)
+{
+    QString oldUsername;
+    QString oldPassword;
+    if (valueForKey(m_challenge, "stale").toLower() == "true") {
+        // stale nonce: the auth failure that triggered this round of authentication is an artifact
+        // of digest authentication. the credentials are probably still good, so keep them.
+        oldUsername = m_username;
+        oldPassword = m_password;
+    }
+    KAbstractHttpAuthentication::setChallenge(c, resource, httpMethod);
+    if (!oldUsername.isEmpty() && !oldPassword.isEmpty()) {
+        // keep credentials *and* don't ask for new ones
+        m_needCredentials = false;
+        m_username = oldUsername;
+        m_password = oldPassword;
+    }
+}
+
+
+void KHttpDigestAuthentication::fillKioAuthInfo(KIO::AuthInfo *ai) const
+{
+    authInfoBoilerplate(ai);
+}
+
+
+struct DigestAuthInfo
+{
+    QByteArray nc;
+    QByteArray qop;
+    QByteArray realm;
+    QByteArray nonce;
+    QByteArray method;
+    QByteArray cnonce;
+    QByteArray username;
+    QByteArray password;
+    KUrl::List digestURIs;
+    QByteArray algorithm;
+    QByteArray entityBody;
+};
+
+
+//calculateResponse() from the original HTTPProtocol
+static QByteArray calculateResponse(const DigestAuthInfo &info, const KUrl &resource)
+{
+  kDebug(7113) << info.nc << info.qop << info.realm << info.nonce << info.method << info.cnonce
+               << info.username << info.password << info.algorithm << info.entityBody;
+  foreach (const KUrl &u, info.digestURIs) {
+      kDebug(7113) << u;
+  }
+  kDebug(7113);
+  KMD5 md;
+  QByteArray HA1;
+  QByteArray HA2;
+
+  // Calculate H(A1)
+  QByteArray authStr = info.username;
+  authStr += ':';
+  authStr += info.realm;
+  authStr += ':';
+  authStr += info.password;
+  md.update( authStr );
+
+  if ( info.algorithm.toLower() == "md5-sess" )
+  {
+    authStr = md.hexDigest();
+    authStr += ':';
+    authStr += info.nonce;
+    authStr += ':';
+    authStr += info.cnonce;
+    md.reset();
+    md.update( authStr );
+  }
+  HA1 = md.hexDigest();
+
+  kDebug(7113) << "A1 => " << HA1;
+
+  // Calcualte H(A2)
+  authStr = info.method;
+  authStr += ':';
+  authStr += resource.encodedPathAndQuery(KUrl::LeaveTrailingSlash, KUrl::AvoidEmptyPath).toLatin1();
+  if ( info.qop == "auth-int" )
+  {
+    authStr += ':';
+    authStr += info.entityBody;
+  }
+  md.reset();
+  md.update( authStr );
+  HA2 = md.hexDigest();
+
+  kDebug(7113) << "A2 => " << HA2;
+
+  // Calcualte the response.
+  authStr = HA1;
+  authStr += ':';
+  authStr += info.nonce;
+  authStr += ':';
+  if ( !info.qop.isEmpty() )
+  {
+    authStr += info.nc;
+    authStr += ':';
+    authStr += info.cnonce;
+    authStr += ':';
+    authStr += info.qop;
+    authStr += ':';
+  }
+  authStr += HA2;
+  md.reset();
+  md.update( authStr );
+
+  QByteArray Response = md.hexDigest();
+
+  kDebug(7113) << "Response => " << Response;
+  return Response;
+}
+
+
+void KHttpDigestAuthentication::generateResponse(const QString &user, const QString &password)
+{
+    generateResponseCommon(user, password);
+    if (m_isError) {
+        return;
+    }
+
+// magic starts here (this part is slightly modified from the original in HTTPProtocol)
+
+    DigestAuthInfo info;
+
+    info.username = m_username.toLatin1();  //### charset breakage
+    info.password = m_password.toLatin1();  //###
+
+    // info.entityBody = p;  // FIXME: send digest of data for POST action ??
+    info.realm = "";
+    info.nonce = "";
+    info.qop = "";
+
+    // cnonce is recommended to contain about 64 bits of entropy
+    info.cnonce = KRandom::randomString(16).toLatin1();
+
+    // HACK: Should be fixed according to RFC 2617 section 3.2.2
+    info.nc = "00000001";
+
+    // Set the method used...
+    info.method = m_httpMethod;
+
+    // Parse the Digest response....
+    info.realm = valueForKey(m_challenge, "realm");
+
+    info.algorithm = valueForKey(m_challenge, "algorith");
+    if (info.algorithm.isEmpty()) {
+        info.algorithm = valueForKey(m_challenge, "algorithm");
+    }
+    if (info.algorithm.isEmpty()) {
+        info.algorithm = "MD5";
+    }
+
+    foreach (const QByteArray &path, valueForKey(m_challenge, "domain").split(' ')) {
+        KUrl u(m_resource, QString::fromLatin1(path));
+        if (u.isValid()) {
+            info.digestURIs.append(u);
+        }
+    }
+
+    info.nonce = valueForKey(m_challenge, "nonce");
+    QByteArray opaque = valueForKey(m_challenge, "opaque");
+    info.qop = valueForKey(m_challenge, "qop");
+
+    if (info.realm.isEmpty() || info.nonce.isEmpty()) {
+        // ### proper error return
+        m_isError = true;
+        return;
+    }
+
+  // If the "domain" attribute was not specified and the current response code
+  // is authentication needed, add the current request url to the list over which
+  // this credential can be automatically applied.
+  if (info.digestURIs.isEmpty() /*###&& (m_request.responseCode == 401 || m_request.responseCode == 407)*/)
+    info.digestURIs.append (m_resource);
+  else
+  {
+    // Verify whether or not we should send a cached credential to the
+    // server based on the stored "domain" attribute...
+    bool send = true;
+
+    // Determine the path of the request url...
+    QString requestPath = m_resource.directory(KUrl::AppendTrailingSlash | KUrl::ObeyTrailingSlash);
+    if (requestPath.isEmpty())
+      requestPath = "/";
+
+    foreach (const KUrl &u, info.digestURIs)
+    {
+      send &= (m_resource.protocol().toLower() == u.protocol().toLower());
+      send &= (m_resource.host().toLower() == u.host().toLower());
+
+      if (m_resource.port() > 0 && u.port() > 0)
+        send &= (m_resource.port() == u.port());
+
+      QString digestPath = u.directory (KUrl::AppendTrailingSlash | KUrl::ObeyTrailingSlash);
+      if (digestPath.isEmpty())
+        digestPath = "/";
+
+      send &= (requestPath.startsWith(digestPath));
+
+      if (send)
+        break;
+    }
+
+    kDebug(7113) << "passed digest authentication credential test: " << send;
+
+    if (!send) {
+        m_isError = true;
+        return;
+    }
+  }
+
+  kDebug(7113) << "RESULT OF PARSING:";
+  kDebug(7113) << "  algorithm: " << info.algorithm;
+  kDebug(7113) << "  realm:     " << info.realm;
+  kDebug(7113) << "  nonce:     " << info.nonce;
+  kDebug(7113) << "  opaque:    " << opaque;
+  kDebug(7113) << "  qop:       " << info.qop;
+
+  // Calculate the response...
+  QByteArray Response = calculateResponse(info, m_resource);
+
+  QString auth = "Digest username=\"";
+  auth += info.username;
+
+  auth += "\", realm=\"";
+  auth += info.realm;
+  auth += "\"";
+
+  auth += ", nonce=\"";
+  auth += info.nonce;
+
+  auth += "\", uri=\"";
+  auth += m_resource.encodedPathAndQuery(KUrl::LeaveTrailingSlash, KUrl::AvoidEmptyPath);
+
+  if (!info.algorithm.isEmpty()) {
+    auth += "\", algorithm=\"";
+    auth += info.algorithm;
+    auth +="\"";
+  }
+
+  if ( !info.qop.isEmpty() )
+  {
+    auth += ", qop=\"";
+    auth += info.qop;
+    auth += "\", cnonce=\"";
+    auth += info.cnonce;
+    auth += "\", nc=";
+    auth += info.nc;
+  }
+
+  auth += ", response=\"";
+  auth += Response;
+  if ( !opaque.isEmpty() )
+  {
+    auth += "\", opaque=\"";
+    auth += opaque;
+  }
+  auth += "\"\r\n";
+
+// magic ends here
+    // note that auth already contains \r\n
+    m_headerFragment = auth;
+    return;
+}
+
+
+QByteArray KHttpNtlmAuthentication::scheme() const
+{
+    return "NTLM";
+}
+
+
+void KHttpNtlmAuthentication::setChallenge(const QByteArray &c, const KUrl &resource,
+                                             const QByteArray &httpMethod)
+{
+    KAbstractHttpAuthentication::setChallenge(c, resource, httpMethod);
+    if (m_challenge.isEmpty()) {
+        // The type 1 message we're going to send needs no credentials;
+        // they come later in the type 3 message.
+        m_needCredentials = false;
+    }
+}
+
+
+void KHttpNtlmAuthentication::fillKioAuthInfo(KIO::AuthInfo *ai) const
+{
+    authInfoBoilerplate(ai);
+    // Every auth scheme is supposed to supply a realm according to the RFCs. Of course this doesn't
+    // prevent Microsoft from not doing it... Dummy value!
+    // we don't have the username yet which may (may!) contain a domain, so we really have no choice
+    ai->realmValue = "NTLM";
+}
+
+
+void KHttpNtlmAuthentication::generateResponse(const QString &_user, const QString &password)
+{
+    generateResponseCommon(_user, password);
+    if (m_isError) {
+        return;
+    }
+
+    QByteArray buf;
+
+    if (m_challenge.isEmpty()) {
+        // first, send type 1 message (with empty domain, workstation..., but it still works)
+        m_forceDisconnect = true;
+        KNTLM::getNegotiate(buf);
+    } else {
+        // we've (hopefully) received a valid type 2 message: send type 3 message as last step
+        QString domain;
+        QString user = m_username;
+        if (user.contains('\\')) {
+            domain = user.section('\\', 0, 0);
+            user = user.section('\\', 1);
+        }
+
+        m_forceKeepAlive = true;
+        QByteArray challenge;
+        KCodecs::base64Decode(m_challenge[0], challenge);
+        KNTLM::getAuth(buf, challenge, user, password, domain, QHostInfo::localHostName());
+    }
+
+    m_headerFragment = "NTLM ";
+    m_headerFragment += KCodecs::base64Encode(buf);
+    m_headerFragment += "\r\n";
+
+    return;
+}
+
+
+//////////////////////////
+#ifdef HAVE_LIBGSSAPI
+
+// just an error message formatter
+static QByteArray gssError(int major_status, int minor_status)
+{
+    OM_uint32 new_status;
+    OM_uint32 msg_ctx = 0;
+    gss_buffer_desc major_string;
+    gss_buffer_desc minor_string;
+    OM_uint32 ret;
+    QByteArray errorstr;
+
+    do {
+        ret = gss_display_status(&new_status, major_status, GSS_C_GSS_CODE, GSS_C_NULL_OID, &msg_ctx, &major_string);
+        errorstr += (const char *)major_string.value;
+        errorstr += ' ';
+        ret = gss_display_status(&new_status, minor_status, GSS_C_MECH_CODE, GSS_C_NULL_OID, &msg_ctx, &minor_string);
+        errorstr += (const char *)minor_string.value;
+        errorstr += ' ';
+    } while (!GSS_ERROR(ret) && msg_ctx != 0);
+
+    return errorstr;
+}
+
+
+QByteArray KHttpNegotiateAuthentication::scheme() const
+{
+    return "Negotiate";
+}
+
+
+void KHttpNegotiateAuthentication::setChallenge(const QByteArray &c, const KUrl &resource,
+                                                const QByteArray &httpMethod)
+{
+    KAbstractHttpAuthentication::setChallenge(c, resource, httpMethod);
+    // GSSAPI knows how to get the credentials on its own
+    m_needCredentials = false;
+}
+
+
+void KHttpNegotiateAuthentication::fillKioAuthInfo(KIO::AuthInfo *ai) const
+{
+    authInfoBoilerplate(ai);
+    //### does GSSAPI supply anything realm-like? dummy value for now.
+    ai->realmValue = "Negotiate";
+}
+
+
+void KHttpNegotiateAuthentication::generateResponse(const QString &user, const QString &password)
+{
+    generateResponseCommon(user, password);
+    if (m_isError) {
+        return;
+    }
+
+    OM_uint32 major_status, minor_status;
+    gss_buffer_desc input_token = GSS_C_EMPTY_BUFFER;
+    gss_buffer_desc output_token = GSS_C_EMPTY_BUFFER;
+    gss_name_t server;
+    gss_ctx_id_t ctx;
+    gss_OID mech_oid;
+    static gss_OID_desc krb5_oid_desc = {9, (void *) "\x2a\x86\x48\x86\xf7\x12\x01\x02\x02"};
+    static gss_OID_desc spnego_oid_desc = {6, (void *) "\x2b\x06\x01\x05\x05\x02"};
+    gss_OID_set mech_set;
+    gss_OID tmp_oid;
+
+    ctx = GSS_C_NO_CONTEXT;
+    mech_oid = &krb5_oid_desc;
+
+    // see whether we can use the SPNEGO mechanism
+    major_status = gss_indicate_mechs(&minor_status, &mech_set);
+    if (GSS_ERROR(major_status)) {
+        kDebug(7113) << "gss_indicate_mechs failed: " << gssError(major_status, minor_status);
+    } else {
+        for (uint i = 0; i < mech_set->count; i++) {
+            tmp_oid = &mech_set->elements[i];
+            if (tmp_oid->length == spnego_oid_desc.length &&
+                !memcmp(tmp_oid->elements, spnego_oid_desc.elements, tmp_oid->length)) {
+                kDebug(7113) << "found SPNEGO mech";
+                mech_oid = &spnego_oid_desc;
+                break;
+            }
+        }
+        gss_release_oid_set(&minor_status, &mech_set);
+    }
+
+    // the service name is "HTTP/f.q.d.n"
+    QByteArray servicename = "HTTP@";
+    servicename += m_resource.host().toAscii();
+
+    input_token.value = (void *)servicename.data();
+    input_token.length = servicename.length() + 1;
+
+    major_status = gss_import_name(&minor_status, &input_token,
+                                   GSS_C_NT_HOSTBASED_SERVICE, &server);
+
+    input_token.value = NULL;
+    input_token.length = 0;
+
+    if (GSS_ERROR(major_status)) {
+        kDebug(7113) << "gss_import_name failed: " << gssError(major_status, minor_status);
+        m_isError = true;
+        return;
+    }
+
+    OM_uint32 req_flags = 0;
+    // GSSAPI knows how to get the credentials its own way, so don't ask for any
+    major_status = gss_init_sec_context(&minor_status, GSS_C_NO_CREDENTIAL,
+                                        &ctx, server, mech_oid,
+                                        req_flags, GSS_C_INDEFINITE,
+                                        GSS_C_NO_CHANNEL_BINDINGS,
+                                        GSS_C_NO_BUFFER, NULL, &output_token,
+                                        NULL, NULL);
+
+    if (GSS_ERROR(major_status) || (output_token.length == 0)) {
+        kDebug(7113) << "gss_init_sec_context failed: " << gssError(major_status, minor_status);
+        gss_release_name(&minor_status, &server);
+        if (ctx != GSS_C_NO_CONTEXT) {
+            gss_delete_sec_context(&minor_status, &ctx, GSS_C_NO_BUFFER);
+            ctx = GSS_C_NO_CONTEXT;
+        }
+        m_isError = true;
+        return;
+    }
+
+    m_headerFragment = "Negotiate ";
+    m_headerFragment += QByteArray::fromRawData((const char *)output_token.value,
+                                                output_token.length).toBase64();
+    m_headerFragment += "\r\n";
+
+    // free everything
+    gss_release_name(&minor_status, &server);
+    if (ctx != GSS_C_NO_CONTEXT) {
+        gss_delete_sec_context(&minor_status, &ctx, GSS_C_NO_BUFFER);
+        ctx = GSS_C_NO_CONTEXT;
+    }
+    gss_release_buffer(&minor_status, &output_token);
+}
+
+#endif // HAVE_LIBGSSAPI
Index: kioslave/http/http_cache_cleaner.desktop
===================================================================
--- kioslave/http/http_cache_cleaner.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kioslave/http/http_cache_cleaner.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -30,6 +30,7 @@
 Name[gu]=HTTP કૅશ સાફ કરનાર
 Name[he]=מנקה מטמון ה־HTTP
 Name[hi]=एचटीटीपी कैच क्लीनर
+Name[hne]=एचटीटीपी कैच क्लीनर
 Name[hr]=Brisanje HTTP pohrane
 Name[hu]=HTTP gyorstártisztító
 Name[is]=Hreinsiforrit HTTP skyndiminnis
@@ -113,6 +114,7 @@
 Comment[gu]=HTTP કૅશમાંથી જૂનાં દાખલાઓ દૂર કરે છે
 Comment[he]=מנקה רשומות ישנות ממטמון ה־HTTP
 Comment[hi]=एचटीटीपी कैच से पुरानी प्रविष्टियों को साफ करता है
+Comment[hne]=एचटीटीपी कैच से जुन्ना प्रविस्टि मन ल साफ करथे 
 Comment[hr]=Uklanjanje starih datoteka iz HTTP privremene lokalne pohrane
 Comment[hsb]=Wumaza stare zapisy z temporerneho pomjatka HTTP
 Comment[hu]=Kitörli a régi bejegyzéseket a HTTP gyorstárból
Index: kioslave/http/http.h
===================================================================
--- kioslave/http/http.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kioslave/http/http.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -4,7 +4,7 @@
    Copyright (C) 2000,2001 George Staikos <staikos@kde.org>
    Copyright (C) 2001,2002 Hamish Rodda <rodda@kde.org>
    Copyright (C) 2007      Daniel Nicoletti <mirttex@users.sourceforge.net>
-   Copyright (C) 2008      Andreas Hartmetz <ahartmetz@gmail.com>
+   Copyright (C) 2008,2009 Andreas Hartmetz <ahartmetz@gmail.com>
 
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
@@ -44,6 +44,8 @@
 
 // HeaderTokenizer declarations
 #include "parsinghelpers.h"
+// KHttpAuthentication & KHttpAuthenticationOutcome declarations
+#include "httpauthentication.h"
 
 class QDomNodeList;
 
@@ -163,21 +165,6 @@
     CacheTag cacheTag;
   };
 
-  struct DigestAuthInfo
-  {
-    QByteArray nc;
-    QByteArray qop;
-    QByteArray realm;
-    QByteArray nonce;
-    QByteArray method;
-    QByteArray cnonce;
-    QByteArray username;
-    QByteArray password;
-    KUrl::List digestURIs;
-    QByteArray algorithm;
-    QByteArray entityBody;
-  };
-
   /** State of the current connection to the server **/
   struct HTTPServerState
   {
@@ -299,16 +286,16 @@
     */
   void addEncoding(const QString &, QStringList &);
 
-  void configAuth(const QList<QByteArray> &headerLine, bool isProxyAuth);
+  //void processAuthenticationRequest();
 
-
   // The methods between here and sendQuery() are helpers for sendQuery().
 
   // Return true if the request is already "done", false otherwise.
   // *sucesss will be set to true if the page was found, false otherwise.
   bool satisfyRequestFromCache(bool *success);
   QString formatRequestUri() const;
-  QString wwwAuthenticationHeader();
+  // create HTTP authentications response(s), if any
+  QString authenticationHeader();
   bool sendQuery();
   
   void httpClose(bool keepAlive);  // Close transfer
@@ -440,37 +427,6 @@
   void resetConnectionSettings();
 
   /**
-   * Returns any pre-cached proxy authentication info
-   * info in HTTP header format.
-   */
-  QString proxyAuthenticationHeader();
-
-  /**
-   * Retrieves authorization info from cache or user.
-   */
-  bool getAuthorization();
-
-  /**
-   * Saves valid authorization info in the cache daemon.
-   */
-  void saveAuthorization(bool isForProxy);
-
-  /**
-   * Creates the entity-header for Basic authentication.
-   */
-  QString createBasicAuth( bool isForProxy = false );
-
-  /**
-   * Creates the entity-header for Digest authentication.
-   */
-  QString createDigestAuth( bool isForProxy = false );
-
-  /**
-   * Creates the entity-header for NTLM authentication.
-   */
-  QString createNTLMAuth( bool isForProxy = false );
-
-  /**
    * Creates the entity-header for Negotiate authentication.
    */
   QString createNegotiateAuth();
@@ -481,16 +437,6 @@
   QByteArray gssError( int major_status, int minor_status );
 
   /**
-   * Calcualtes the message digest response based on RFC 2617.
-   */
-  void calculateResponse( DigestAuthInfo &info, QByteArray &Response );
-
-  /**
-   * Prompts the user for authorization retry.
-   */
-  bool retryPrompt();
-
-  /**
    * Creates authorization prompt info.
    */
   void fillPromptInfo(KIO::AuthInfo *info);
@@ -558,12 +504,9 @@
   // Operation mode
   QByteArray m_protocol;
 
-  // Authentication
-  bool m_isUnauthorized;
-
   //TODO use PrevRequest fully
   //TODO isAuthValid/m_isUnauthorized -> auth.scheme != AUTH_None ?
-
+#if 0
   struct AuthState
   {
     AUTH_SCHEME scheme;
@@ -571,9 +514,12 @@
     QString authorization;
     int authCount;
   };
+#endif
 
-  AuthState m_auth;
-  AuthState m_proxyAuth;
+  KAbstractHttpAuthentication *m_wwwAuth;
+  KAbstractHttpAuthentication *m_proxyAuth;
+  // For proxy auth when it's handled by the Qt/KDE socket classes
+  QAuthenticator *m_socketProxyAuth;
 
   // Indicates whether there was some connection error.
   bool m_isError;
Index: kioslave/http/httpauthentication.h
===================================================================
--- kioslave/http/httpauthentication.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 0)
+++ kioslave/http/httpauthentication.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -0,0 +1,156 @@
+/* This file is part of the KDE libraries
+    Copyright (C) 2008, 2009 Andreas Hartmetz <ahartmetz@gmail.com>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Library General Public
+    License as published by the Free Software Foundation; either
+    version 2 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Library General Public License for more details.
+
+    You should have received a copy of the GNU Library General Public License
+    along with this library; see the file COPYING.LIB.  If not, write to
+    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+    Boston, MA 02110-1301, USA.
+*/
+
+#ifndef HTTPAUTHENTICATION_H
+#define HTTPAUTHENTICATION_H
+
+#include <config-gssapi.h>
+
+#ifndef HTTP_H_ // if we're included from http.cpp all necessary headers are already included
+#include <QtCore/QByteArray>
+#include <QtCore/QString>
+#include <QtCore/QList>
+#include <kio/authinfo.h>
+#endif
+
+namespace KIO {
+class AuthInfo;
+}
+
+class KAbstractHttpAuthentication
+{
+public:
+    KAbstractHttpAuthentication()
+    {
+        reset();
+    }
+
+    static QByteArray bestOffer(const QList<QByteArray> &offers);
+    static KAbstractHttpAuthentication *newAuth(const QByteArray &offer);
+
+    virtual ~KAbstractHttpAuthentication() {}
+
+    // reset to state after default construction.
+    void reset();
+    // the authentication scheme: "Negotiate", "Digest", "Basic", "NTLM"
+    virtual QByteArray scheme() const = 0;
+    // initiate authentication with challenge string (from HTTP header) c
+    virtual void setChallenge(const QByteArray &c, const KUrl &resource, const QByteArray &httpMethod);
+    // return value updated by setChallenge(); if this is false user and password passed
+    // to generateResponse will be ignored and may be empty.
+    bool needCredentials() const { return m_needCredentials; }
+    // KIO compatible data to find cached credentials. Note that username and/or password
+    // as well as UI text will NOT be filled in.
+    virtual void fillKioAuthInfo(KIO::AuthInfo *ai) const = 0;
+    // what to do in response to challenge
+    virtual void generateResponse(const QString &user,
+                                  const QString &password) = 0;
+
+    // the following accessors return useful data after generateResponse() has been called.
+    // clients process the following fields top to bottom: highest priority is on top
+
+    // malformed challenge and similar problems - it is advisable to reconnect
+    bool isError() const { return m_isError; }
+    // force keep-alive connection because the authentication method requires it
+    bool forceKeepAlive() const { return m_forceKeepAlive; }
+    // force disconnection because the authentication method requires it
+    bool forceDisconnect() const { return m_forceDisconnect; }
+
+    // insert this into the next request header after "Authorization: " or "Proxy-Authorization: "
+    QString headerFragment() const { return m_headerFragment; }
+    // this is mainly for GUI shown to the user
+    QString realm() const;
+
+protected:
+    void authInfoBoilerplate(KIO::AuthInfo *a) const;
+    void generateResponseCommon(const QString &user, const QString &password);
+
+    QByteArray m_scheme;    // this is parsed from the header and not necessarily == scheme().
+    QList<QByteArray> m_challenge;
+    KUrl m_resource;
+    QByteArray m_httpMethod;
+
+    bool m_isError;
+    bool m_needCredentials;
+    bool m_forceKeepAlive;
+    bool m_forceDisconnect;
+    QString m_headerFragment;
+
+    QString m_username;
+    QString m_password;
+};
+
+
+class KHttpBasicAuthentication : public KAbstractHttpAuthentication
+{
+public:
+    virtual QByteArray scheme() const;
+    virtual void fillKioAuthInfo(KIO::AuthInfo *ai) const;
+    virtual void generateResponse(const QString &user, const QString &password);
+private:
+    friend class KAbstractHttpAuthentication;
+    KHttpBasicAuthentication()
+     : KAbstractHttpAuthentication() {}
+};
+
+
+class KHttpDigestAuthentication : public KAbstractHttpAuthentication
+{
+public:
+    virtual QByteArray scheme() const;
+    virtual void setChallenge(const QByteArray &c, const KUrl &resource, const QByteArray &httpMethod);
+    virtual void fillKioAuthInfo(KIO::AuthInfo *ai) const;
+    virtual void generateResponse(const QString &user, const QString &password);
+private:
+    friend class KAbstractHttpAuthentication;
+    KHttpDigestAuthentication()
+     : KAbstractHttpAuthentication() {}
+};
+
+
+class KHttpNtlmAuthentication : public KAbstractHttpAuthentication
+{
+public:
+    virtual QByteArray scheme() const;
+    virtual void setChallenge(const QByteArray &c, const KUrl &resource, const QByteArray &httpMethod);
+    virtual void fillKioAuthInfo(KIO::AuthInfo *ai) const;
+    virtual void generateResponse(const QString &user, const QString &password);
+private:
+    friend class KAbstractHttpAuthentication;
+    KHttpNtlmAuthentication()
+     : KAbstractHttpAuthentication() {}
+};
+
+
+#ifdef HAVE_LIBGSSAPI
+class KHttpNegotiateAuthentication : public KAbstractHttpAuthentication
+{
+public:
+    virtual QByteArray scheme() const;
+    virtual void setChallenge(const QByteArray &c, const KUrl &resource, const QByteArray &httpMethod);
+    virtual void fillKioAuthInfo(KIO::AuthInfo *ai) const;
+    virtual void generateResponse(const QString &user, const QString &password);
+private:
+    friend class KAbstractHttpAuthentication;
+    KHttpNegotiateAuthentication()
+     : KAbstractHttpAuthentication() {}
+};
+#endif // HAVE_LIBGSSAPI
+
+#endif // HTTPAUTHENTICATION_H
Index: kioslave/http/parsinghelpers.cpp
===================================================================
--- kioslave/http/parsinghelpers.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kioslave/http/parsinghelpers.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -145,7 +145,8 @@
         {"location", false},
         {"p3p", true}, // http://www.w3.org/TR/P3P/
         {"pragma", true},
-        {"proxy-authenticate", true},
+        {"proxy-authenticate", false}, //complicated multi-valuedness: quoted commas don't separate
+                                       //multiple values. we handle this at a higher level.
         {"proxy-connection", true}, //inofficial but well-known; to avoid misunderstandings
                                     //when using "connection" when talking to a proxy.
         {"refresh", false}, //not sure, only found some mailing list posts mentioning it
@@ -155,7 +156,7 @@
         {"transfer-encoding", true},
         {"upgrade", true},
         {"warning", true},
-        {"www-authenticate", true}
+        {"www-authenticate", false} //see proxy-authenticate
     };
 
     for (uint i = 0; i < sizeof(headerFieldTemplates) / sizeof(HeaderFieldTemplate); i++) {
Index: kinit/klauncher.cpp
===================================================================
--- kinit/klauncher.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kinit/klauncher.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -17,6 +17,8 @@
   Boston, MA 02110-1301, USA.
 */
 
+#define QT_NO_CAST_FROM_ASCII
+
 #include "klauncher.h"
 #include "klauncher_cmds.h"
 #include "klauncher_adaptor.h"
@@ -58,6 +60,9 @@
 
 // #define KLAUNCHER_VERBOSE_OUTPUT
 
+static const char* const s_DBusStartupTypeToString[] =
+    { "DBusNone", "DBusUnique", "DBusMulti", "DBusWait", "ERROR" };
+
 using namespace KIO;
 
 IdleSlave::IdleSlave(QObject *parent)
@@ -167,7 +172,7 @@
 
 KLauncher::KLauncher(int _kdeinitSocket)
   : QObject(0),
-    kdeinitSocket(_kdeinitSocket), dontBlockReading(false)
+    kdeinitSocket(_kdeinitSocket)
 {
 #ifdef Q_WS_X11
    mCached_dpy = NULL;
@@ -177,7 +182,7 @@
 
    mAutoTimer.setSingleShot(true);
    new KLauncherAdaptor(this);
-   QDBusConnection::sessionBus().registerObject("/KLauncher", this); // same as ktoolinvocation.cpp
+   QDBusConnection::sessionBus().registerObject(QLatin1String("/KLauncher"), this); // same as ktoolinvocation.cpp
 
    connect(&mAutoTimer, SIGNAL(timeout()), this, SLOT(slotAutoStart()));
    connect(QDBusConnection::sessionBus().interface(),
@@ -276,8 +281,24 @@
 {
   ssize_t result;
   int bytes_left = len;
-  while ( bytes_left > 0)
-  {
+    while (bytes_left > 0) {
+        // in case we get a request to start an application and data arrive
+        // to kdeinitSocket at the same time, requestStart() will already
+        // call slotKDEInitData(), so we must check there's still something
+        // to read, otherwise this would block
+
+        // Same thing if kdeinit dies without warning.
+
+        fd_set in;
+        timeval tm = { 30, 0 }; // 30 seconds timeout, so we're not stuck in case kdeinit dies on us
+        FD_ZERO ( &in );
+        FD_SET( sock, &in );
+        select( sock + 1, &in, 0, 0, &tm );
+        if( !FD_ISSET( sock, &in )) {
+            kDebug(7016) << "read_socket" << sock << "nothing to read, kdeinit4 must be dead";
+            return -1;
+        }
+
      result = read(sock, buffer, bytes_left);
      if (result > 0)
      {
@@ -298,21 +319,7 @@
 {
    klauncher_header request_header;
    QByteArray requestData;
-   if( dontBlockReading )
-   {
-   // in case we get a request to start an application and data arrive
-   // to kdeinitSocket at the same time, requestStart() will already
-   // call slotKDEInitData(), so we must check there's still something
-   // to read, otherwise this would block
-      fd_set in;
-      timeval tm = { 0, 0 };
-      FD_ZERO ( &in );
-      FD_SET( kdeinitSocket, &in );
-      select( kdeinitSocket + 1, &in, 0, 0, &tm );
-      if( !FD_ISSET( kdeinitSocket, &in ))
-         return;
-   }
-   dontBlockReading = false;
+
    int result = read_socket(kdeinitSocket, (char *) &request_header,
                             sizeof( request_header));
    if (result == -1)
@@ -391,15 +398,19 @@
       if (request->pid == pid)
       {
          if (request->dbus_startup_type == KService::DBusWait)
-            request->status = KLaunchRequest::Done;
+             request->status = KLaunchRequest::Done;
          else if ((request->dbus_startup_type == KService::DBusUnique)
-                  && QDBusConnection::sessionBus().interface()->isServiceRegistered(request->dbus_name))
-            request->status = KLaunchRequest::Running;
-         else
-            request->status = KLaunchRequest::Error;
+                  && QDBusConnection::sessionBus().interface()->isServiceRegistered(request->dbus_name)) {
+             request->status = KLaunchRequest::Running;
 #ifdef KLAUNCHER_VERBOSE_OUTPUT
-         kDebug(7016) << pid << "died, requestDone. status=" << request->status;
+             kDebug(7016) << pid << "running as a unique app";
 #endif
+         } else {
+             request->status = KLaunchRequest::Error;
+#ifdef KLAUNCHER_VERBOSE_OUTPUT
+             kDebug(7016) << pid << "died, requestDone. status=" << request->status;
+#endif
+         }
          requestDone(request);
          return;
       }
@@ -414,13 +425,13 @@
     // appId just registered, e.g. org.koffice.kword-12345
     // Let's see if this is what pendingAppId (e.g. org.koffice.kword or *.kword) was waiting for.
 
-    const QString newAppId = appId.left(appId.lastIndexOf('-')); // strip out the -12345 if present.
+    const QString newAppId = appId.left(appId.lastIndexOf(QLatin1Char('-'))); // strip out the -12345 if present.
 
     //kDebug() << "appId=" << appId << "newAppId=" << newAppId << "pendingAppId=" << pendingAppId;
 
-    if (pendingAppId.startsWith("*.")) {
+    if (pendingAppId.startsWith(QLatin1String("*."))) {
         const QString pendingName = pendingAppId.mid(2);
-        const QString appName = newAppId.mid(newAppId.lastIndexOf('.')+1);
+        const QString appName = newAppId.mid(newAppId.lastIndexOf(QLatin1Char('.'))+1);
         //kDebug() << "appName=" << appName;
         return appName == pendingName;
     }
@@ -444,19 +455,29 @@
       if (request->status != KLaunchRequest::Launching)
          continue;
 
+#ifdef KLAUNCHER_VERBOSE_OUTPUT
+      kDebug(7016) << "had pending request" << request->name << s_DBusStartupTypeToString[request->dbus_startup_type] << "dbus_name" << request->dbus_name << request->tolerant_dbus_name;
+#endif
       // For unique services check the requested service name first
-      if ((request->dbus_startup_type == KService::DBusUnique) &&
-          ((appId == request->dbus_name) ||
-           QDBusConnection::sessionBus().interface()->isServiceRegistered(request->dbus_name)))
-      {
-         request->status = KLaunchRequest::Running;
-         requestDone(request);
-         continue;
+      if (request->dbus_startup_type == KService::DBusUnique) {
+          if ((appId == request->dbus_name) || // just started
+              QDBusConnection::sessionBus().interface()->isServiceRegistered(request->dbus_name)) { // was already running
+              request->status = KLaunchRequest::Running;
+#ifdef KLAUNCHER_VERBOSE_OUTPUT
+              kDebug(7016) << "OK, unique app" << request->dbus_name << "is running";
+#endif
+              requestDone(request);
+              continue;
+          } else {
+#ifdef KLAUNCHER_VERBOSE_OUTPUT
+              kDebug(7016) << "unique app" << request->dbus_name << "not running yet";
+#endif
+          }
       }
 
-      const QString rAppId = request->dbus_name;
+      const QString rAppId = !request->tolerant_dbus_name.isEmpty() ? request->tolerant_dbus_name : request->dbus_name;
 #ifdef KLAUNCHER_VERBOSE_OUTPUT
-      kDebug(7016) << "had pending request" << rAppId;
+      //kDebug(7016) << "using" << rAppId << "for matching";
 #endif
       if (rAppId.isEmpty())
           continue;
@@ -523,16 +544,16 @@
    {
       requestResult.result = 0;
       requestResult.dbusName = request->dbus_name;
-      requestResult.error = "";
+      requestResult.error = QString::fromLatin1(""); // not null, cf assert further down
       requestResult.pid = request->pid;
    }
    else
    {
       requestResult.result = 1;
-      requestResult.dbusName = "";
+      requestResult.dbusName = QString();
       requestResult.error = i18n("KDEInit could not launch '%1'.", request->name);
       if (!request->errorMsg.isEmpty())
-         requestResult.error += ":\n" + request->errorMsg;
+          requestResult.error += QString::fromLatin1(":\n") + request->errorMsg;
       requestResult.pid = 0;
 
 #ifdef Q_WS_X11
@@ -543,11 +564,11 @@
               (request->startup_dpy == XDisplayString( mCached_dpy )))
             dpy = mCached_dpy;
          if( dpy == NULL )
-            dpy = XOpenDisplay( request->startup_dpy.toLocal8Bit() );
+            dpy = XOpenDisplay(request->startup_dpy);
          if( dpy )
          {
             KStartupInfoId id;
-            id.initId( request->startup_id.toLocal8Bit() );
+            id.initId(request->startup_id);
             KStartupInfo::sendFinishX( dpy, id );
             if( mCached_dpy != dpy && mCached_dpy != NULL )
                XCloseDisplay( mCached_dpy );
@@ -565,7 +586,7 @@
    if (request->transaction.type() != QDBusMessage::InvalidMessage)
    {
       if ( requestResult.dbusName.isNull() ) // null strings can't be sent
-          requestResult.dbusName = "";
+          requestResult.dbusName = QString();
       Q_ASSERT( !requestResult.error.isNull() );
       PIDType<sizeof(pid_t)>::PID_t stream_pid = requestResult.pid;
       QDBusConnection::sessionBus().send(request->transaction.createReply(QVariantList() << requestResult.result
@@ -636,10 +657,10 @@
 #ifdef Q_WS_X11
    bool startup_notify = !request->startup_id.isNull() && request->startup_id != "0";
    if( startup_notify )
-       requestData.append(request->startup_id.toLocal8Bit()).append('\0');
+       requestData.append(request->startup_id).append('\0');
 #endif
    if (!request->cwd.isEmpty())
-       requestData.append(request->cwd.toLocal8Bit()).append('\0');
+       requestData.append(QFile::encodeName(request->cwd)).append('\0');
 
 #ifdef Q_WS_X11
    request_header.cmd = startup_notify ? LAUNCHER_EXT_EXEC : LAUNCHER_EXEC_NEW;
@@ -647,17 +668,21 @@
    request_header.cmd = LAUNCHER_EXEC_NEW;
 #endif
    request_header.arg_length = requestData.length();
+
+#ifdef KLAUNCHER_VERBOSE_OUTPUT
+   kDebug(7016) << "Asking kdeinit to start" << request->name << request->arg_list
+                << "cmd=" << commandToString(request_header.cmd);
+#endif
+
    write(kdeinitSocket, &request_header, sizeof(request_header));
    write(kdeinitSocket, requestData.data(), requestData.length());
 
    // Wait for pid to return.
    lastRequest = request;
-   dontBlockReading = false;
    do {
       slotKDEInitData( kdeinitSocket );
    }
    while (lastRequest != 0);
-   dontBlockReading = true;
 #endif
 }
 
@@ -672,11 +697,11 @@
    request->status = KLaunchRequest::Launching;
    request->envs = envs;
    // Find service, if any - strip path if needed
-   KService::Ptr service = KService::serviceByDesktopName( name.mid( name.lastIndexOf( '/' ) + 1 ));
+   KService::Ptr service = KService::serviceByDesktopName( name.mid( name.lastIndexOf(QLatin1Char('/')) + 1 ));
    if (service)
-       send_service_startup_info( request, service, startup_id, QStringList());
+       send_service_startup_info(request, service, startup_id.toLocal8Bit(), QStringList());
    else // no .desktop file, no startup info
-       cancel_service_startup_info( request, startup_id, envs );
+       cancel_service_startup_info( request, startup_id.toLocal8Bit(), envs );
 
    requestStart(request);
    // We don't care about this request any longer....
@@ -696,10 +721,10 @@
    {
       requestResult.result = ENOENT;
       requestResult.error = i18n("Could not find service '%1'.", serviceName);
-      cancel_service_startup_info( NULL, startup_id, envs ); // cancel it if any
+      cancel_service_startup_info( NULL, startup_id.toLocal8Bit(), envs ); // cancel it if any
       return false;
    }
-   return start_service(service, urls, envs, startup_id, blind, false, msg);
+   return start_service(service, urls, envs, startup_id.toLocal8Bit(), blind, false, msg);
 }
 
 bool
@@ -721,10 +746,10 @@
    {
       requestResult.result = ENOENT;
       requestResult.error = i18n("Could not find service '%1'.", serviceName);
-      cancel_service_startup_info( NULL, startup_id, envs ); // cancel it if any
+      cancel_service_startup_info( NULL, startup_id.toLocal8Bit(), envs ); // cancel it if any
       return false;
    }
-   return start_service(service, urls, envs, startup_id, blind, false, msg);
+   return start_service(service, urls, envs, startup_id.toLocal8Bit(), blind, false, msg);
 }
 
 bool
@@ -736,16 +761,16 @@
    {
       requestResult.result = ENOENT;
       requestResult.error = i18n("Could not find service '%1'.", serviceName);
-      cancel_service_startup_info( NULL, startup_id, envs ); // cancel it if any
+      cancel_service_startup_info( NULL, startup_id.toLocal8Bit(), envs ); // cancel it if any
       return false;
    }
-   return start_service(service, urls, envs, startup_id, blind, false, msg);
+   return start_service(service, urls, envs, startup_id.toLocal8Bit(), blind, false, msg);
 }
 
 bool
 KLauncher::start_service(KService::Ptr service, const QStringList &_urls,
-    const QStringList &envs, const QString &startup_id,
-    bool blind, bool autoStart, const QDBusMessage &msg)
+                         const QStringList &envs, const QByteArray &startup_id,
+                         bool blind, bool autoStart, const QDBusMessage &msg)
 {
    QStringList urls = _urls;
    if (!service->isValid())
@@ -772,7 +797,7 @@
       {
          QStringList singleUrl;
          singleUrl.append(*it);
-         QString startup_id2 = startup_id;
+         QByteArray startup_id2 = startup_id;
          if( !startup_id2.isEmpty() && startup_id2 != "0" )
              startup_id2 = "0"; // can't use the same startup_id several times
          start_service( service, singleUrl, envs, startup_id2, true, false, msg);
@@ -795,28 +820,35 @@
 
    request->name = request->arg_list.takeFirst();
 
-   if (request->name.endsWith("/kioexec")) {
+   if (request->name.endsWith(QLatin1String("/kioexec"))) {
        // Special case for kioexec; if createArgs said we were going to use it,
        // then we have to expect a kioexec-PID, not a org.kde.finalapp...
        // Testcase: konqueror www.kde.org, RMB on link, open with, kruler.
 
        request->dbus_startup_type = KService::DBusMulti;
-       request->dbus_name = "org.kde.kioexec";
+       request->dbus_name = QString::fromLatin1("org.kde.kioexec");
    } else {
        request->dbus_startup_type = service->dbusStartupType();
 
        if ((request->dbus_startup_type == KService::DBusUnique) ||
            (request->dbus_startup_type == KService::DBusMulti)) {
-           const QVariant v = service->property("X-DBUS-ServiceName");
+           const QVariant v = service->property(QLatin1String("X-DBUS-ServiceName"));
            if (v.isValid()) {
-               request->dbus_name = v.toString().toUtf8();
+               request->dbus_name = v.toString();
            }
            if (request->dbus_name.isEmpty()) {
-               request->dbus_name = "*." + QFile::encodeName(KRun::binaryName(service->exec(), true));
+               const QString binName = KRun::binaryName(service->exec(), true);
+               request->dbus_name = QString::fromLatin1("org.kde.") + binName;
+               request->tolerant_dbus_name = QString::fromLatin1("*.") + binName;
            }
        }
    }
 
+#ifdef KLAUNCHER_VERBOSE_OUTPUT
+   kDebug(7016) << "name=" << request->name << "dbus_name=" << request->dbus_name
+                << "startup type=" << s_DBusStartupTypeToString[request->dbus_startup_type];
+#endif
+
    request->pid = 0;
    request->envs = envs;
    send_service_startup_info( request, service, startup_id, envs );
@@ -832,33 +864,31 @@
 }
 
 void
-KLauncher::send_service_startup_info( KLaunchRequest *request, KService::Ptr service, const QString& startup_id,
+KLauncher::send_service_startup_info( KLaunchRequest *request, KService::Ptr service, const QByteArray& startup_id,
     const QStringList &envs )
 {
 #ifdef Q_WS_X11
     request->startup_id = "0";
-    if( startup_id == "0" )
+    if (startup_id == "0")
         return;
     bool silent;
     QByteArray wmclass;
     if( !KRun::checkStartupNotify( QString(), service.data(), &silent, &wmclass ))
         return;
     KStartupInfoId id;
-    id.initId( startup_id.toLatin1() );
-    QString dpy_str;
+    id.initId(startup_id);
+    QByteArray dpy_str;
     foreach (const QString &env, envs) {
         if (env.startsWith(QLatin1String("DISPLAY=")))
-            dpy_str = env.mid(8);
+            dpy_str = env.mid(8).toLocal8Bit();
     }
     Display* dpy = NULL;
-    if( !dpy_str.isEmpty() && mCached_dpy != NULL
-        && dpy_str != QLatin1String(XDisplayString(mCached_dpy)) )
+    if (!dpy_str.isEmpty() && mCached_dpy != NULL && dpy_str != XDisplayString(mCached_dpy))
         dpy = mCached_dpy;
-    if( dpy == NULL )
-        dpy = XOpenDisplay( dpy_str.toLatin1().constData() );
+    if (dpy == NULL)
+        dpy = XOpenDisplay(dpy_str);
     request->startup_id = id.id();
-    if( dpy == NULL )
-    {
+    if (dpy == NULL) {
         cancel_service_startup_info( request, startup_id, envs );
         return;
     }
@@ -885,7 +915,7 @@
 }
 
 void
-KLauncher::cancel_service_startup_info( KLaunchRequest* request, const QString& startup_id,
+KLauncher::cancel_service_startup_info( KLaunchRequest* request, const QByteArray& startup_id,
     const QStringList &envs )
 {
 #ifdef Q_WS_X11
@@ -907,7 +937,7 @@
         if( dpy == NULL )
             return;
         KStartupInfoId id;
-        id.initId( startup_id.toLatin1() );
+        id.initId(startup_id);
         KStartupInfo::sendFinishX( dpy, id );
         if( mCached_dpy != dpy && mCached_dpy != NULL )
            XCloseDisplay( mCached_dpy );
@@ -923,36 +953,27 @@
 {
    KLaunchRequest *request = new KLaunchRequest;
    request->autoStart = false;
-
-   for(QStringList::ConstIterator it = args.begin();
-       it != args.end();
-       ++it)
-   {
-       QString arg = *it;
-       request->arg_list.append(arg.toLocal8Bit());
-   }
-
-   request->name = app.toLocal8Bit();
-
+   request->arg_list = args;
+   request->name = app;
    if (wait)
       request->dbus_startup_type = KService::DBusWait;
    else
       request->dbus_startup_type = KService::DBusNone;
    request->pid = 0;
 #ifdef Q_WS_X11
-   request->startup_id = startup_id;
+   request->startup_id = startup_id.toLocal8Bit();
 #endif
    request->envs = envs;
    request->cwd = workdir;
-   if( !app.endsWith("kbuildsycoca4") ) // avoid stupid loop
-   {
+   if (!app.endsWith(QLatin1String("kbuildsycoca4"))) { // avoid stupid loop
        // Find service, if any - strip path if needed
-       KService::Ptr service = KService::serviceByDesktopName( app.mid( app.lastIndexOf( '/' ) + 1 ));
+       const QString desktopName = app.mid(app.lastIndexOf(QLatin1Char('/')) + 1);
+       KService::Ptr service = KService::serviceByDesktopName(desktopName);
        if (service)
-           send_service_startup_info( request,  service,
-               startup_id, QStringList());
+           send_service_startup_info(request, service,
+                                     request->startup_id, QStringList());
        else // no .desktop file, no startup info
-           cancel_service_startup_info( request, startup_id, envs );
+           cancel_service_startup_info(request, request->startup_id, envs);
    }
    msg.setDelayedReply(true);
    request->transaction = msg;
@@ -1107,9 +1128,9 @@
     }
     if (mSlaveValgrind == arg1)
     {
-       arg_list.prepend(QFile::encodeName(KLibLoader::findLibrary(name.toLocal8Bit())));
-       arg_list.prepend(QFile::encodeName(KStandardDirs::locate("exe", "kioslave")));
-       name = "valgrind";
+       arg_list.prepend(KLibLoader::findLibrary(name));
+       arg_list.prepend(KStandardDirs::locate("exe", QString::fromLatin1("kioslave")));
+       name = QString::fromLatin1("valgrind");
        if (!mSlaveValgrindSkin.isEmpty()) {
            arg_list.prepend(QLatin1String("--tool=") + mSlaveValgrindSkin);
        } else
@@ -1204,7 +1225,7 @@
     time_t now = time(0);
     foreach (IdleSlave *slave, mSlaveList)
     {
-        if ((slave->protocol()=="file") && (keepOneFileSlave))
+        if ((slave->protocol()==QLatin1String("file")) && (keepOneFileSlave))
            keepOneFileSlave=false;
         else if (slave->age(now) > SLAVE_MAX_IDLE)
         {
Index: kinit/kioslave.cpp
===================================================================
--- kinit/kioslave.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kinit/kioslave.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -19,11 +19,13 @@
  * Boston, MA 02110-1301, USA.
  */
 
+#include <kdebug.h>
 #include <config.h>
 
 #include <stdlib.h>
 #include <stdio.h>
 #include <errno.h>
+#include <locale.h>
 
 #include <QtCore/QString>
 #include <QtCore/QLibrary>
@@ -50,7 +52,8 @@
         fprintf(stderr, "Usage: kioslave <slave-lib> <protocol> <klauncher-socket> <app-socket>\n\nThis program is part of KDE.\n");
         exit(1);
      }
-     QString libpath = QFile::decodeName(argv[1]);
+     setlocale(LC_ALL, "");
+     QString libpath = QFile::encodeName(argv[1]);
 
      if (libpath.isEmpty())
      {
Index: kinit/kinit.cpp
===================================================================
--- kinit/kinit.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kinit/kinit.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -19,6 +19,8 @@
  * Boston, MA 02110-1301, USA.
  */
 
+#define QT_NO_CAST_FROM_ASCII
+
 #include <config.h>
 
 #include <sys/types.h>
@@ -87,6 +89,8 @@
 #endif
 #endif
 
+// #define SKIP_PROCTITLE 1
+
 extern char **environ;
 
 #ifdef Q_WS_X11
@@ -373,7 +377,7 @@
     KStartupInfoData data;
     int desktop = get_current_desktop( X11_startup_notify_display );
     data.setDesktop( desktop );
-    data.setBin( bin );
+    data.setBin(QFile::decodeName(bin));
     KStartupInfo::sendChangeX( X11_startup_notify_display, id, data );
     XFlush( X11_startup_notify_display );
 }
@@ -400,32 +404,31 @@
 QByteArray execpath_avoid_loops( const QByteArray& exec, int envc, const char* envs, bool avoid_loops )
 {
      QStringList paths;
+     const QRegExp pathSepRegExp(QString::fromLatin1("[:\b]"));
      if( envc > 0 ) /* use the passed environment */
      {
          const char* path = get_env_var( "PATH=", envc, envs );
          if( path != NULL )
-             paths = QString(path).split( QRegExp( "[:\b]" ));
+             paths = QFile::decodeName(path).split(pathSepRegExp);
+     } else {
+         paths = QString::fromLocal8Bit(qgetenv("PATH")).split(pathSepRegExp, QString::KeepEmptyParts);
      }
-     else
-         paths = QString::fromLocal8Bit( qgetenv("PATH") ).split( QRegExp( "[:\b]" ), QString::KeepEmptyParts );
-     QByteArray execpath = QFile::encodeName(
-         s_instance->dirs()->findExe( exec, paths.join( QLatin1String( ":" ))));
-     if( avoid_loops && !execpath.isEmpty())
-     {
-         int pos = execpath.lastIndexOf( '/' );
-         QString bin_path = execpath.left( pos );
+     QString execpath =
+         s_instance->dirs()->findExe(QFile::decodeName(exec), paths.join(QLatin1String(":")));
+     if (avoid_loops && !execpath.isEmpty()) {
+         const int pos = execpath.lastIndexOf(QLatin1Char('/'));
+         const QString bin_path = execpath.left(pos);
          for( QStringList::Iterator it = paths.begin();
               it != paths.end();
-              ++it )
-             if( ( *it ) == bin_path || ( *it ) == bin_path + '/' )
-             {
+              ++it ) {
+             if( *it == bin_path || *it == bin_path + QLatin1Char('/')) {
                  paths.erase( it );
                  break; // -->
              }
-         execpath = QFile::encodeName(
-             s_instance->dirs()->findExe( exec, paths.join( QString( ":" ))));
+         }
+         execpath = s_instance->dirs()->findExe(QFile::decodeName(exec), paths.join(QLatin1String(":")));
      }
-     return execpath;
+     return QFile::encodeName(execpath);
 }
 
 static pid_t launch(int argc, const char *_name, const char *args,
@@ -435,7 +438,7 @@
                     const char* startup_id_str = "0" )
 {
   int starting_klauncher = 0;
-  QByteArray lib;
+  QString lib;
   QByteArray name;
   QByteArray exec;
 
@@ -451,31 +454,28 @@
      starting_klauncher = 1;
   }
 
-  QByteArray libpath;
-  QByteArray execpath;
-  if (_name[0] != '/')
-  {
-     lib = name = _name;
-     exec = name;
-     libpath = QFile::encodeName(KLibLoader::findLibrary(lib.constData(), *s_instance));
-     execpath = execpath_avoid_loops( exec, envc, envs, avoid_loops );
-  }
-  else
-  {
-     lib = _name;
-     name = _name;
-     name = name.mid( name.lastIndexOf('/') + 1);
-     exec = _name;
-     if (lib.endsWith(".la"))
-        libpath = lib;
-     else
-        execpath = exec;
-  }
-  fprintf(stderr,"kdeinit4: preparing to launch %s\n", execpath.constData());
-  if (!args)
-  {
-    argc = 1;
-  }
+    QString libpath;
+    QByteArray execpath;
+    if (_name[0] != '/') {
+        name = _name;
+        lib = QFile::decodeName(name);
+        exec = name;
+        libpath = KLibLoader::findLibrary(lib, *s_instance);
+        execpath = execpath_avoid_loops(exec, envc, envs, avoid_loops);
+    } else {
+        name = _name;
+        lib = QFile::decodeName(name);
+        name = name.mid(name.lastIndexOf('/') + 1);
+        exec = _name;
+        if (lib.endsWith(QLatin1String(".la")))
+            libpath = lib;
+        else
+            execpath = exec;
+    }
+    fprintf(stderr,"kdeinit4: preparing to launch %s\n", execpath.constData());
+    if (!args) {
+        argc = 1;
+    }
 
   if (0 > pipe(d.fd))
   {
@@ -584,6 +584,7 @@
        }
        d.argv[argc] = 0;
 
+#ifndef SKIP_PROCTITLE
        /** Give the process a new name **/
 #ifdef Q_OS_LINUX
        /* set the process name, so that killall works like intended */
@@ -595,6 +596,7 @@
 #else
        proctitle_set( "kdeinit4: %s%s", name.data(), procTitle.data() ? procTitle.data() : "" );
 #endif
+#endif
      }
 
      if (libpath.isEmpty() && execpath.isEmpty())
@@ -617,13 +619,13 @@
           if (execpath.isEmpty())
           {
              // Error
-             QString errorMsg = i18n("Could not open library '%1'.\n%2", QFile::decodeName(libpath), ltdlError);
+             QString errorMsg = i18n("Could not open library '%1'.\n%2", libpath, ltdlError);
              exitWithErrorMsg(errorMsg);
           }
           else
           {
              // Print warning
-             fprintf(stderr, "Could not open library %s: %s\n", lib.data(),
+             fprintf(stderr, "Could not open library %s: %s\n", qPrintable(lib),
                      qPrintable(ltdlError) );
           }
        }
@@ -664,7 +666,7 @@
             QString ltdlError = l.errorString();
             fprintf(stderr, "Could not find kdemain: %s\n", qPrintable(ltdlError) );
               QString errorMsg = i18n("Could not find 'kdemain' in '%1'.\n%2",
-                    QLatin1String(libpath), ltdlError);
+                                      libpath, ltdlError);
               exitWithErrorMsg(errorMsg);
            }
         }
@@ -1159,6 +1161,7 @@
        }
    }
 
+   //kDebug() << "Got cmd" << request_header.cmd << commandToString(request_header.cmd);
    if (request_header.cmd == LAUNCHER_OK)
    {
       d.launcher_ok = true;
@@ -1484,15 +1487,15 @@
 
 static void kdeinit_library_path()
 {
-   QStringList ltdl_library_path =
-     QFile::decodeName(qgetenv("LTDL_LIBRARY_PATH")).split(':',QString::SkipEmptyParts);
+   const QStringList ltdl_library_path =
+     QFile::decodeName(qgetenv("LTDL_LIBRARY_PATH")).split(QLatin1Char(':'),QString::SkipEmptyParts);
 #ifdef Q_OS_DARWIN
-   QStringList ld_library_path =
-     QFile::decodeName(qgetenv("DYLD_LIBRARY_PATH")).split(':',QString::SkipEmptyParts);
+   const QByteArray ldlibpath = qgetenv("DYLD_LIBRARY_PATH");
 #else
-   QStringList ld_library_path =
-     QFile::decodeName(qgetenv("LD_LIBRARY_PATH")).split(':',QString::SkipEmptyParts);
+   const QByteArray ldlibpath = qgetenv("LD_LIBRARY_PATH");
 #endif
+   const QStringList ld_library_path =
+     QFile::decodeName(ldlibpath).split(QLatin1Char(':'),QString::SkipEmptyParts);
 
    QByteArray extra_path;
    const QStringList candidates = s_instance->dirs()->resourceDirs("lib");
@@ -1505,7 +1508,7 @@
           continue;
       if (ld_library_path.contains(d))
           continue;
-      if (d[d.length()-1] == '/')
+      if (d[d.length()-1] == QLatin1Char('/'))
       {
          d.truncate(d.length()-1);
          if (ltdl_library_path.contains(d))
@@ -1513,7 +1516,7 @@
          if (ld_library_path.contains(d))
             continue;
       }
-      if ((d == "/lib") || (d == "/usr/lib"))
+      if ((d == QLatin1String("/lib")) || (d == QLatin1String("/usr/lib")))
          continue;
 
       QByteArray dir = QFile::encodeName(d);
@@ -1558,7 +1561,8 @@
 
    display.replace(':','_');
    // WARNING, if you change the socket name, adjust kwrapper too
-   QByteArray socketName = QFile::encodeName(KStandardDirs::locateLocal("socket", QString("kdeinit4_%1").arg(QLatin1String(display)), *s_instance));
+   const QString socketFileName = QString::fromLatin1("kdeinit4_%1").arg(QLatin1String(display));
+   QByteArray socketName = QFile::encodeName(KStandardDirs::locateLocal("socket", socketFileName, *s_instance));
    if (socketName.length() >= MAX_SOCK_FILE)
    {
      fprintf(stderr, "kdeinit4: Aborting. Socket name will be too long:\n");
@@ -1628,11 +1632,14 @@
     char errstr[256];
     // kdeinit almost doesn't use X, and therefore there shouldn't be any X error
     XGetErrorText( dpy, err->error_code, errstr, 256 );
-    fprintf(stderr, "kdeinit4: KDE detected X Error: %s %d\n"
+    fprintf(stderr, "kdeinit4(%d) : KDE detected X Error: %s %d\n"
                     "         Major opcode: %d\n"
                     "         Minor opcode: %d\n"
                     "         Resource id:  0x%lx\n",
-            errstr, err->error_code, err->request_code, err->minor_code, err->resourceid );
+            getpid(), errstr, err->error_code, err->request_code, err->minor_code, err->resourceid );
+
+    //kDebug() << kBacktrace();
+
 #else
     Q_UNUSED(dpy);
     Q_UNUSED(err);
@@ -1713,7 +1720,9 @@
 
 int main(int argc, char **argv, char **envp)
 {
-   int i;
+    setlocale (LC_ALL, "");
+    setlocale (LC_NUMERIC, "C");
+
    pid_t pid;
    bool do_fork = true;
    int launch_klauncher = 1;
@@ -1723,7 +1732,7 @@
 
    /** Save arguments first... **/
    char **safe_argv = (char **) malloc( sizeof(char *) * argc);
-   for(i = 0; i < argc; i++)
+   for(int i = 0; i < argc; i++)
    {
       safe_argv[i] = strcpy((char*)malloc(strlen(argv[i])+1), argv[i]);
       if (strcmp(safe_argv[i], "--no-klauncher") == 0)
@@ -1741,12 +1750,12 @@
          d.suicide = true;
       if (strcmp(safe_argv[i], "--exit") == 0)
          keep_running = 0;
-      if (strcmp(safe_argv[i], "--version") == 0) 
-      { 
-	 printf("Qt: %s\n", qVersion()); 
-	 printf("KDE: %s\n", KDE_VERSION_STRING); 
+      if (strcmp(safe_argv[i], "--version") == 0)
+      {
+	 printf("Qt: %s\n", qVersion());
+	 printf("KDE: %s\n", KDE_VERSION_STRING);
 	 exit(0);
-      } 
+      }
       if (strcmp(safe_argv[i], "--help") == 0)
       {
         printf("Usage: kdeinit4 [options]\n");
@@ -1810,7 +1819,10 @@
    s_instance = new KComponentData("kdeinit4", QByteArray(), KComponentData::SkipMainComponentRegistration);
 
    /** Prepare to change process name **/
+#ifndef SKIP_PROCTITLE
    proctitle_init(argc, argv, envp);
+#endif
+
    kdeinit_library_path();
    // Don't make our instance the global instance
    // (do it only after kdeinit_library_path, that one indirectly uses KConfig,
@@ -1846,7 +1858,7 @@
 #ifdef Q_WS_X11
    if (!d.suicide && qgetenv("KDE_IS_PRELINKED").isEmpty())
    {
-       QString konq = KStandardDirs::locate("lib", "libkonq.so.5", *s_instance);
+       QString konq = KStandardDirs::locate("lib", QLatin1String("libkonq.so.5"), *s_instance);
        // can't use KLibLoader here as it would unload the library
        // again
        if (!konq.isEmpty()) {
@@ -1871,8 +1883,6 @@
 
    {
       QFont::initialize();
-      setlocale (LC_ALL, "");
-      setlocale (LC_NUMERIC, "C");
 #ifdef Q_WS_X11
       if (XSupportsLocale ())
       {
@@ -1893,7 +1903,7 @@
       handle_requests(pid);
    }
 
-   for(i = 1; i < argc; i++)
+   for(int i = 1; i < argc; i++)
    {
       if (safe_argv[i][0] == '+')
       {
@@ -1917,13 +1927,15 @@
    }
 
    /** Free arguments **/
-   for(i = 0; i < argc; i++)
+   for(int i = 0; i < argc; i++)
    {
       free(safe_argv[i]);
    }
    free (safe_argv);
 
+#ifndef SKIP_PROCTITLE
    proctitle_set("kdeinit4 Running...");
+#endif
 
    if (!keep_running)
       return 0;
Index: kinit/klauncher.h
===================================================================
--- kinit/klauncher.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kinit/klauncher.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -87,6 +87,7 @@
    QString name;
    QStringList arg_list;
    QString dbus_name;
+   QString tolerant_dbus_name;
    enum status_t { Init = 0, Launching, Running, Error, Done };
    pid_t pid;
    status_t status;
@@ -95,8 +96,8 @@
    bool autoStart;
    QString errorMsg;
 #ifdef Q_WS_X11
-   QString startup_id; // "" is the default, "0" for none
-   QString startup_dpy; // Display to send startup notification to.
+   QByteArray startup_id; // "" is the default, "0" for none
+   QByteArray startup_dpy; // Display to send startup notification to.
 #endif
    QStringList envs; // env. variables to be app's environment
    QString cwd;
@@ -136,7 +137,7 @@
    void requestDone(KLaunchRequest *request);
 
    bool start_service(KService::Ptr service, const QStringList &urls,
-       const QStringList &envs, const QString &startup_id,
+       const QStringList &envs, const QByteArray &startup_id,
        bool blind, bool autoStart, const QDBusMessage &msg );
 
    void createArgs( KLaunchRequest *request, const KService::Ptr service,
@@ -144,9 +145,9 @@
 
    void queueRequest(KLaunchRequest *);
 
-   void send_service_startup_info( KLaunchRequest *request, KService::Ptr service, const QString &startup_id,
+   void send_service_startup_info( KLaunchRequest *request, KService::Ptr service, const QByteArray &startup_id,
        const QStringList &envs );
-   void cancel_service_startup_info( KLaunchRequest *request, const QString& startup_id,
+   void cancel_service_startup_info( KLaunchRequest *request, const QByteArray& startup_id,
        const QStringList &envs );
 
 Q_SIGNALS:
Index: nepomuk/core/resource.cpp
===================================================================
--- nepomuk/core/resource.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ nepomuk/core/resource.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -170,8 +170,11 @@
 
 void Nepomuk::Resource::addType( const QUrl& type )
 {
-    if ( m_data )
-        setTypes( types() << type );
+    if ( m_data ) {
+        QList<QUrl> tl = types();
+        if( !tl.contains( type ) )
+            setTypes( tl << type );
+    }
 }
 
 
Index: nepomuk/core/ontology/entitymanager.h
===================================================================
--- nepomuk/core/ontology/entitymanager.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ nepomuk/core/ontology/entitymanager.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -25,10 +25,6 @@
 #include <QtCore/QSharedData>
 #include <QtCore/QMutex>
 
-inline uint qHash( const QUrl& url ) {
-    return qHash( url.toString() );
-}
-
 namespace Soprano {
     class Statement;
 }
Index: nepomuk/core/ontology/entity.cpp
===================================================================
--- nepomuk/core/ontology/entity.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ nepomuk/core/ontology/entity.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -32,19 +32,6 @@
 
 #include <kicon.h>
 
-#ifndef _MSC_VER
-uint qHash( const QUrl& url )
-{
-    return qHash( url.toString() );
-}
-#endif
-
-// uint qHash( const Nepomuk::Types::Entity& c )
-// {
-//     return (uint)(ulong)c.d.data();
-// }
-
-
 Nepomuk::Types::EntityPrivate::EntityPrivate( const QUrl& uri_ )
     : uri( uri_ ),
       available( uri_.isValid() ? -1 : 0 ),
Index: kimgio/qimageio_plugin.desktop
===================================================================
--- kimgio/qimageio_plugin.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/qimageio_plugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -26,6 +26,7 @@
 Comment[gu]=QImageIOHandler પ્લગઇન
 Comment[he]=תוסף QImageIOHandler
 Comment[hi]=क्यूइमेजआईओहैंडलर प्लगइन
+Comment[hne]=क्यूइमेजआईओ हेंडलर प्लगइन
 Comment[hu]=QImageIOHandler modul
 Comment[is]=QImageIOHandler íforrit
 Comment[it]=Plugin QImageIOHandler
Index: kimgio/dds.desktop
===================================================================
--- kimgio/dds.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/dds.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=DDS
 Name[bn]=ডি-ডি-এস
 Name[hi]=डीडीएस
+Name[hne]=डीडीएस
 Name[mai]=डीडीएस
 Name[ml]=ഡിഡിഎസ്
 Name[sr]=ДДС
Index: kimgio/hdr.desktop
===================================================================
--- kimgio/hdr.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/hdr.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=HDR
 Name[bn]=এইচ-ডি-আর
 Name[hi]=एचडीआर
+Name[hne]=एचडीआर
 Name[mai]=एचडीआर
 Name[ml]=എച്ച്ഡിആര്‍
 Name[sr]=ХДР
Index: kimgio/pbm.desktop
===================================================================
--- kimgio/pbm.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/pbm.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=PBM
 Name[bn]=পি-বি-এম
 Name[hi]=पीबीएम
+Name[hne]=पीबीएम
 Name[mai]=पीबीएम
 Name[ml]=പിബിഎം
 Name[sr]=ПБМ
Index: kimgio/mng.desktop
===================================================================
--- kimgio/mng.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/mng.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=MNG
 Name[bn]=এম-এন-জি
 Name[hi]=एमएमजी
+Name[hne]=एमएमजी
 Name[mai]=एमएमजी
 Name[ml]=എഎന്‍ജി 
 Name[sr]=МНГ
Index: kimgio/png.desktop
===================================================================
--- kimgio/png.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/png.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=PNG
 Name[bn]=পি-এন-জি
 Name[hi]=पीएनजी
+Name[hne]=पीएनजी
 Name[ml]=പിഎന്‍ജി
 Name[sr]=ПНГ
 Name[te]=పిఎన్ జి
Index: kimgio/jpeg.desktop
===================================================================
--- kimgio/jpeg.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/jpeg.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=JPEG
 Name[bn]=জেপেগ
 Name[hi]=जेपीईजी
+Name[hne]=जेपीईजी
 Name[ml]=ജെപ്പെഗ്
 Name[sr]=ЈПЕГ
 Name[te]=జెపిఈజి
Index: kimgio/xbm.desktop
===================================================================
--- kimgio/xbm.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/xbm.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=XBM
 Name[bn]=এক্স-বি-এম
 Name[hi]=एक्सबीएम
+Name[hne]=एक्सबीएम
 Name[ml]=എക്സ്ബിഎം
 Name[sr]=ИксБМ
 Name[te]=ఎక్స్ బిఎం
Index: kimgio/eps.desktop
===================================================================
--- kimgio/eps.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/eps.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=EPS
 Name[bn]=ই-পি-এস
 Name[hi]=ईपीएस
+Name[hne]=ईपीएस
 Name[mai]=ईपीएस
 Name[ml]=ഇപിഎസ്
 Name[sr]=ЕПС
Index: kimgio/pnm.desktop
===================================================================
--- kimgio/pnm.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/pnm.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=PNM
 Name[bn]=পি-এন-এম
 Name[hi]=पीएनएम
+Name[hne]=पीएनएम
 Name[kk]=PBM
 Name[ml]=പിഎന്‍എം
 Name[sr]=ПНМ
Index: kimgio/jp2.desktop
===================================================================
--- kimgio/jp2.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/jp2.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=JP2
 Name[bn]=জে-পি-২
 Name[hi]=जेपी२ 
+Name[hne]=जेपी२ 
 Name[mai]=जेपी२ 
 Name[ml]=ജെപി2
 Name[sr]=ЈП2
Index: kimgio/ppm.desktop
===================================================================
--- kimgio/ppm.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/ppm.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=PPM
 Name[bn]=পি-পি-এম
 Name[hi]=पीपीएम
+Name[hne]=पीपीएम
 Name[mai]=पीपीएम
 Name[ml]=പിപിഎം
 Name[sr]=ППМ
Index: kimgio/exr.desktop
===================================================================
--- kimgio/exr.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/exr.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=EXR
 Name[bn]=ই-এক্স-আর
 Name[hi]=ईएक्सआर
+Name[hne]=ईएक्सआर
 Name[mai]=ईएक्सआर
 Name[ml]=ഇഎക്സ്ആര്‍
 Name[sr]=ЕИксР
Index: kimgio/xpm.desktop
===================================================================
--- kimgio/xpm.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/xpm.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=XPM
 Name[bn]=এক্স-পি-এম
 Name[hi]=एक्सपीएम
+Name[hne]=एक्सपीएम
 Name[ml]=എക്സ്പിഎം
 Name[sr]=ИксПМ
 Name[te]=ఎక్స్ పిఎం
Index: kimgio/gif.desktop
===================================================================
--- kimgio/gif.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/gif.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -3,6 +3,7 @@
 Name[ar]=SGI
 Name[bn]=জি-আই-এফ
 Name[hi]=जीआईएफ़
+Name[hne]=जीआईएफ
 Name[ml]=ജിഫ്
 Name[sr]=ГИФ
 Name[te]=జిఐఎఫ్
Index: kimgio/ico.desktop
===================================================================
--- kimgio/ico.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/ico.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=ICO
 Name[bn]=আই-সি-ও
 Name[hi]=आईसीओ
+Name[hne]=आईसीओ
 Name[mai]=चिह्न
 Name[ml]=ഐകോ
 Name[sr]=ИЦО
Index: kimgio/rgb.desktop
===================================================================
--- kimgio/rgb.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/rgb.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=RGB
 Name[bn]=আর-জি-বি
 Name[hi]=आरजीबी
+Name[hne]=आरजीबी
 Name[kn]=ಕೆ.ಹ.ನೀ/RGB
 Name[ml]=ആര്‍ജിബി
 Name[oc]=RVB
Index: kimgio/tga.desktop
===================================================================
--- kimgio/tga.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/tga.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=TGA
 Name[bn]=টি-জি-এ
 Name[hi]=टीजीए
+Name[hne]=टीजीए
 Name[ml]=ടിജിഎ
 Name[sr]=ТГА
 Name[te]=టిజిఏ
Index: kimgio/bmp.desktop
===================================================================
--- kimgio/bmp.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/bmp.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=BMP
 Name[bn]=বি-এম-পি
 Name[hi]=बीएमपी
+Name[hne]=बीएमपी
 Name[ml]=ബിഎംപി
 Name[sr]=БМП
 Name[te]=బిఎంపి
Index: kimgio/xcf.desktop
===================================================================
--- kimgio/xcf.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/xcf.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=XCF
 Name[bn]=এক্স-সি-এফ
 Name[hi]=एक्ससीएफ़
+Name[hne]=एक्ससीएफ
 Name[mai]=एक्ससीएफ़
 Name[ml]=എക്സ്സിഎഫ്
 Name[sr]=ИксЦФ
Index: kimgio/pgm.desktop
===================================================================
--- kimgio/pgm.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/pgm.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=PGM
 Name[bn]=পি-জি-এম
 Name[hi]=पीजीएम
+Name[hne]=पीजीएम
 Name[mai]=पीजीएम
 Name[ml]=പിജിഎം
 Name[sr]=ПГМ
Index: kimgio/psd.desktop
===================================================================
--- kimgio/psd.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/psd.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=PSD
 Name[bn]=পি-এস-ডি
 Name[hi]=पीएसडी
+Name[hne]=पीएसडी
 Name[mai]=पीएसडी
 Name[ml]=പിഎസ്ഡി
 Name[sr]=ПСД
Index: kimgio/tiff.desktop
===================================================================
--- kimgio/tiff.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/tiff.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=TIFF
 Name[bn]=টিফ
 Name[hi]=टीआईएफ़एफ़
+Name[hne]=टीआईएफएफ
 Name[ml]=ടിഫ്
 Name[sr]=ТИФФ
 Name[te]=టిఐ ఎఫ్ఎఫ్
Index: kimgio/pcx.desktop
===================================================================
--- kimgio/pcx.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/pcx.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=PCX
 Name[bn]=পি-সি-এক্স
 Name[hi]=पीसीएक्स
+Name[hne]=पीसीएक्स
 Name[mai]=पीसीएक्स
 Name[ml]=പിസിഎക്സ്
 Name[sr]=ПЦИкс
Index: kimgio/xv.desktop
===================================================================
--- kimgio/xv.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kimgio/xv.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -2,6 +2,7 @@
 Name=XV
 Name[bn]=এক্স-ভি
 Name[hi]=एक्सवी
+Name[hne]=एक्सवी
 Name[mai]=एक्सवी
 Name[ml]=എക്സ്‌വി
 Name[sr]=ИксВ
Index: kio/kfileplugin.desktop
===================================================================
--- kio/kfileplugin.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kfileplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -28,6 +28,7 @@
 Name[gu]=Meta માહિતી પ્લગઈન
 Name[he]=תוסף מידע קובץ עבור KFile
 Name[hi]=के-फ़ाइल मेटा डाटा प्लगइन
+Name[hne]=के-फाइल मेटा डाटा प्लगइन
 Name[hr]=KFile dodatak za meta-podatke
 Name[hsb]=KFile-zašćěpka za Meta-Data
 Name[hu]=KFile metaadat-modul
Index: kio/kio/kdirlister_p.h
===================================================================
--- kio/kio/kdirlister_p.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kdirlister_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -84,7 +84,6 @@
     void aboutToRefreshItem(const KFileItem& item);
     void addRefreshItem(const KUrl& directoryUrl, const KFileItem& oldItem, const KFileItem& item);
   void emitItems();
-  void emitDeleteItem( const KFileItem &item );
   void emitItemsDeleted(const KFileItemList &items);
 
     /**
@@ -280,6 +279,7 @@
   void deleteUnmarkedItems( const QList<KDirLister *>&, KFileItemList & );
     // Helper method called when we know that a list of items was deleted
     void itemsDeleted(const QList<KDirLister *>& listers, const KFileItemList& deletedItems);
+    void slotFilesRemoved(const KUrl::List& urls);
     // common for slotRedirection and slotFileRenamed
   void renameDir( const KUrl &oldUrl, const KUrl &url );
   // common for deleteUnmarkedItems and slotFilesRemoved
Index: kio/kio/tcpslavebase.cpp
===================================================================
--- kio/kio/tcpslavebase.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/tcpslavebase.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -198,9 +198,16 @@
         return -1;
     }
 
-    if (d->isBlocking && !d->socket.bytesAvailable()) {
-        d->socket.waitForReadyRead(-1);
-    } else {
+    if (!d->socket.bytesAvailable()) {
+        if (d->isBlocking) {
+            d->socket.waitForReadyRead(-1);
+        } else {
+            d->socket.waitForReadyRead(0);
+        }
+    } else if (d->socket.encryptionMode() != KTcpSocket::SslClientMode ||
+               QNetworkProxy::applicationProxy().type() == QNetworkProxy::NoProxy) {
+        // we only do this when it doesn't trigger Qt socket bugs. When it doesn't break anything
+        // it seems to help performance.
         d->socket.waitForReadyRead(0);
     }
 
Index: kio/kio/kdirmodel.h
===================================================================
--- kio/kio/kdirmodel.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kdirmodel.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -32,6 +32,13 @@
  * KDirModel implements the QAbstractItemModel interface (for use with Qt's model/view widgets)
  * around the directory listing for one directory or a tree of directories.
  *
+ * Note that there are some cases when using QPersistentModelIndexes from this model will not give
+ * expected results. QPersistentIndexes will remain valid and updated if its siblings are added or 
+ * removed. However, if the QPersistentIndex or one of its ancestors is moved, the QPersistentIndex will become 
+ * invalid. For example, if a file or directory is renamed after storing a QPersistentModelIndex for it, 
+ * the index (along with any stored children) will become invalid even though it is still in the model. The reason 
+ * for this is that moves of files and directories are treated as separate insert and remove actions.
+ *
  * @see KDirSortFilterProxyModel
  *
  * @author David Faure
Index: kio/kio/kfileitem.cpp
===================================================================
--- kio/kio/kfileitem.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kfileitem.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -418,10 +418,10 @@
 
     // Include the type in the first char like kde3 did; people are more used to seeing it,
     // even though it's not really part of the permissions per se.
-    if (m_fileMode != KFileItem::Unknown && S_ISDIR(m_fileMode))
+    if (m_bLink)
+        buffer[0] = 'l';
+    else if (m_fileMode != KFileItem::Unknown && S_ISDIR(m_fileMode))
         buffer[0] = 'd';
-    else if (m_bLink)
-        buffer[0] = 'l';
     else
         buffer[0] = '-';
 
Index: kio/kio/copyjob.h
===================================================================
--- kio/kio/copyjob.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/copyjob.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -245,6 +245,7 @@
 
     protected:
         CopyJob(CopyJobPrivate &dd);
+        void emitResult();
 
     private:
         Q_PRIVATE_SLOT(d_func(), void slotStart())
Index: kio/kio/kmimetyperesolver.cpp
===================================================================
--- kio/kio/kmimetyperesolver.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kmimetyperesolver.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -19,6 +19,7 @@
 */
 
 #include "kmimetyperesolver.h"
+#include <kdebug.h>
 #include "defaultviewadapter_p.h"
 #include <kdirmodel.h>
 #include <kfileitem.h>
@@ -148,13 +149,11 @@
     }
 
     int nextDelay = 0;
-    bool isVisible = false;
     QModelIndex index = findVisibleIcon();
     if (index.isValid()) {
         // Found a visible item.
         const int numFound = m_pendingIndexes.removeAll(index);
         Q_ASSERT(numFound == 1);
-        isVisible = true;
     } else {
         // No more visible items.
         // Do the unvisible ones, then, but with a bigger delay, if so configured
@@ -164,11 +163,8 @@
     KFileItem item = m_dirModel->itemForIndex(index);
     if (!item.isNull()) { // check that item still exists
         if (!item.isMimeTypeKnown()) { // check if someone did it meanwhile
-            //kDebug() << "Determining mimetype for " << item.url();
             item.determineMimeType();
-            if (isVisible) {
-                m_dirModel->itemChanged(index);
-            }
+            m_dirModel->itemChanged(index);
         }
     }
     m_timer.start(nextDelay); // singleshot
Index: kio/kio/kdirlister.h
===================================================================
--- kio/kio/kdirlister.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kdirlister.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -44,12 +44,12 @@
  *
  * Typical usage :
  * @li Create an instance.
- * @li Connect to at least update, clear, newItem, and deleteItem.
+ * @li Connect to at least update, clear, itemsAdded, and itemsDeleted.
  * @li Call openUrl - the signals will be called.
  * @li Reuse the instance when opening a new url (openUrl).
  * @li Destroy the instance when not needed anymore (usually destructor).
  *
- * Advanced usage : call openUrl with _keep = true to list directories
+ * Advanced usage : call openUrl with OpenUrlFlag::Keep to list directories
  * without forgetting the ones previously read (e.g. for a tree view)
  *
  * @author Michael Brade <brade@kde.org>
@@ -100,7 +100,7 @@
    * Run the directory lister on the given url.
    *
    * This method causes KDirLister to emit _all_ the items of @p _url, in any case.
-   * Depending on @p _keep either clear() or clear(const KUrl &) will be
+   * Depending on _flags, either clear() or clear(const KUrl &) will be
    * emitted first.
    *
    * The newItems() signal may be emitted more than once to supply you
@@ -223,7 +223,7 @@
   /**
    * Returns the top level URL that is listed by this KDirLister.
    * It might be different from the one given with openUrl() if there was a
-   * redirection. If you called openUrl() with @p _keep == true this is the
+   * redirection. If you called openUrl() with OpenUrlFlag::Keep this is the
    * first url opened (e.g. in a treeview this is the root).
    *
    * @return the url used by this instance to list the files.
@@ -232,7 +232,7 @@
 
   /**
    * Returns all URLs that are listed by this KDirLister. This is only
-   * useful if you called openUrl() with @p _keep == true, as it happens in a
+   * useful if you called openUrl() with OpenUrlFlag::Keep, as it happens in a
    * treeview, for example. (Note that the base url is included in the list
    * as well, of course.)
    *
@@ -423,7 +423,7 @@
    *
    * @param dir specifies the url for which the items should be returned. This
    *            is only useful if you use KDirLister with multiple URLs
-   *            i.e. using bool keep = true in openUrl().
+   *            i.e. using bool OpenUrlFlag::Keep in openUrl().
    * @param which specifies whether the returned list will contain all entries
    *              or only the ones that passed the nameFilter, mimeFilter, etc.
    *              Note that the latter causes iteration over all the items,
@@ -486,7 +486,7 @@
   /**
    * Signal a redirection.
    * Only emitted if there's just one directory to list, i.e. most
-   * probably openUrl() has been called with @p _keep == @p false.
+   * probably openUrl() has been called without OpenUrlFlag::Keep.
    * @param _url the new URL
    */
   void redirection( const KUrl& _url );
@@ -537,6 +537,8 @@
   /**
    * Signals that an item has been deleted
    *
+   * @deprecated Don't connect to this signal. Use itemsDeleted instead.
+   *
    * @param _fileItem the fileItem to delete
    */
   void deleteItem( const KFileItem &_fileItem ); // KDE5: remove, and port to itemsDeleted
Index: kio/kio/krun.h
===================================================================
--- kio/kio/krun.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/krun.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -357,10 +357,10 @@
    */
 
   /**
-   * This slot is called whenever the internal time has
-   * a timeout.
+   * This slot is called whenever the internal timer fired,
+   * in order to move on to the next step.
    */
-  void slotTimeout();
+  void slotTimeout(); // KDE5: rename to slotNextStep() or something like that
 
   /**
    * This slot is called when the scan job is finished.
Index: kio/kio/kfilewriteplugin.cpp
===================================================================
--- kio/kio/kfilewriteplugin.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kfilewriteplugin.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -45,7 +45,7 @@
 
 KFileWritePlugin*
 KFileWriterProvider::loadPlugin(const QString& key) {
-    qDebug() << "loading writer for key " << key;
+    //kDebug() << "loading writer for key " << key;
     const QString constraint = QString::fromLatin1("'%1' in MetaDataKeys")
         .arg(key);
     KService::List offers = KServiceTypeTrader::self()->query(
Index: kio/kio/krun.cpp
===================================================================
--- kio/kio/krun.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/krun.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -487,8 +487,9 @@
   return QString();
 }
 
-static bool runCommandInternal( KProcess* proc, const KService* service, const QString& binName,
-    const QString &execName, const QString & iconName, QWidget* window, const QByteArray& asn )
+static bool runCommandInternal(KProcess* proc, const KService* service, const QString& executable,
+                               const QString &userVisibleName, const QString & iconName, QWidget* window,
+                               const QByteArray& asn)
 {
   if( window != NULL )
       window = window->topLevelWidget();
@@ -500,12 +501,12 @@
      delete proc;
      return false;
   }
-  QString bin = KRun::binaryName( binName, true );
+  QString bin = KRun::binaryName( executable, true );
 #ifdef Q_WS_X11 // Startup notification doesn't work with QT/E, service isn't needed without Startup notification
   bool silent;
   QByteArray wmclass;
   KStartupInfoId id;
-  bool startup_notify = ( asn != "0" && KRun::checkStartupNotify( binName, service, &silent, &wmclass ));
+  bool startup_notify = (asn != "0" && KRun::checkStartupNotify(QString() /*unused*/, service, &silent, &wmclass));
   if( startup_notify )
   {
       id.initId( asn );
@@ -513,8 +514,8 @@
       KStartupInfoData data;
       data.setHostname();
       data.setBin( bin );
-      if( !execName.isEmpty())
-          data.setName( execName );
+      if (!userVisibleName.isEmpty())
+          data.setName(userVisibleName);
       else if( service && !service->name().isEmpty())
           data.setName( service->name());
       data.setDescription( i18n( "Launching %1" ,  data.name()));
@@ -531,7 +532,7 @@
           data.setLaunchedBy( window->winId());
       KStartupInfo::sendStartup( id, data );
   }
-  int pid = KProcessRunner::run( proc, binName, id );
+  int pid = KProcessRunner::run(proc, executable, id);
   if( startup_notify && pid )
   {
       KStartupInfoData data;
@@ -541,7 +542,7 @@
   }
   return pid != 0;
 #else
-  Q_UNUSED( execName );
+  Q_UNUSED(userVisibleName);
   Q_UNUSED( iconName );
   return KProcessRunner::run( proc, bin ) != 0;
 #endif
@@ -763,8 +764,8 @@
 
 bool KRun::runCommand( const QString &cmd, QWidget* window )
 {
-  QString bin = binaryName( cmd, true );
-  return KRun::runCommand( cmd, bin, bin, window, QByteArray() );
+    const QString bin = KShell::splitArgs(cmd).first();
+    return KRun::runCommand(cmd, bin, bin /*iconName*/, window, QByteArray());
 }
 
 bool KRun::runCommand( const QString& cmd, const QString &execName, const QString & iconName, QWidget* window, const QByteArray& asn )
@@ -774,7 +775,10 @@
   proc->setShellCommand( cmd );
   QString bin = binaryName( execName, true );
   KService::Ptr service = KService::serviceByDesktopName( bin );
-  return runCommandInternal( proc, service.data(), bin, execName, iconName, window, asn );
+  return runCommandInternal( proc, service.data(),
+                             execName /*executable to check for in slotProcessExited*/,
+                             execName /*user-visible name*/,
+                             iconName, window, asn );
 }
 
 KRun::KRun( const KUrl& url, QWidget* window, mode_t mode, bool isLocalFile,
@@ -1197,7 +1201,7 @@
   if ( !mime )
       kWarning(7010) << "Unknown mimetype " << type;
 
-  // Suport for preferred service setting, see setPreferredService
+  // Support for preferred service setting, see setPreferredService
   if ( !d->m_preferredService.isEmpty() ) {
       kDebug(7010) << "Attempting to open with preferred service: " << d->m_preferredService;
       KService::Ptr serv = KService::serviceByDesktopName( d->m_preferredService );
@@ -1413,32 +1417,35 @@
 /****************/
 
 #ifndef Q_WS_X11
-int KProcessRunner::run(KProcess * p, const QString & binName)
+int KProcessRunner::run(KProcess * p, const QString & executable)
 {
-    return (new KProcessRunner(p, binName))->pid();
+    return (new KProcessRunner(p, executable))->pid();
 }
 #else
-int KProcessRunner::run(KProcess * p, const QString & binName, const KStartupInfoId& id)
+int KProcessRunner::run(KProcess * p, const QString & executable, const KStartupInfoId& id)
 {
-    return (new KProcessRunner(p, binName, id))->pid();
+    return (new KProcessRunner(p, executable, id))->pid();
 }
 #endif
 
 #ifndef Q_WS_X11
-KProcessRunner::KProcessRunner(KProcess * p, const QString & _binName)
+KProcessRunner::KProcessRunner(KProcess * p, const QString & executable)
 #else
-KProcessRunner::KProcessRunner(KProcess * p, const QString & _binName, const KStartupInfoId& _id) :
+KProcessRunner::KProcessRunner(KProcess * p, const QString & executable, const KStartupInfoId& _id) :
     id(_id)
 #endif
 {
     process = p;
-    binName = _binName;
+    m_executable = executable;
     connect(process, SIGNAL(finished(int, QProcess::ExitStatus)),
             this, SLOT(slotProcessExited(int, QProcess::ExitStatus)));
 
     process->start();
     if (!process->waitForStarted()) {
-        slotProcessExited(127, QProcess::NormalExit);
+        //kDebug() << "wait for started failed, exitCode=" << process->exitCode()
+        //         << "exitStatus=" << process->exitStatus();
+        // Note that exitCode is 255 here (the first time), and 0 later on (bug?).
+        slotProcessExited(255, process->exitStatus());
     }
 }
 
@@ -1452,11 +1459,8 @@
     return process ? process->pid() : 0;
 }
 
-void
-KProcessRunner::slotProcessExited(int exitCode, QProcess::ExitStatus exitStatus)
+void KProcessRunner::terminateStartupNotification()
 {
-    kDebug(7010) << binName << "exitCode=" << exitCode << "exitStatus=" << exitStatus;
-
 #ifdef Q_WS_X11
     if (!id.none()) {
         KStartupInfoData data;
@@ -1465,18 +1469,28 @@
         KStartupInfo::sendFinish(id, data);
     }
 #endif
+}
 
-    bool showErr = exitStatus == QProcess::NormalExit
-                   && (exitCode == 127 || exitCode == 1);
-    if (!binName.isEmpty() && showErr) {
-        // Often we get 1 (zsh, csh) or 127 (ksh, bash) because the binary doesn't exist.
-        // We can't just rely on that, but it's a good hint.
-        // Before assuming its really so, we'll try to find the binName
-        // relatively to current directory,  and then in the PATH.
-        if (!QFile(binName).exists() && KStandardDirs::findExe(binName).isEmpty()) {
+void
+KProcessRunner::slotProcessExited(int exitCode, QProcess::ExitStatus exitStatus)
+{
+    kDebug(7010) << m_executable << "exitCode=" << exitCode << "exitStatus=" << exitStatus;
+    Q_UNUSED(exitStatus);
+
+    terminateStartupNotification(); // do this before the messagebox
+    if (exitCode != 0 && !m_executable.isEmpty()) {
+        // Let's see if the error is because the exe doesn't exist.
+        // When this happens, waitForStarted returns false, but not if kioexec
+        // was involved, then we come here, that's why the code is here.
+        //
+        // We'll try to find the executable relatively to current directory,
+        // (or with a full path, if m_executable is absolute), and then in the PATH.
+        if (!QFile(m_executable).exists() && KStandardDirs::findExe(m_executable).isEmpty()) {
             KGlobal::ref();
-            KMessageBox::sorry(0L, i18n("Could not find the program '%1'", binName));
+            KMessageBox::sorry(0L, i18n("Could not find the program '%1'", m_executable));
             KGlobal::deref();
+        } else {
+            kDebug() << process->readAllStandardError();
         }
     }
     deleteLater();
Index: kio/kio/kdirwatch.cpp
===================================================================
--- kio/kio/kdirwatch.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kdirwatch.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -91,6 +91,8 @@
   } else {
 #ifdef Q_OS_WIN
     return KDirWatchPrivate::QFSWatch;
+#elif defined(Q_OS_FREEBSD)
+    return KDirWatchPrivate::Stat;
 #else
     return KDirWatchPrivate::INotify;
 #endif
@@ -517,7 +519,7 @@
 // setup INotify notification, returns false if not possible
 bool KDirWatchPrivate::useINotify( Entry* e )
 {
-  kDebug (7001) << "trying to use inotify for monitoring";
+  //kDebug (7001) << "trying to use inotify for monitoring";
 
   e->wd = 0;
   e->dirty = false;
@@ -545,7 +547,7 @@
   if ( ( e->wd = inotify_add_watch( m_inotify_fd,
                                     QFile::encodeName( e->path ), mask) ) > 0)
   {
-    kDebug (7001) << "inotify successfully used for monitoring";
+    //kDebug (7001) << "inotify successfully used for monitoring";
     return true;
   }
 
@@ -1079,7 +1081,14 @@
 #endif
     if ( (e->m_ctime != invalid_ctime) &&
           ((stat_buf.st_ctime != e->m_ctime) ||
-          (stat_buf.st_nlink != (nlink_t) e->m_nlink)) ) {
+          (stat_buf.st_nlink != (nlink_t) e->m_nlink))
+#if defined( HAVE_QFILESYSTEMWATCHER )
+          // we trust QFSW to get it right, the ctime comparisons above
+          // fail for example when adding files to directories on Windows
+          // which doesn't change the mtime of the directory
+        ||(e->m_mode == QFSWatchMode )
+#endif
+    ) {
       e->m_ctime = stat_buf.st_ctime;
       e->m_nlink = stat_buf.st_nlink;
       return Changed;
Index: kio/kio/jobclasses.h
===================================================================
--- kio/kio/jobclasses.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/jobclasses.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -546,15 +546,19 @@
          * instead of the amount of data that that has been received.
          * @see slotProcessedSize
          * @see slotSpeed
+         * @deprecated not needed, this is false for KIO::get and true for KIO::put,
+         *             automatically since KDE-4.2.1
          */
-        void setReportDataSent(bool enabled);
+        KDE_DEPRECATED void setReportDataSent(bool enabled);
 
         /**
          *  Returns whether the job reports the amount of data that has been
          *  sent (true), or whether the job reports the amount of data that
          * has been received (false)
+         * @deprecated not needed, this is false for KIO::get and true for KIO::put,
+         *             automatically since KDE-4.2.1 (and not useful as public API)
          */
-        bool reportDataSent() const;
+        KDE_DEPRECATED bool reportDataSent() const;
 
         /**
          * Call this in the slot connected to result,
@@ -563,6 +567,13 @@
          */
         QString mimetype() const;
 
+        /**
+         * Set the total size of data that we are going to send
+         * in a put job. Helps getting proper progress information.
+         * @since 4.2.1
+         */
+        void setTotalSize(KIO::filesize_t bytes);
+
     protected:
         /**
          * Called when m_subJob finishes.
Index: kio/kio/job.cpp
===================================================================
--- kio/kio/job.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/job.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -399,7 +399,7 @@
     q->connect( slave, SIGNAL(finished()),
                 SLOT(slotFinished()) );
 
-    if ((m_extraFlags & EF_TransferJobDataSent) == 0)
+    if ((m_extraFlags & EF_TransferJobDataSent) == 0) // this is a "get" job
     {
         q->connect( slave, SIGNAL(totalSize(KIO::filesize_t)),
                     SLOT(slotTotalSize(KIO::filesize_t)) );
@@ -903,6 +903,10 @@
 TransferJob::TransferJob(TransferJobPrivate &dd)
     : SimpleJob(dd)
 {
+    Q_D(TransferJob);
+    if (d->m_command == CMD_PUT) {
+        d->m_extraFlags |= JobPrivate::EF_TransferJobDataSent;
+    }
 }
 
 TransferJob::~TransferJob()
@@ -917,6 +921,11 @@
       emit data( this, _data);
 }
 
+void KIO::TransferJob::setTotalSize(KIO::filesize_t bytes)
+{
+    setTotalAmount(KJob::Bytes, bytes);
+}
+
 // Slave got a redirection request
 void TransferJob::slotRedirection( const KUrl &url)
 {
@@ -1026,7 +1035,7 @@
     if (d->m_extraFlags & JobPrivate::EF_TransferJobNeedData)
     {
        d->m_slave->send( MSG_DATA, dataForSlave );
-       if (d->m_extraFlags & JobPrivate::EF_TransferJobDataSent)
+       if (d->m_extraFlags & JobPrivate::EF_TransferJobDataSent) // put job -> emit progress
        {
            KIO::filesize_t size = processedAmount(KJob::Bytes)+dataForSlave.size();
            setProcessedAmount(KJob::Bytes, size);
Index: kio/kio/ksambashare.cpp
===================================================================
--- kio/kio/ksambashare.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/ksambashare.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,19 @@
 #include <kconfiggroup.h>
 #include <kglobal.h>
 
+// Default smb.conf locations
+static const char * DefaultSambaConfigFilePathList[] =
+{
+  "/etc/samba/smb.conf",
+  "/etc/smb.conf",
+  "/usr/local/etc/smb.conf",
+  "/usr/local/samba/lib/smb.conf",
+  "/usr/samba/lib/smb.conf",
+  "/usr/lib/smb.conf",
+  "/usr/local/lib/smb.conf"
+};
+static const int DefaultSambaConfigFilePathListSize = sizeof( DefaultSambaConfigFilePathList ) / sizeof(char*);
+
 class KSambaShare::KSambaSharePrivate
 {
 public:
@@ -70,36 +83,30 @@
  **/
 bool KSambaShare::KSambaSharePrivate::findSmbConf()
 {
-  KConfig config(QLatin1String(FILESHARECONF));
-  const KConfigGroup group(&config, QString());
-  smbConf = group.readEntry("SMBCONF");
+  KConfig config( QLatin1String( FILESHARECONF ) );
+  const KConfigGroup group( &config, QString() );
+  smbConf = group.readEntry( "SMBCONF" );
 
-  if ( QFile::exists(smbConf) )
+  if ( QFile::exists( smbConf ) )
     return true;
 
-  if ( QFile::exists("/etc/samba/smb.conf") )
-    smbConf = "/etc/samba/smb.conf";
-  else
-  if ( QFile::exists("/etc/smb.conf") )
-    smbConf = "/etc/smb.conf";
-  else
-  if ( QFile::exists("/usr/local/samba/lib/smb.conf") )
-    smbConf = "/usr/local/samba/lib/smb.conf";
-  else
-  if ( QFile::exists("/usr/samba/lib/smb.conf") )
-    smbConf = "/usr/samba/lib/smb.conf";
-  else
-  if ( QFile::exists("/usr/lib/smb.conf") )
-    smbConf = "/usr/lib/smb.conf";
-  else
-  if ( QFile::exists("/usr/local/lib/smb.conf") )
-    smbConf = "/usr/local/lib/smb.conf";
-  else {
-    kDebug(7000) << "KSambaShare: Could not found smb.conf!";
-    return false;
+  bool success = false;
+  for( int i = 0; i<DefaultSambaConfigFilePathListSize; ++i )
+  {
+    const QString filePath( DefaultSambaConfigFilePathList[i] );
+    if( QFile::exists( filePath ) )
+    {
+        smbConf = filePath;
+        success = true;
+        break;
+    }
   }
+  
+  if( ! success )
+    kDebug(7000) << "KSambaShare: Could not find smb.conf!";
 
-  return true;
+  return success;
+  
 }
 
 
@@ -161,7 +168,7 @@
       QString name = completeLine.left(i).trimmed().toLower();
       QString value = completeLine.mid(i+1).trimmed();
 
-      if (name == KGlobal::staticQString("path")) {
+      if (name == KGlobal::staticQString("path") && !value.isEmpty()) {
         // Handle quotation marks
         if ( value[0] == '"' )
           value.remove(0,1);
Index: kio/kio/kfilewrite.desktop
===================================================================
--- kio/kio/kfilewrite.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kfilewrite.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -28,6 +28,7 @@
 Comment[gu]=KFileWrite પ્લગઈન
 Comment[he]=תוסף KFileWrite
 Comment[hi]=के-फ़ाइल-राइट प्लगइन
+Comment[hne]=के-फाइल-राइट प्लगइन
 Comment[hsb]=KFileWrite-zašćěpka
 Comment[hu]=KFileWrite modul
 Comment[is]=KFileWrite íforrit
Index: kio/kio/kdirlister.cpp
===================================================================
--- kio/kio/kdirlister.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/kdirlister.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -606,6 +606,17 @@
     // we don't need to emit canceled signals since we only replaced the job,
     // the listing is continuing.
 
+    if (!(listers.isEmpty() || killed)) {
+        kWarning() << "The unexpected happened.";
+        kWarning() << "listers=" << listers;
+        kWarning() << "job=" << job;
+        Q_FOREACH(KDirLister *kdl, listers) {
+            kDebug() << "lister" << kdl << "m_cachedItemsJob=" << kdl->d->m_cachedItemsJob;
+        }
+#ifndef NDEBUG
+        printDebug();
+#endif
+    }
     Q_ASSERT( listers.isEmpty() || killed );
 
     job = KIO::listDir( _dir, KIO::HideProgressInfo );
@@ -747,18 +758,23 @@
 
 void KDirListerCache::slotFilesRemoved( const QStringList &fileList ) // from KDirNotify signals
 {
-    kDebug(7004) << fileList.count();
+    slotFilesRemoved(KUrl::List(fileList));
+}
+
+void KDirListerCache::slotFilesRemoved(const KUrl::List& fileList)
+{
+    //kDebug(7004) << fileList.count();
     // Group notifications by parent dirs (usually there would be only one parent dir)
     QMap<QString, KFileItemList> removedItemsByDir;
-    QStringList deletedSubdirs;
+    KUrl::List deletedSubdirs;
 
-    for (QStringList::const_iterator it = fileList.begin(); it != fileList.end() ; ++it) {
-        KUrl url(*it);
+    for (KUrl::List::const_iterator it = fileList.begin(); it != fileList.end() ; ++it) {
+        const KUrl url(*it);
         DirItem* dirItem = dirItemForUrl(url); // is it a listed directory?
         if (dirItem) {
-            deletedSubdirs.append(*it);
+            deletedSubdirs.append(url);
             if (!dirItem->rootItem.isNull()) {
-                removedItemsByDir[*it].append(dirItem->rootItem);
+                removedItemsByDir[url.url()].append(dirItem->rootItem);
             }
         }
 
@@ -773,7 +789,7 @@
                 removedItemsByDir[parentDir.url()].append(fileitem);
                 // If we found a fileitem, we can test if it's a dir. If not, we'll go to deleteDir just in case.
                 if (fileitem.isNull() || fileitem.isDir()) {
-                    deletedSubdirs.append(*it);
+                    deletedSubdirs.append(url);
                 }
                 dirItem->lstItems.erase(fit); // remove fileitem from list
                 break;
@@ -791,7 +807,7 @@
         }
     }
 
-    Q_FOREACH(const QString& url, deletedSubdirs) {
+    Q_FOREACH(const KUrl& url, deletedSubdirs) {
         // in case of a dir, check if we have any known children, there's much to do in that case
         // (stopping jobs, removing dirs from cache etc.)
         deleteDir(url);
@@ -853,17 +869,14 @@
   // only update the name and not the underlying URL.
   bool nameOnly = fileitem && !fileitem->entry().stringValue( KIO::UDSEntry::UDS_URL ).isEmpty();
   nameOnly &= src.directory( KUrl::IgnoreTrailingSlash | KUrl::AppendTrailingSlash ) ==
-                dst.directory( KUrl::IgnoreTrailingSlash | KUrl::AppendTrailingSlash );
+              dst.directory( KUrl::IgnoreTrailingSlash | KUrl::AppendTrailingSlash );
 
-  // Somehow this should only be called if src is a dir. But how could we know if it is?
-  // (Note that looking into itemsInUse isn't good enough. One could rename a subdir in a view.)
-  // DF: well, findByUrl can find subdirs too...
-  if( !nameOnly ) {
+    if (!nameOnly && (!fileitem || fileitem->isDir())) {
         renameDir( src, dst );
         // #172945 - if the fileitem was the root item of a DirItem that was just removed from the cache,
         // then it's a dangling pointer now...
         fileitem = findByUrl( 0, oldurl );
-  }
+    }
 
   // Now update the KFileItem representing that file or dir (not exclusive with the above!)
   if ( fileitem )
@@ -872,6 +885,16 @@
         slotFilesChanged( QStringList() << src.url() );
     else
     {
+        // Dest already exists? Was overwritten then (testcase: #151851)
+        // We better emit it as deleted -before- doing the renaming, otherwise
+        // the "update" mechanism will emit the old one as deleted and
+        // kdirmodel will delete the new (renamed) one!
+        KFileItem* existingDestItem = findByUrl(0, dst);
+        if (existingDestItem) {
+            //kDebug() << dst << "already existed, let's delete it";
+            slotFilesRemoved(dst);
+        }
+
         aboutToRefreshItem( *fileitem );
         const KFileItem oldItem = *fileitem;
         if( nameOnly )
@@ -954,15 +977,23 @@
         // A dir: launch an update job if anyone cares about it
         updateDirectory(url);
     } else {
-        // A file: delay updating it, FAM is flooding us with events
-        const QString urlStr = url.url(KUrl::RemoveTrailingSlash);
-        if (!pendingUpdates.contains(urlStr)) {
-            KUrl dir(url);
-            dir.setPath(dir.directory());
-            if (checkUpdate(dir.url())) {
-                pendingUpdates.insert(urlStr);
-                if (!pendingUpdateTimer.isActive())
-                    pendingUpdateTimer.start( 500 );
+        // A file: do we know about it already?
+        KFileItem* existingItem = findByUrl(0, url);
+        if (!existingItem) {
+            // No - update the parent dir then
+            url.setPath(url.directory());
+            updateDirectory(url);
+        } else {
+            // A known file: delay updating it, FAM is flooding us with events
+            const QString urlStr = url.url(KUrl::RemoveTrailingSlash);
+            if (!pendingUpdates.contains(urlStr)) {
+                KUrl dir(url);
+                dir.setPath(dir.directory());
+                if (checkUpdate(dir.url())) {
+                    pendingUpdates.insert(urlStr);
+                    if (!pendingUpdateTimer.isActive())
+                        pendingUpdateTimer.start( 500 );
+                }
             }
         }
     }
@@ -993,10 +1024,18 @@
     //kDebug(7004) << "new entries for " << url;
 
     DirItem *dir = itemsInUse.value(urlStr);
-    Q_ASSERT( dir );
+    if (!dir) {
+        kError(7004) << "Internal error: job is listing" << url << "but itemsInUse only knows about" << itemsInUse.keys();
+        Q_ASSERT( dir );
+        return;
+    }
 
     DirectoryDataHash::iterator dit = directoryData.find(urlStr);
-    Q_ASSERT(dit != directoryData.end());
+    if (dit == directoryData.end()) {
+        kError(7004) << "Internal error: job is listing" << url << "but directoryData doesn't know about that url, only about:" << directoryData.keys();
+        Q_ASSERT(dit != directoryData.end());
+        return;
+    }
     KDirListerCacheDirectoryData& dirData = *dit;
     Q_ASSERT( !dirData.listersCurrentlyListing.isEmpty() );
 
@@ -1550,6 +1589,7 @@
                 foreach ( KDirLister *kdl, listers )
                     kdl->d->addRefreshItem(jobUrl, oldItem, *tmp);
             }
+            //kDebug(7004) << "marking" << tmp;
             tmp->mark();
         }
         else // this is a new file
@@ -1623,9 +1663,9 @@
     // Find all unmarked items and delete them
     QMutableListIterator<KFileItem> kit(lstItems);
     while (kit.hasNext()) {
-        const KFileItem item = kit.next();
+        const KFileItem& item = kit.next();
         if (!item.isMarked()) {
-            //kDebug() << "deleted:" << item.name();
+            //kDebug() << "deleted:" << item.name() << &item;
             deletedItems.append(item);
             kit.remove();
         }
@@ -2254,13 +2294,6 @@
   }
 }
 
-void KDirLister::Private::emitDeleteItem( const KFileItem &item )
-{
-    if (isItemVisible(item) && m_parent->matchesMimeFilter(item)) {
-        emit m_parent->deleteItem(item);
-    }
-}
-
 bool KDirLister::Private::isItemVisible(const KFileItem& item) const
 {
     // Note that this doesn't include mime filters, because
Index: kio/kio/krun_p.h
===================================================================
--- kio/kio/krun_p.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/krun_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -61,8 +61,10 @@
     KProcessRunner(KProcess *, const QString & binName, const KStartupInfoId& id);
 #endif
 
+    void terminateStartupNotification();
+
     KProcess *process;
-    QString binName;
+    QString m_executable;
     KStartupInfoId id;
 
     Q_DISABLE_COPY(KProcessRunner)
Index: kio/kio/copyjob.cpp
===================================================================
--- kio/kio/copyjob.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/copyjob.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -153,7 +153,7 @@
     QList<CopyInfo> dirs;
     KUrl::List dirsToRemove;
     KUrl::List m_srcList;
-    KUrl::List m_skippedSourceUrls;
+    KUrl::List m_successSrcList;
     KUrl::List::const_iterator m_currentStatSrc;
     bool m_bCurrentSrcIsDir;
     bool m_bCurrentOperationIsLink;
@@ -770,10 +770,6 @@
 
 void CopyJobPrivate::skip( const KUrl & sourceUrl )
 {
-    // If this is one if toplevel sources,
-    // remove it from d->m_srcList, for a correct FilesRemoved() signal
-    // But don't do it right away, we have iterators into that list (#157601)
-    m_skippedSourceUrls.append( sourceUrl );
     dirsToRemove.removeAll( sourceUrl );
 }
 
@@ -857,6 +853,7 @@
     {
         //this is required for the undo feature
         emit q->copyingDone( q, (*it).uSource, (*it).uDest, (*it).mtime, true, false );
+        m_successSrcList.append((*it).uSource);
         m_directoriesCopied.append( *it );
         dirs.erase( it );
     }
@@ -1118,6 +1115,7 @@
             emit q->copyingDone( q, (*it).uSource, (*it).uDest, (*it).mtime, false, false );
             if (m_mode == CopyJob::Move)
                 org::kde::KDirNotify::emitFileMoved( (*it).uSource.url(), (*it).uDest.url() );
+            m_successSrcList.append((*it).uSource);
         }
         // remove from list, to move on to next file
         files.erase( it );
@@ -1372,7 +1370,7 @@
         KIO::Job * newjob = 0;
         if ( m_mode == CopyJob::Link ) {
             // User requested that a symlink be made
-          JobFlags flags = bOverwrite ? Overwrite : DefaultFlags;
+            const JobFlags flags = bOverwrite ? Overwrite : DefaultFlags;
             newjob = linkNextFile(uSource, uDest, flags);
             if (!newjob)
                 return;
@@ -1384,7 +1382,7 @@
                   (uSource.pass() == uDest.pass()))
             // Copying a symlink - only on the same protocol/host/etc. (#5601, downloading an FTP file through its link),
         {
-            JobFlags flags = bOverwrite ? Overwrite : DefaultFlags;
+            const JobFlags flags = bOverwrite ? Overwrite : DefaultFlags;
             KIO::SimpleJob *newJob = KIO::symlink( (*it).linkDest, uDest, flags | HideProgressInfo /*no GUI*/ );
             Scheduler::scheduleJob(newJob);
             newjob = newJob;
@@ -1509,23 +1507,6 @@
         // but then we need to jump to the else part below. Maybe with a recursive call?
 #endif
     } else {
-        // Finished - tell the world
-        if ( !m_bOnlyRenames )
-        {
-            KUrl url( m_globalDest );
-            if ( m_globalDestinationState != DEST_IS_DIR || m_asMethod )
-                url.setPath( url.directory() );
-            //kDebug(7007) << "KDirNotify'ing FilesAdded " << url;
-            org::kde::KDirNotify::emitFilesAdded( url.url() );
-
-            Q_FOREACH(const KUrl& url, m_skippedSourceUrls)
-                m_srcList.removeAll(url);
-
-            if ( m_mode == CopyJob::Move && !m_srcList.isEmpty() ) {
-                //kDebug(7007) << "KDirNotify'ing FilesRemoved " << m_srcList.toStringList();
-                org::kde::KDirNotify::emitFilesRemoved( m_srcList.toStringList() );
-            }
-        }
         if (m_reportTimer)
             m_reportTimer->stop();
         --m_processedFiles; // undo the "start at 1" hack
@@ -1535,6 +1516,27 @@
     }
 }
 
+void CopyJob::emitResult()
+{
+    Q_D(CopyJob);
+    // Before we go, tell the world about the changes that were made.
+    // Even if some error made us abort midway, we might still have done
+    // part of the job so we better update the views! (#118583)
+    if (!d->m_bOnlyRenames) {
+        KUrl url(d->m_globalDest);
+        if (d->m_globalDestinationState != DEST_IS_DIR || d->m_asMethod)
+            url.setPath(url.directory());
+        //kDebug(7007) << "KDirNotify'ing FilesAdded " << url;
+        org::kde::KDirNotify::emitFilesAdded( url.url() );
+
+        if (d->m_mode == CopyJob::Move && !d->m_successSrcList.isEmpty()) {
+            kDebug(7007) << "KDirNotify'ing FilesRemoved" << d->m_successSrcList.toStringList();
+            org::kde::KDirNotify::emitFilesRemoved(d->m_successSrcList.toStringList());
+        }
+    }
+    Job::emitResult();
+}
+
 void CopyJobPrivate::slotProcessedSize( KJob*, qulonglong data_size )
 {
   Q_Q(CopyJob);
@@ -1635,7 +1637,7 @@
             kDebug(7007) << "KTemporaryFile using" << _tmp << "as intermediary";
             if ( KDE_rename( _src, _tmp ) == 0 )
             {
-                if ( !QFile::exists( _dest ) && KDE_rename( _tmp, _dest ) == 0 )
+                if ( !QFile::exists( dest.path() ) && KDE_rename( _tmp, _dest ) == 0 )
                 {
                     kDebug(7007) << "Success.";
                     err = 0;
@@ -1801,6 +1803,7 @@
         kDebug(7007) << "Renaming succeeded, move on";
         ++m_processedFiles;
         emit q->copyingDone( q, *m_currentStatSrc, dest, -1 /*mtime unknown, and not needed*/, true, true );
+        m_successSrcList.append(*m_currentStatSrc);
         statNextSrc();
     }
 }
Index: kio/kio/directorysizejob.h
===================================================================
--- kio/kio/directorysizejob.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kio/directorysizejob.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,8 @@
 /**
  * Computes a directory size (similar to "du", but doesn't give the same results
  * since we simply sum up the dir and file sizes, whereas du speaks disk blocks)
+ *
+ * Usage: see KIO::directorySize.
  */
 class KIO_EXPORT DirectorySizeJob : public KIO::Job
 {
@@ -70,7 +72,8 @@
 
 /**
  * Computes a directory size (by doing a recursive listing).
- * Connect to the result signal. Use NetAccess::synchronousRun for a synchronous version.
+ * Connect to the result signal (this is the preferred solution to avoid blocking the GUI),
+ * or use exec() for a synchronous (blocking) calculation.
  *
  * This one lists a single directory.
  */
@@ -78,7 +81,8 @@
 
 /**
  * Computes a directory size (by doing a recursive listing).
- * Connect to the result signal. Use NetAccess::synchronousRun for a synchronous version.
+ * Connect to the result signal (this is the preferred solution to avoid blocking the GUI),
+ * or use exec() for a synchronous (blocking) calculation.
  *
  * This one lists the items from @p lstItems.
  * The reason we asks for items instead of just urls, is so that
Index: kio/bookmarks/kbookmarkmanager.cc
===================================================================
--- kio/bookmarks/kbookmarkmanager.cc	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/bookmarks/kbookmarkmanager.cc	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -398,6 +398,7 @@
     {
         file.simpleBackupFile( file.fileName(), QString(), ".bak" );
         QTextStream stream(&file);
+        stream.setCodec( QTextCodec::codecForName( "UTF-8" ) );
         stream << internalDocument().toString();
         stream.flush();
         if ( file.finalize() )
Index: kio/kdatatool.desktop
===================================================================
--- kio/kdatatool.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kdatatool.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
 Comment[gu]=KDE માહિતી સાધન
 Comment[he]=כלי נתונים של KDE
 Comment[hi]=केडीई डाटा औजार
+Comment[hne]=केडीई डाटा औजार
 Comment[hr]=KDE alat za podatke
 Comment[hsb]=Datowy nastroj za KDE
 Comment[hu]=KDE adatkezelő segédprogram
Index: kio/kfile/kpropertiesdialogplugin.desktop
===================================================================
--- kio/kfile/kpropertiesdialogplugin.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kfile/kpropertiesdialogplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -32,6 +32,7 @@
 Comment[gu]=પ્લગઈન માટે ગુણધર્મો સંવાદ
 Comment[he]=תוסף לדו־שיח המאפיינים
 Comment[hi]=गुण संवाद के लिए प्लगइन
+Comment[hne]=गुन गोठ बर प्लगइन
 Comment[hr]=Dodatak dijaloga 'Svojstva'
 Comment[hsb]=Zašćěpka za swójstwowy dialog
 Comment[hu]=Beépülő modul a tulajdonságok párbeszédablakhoz
Index: kio/kfile/kfiledialog.cpp
===================================================================
--- kio/kfile/kfiledialog.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kfile/kfiledialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -52,17 +52,24 @@
 const bool NATIVE_FILEDIALOGS_BY_DEFAULT = false;
 #endif
 
-static QStringList mime2KdeFilter( const QStringList &mimeTypes )
+static QStringList mime2KdeFilter( const QStringList &mimeTypes, QString *allExtensions = 0 )
 {
   const KUrl emptyUrl;
   QStringList kdeFilter;
+  QStringList allExt;
   foreach( const QString& mimeType, mimeTypes ) {
     KMimeType::Ptr mime( KMimeType::mimeType(mimeType) );
-    if (mime)
+    if (mime) {
+      allExt += mime->patterns();
       kdeFilter.append(mime->patterns().join(QLatin1String(" ")) +
                        QLatin1Char('|') +
                        mime->comment(emptyUrl));
+    }
   }
+  if (allExtensions) {
+      allExt.sort();
+      *allExtensions = allExt.join(QLatin1String(" "));
+  }
   return kdeFilter;
 }
 /** @return File dialog filter in Qt format for @a filters
@@ -245,6 +252,7 @@
     d->w = ::qobject_cast<KAbstractFileWidget *>(fileQWidget);
 
     if (d->native) {
+        KFileDialogPrivate::Native::s_startDir = startDir;
         // check if it's a mimefilter
         int pos = filter.indexOf('/');
         if (pos > 0 && filter[pos - 1] != '\\')
@@ -318,8 +326,14 @@
 {
     d->w->setMimeFilter(mimeTypes, defaultType);
 
-    if (d->native)
-        d->native->filter = mime2KdeFilter( mimeTypes ).join(QLatin1String("\n"));
+    if (d->native) {
+        QString allExtensions;
+        QStringList filters = mime2KdeFilter(mimeTypes, &allExtensions);
+        if (defaultType.isEmpty() && (mimeTypes.count() > 1)) {
+            filters.prepend(allExtensions + QLatin1Char('|') + i18n("All Supported Files"));
+        }
+        d->native->filter = filters.join(QLatin1String("\n"));
+    }
 }
 
 void KFileDialog::clearFilter()
@@ -633,7 +647,7 @@
             parent,
             caption.isEmpty() ? i18n("Save As") : caption,
             KFileDialogPrivate::Native::staticStartDir( startDir ).path(),
-            filter );
+            qtFilter(filter) );
 // TODO use extra args?     QString * selectedFilter = 0, Options options = 0
         if (!result.isEmpty()) {
             if (!recentDirClass.isEmpty())
Index: kio/misc/kssld/kssld.cpp
===================================================================
--- kio/misc/kssld/kssld.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/misc/kssld/kssld.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -104,7 +104,7 @@
     if (rule.hostName().isEmpty()) {
         return;
     }
-    KConfigGroup group = d->config.group(rule.certificate().digest());
+    KConfigGroup group = d->config.group(rule.certificate().digest().toHex());
 
     QStringList sl;
 
@@ -139,7 +139,7 @@
 
 void KSSLD::clearRule(const QSslCertificate &cert, const QString &hostName)
 {
-    KConfigGroup group = d->config.group(cert.digest());
+    KConfigGroup group = d->config.group(cert.digest().toHex());
     group.deleteEntry(hostName);
     if (group.keyList().size() < 2) {
         group.deleteGroup();
@@ -150,7 +150,7 @@
 
 KSslCertificateRule KSSLD::rule(const QSslCertificate &cert, const QString &hostName) const
 {
-    KConfigGroup group = d->config.group(cert.digest());
+    KConfigGroup group = d->config.group(cert.digest().toHex());
 
     //Find a rule for the hostname, either directly or with wildcards
     QString key = hostName;
Index: kio/misc/kssld/kssld.desktop
===================================================================
--- kio/misc/kssld/kssld.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/misc/kssld/kssld.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -34,6 +34,7 @@
 Name[gu]=KSSL ડેમોન મોડ્યુલ
 Name[he]=מודול השירות של KSSL
 Name[hi]=केएसएसएल डेमन मॉड्यूल
+Name[hne]=केएसएसएल डेमन माड्यूल
 Name[hr]=Modul KSSL demona
 Name[hsb]=KSSL Daemon Modul
 Name[hu]=KSSL szolgáltatásmodul
@@ -114,6 +115,7 @@
 Comment[gu]=KDED માટે KSSL ડેમોન મોડ્યુલ
 Comment[he]=מודול שירות של KSSL עבור KDED
 Comment[hi]=केडीईडी के लिए केएसएसएल डेमन मॉड्यूल
+Comment[hne]=केडीईडी बर केएसएसएल डेमन माड्यूल
 Comment[hr]=KSSL demon modul za KDED
 Comment[hsb]=KSSL daemon modul za KDED
 Comment[hu]=KSSL szolgáltatásmodul a KDED-hez
Index: kio/misc/mms.protocol
===================================================================
--- kio/misc/mms.protocol	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/misc/mms.protocol	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -32,6 +32,7 @@
 Description[gu]=માઇક્રોસોફ્ટ મીડીઆ સર્વર પ્રોટોકોલ
 Description[he]=פרוטוקול Microsoft Media Server
 Description[hi]=माइक्रोसॉफ़्ट मीडिया सर्वर प्रोटोकॉल
+Description[hne]=माइक्रोसाफ्ट मीडिया सर्वर प्रोटोकाल
 Description[hr]=Protokol Microsoft Media poslužitelja
 Description[hsb]=Microsoft Media Server protokol
 Description[hu]=MMS protokoll
Index: kio/misc/kpac/proxyscout.notifyrc
===================================================================
--- kio/misc/kpac/proxyscout.notifyrc	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/misc/kpac/proxyscout.notifyrc	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -28,6 +28,7 @@
 Comment[gu]=આપમેળે પ્રોક્સી રુપરેખાંકન
 Comment[he]=קביעת הגדרות מתווכים באופן אוטומטי
 Comment[hi]=स्वचालित प्रॉक्सी कॉन्फ़िगरेशन
+Comment[hne]=अपने अपन प्राक्सी कान्फिगरेसन
 Comment[hsb]=Awtomatiska konfiguracija proxyja
 Comment[hu]=Automatikus proxybeállítás
 Comment[is]=Sjálfvirkar stillingar vefsels
@@ -101,6 +102,7 @@
 Name[gu]=અયોગ્ય પ્રોક્સી સ્ક્રિપ્ટ
 Name[he]=תסריט מתווך לא תקין
 Name[hi]=अवैध प्रॉक्सी स्क्रिप्ट
+Name[hne]=अवैध प्राक्सी स्क्रिप्ट
 Name[hsb]=Njekorektny proxyjowy skript
 Name[hu]=Érvénytelen proxyszkript
 Name[is]=Ógild vefselsskrifta
@@ -175,6 +177,7 @@
 Comment[gu]=ડાઉનલોડ કરેલ પ્રોક્સી રૂપરેખાંકન સ્ક્રિપ્ટ અયોગ્ય છે
 Comment[he]=תסריט ההגדרות של השרת המתווך שהורד לא תקין
 Comment[hi]=डाउनलोड किया गया प्रॉक्सी कॉन्फ़िगरेशन स्क्रिप्ट अवैध है
+Comment[hne]=डाउनलोड करे गे प्राक्सी कान्फिगरेसन स्क्रिप्ट अवैध हे
 Comment[hr]=Preuzeta skripta konfiguriranja proxyja je neispravna
 Comment[hsb]=Sćehnjeny konfiguraciski skript za proxy je njekorektny.
 Comment[hu]=A letöltött proxyszkript érvénytelen
@@ -256,6 +259,7 @@
 Name[gu]=સ્ક્રિપ્ટ ડાઉનલોડ ક્ષતિ
 Name[he]=שגיאת הורדת תסריט
 Name[hi]=स्क्रिप्ट डाउनलोड त्रुटि
+Name[hne]=स्क्रिप्ट डाउनलोड गलती
 Name[hsb]=Zmylk sćehnjenja skripta
 Name[hu]=Szkriptletöltési hiba
 Name[is]=Villa við niðurhal skriftu
@@ -330,6 +334,7 @@
 Comment[gu]=પ્રોક્સી રૂપરેખાંકન સ્ક્રિપ્ટ ડાઉનલોડ કરી શકાતી નથી
 Comment[he]=אין אפשרות להוריד את תסריט הגדרות שרת המתווך
 Comment[hi]=प्रॉक्सी कॉन्फ़िगरेशन स्क्रिप्ट को डाउनलोड नहीं किया जा सका
+Comment[hne]=प्राक्सी कान्फिगरेसन स्क्रिप्ट ल डाउनलोड नइ कर सकीस
 Comment[hr]=Skripta konfiguriranja proxyja nije mogla biti preuzetom s Interneta
 Comment[hsb]=Konfiguraciski skript za proxy njehodźi so sćahnyć
 Comment[hu]=A proxyszkriptet nem sikerült letölteni
@@ -411,6 +416,7 @@
 Name[gu]=સ્ક્રિપ્ટ ચકાસણી ક્ષતિ
 Name[he]=שגיאה בעת פיענוח התסריט
 Name[hi]=स्क्रिप्ट परीक्षण त्रुटि
+Name[hne]=स्क्रिप्ट परीक्छन गलती
 Name[hsb]=Zmylk při wuwjedźenju skripta
 Name[hu]=Szkriptkiértékelési hiba
 Name[is]=Villa við túlkun skriftu
@@ -484,6 +490,7 @@
 Comment[gu]=પ્રોક્સી રૂપરેખાંકન સ્ક્રિપ્ટ ચલાવવામાં ક્ષતિ હતી
 Comment[he]=ארעה שגיאה בעת ההפעלה של תסריט הגדרת השרת המתווך
 Comment[hi]=प्रॉक्सी कॉन्फ़िगरेशन स्क्रिप्ट को चलाने के दौरान एक त्रुटि हुई
+Comment[hne]=प्राक्सी कान्फिगरेसन स्क्रिप्ट ल चलाय के समय एक गलती होइस
 Comment[hr]=Došlo je do pogreške pri izvršavanju konfiguracijske skripte proxyja
 Comment[hsb]=Při wuwjedźenju konfiguraciskeho skripta za proxy je so zmylk stał
 Comment[hu]=Hiba történt a proxyszkript végrehajtása közben
@@ -516,6 +523,7 @@
 Comment[pt_BR]=Houve um erro ao executar o script de configuração do proxy
 Comment[ro]=A apărut o eroare la execuția scriptului de configurare proxy
 Comment[ru]=Ошибка при выполнении скрипта настройки прокси-сервера
+Comment[se]=Meattáhus čuožžilii go vujii gaskabálváheivehanskripta
 Comment[sk]=Vyskytla sa chyba počas spustenia konfiguračného skriptu proxy
 Comment[sl]=Prišlo je do napake pri izvajanju nastavitvenega skripta posrednika
 Comment[sr]=Грешка током извршавања скрипте поставе проксија
Index: kio/misc/kpac/proxyscout.desktop
===================================================================
--- kio/misc/kpac/proxyscout.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/misc/kpac/proxyscout.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -23,6 +23,7 @@
 Name[gu]=પ્રોક્સી સ્કાઉટ
 Name[he]=מחפש שרתים מתווכים
 Name[hi]=प्रॉक्सी स्काउट
+Name[hne]=प्राक्सी स्काउट
 Name[hr]=Proxy izvidnik
 Name[is]=Vefselsleitari
 Name[it]=Esploratore proxy
@@ -94,6 +95,7 @@
 Comment[gu]=આપમેળે પ્રોક્સી રુપરેખાંકન
 Comment[he]=קביעת הגדרות מתווכים באופן אוטומטי
 Comment[hi]=स्वचालित प्रॉक्सी कॉन्फ़िगरेशन
+Comment[hne]=अपने अपन प्राक्सी कान्फिगरेसन
 Comment[hr]=Automatsko konfiguriranje proxyja
 Comment[hsb]=Awtomatiska konfiguracija proxyja
 Comment[hu]=Automatikus proxybeállítás
Index: kio/kcmoduleinit.desktop
===================================================================
--- kio/kcmoduleinit.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kcmoduleinit.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,7 @@
 Name[gu]=KDE રૂપરેખાંકન શરૂઆત
 Name[he]=איתחול ההגדרות של KDE
 Name[hi]=केडीई कॉन्फ़िगरेशन इनिशिअलाइज़ेशन
+Name[hne]=केडीई कान्फिगरेसन इनिसिअलाइजेसन
 Name[hsb]=Inicializacija za konfiguraciju KDE
 Name[hu]=KDE konfigurációkészítő
 Name[is]=Ræsing KDE stillinga
Index: kio/tests/kdirlistertest.cpp
===================================================================
--- kio/tests/kdirlistertest.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/tests/kdirlistertest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -326,6 +326,55 @@
     m_refreshedItems.clear();
 }
 
+void KDirListerTest::testRenameAndOverwrite() // has to be run after testRenameItem
+{
+    // Rename toplevelfile_2.renamed.html to toplevelfile_2, overwriting it.
+    const QString dirPath = m_tempDir.name();
+    const QString path = dirPath+"toplevelfile_2";
+    createTestFile(path);
+    KFileItem existingItem;
+    while (existingItem.isNull()) {
+        QTest::qWait(100);
+        existingItem = m_dirLister.findByUrl(KUrl(path));
+    };
+    QCOMPARE(existingItem.url().path(), path);
+
+    m_refreshedItems.clear();
+    qRegisterMetaType<KFileItem>("KFileItem");
+    connect(&m_dirLister, SIGNAL(refreshItems(const QList<QPair<KFileItem, KFileItem> > &)),
+            this, SLOT(slotRefreshItems(const QList<QPair<KFileItem, KFileItem> > &)));
+    QSignalSpy spyItemsDeleted(&m_dirLister, SIGNAL(itemsDeleted(KFileItemList)));
+    const QString newPath = dirPath+"toplevelfile_2.renamed.html";
+
+    KIO::SimpleJob* job = KIO::rename(newPath, path, KIO::Overwrite | KIO::HideProgressInfo);
+    bool ok = job->exec();
+    QVERIFY(ok);
+
+    if (m_refreshedItems.isEmpty()) {
+        // Wait for refreshItems. Could come from KDirWatch or KDirNotify.
+        //qDebug("waiting for refreshItems");
+        connect(this, SIGNAL(refreshItemsReceived()), this, SLOT(exitLoop()));
+        enterLoop();
+    }
+
+    // Check that itemsDeleted was emitted -- preferrably BEFORE refreshItems,
+    // but we can't easily check that with QSignalSpy...
+    QCOMPARE(spyItemsDeleted.count(), 1);
+
+    QCOMPARE(m_refreshedItems.count(), 1);
+    QPair<KFileItem, KFileItem> entry = m_refreshedItems.first();
+    QCOMPARE(entry.first.url().path(), newPath);
+    QCOMPARE(entry.second.url().path(), path);
+    disconnect(&m_dirLister, 0, this, 0);
+
+    // Let's see what KDirLister has in cache now
+    KFileItem cachedItem = m_dirLister.findByUrl(KUrl(path));
+    QCOMPARE(cachedItem.url().path(), path);
+    KFileItem oldCachedItem = m_dirLister.findByUrl(KUrl(newPath));
+    QVERIFY(oldCachedItem.isNull());
+    m_refreshedItems.clear();
+}
+
 void KDirListerTest::testConcurrentListing()
 {
     m_items.clear();
Index: kio/tests/kruntest.cpp
===================================================================
--- kio/tests/kruntest.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/tests/kruntest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -56,12 +56,13 @@
     { "run(kwrite, no url)", "should work normally", "kwrite", 0 },
     { "run(kwrite, file url)", "should work normally", "kwrite", testFile },
     { "run(kwrite, remote url)", "should work normally", "kwrite", "http://www.kde.org" },
-    { "run(doesnotexist, no url)", "should show error message", "doesnotexist", 0 },
-    { "run(doesnotexist, file url)", "should show error message", "doesnotexist", testFile },
-    { "run(doesnotexist, remote url)", "should use kioexec and show error message", "doesnotexist", "http://www.kde.org" },
+    { "run(doesnotexit, no url)", "should show error message", "doesnotexist", 0 },
+    { "run(doesnotexit, file url)", "should show error message", "doesnotexist", testFile },
+    { "run(doesnotexit, remote url)", "should use kioexec and show error message", "doesnotexist", "http://www.kde.org" },
     { "run(missing lib, no url)", "should show error message (remove libqca.so.2 for this, e.g. by editing LD_LIBRARY_PATH if qca is in its own prefix)", "qcatool", 0 },
     { "run(missing lib, file url)", "should show error message (remove libqca.so.2 for this, e.g. by editing LD_LIBRARY_PATH if qca is in its own prefix)", "qcatool", testFile },
-    { "run(missing lib, remote url)", "should show error message (remove libqca.so.2 for this, e.g. by editing LD_LIBRARY_PATH if qca is in its own prefix)", "qcatool", "http://www.kde.org" }
+    { "run(missing lib, remote url)", "should show error message (remove libqca.so.2 for this, e.g. by editing LD_LIBRARY_PATH if qca is in its own prefix)", "qcatool", "http://www.kde.org" },
+    { "runCommand(full path)", "should work normally", "../../kdecore/tests/kurltest", "" }
 };
 
 Receiver::Receiver()
@@ -106,9 +107,13 @@
     Q_ASSERT(button);
     const int testNumber = button->property("testNumber").toInt();
     KUrl::List urls;
-    if (s_tests[testNumber].url)
-        urls << KUrl(s_tests[testNumber].url);
-    KRun::run(s_tests[testNumber].exec, urls, this);
+    if (QByteArray(s_tests[testNumber].text).startsWith("runCommand")) {
+        KRun::runCommand(s_tests[testNumber].exec, this);
+    } else {
+        if (s_tests[testNumber].url)
+            urls << KUrl(s_tests[testNumber].url);
+        KRun::run(s_tests[testNumber].exec, urls, this);
+    }
 }
 
 void Receiver::slotStop()
Index: kio/tests/kioslavetest.cpp
===================================================================
--- kio/tests/kioslavetest.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/tests/kioslavetest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -14,6 +14,7 @@
 #include <QtCore/QDir>
 #include <QtGui/QGroupBox>
 
+#include <unistd.h>
 #include <kapplication.h>
 #include <kcmdlineargs.h>
 #include <kdebug.h>
@@ -259,11 +260,15 @@
     break;
 
   case Put:
+  {
     putBuffer = 0;
-    myJob = KIO::put( src, -1, KIO::Overwrite );
-    connect(myJob, SIGNAL( dataReq( KIO::Job*, QByteArray &)),
+    KIO::TransferJob* tjob = KIO::put( src, -1, KIO::Overwrite );
+    tjob->setTotalSize(48*1024*1024);
+    myJob = tjob;
+    connect(tjob, SIGNAL( dataReq( KIO::Job*, QByteArray &)),
             SLOT( slotDataReq( KIO::Job*, QByteArray &)));
     break;
+  }
 
   case Copy:
     job = KIO::copy( src, dest, observe );
@@ -440,6 +445,11 @@
          "This is a test file\n",
          "You can safely delete it.\n",
 	 "BIG\n",
+	 "BIG1\n",
+	 "BIG2\n",
+	 "BIG3\n",
+	 "BIG4\n",
+	 "BIG5\n",
          0
        };
     const char *fileData = fileDataArray[putBuffer++];
@@ -449,11 +459,12 @@
        kDebug(0) << "DataReq: <End>";
        return;
     }
-    if (!strcmp(fileData, "BIG\n"))
-	data.fill(0, 29*1024*1024);
+    if (!strncmp(fileData, "BIG", 3))
+	data.fill(0, 8*1024*1024);
     else
 	data = QByteArray(fileData, strlen(fileData));
     kDebug(0) << "DataReq: \"" << fileData << "\"";
+    sleep(1); // want to see progress info...
 }
 
 void KioslaveTest::stopJob() {
@@ -473,10 +484,9 @@
   options.add("d");
   options.add("dest <dest>", ki18n("Destination URL"), QByteArray());
   options.add("o");
-  options.add("operation <operation>", ki18n("Operation (list,listrecursive,stat,get,put,copy,move,del,mkdir)"), QByteArray("copy"));
+  options.add("operation <operation>", ki18n("Operation (list,listrecursive,stat,get,put,copy,move,del,mkdir)"));
   options.add("p");
-  options.add("progress <progress>", ki18n("Progress Type (none,default,status)"),
-          QByteArray("default"));
+  options.add("progress <progress>", ki18n("Progress Type (none,default,status)"), QByteArray("default"));
 
   const char version[] = "v0.0.0 0000";   // :-)
   KLocalizedString description = ki18n("Test for kioslaves");
@@ -490,48 +500,48 @@
   QString src = args->getOption("src");
   QString dest = args->getOption("dest");
 
-  uint op = 0;
+  uint op = KioslaveTest::Copy;
   uint pr = 0;
 
-  QString tmps;
-
-  tmps = args->getOption("operation");
-  if ( tmps == "list") {
+  QString operation = args->getOption("operation");
+  if ( operation == "list") {
     op = KioslaveTest::List;
-  } else if ( tmps == "listrecursive") {
+  } else if ( operation == "listrecursive") {
     op = KioslaveTest::ListRecursive;
-  } else if ( tmps == "stat") {
+  } else if ( operation == "stat") {
     op = KioslaveTest::Stat;
-  } else if ( tmps == "get") {
+  } else if ( operation == "get") {
     op = KioslaveTest::Get;
-  } else if ( tmps == "put") {
+  } else if ( operation == "put") {
     op = KioslaveTest::Put;
-  } else if ( tmps == "copy") {
+  } else if ( operation == "copy") {
     op = KioslaveTest::Copy;
-  } else if ( tmps == "move") {
+  } else if ( operation == "move") {
     op = KioslaveTest::Move;
-  } else if ( tmps == "del") {
+  } else if ( operation == "del") {
     op = KioslaveTest::Delete;
-  } else if ( tmps == "mkdir") {
+  } else if ( operation == "mkdir") {
     op = KioslaveTest::Mkdir;
-  } else KCmdLineArgs::usage(QByteArray("unknown operation"));
+  } else if (!operation.isEmpty()) {
+    KCmdLineArgs::usage(QByteArray("unknown operation"));
+  }
 
-  tmps = args->getOption("progress");
-  if ( tmps == "none") {
+  QString progress = args->getOption("progress");
+  if ( progress == "none") {
     pr = KioslaveTest::ProgressNone;
-  } else if ( tmps == "default") {
+  } else if ( progress == "default") {
     pr = KioslaveTest::ProgressDefault;
-  } else if ( tmps == "status") {
+  } else if ( progress == "status") {
     pr = KioslaveTest::ProgressStatus;
   } else KCmdLineArgs::usage(QByteArray("unknown progress mode"));
 
   args->clear(); // Free up memory
 
-  KioslaveTest test( src, dest, op, pr );
-  QTimer::singleShot(100, &test, SLOT(startJob()));
-  test.show();
-  // Bug in KTMW / Qt / layouts ?
-  test.resize( test.sizeHint() );
+  KioslaveTest* test = new KioslaveTest( src, dest, op, pr );
+  if (!operation.isEmpty())
+      QTimer::singleShot(100, test, SLOT(startJob()));
+  test->show();
+  test->resize( test->sizeHint() );
 
   app.exec();
 }
Index: kio/tests/kdirlistertest.h
===================================================================
--- kio/tests/kdirlistertest.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/tests/kdirlistertest.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -36,6 +36,7 @@
     void testRefreshItems();
     void testDeleteItem();
     void testRenameItem();
+    void testRenameAndOverwrite();
     void testConcurrentListing();
     void testConcurrentHoldingListing();
     void testOpenUrlTwice();
Index: kio/tests/dummymeta.desktop
===================================================================
--- kio/tests/dummymeta.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/tests/dummymeta.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -20,6 +20,7 @@
 Name[ga]=Meitea Caoch
 Name[gu]=નકલી મેટા
 Name[hi]=डमी मेटा
+Name[hne]=डमी मेटा
 Name[hr]=Ogledni meta podatak
 Name[hu]=Üres (dummy) metaadat
 Name[it]=Informazioni aggiuntive posticce
Index: kio/kscan.desktop
===================================================================
--- kio/kscan.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kscan.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -6,6 +6,7 @@
 Name[cy]=KSgan
 Name[eo]=Bildciferecigo
 Name[hi]=के-स्कैन
+Name[hne]=के-स्कैन
 Name[is]=KScan myndlesari
 Name[kn]=ಕೆಸ್ಕ್ಯಾನ್
 Name[mai]=के-स्कैन
Index: kio/kurifilterplugin.desktop
===================================================================
--- kio/kurifilterplugin.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kurifilterplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
 Name[gu]=સુધારો શોધખોળ પ્લગઈન
 Name[he]=תוסף לגלישה משופרת
 Name[hi]=एनहैंस्ड ब्राउज़िंग प्लगइन
+Name[hne]=एन हैस्ड ब्राउजिंग प्लगइन
 Name[hr]=Napredni dodatak za pretraživanje
 Name[hsb]=Zašćěpka za polěpšenje browsowanje
 Name[hu]=Továbbfejlesztett böngészés bővítőmodul
Index: kio/data.protocol
===================================================================
--- kio/data.protocol	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/data.protocol	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -34,6 +34,7 @@
 Description[gu]=માહિતી URIs (rfc2397) માટે kioslave
 Description[he]=פרוטוקול לכתובות נתונים (RFC 2397)
 Description[hi]=डाटा यूआरआई (rfc2397) के लिए एक केआईओस्लेव
+Description[hne]=डाटा यूआरआई (rfc2397) बर एक केआईओस्लेव
 Description[hr]=kioslave za podatkovne URI-ije (rfc2397)
 Description[hsb]=kioslave za datowe URL (rfc2397)
 Description[hu]=KDE-protokoll adat-URI-k használataához (RFC 2397)
Index: kio/Mainpage.dox
===================================================================
--- kio/Mainpage.dox	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/Mainpage.dox	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -13,29 +13,9 @@
 KIO::NetAccess class (for easy synchronous access) or via the
 KIO::Job class (for more complex asynchronous jobs).
 
-This library also implements the System Configuration Cache (KSycoca),
-and the %KDE file selector widget (see
+This library also implements the %KDE file selector widget (see
 @ref filedialog "the page on the file selector widget").
 
-@see KMimeType:
-  Represents the type of a file.
-
-@see KService:
-  A service is a library or application that can deal with a certain
-  set of mimetypes.
-
-@see KServiceType:
-  A service type is a group of services with similar functionality.  For
-  example, KOffice's filters have the service type KOfficeFilter.
-
-@see KServiceTypeTrader:
-  Can be used to query for which services implement a given servicetype.
-  Has its own language, in order to allow complex queries.
-
-@see KMimeTypeTrader:
-  Can be used to query for which services can handle a given mimetype.
-  Has its own language, in order to allow complex queries.
-
 @authors
 Various: see copyright headers in individual files
 
Index: kio/kcmodule.desktop
===================================================================
--- kio/kcmodule.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kcmodule.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -30,6 +30,7 @@
 Name[gu]=KDE રૂપરેખાંકન મોડ્યુલ
 Name[he]=מודול הגדרות של KDE
 Name[hi]=केडीई कॉन्फ़िगरेशन मॉड्यूल
+Name[hne]=केडीई कान्फिगरेसन माड्यूल
 Name[hsb]=Modul za konfigurowanje KDE
 Name[hu]=KDE beállítómodul
 Name[is]=KDE stillingaeining
Index: kio/application.desktop
===================================================================
--- kio/application.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/application.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -30,6 +30,7 @@
 Name[gu]=કાર્યક્રમ
 Name[he]=תוכנית
 Name[hi]=अनुप्रयोग
+Name[hne]=अनुपरयोग
 Name[hr]=Aplikacija
 Name[hsb]=aplikacija
 Name[hu]=alkalmazás
Index: kio/kssl/ksslcertificatemanager.upd
===================================================================
--- kio/kssl/ksslcertificatemanager.upd	(.../tags/KDE/4.2.0/kdelibs)	(wersja 0)
+++ kio/kssl/ksslcertificatemanager.upd	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -0,0 +1,5 @@
+# KConfigGroup cannot handle arbitrary binary data as group names.
+# As fixing this right would be quite hard, and the data is not very valuable,
+# we'll simply wipe the config file.
+Id=kde4.2
+Script=ksslcertificatemanager.upd.sh,sh
Index: kio/kssl/ksslinfodialog.cpp
===================================================================
--- kio/kssl/ksslinfodialog.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/kssl/ksslinfodialog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -75,6 +75,7 @@
     setAttribute(Qt::WA_DeleteOnClose);
 
     d->ui.setupUi(mainWidget());
+    setButtons(KDialog::Close);
 
     d->subject = new KSslCertificateBox(d->ui.certParties);
     d->issuer = new KSslCertificateBox(d->ui.certParties);
Index: kio/kssl/ksslcertificatemanager.upd.sh
===================================================================
--- kio/kssl/ksslcertificatemanager.upd.sh	(.../tags/KDE/4.2.0/kdelibs)	(wersja 0)
+++ kio/kssl/ksslcertificatemanager.upd.sh	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -0,0 +1,2 @@
+#!/bin/sh
+rm `kde4-config --localprefix`/share/config/ksslcertificatemanager
Index: kio/CMakeLists.txt
===================================================================
--- kio/CMakeLists.txt	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/CMakeLists.txt	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -245,6 +245,9 @@
    kssl/certificateparty.ui
 )
 
+install(FILES kssl/ksslcertificatemanager.upd 
+              kssl/ksslcertificatemanager.upd.sh
+        DESTINATION  ${DATA_INSTALL_DIR}/kconf_update)
 
 kde4_add_library(kio SHARED ${kio_LIB_SRCS})
 
Index: kio/renamedialogplugin.desktop
===================================================================
--- kio/renamedialogplugin.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kio/renamedialogplugin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
 Comment[gu]=નામબદલી સંવાદ માટે પ્લગઈન
 Comment[he]=תוסף לדו־שיח שינוי שם
 Comment[hi]=नाम बदलने वाले संवाद के लिए प्लगइन
+Comment[hne]=नाम बदले वाले गोठ बर प्लगइन
 Comment[hr]=Dodatak dijaloga za preimenovanja
 Comment[hsb]=Zašćěpka za přemjenowanski dialog
 Comment[hu]=Bővítőmodul az átnevezési párbeszédablakhoz
Index: kpty/kpty.cpp
===================================================================
--- kpty/kpty.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kpty/kpty.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -148,6 +148,10 @@
 {
 }
 
+KPtyPrivate::~KPtyPrivate()
+{
+}
+
 #ifndef HAVE_OPENPTY
 bool KPtyPrivate::chownpty(bool grant)
 {
Index: kpty/kpty_p.h
===================================================================
--- kpty/kpty_p.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kpty/kpty_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
     Q_DECLARE_PUBLIC(KPty)
 
     KPtyPrivate(KPty* parent);
+    virtual ~KPtyPrivate();
 #ifndef HAVE_OPENPTY
     bool chownpty(bool grant);
 #endif
Index: kdeui/dialogs/kbugreport.cpp
===================================================================
--- kdeui/dialogs/kbugreport.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/dialogs/kbugreport.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -127,7 +127,7 @@
   {
     // From
     QString qwtstr = i18n( "Your email address. If incorrect, use the Configure Email button to change it" );
-    tmpLabel = new QLabel( i18n("From:"), parent );
+    tmpLabel = new QLabel( i18nc("Email sender address", "From:"), parent );
     glay->addWidget( tmpLabel, row,0 );
     tmpLabel->setWhatsThis(qwtstr );
     d->m_from = new QLabel( parent );
@@ -144,7 +144,7 @@
 
     // To
     qwtstr = i18n( "The email address this bug report is sent to." );
-    tmpLabel = new QLabel( i18n("To:"), parent );
+    tmpLabel = new QLabel( i18nc("Email receiver address", "To:"), parent );
     glay->addWidget( tmpLabel, ++row,0 );
     tmpLabel->setWhatsThis(qwtstr );
     tmpLabel = new QLabel( d->m_aboutData->bugAddress(), parent );
Index: kdeui/tests/kcombobox_unittest.cpp
===================================================================
--- kdeui/tests/kcombobox_unittest.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/tests/kcombobox_unittest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -81,6 +81,12 @@
         QCOMPARE(comboActivatedSpy[0][0].toString(), QString("Hello world"));
     }
 
+    void testHistoryComboInsertItems()
+    {
+        KHistoryComboBox combo;
+        // uic generates code like this, let's make sure it compiles
+        combo.insertItems(0, QStringList() << "foo");
+    }
 };
 
 QTEST_KDEMAIN(KComboBox_UnitTest, GUI)
Index: kdeui/windowmanagement/kwindowsystem_x11.cpp
===================================================================
--- kdeui/windowmanagement/kwindowsystem_x11.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/windowmanagement/kwindowsystem_x11.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -502,7 +502,7 @@
         x -= w / 2; // from center back to topleft
         y -= h / 2;
         p = constrainViewportRelativePosition( QPoint( x, y ));
-        int flags = ( 0x20 << 12 ) | ( 0x03 << 8 ) | 10; // from tool(?), x/y, static gravity
+        int flags = ( 0x02 << 12 ) | ( 0x03 << 8 ) | 10; // from tool(?), x/y, static gravity
         KWindowSystemPrivate* const s_d = s_d_func();
         s_d->moveResizeWindowRequest( win, flags, p.x(), p.y(), w, h );
         return;
Index: kdeui/windowmanagement/kwindowsystem_win.cpp
===================================================================
--- kdeui/windowmanagement/kwindowsystem_win.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/windowmanagement/kwindowsystem_win.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -148,6 +148,9 @@
     QPixmap pix  = QPixmap::fromWinHBITMAP( ii.hbmColor );
     pix.setMask( QPixmap::fromWinHBITMAP( ii.hbmMask ) );
 
+    DeleteObject( ii.hbmMask );
+    DeleteObject( ii.hbmColor );
+
     return pix;
 }
 
Index: kdeui/windowmanagement/kwindowinfo_win.cpp
===================================================================
--- kdeui/windowmanagement/kwindowinfo_win.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/windowmanagement/kwindowinfo_win.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -147,7 +147,7 @@
         return NET::PopupMenu;
     else if(windowStyleEx & WS_EX_TOOLWINDOW && supported_types & NET::TooltipMask)
         return NET::Tooltip;
-    else if(!windowStyle & WS_CHILD  && supported_types & NET::NormalMask)
+    else if(!(windowStyle & WS_CHILD) && supported_types & NET::NormalMask)
         return NET::Normal;
         
     return wt;
Index: kdeui/windowmanagement/netwm_def.h
===================================================================
--- kdeui/windowmanagement/netwm_def.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/windowmanagement/netwm_def.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -703,15 +703,15 @@
         /**
           @internal indicates that the source of the request is unknown
         **/
-        FromUnknown, // internal
+        FromUnknown = 0, // internal
         /**
            indicates that the request comes from a normal application
         **/
-        FromApplication,
+        FromApplication = 1,
         /**
            indicated that the request comes from pager or similar tool
         **/
-        FromTool
+        FromTool = 2
     };
     
     /**
Index: kdeui/widgets/ktextedit.cpp
===================================================================
--- kdeui/widgets/ktextedit.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/widgets/ktextedit.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -909,6 +909,8 @@
     return true;
   } else if ( KStandardShortcut::pasteSelection().contains( key ) ) {
     return true;
+  } else if (event->matches(QKeySequence::SelectAll)) { // currently missing in QTextEdit
+      return true;
   } else if (event->modifiers() == Qt::ControlModifier &&
             (event->key() == Qt::Key_Return || event->key() == Qt::Key_Enter) &&
               qobject_cast<KDialog*>(parent->window()) ) {
Index: kdeui/widgets/kcompletionbox.h
===================================================================
--- kdeui/widgets/kcompletionbox.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/widgets/kcompletionbox.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -228,7 +228,6 @@
     virtual void slotActivated( QListWidgetItem * );
 
 private Q_SLOTS:
-    void slotSetCurrentItem( QListWidgetItem *i ); // grrr
     void slotCurrentChanged();
     void canceled();
     void slotItemClicked( QListWidgetItem * );
Index: kdeui/widgets/klineedit.cpp
===================================================================
--- kdeui/widgets/klineedit.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/widgets/klineedit.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -104,8 +104,6 @@
         }
     }
 
-    void doCompletion(const QString& txt);
-
     /**
      * Checks whether we should/should not consume a key used as a shortcut.
      * This makes it possible to handle shortcuts in the focused widget before any
@@ -826,7 +824,7 @@
                     if (e->key() == Qt::Key_Delete )
                         d->autoSuggest=false;
 
-                    d->doCompletion(txt);
+                    doCompletion(txt);
 
                     if(  (e->key() == Qt::Key_Backspace || e->key() == Qt::Key_Delete) )
                         d->autoSuggest=true;
@@ -899,7 +897,7 @@
                 if ( d->completionBox )
                   d->completionBox->setCancelledText( txt );
 
-                d->doCompletion(txt);
+                doCompletion(txt);
 
                 if ( (e->key() == Qt::Key_Backspace || e->key() == Qt::Key_Delete ) &&
                     mode == KGlobalSettings::CompletionPopupAuto )
@@ -930,7 +928,7 @@
                 const int len = txt.length();
                 if ( cursorPosition() == len && len != 0 )
                 {
-                    d->doCompletion(txt);
+                    doCompletion(txt);
                     return;
                 }
             }
@@ -995,7 +993,6 @@
             }
         }
     }
-
     const int selectedLength = selectedText().length();
 
     // Let QLineEdit handle any other keys events.
@@ -1284,17 +1281,6 @@
             // Eat the event if the user asked for it, or if a completionbox was visible
             if (stopEvent)
                 return true;
-        } else if (e->key() == Qt::Key_Tab && e->modifiers() == Qt::NoButton ) {
-            // #65877: Key_Tab should complete using the first (or selected) item, and then offer completions again
-            const bool tabHandling = d->completionBox && d->completionBox->isVisible() && d->completionBox->count() > 0;
-            if (tabHandling) {
-                QListWidgetItem* currentItem = d->completionBox->currentItem();
-                const QString txt = currentItem ? currentItem->text() : d->completionBox->item(0)->text();
-                setTextWorkaround(txt);
-                d->doCompletion(txt);
-                e->accept();
-                return true;
-            }
         }
     }
     return QLineEdit::event( ev );
@@ -1423,6 +1409,16 @@
     else if (KStandardShortcut::endOfLine().contains( key ))
         return true;
 
+    // Shortcut overrides for shortcuts that QLineEdit handles
+    // but doesn't dare force as "stronger than kaction shortcuts"...
+    else if (e->matches(QKeySequence::SelectAll)) {
+        return true;
+    }
+#ifdef Q_WS_X11
+    else if (key == Qt::CTRL + Qt::Key_E || key == Qt::CTRL + Qt::Key_U)
+        return true;
+#endif
+
     if (completionBox && completionBox->isVisible ())
     {
         const int key = e->key();
@@ -1700,14 +1696,14 @@
     return echoMode() == NoEcho || echoMode() == Password;
 }
 
-void KLineEditPrivate::doCompletion(const QString& txt)
+void KLineEdit::doCompletion(const QString& txt)
 {
-    if (q->emitSignals()) {
-        emit q->completion(txt); // emit when requested...
+    if (emitSignals()) {
+        emit completion(txt); // emit when requested...
     }
 
-    if (q->handleSignals()) {
-        q->makeCompletion(txt);  // handle when requested...
+    if (handleSignals()) {
+        makeCompletion(txt);  // handle when requested...
     }
 }
 
Index: kdeui/widgets/kcompletionbox.cpp
===================================================================
--- kdeui/widgets/kcompletionbox.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/widgets/kcompletionbox.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -22,6 +22,7 @@
 
 
 #include "kcompletionbox.h"
+#include "klineedit.h"
 
 #include <QtCore/QEvent>
 #include <QtGui/QApplication>
@@ -40,7 +41,7 @@
     QWidget *m_parent; // necessary to set the focus back
     QString cancelText;
     bool tabHandling : 1;
-    bool down_workaround : 1;
+    bool down_workaround : 1; // next call to down() selects the first item
     bool upwardBox : 1;
     bool emitSelected : 1;
 };
@@ -114,135 +115,143 @@
         return false;
     }
 
-    if (wid && (wid == d->m_parent || wid->windowFlags() & Qt::Window) && 
-               (type == QEvent::Move || type == QEvent::Resize)) {
+    if (wid && (wid == d->m_parent || wid->windowFlags() & Qt::Window) &&
+        (type == QEvent::Move || type == QEvent::Resize)) {
         hide();
         return false;
     }
 
     if (type == QEvent::MouseButtonPress && (wid && !isAncestorOf(wid))) {
         if (!d->emitSelected && currentItem() && !qobject_cast<QScrollBar*>(o)) {
-          Q_ASSERT(currentItem());
-          emit currentTextChanged(currentItem()->text() );
+            Q_ASSERT(currentItem());
+            emit currentTextChanged(currentItem()->text() );
         }
         hide();
         e->accept();
         return true;
     }
 
-    if (wid && wid->isAncestorOf(d->m_parent)) {
-        if ( isVisible() ) {
-            if ( type == QEvent::KeyPress ) {
-                QKeyEvent *ev = static_cast<QKeyEvent *>( e );
-                switch ( ev->key() ) {
-                    case Qt::Key_Backtab:
-                        if ( d->tabHandling && (ev->modifiers() == Qt::NoButton ||
-                             (ev->modifiers() & Qt::ShiftModifier)) ) {
-                            up();
-                            ev->accept();
-                            return true;
-                        }
-                        break;
-                    case Qt::Key_Tab:
-                        if ( d->tabHandling && (ev->modifiers() == Qt::NoButton) ) {
-                            down(); // Only on TAB!!
-                            ev->accept();
-                            return true;
-                        }
-                        break;
-                    case Qt::Key_Down:
-                        down();
-                        ev->accept();
-                        return true;
-                    case Qt::Key_Up:
-                        // If there is no selected item and we've popped up above
-                        // our parent, select the first item when they press up.
-                        if ( !selectedItems().isEmpty() ||
-                             mapToGlobal( QPoint( 0, 0 ) ).y() >
-                             d->m_parent->mapToGlobal( QPoint( 0, 0 ) ).y() )
-                            up();
-                        else
-                            down();
-                        ev->accept();
-                        return true;
-                    case Qt::Key_PageUp:
-                        pageUp();
-                        ev->accept();
-                        return true;
-                    case Qt::Key_PageDown:
-                        pageDown();
-                        ev->accept();
-                        return true;
-                    case Qt::Key_Escape:
-                        canceled();
-                        ev->accept();
-                        return true;
-                    case Qt::Key_Enter:
-                    case Qt::Key_Return:
-                        if ( ev->modifiers() & Qt::ShiftModifier ) {
+    if (wid && wid->isAncestorOf(d->m_parent) && isVisible()) {
+        if ( type == QEvent::KeyPress ) {
+            QKeyEvent *ev = static_cast<QKeyEvent *>( e );
+            switch ( ev->key() ) {
+            case Qt::Key_Backtab:
+                if ( d->tabHandling && (ev->modifiers() == Qt::NoButton ||
+                                        (ev->modifiers() & Qt::ShiftModifier)) ) {
+                    up();
+                    ev->accept();
+                    return true;
+                }
+                break;
+            case Qt::Key_Tab:
+                if ( d->tabHandling && (ev->modifiers() == Qt::NoButton) ) {
+                    down();
+                    // #65877: Key_Tab should complete using the first
+                    // (or selected) item, and then offer completions again
+                    if (count() == 1) {
+                        KLineEdit* parent = qobject_cast<KLineEdit*>(d->m_parent);
+                        if (parent) {
+                            parent->doCompletion(currentItem()->text());
+                        } else {
                             hide();
-                            ev->accept();  // Consume the Enter event
-                            return true;
                         }
-                        break;
-                    case Qt::Key_End:
-                        if ( ev->modifiers() & Qt::ControlModifier )
-                        {
-                            end();
-                            ev->accept();
-                            return true;
-                        }
-                        break;
-                    case Qt::Key_Home:
-                        if ( ev->modifiers() & Qt::ControlModifier )
-                        {
-                            home();
-                            ev->accept();
-                            return true;
-                        }
-                    default:
-                        break;
+                    }
+                    ev->accept();
+                    return true;
                 }
-            } else if ( type == QEvent::ShortcutOverride ) {
-                // Override any accelerators that match
-                // the key sequences we use here...
-                QKeyEvent *ev = static_cast<QKeyEvent *>( e );
-                switch ( ev->key() ) {
-                    case Qt::Key_Down:
-                    case Qt::Key_Up:
-                    case Qt::Key_PageUp:
-                    case Qt::Key_PageDown:
-                    case Qt::Key_Escape:
-                    case Qt::Key_Enter:
-                    case Qt::Key_Return:
-                      ev->accept();
-                      return true;
-                      break;
-                    case Qt::Key_Tab:
-                    case Qt::Key_Backtab:
-                        if ( ev->modifiers() == Qt::NoButton ||
-                            (ev->modifiers() & Qt::ShiftModifier))
-                        {
-                            ev->accept();
-                            return true;
-                        }
-                        break;
-                    case Qt::Key_Home:
-                    case Qt::Key_End:
-                        if ( ev->modifiers() & Qt::ControlModifier )
-                        {
-                            ev->accept();
-                            return true;
-                        }
-                        break;
-                    default:
-                        break;
+                break;
+            case Qt::Key_Down:
+                down();
+                ev->accept();
+                return true;
+            case Qt::Key_Up:
+                // If there is no selected item and we've popped up above
+                // our parent, select the first item when they press up.
+                if ( !selectedItems().isEmpty() ||
+                     mapToGlobal( QPoint( 0, 0 ) ).y() >
+                     d->m_parent->mapToGlobal( QPoint( 0, 0 ) ).y() )
+                    up();
+                else
+                    down();
+                ev->accept();
+                return true;
+            case Qt::Key_PageUp:
+                pageUp();
+                ev->accept();
+                return true;
+            case Qt::Key_PageDown:
+                pageDown();
+                ev->accept();
+                return true;
+            case Qt::Key_Escape:
+                canceled();
+                ev->accept();
+                return true;
+            case Qt::Key_Enter:
+            case Qt::Key_Return:
+                if ( ev->modifiers() & Qt::ShiftModifier ) {
+                    hide();
+                    ev->accept();  // Consume the Enter event
+                    return true;
                 }
-            } else if ( type == QEvent::FocusOut ) {
-                  QFocusEvent* event = static_cast<QFocusEvent*>( e );
-                  if (event->reason() != Qt::PopupFocusReason)
-                    hide();
+                break;
+            case Qt::Key_End:
+                if ( ev->modifiers() & Qt::ControlModifier )
+                {
+                    end();
+                    ev->accept();
+                    return true;
+                }
+                break;
+            case Qt::Key_Home:
+                if ( ev->modifiers() & Qt::ControlModifier )
+                {
+                    home();
+                    ev->accept();
+                    return true;
+                }
+            default:
+                break;
             }
+        } else if ( type == QEvent::ShortcutOverride ) {
+            // Override any accelerators that match
+            // the key sequences we use here...
+            QKeyEvent *ev = static_cast<QKeyEvent *>( e );
+            switch ( ev->key() ) {
+            case Qt::Key_Down:
+            case Qt::Key_Up:
+            case Qt::Key_PageUp:
+            case Qt::Key_PageDown:
+            case Qt::Key_Escape:
+            case Qt::Key_Enter:
+            case Qt::Key_Return:
+                ev->accept();
+                return true;
+                break;
+            case Qt::Key_Tab:
+            case Qt::Key_Backtab:
+                if ( ev->modifiers() == Qt::NoButton ||
+                     (ev->modifiers() & Qt::ShiftModifier))
+                {
+                    ev->accept();
+                    return true;
+                }
+                break;
+            case Qt::Key_Home:
+            case Qt::Key_End:
+                if ( ev->modifiers() & Qt::ControlModifier )
+                {
+                    ev->accept();
+                    return true;
+                }
+                break;
+            default:
+                break;
+            }
+        } else if ( type == QEvent::FocusOut ) {
+            QFocusEvent* event = static_cast<QFocusEvent*>( e );
+            if (event->reason() != Qt::PopupFocusReason)
+                hide();
         }
     }
 
@@ -333,7 +342,7 @@
             qApp->removeEventFilter( this );
         d->cancelText.clear();
     }
-  
+
     KListWidget::setVisible(visible);
 }
 
@@ -427,7 +436,7 @@
     //int i = currentItem() - numItemsVisible();
     //i = i < 0 ? 0 : i;
     //setCurrentRow( i );
-    
+
     moveCursor(QAbstractItemView::MovePageUp , Qt::NoModifier);
 }
 
@@ -546,11 +555,6 @@
     d->down_workaround = true;
 }
 
-void KCompletionBox::slotSetCurrentItem( QListWidgetItem *i )
-{
-    setCurrentItem( i ); // grrr
-}
-
 void KCompletionBox::slotCurrentChanged()
 {
     if (currentItem())
Index: kdeui/widgets/klineedit.h
===================================================================
--- kdeui/widgets/klineedit.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/widgets/klineedit.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -340,13 +340,22 @@
      * @return whether or not the clear button is shown
      **/
     bool isClearButtonShown() const;
-    
+
     /**
      * @return the size used by the clear button
      * @since KDE 4.1
      **/
     QSize clearButtonUsedSize() const;
 
+    /**
+     * Do completion now. This is called automatically when typing a key for instance.
+     * Emits completion() and/or calls makeCompletion(), depending on
+     * emitSignals and handleSignals.
+     *
+     * @since 4.2.1
+     */
+    void doCompletion(const QString& txt);
+
 Q_SIGNALS:
 
     /**
Index: kdeui/widgets/kmainwindow.cpp
===================================================================
--- kdeui/widgets/kmainwindow.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/widgets/kmainwindow.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -461,6 +461,7 @@
 KMainWindow::~KMainWindow()
 {
     sMemberList->removeAll( this );
+    delete k_ptr->dockResizeListener;  //so we don't get anymore events after k_ptr is destroyed
     delete k_ptr;
     KGlobal::deref();
 }
Index: kdeui/widgets/khistorycombobox.h
===================================================================
--- kdeui/widgets/khistorycombobox.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/widgets/khistorycombobox.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -179,6 +179,8 @@
      */
     void reset();
 
+    using QComboBox::insertItems;
+
 public Q_SLOTS:
     /**
      * Adds an item to the end of the history list and to the completion list.
Index: kdeui/widgets/kcharselect.cpp
===================================================================
--- kdeui/widgets/kcharselect.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/widgets/kcharselect.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -351,14 +351,14 @@
     d->backButton = new QToolButton(this);
     comboLayout->addWidget(d->backButton);
     d->backButton->setEnabled(false);
-    d->backButton->setText(i18n("Back"));
+    d->backButton->setText(i18nc("Goes to previous character", "Back"));
     d->backButton->setIcon(KIcon("go-previous"));
     d->backButton->setToolTip(i18n("Previous Character"));
 
     d->forwardButton = new QToolButton(this);
     comboLayout->addWidget(d->forwardButton);
     d->forwardButton->setEnabled(false);
-    d->forwardButton->setText(i18n("Forward"));
+    d->forwardButton->setText(i18nc("Goes to next character", "Forward"));
     d->forwardButton->setIcon(KIcon("go-next"));
     d->forwardButton->setToolTip(i18n("Next Character"));
 
Index: kdeui/icons/kiconeffect.cpp
===================================================================
--- kdeui/icons/kiconeffect.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/icons/kiconeffect.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -83,6 +83,7 @@
     groups += "MainToolbar";
     groups += "Small";
     groups += "Panel";
+    groups += "Dialog";
 
     QStringList states;
     states += "Default";
Index: kdeui/util/knotificationmanager.cpp
===================================================================
--- kdeui/util/knotificationmanager.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/util/knotificationmanager.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -134,8 +134,8 @@
 
     QList<QVariant>  args;
     args << n->eventId() << (appname.isEmpty() ? KGlobal::mainComponent().componentName() : appname);
-    args.append( contextList); // not the operator<< or it will concatenate the two list.
-    args << n->text() <<  pixmapData << actions << qlonglong(winId) ;
+    args.append(QVariant(contextList)); 
+    args << n->text() <<  pixmapData << QVariant(actions) << qlonglong(winId) ;
     return d->knotify->callWithCallback( "event", args, n, SLOT(slotReceivedId(int)), SLOT(slotReceivedIdError(QDBusError)));
 }
 
Index: kdeui/util/ksystemtrayicon.cpp
===================================================================
--- kdeui/util/ksystemtrayicon.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdeui/util/ksystemtrayicon.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -64,17 +64,18 @@
         window = parent;
         movie = 0;
 #ifdef Q_WS_WIN
-        // FIXME the below makes korgac ( the reminder daemon in kdepim) crash
-        // on startup
-        window->installEventFilter( this );
+        if ( window ) {
+            window->installEventFilter( this );
+        }
 #endif
     }
 
     ~KSystemTrayIconPrivate()
     {
 #ifdef Q_WS_WIN
-     // FIXME makes korgac crash, see above
-     //   window->removeEventFilter( this );
+        if ( window ) {
+            window->removeEventFilter( this );
+        }
 #endif
         delete actionCollection;
         delete menu;
Index: security/crypto/crypto.desktop
===================================================================
--- security/crypto/crypto.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ security/crypto/crypto.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -28,6 +28,7 @@
 Name[gu]=ક્રાય્પ્ટો
 Name[he]=הצפנה
 Name[hi]=क्रिप्टो
+Name[hne]=क्रिप्टो
 Name[hu]=Titkosítás
 Name[is]=Dulkóðun
 Name[it]=Crittografia
@@ -93,6 +94,7 @@
 Comment[gu]=SSL રુપરેખાંકન, પ્રમાણપત્ર સંચાલન અને અન્ય ક્રાય્પ્ટોગ્રાફી ગોઠવણીઓ કરો
 Comment[he]=שינוי הגדרות SSL, ניהול תעודות והגדרות הצפנה אחרות
 Comment[hi]=एसएसएल कॉन्फ़िगर, प्रमाणपत्र प्रबंधन, तथा अन्य क्रिप्टोग्राफ़िक सेटिंग
+Comment[hne]=एसएसएल कान्फिगर, प्रमानपत्र प्रबंधन, अउ दुसरा क्रिप्टोग्राफी सेटिंग
 Comment[hsb]=Konfigurowanje SSL, zastaranje certifikatow a druhe kryptografiske nastajenja
 Comment[hu]=SSL-beállítások, tanúsítványkezelés és további titkosítási lehetőségek
 Comment[is]=Stilla SSL, stýra skírteinum, og aðrar dulkóðunarstillingar
Index: security/kcert/kcertpart.desktop
===================================================================
--- security/kcert/kcertpart.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ security/kcert/kcertpart.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,7 @@
 Comment[gu]=જડિત ખાનગી પ્રમાણપત્ર વ્યવસ્થાપક
 Comment[he]=מנהל תעודות אישי הניתן לשיבוץ
 Comment[hi]=अंतर्निर्मित व्यक्तिगत प्रमाणपत्र प्रबंधक
+Comment[hne]=भीतर मं बने निजी प्रमानपत्र प्रबंधक
 Comment[hr]=Ugradivi upravitelj osobnim potvrdama
 Comment[hsb]=Integrujomny Personal Certificate Manager
 Comment[hu]=Beágyazható személyes tanúsítványkezelő
@@ -90,6 +91,7 @@
 Name[cy]=KRhanTyst
 Name[eo]=Atestilo-parto
 Name[hi]=के-सर्ट-पार्ट
+Name[hne]=के-सर्ट-पार्ट
 Name[kn]=ಕೆಸರ್ಟ್ ಪಾರ್ಟ್
 Name[mai]=के-सर्ट-पार्ट
 Name[ml]=കെസെര്‍ട്ട്പാര്‍ട്ട്
Index: dnssd/remoteservice.h
===================================================================
--- dnssd/remoteservice.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ dnssd/remoteservice.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -89,7 +89,7 @@
 	void resolveAsync();
 
 	/**
-	 * Resolves the host name and port of service asynchronously
+	 * Resolves the host name and port of service synchronously
 	 *
 	 * The host name is not resolved into an IP address - use KResolver
 	 * for that.
Index: kutils/kpluginselector.cpp
===================================================================
--- kutils/kpluginselector.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kutils/kpluginselector.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -283,6 +283,7 @@
 
 KPluginSelector::~KPluginSelector()
 {
+    delete d->listView; // depends on some other things in d, make sure this dies first.
     delete d;
 }
 
@@ -303,10 +304,10 @@
     if (!config)
         config = KSharedConfig::openConfig(componentName);
 
-    KConfigGroup *cfgGroup = new KConfigGroup(config, "KParts Plugins");
-    kDebug( 702 ) << "cfgGroup = " << cfgGroup;
+    KConfigGroup cfgGroup(config, "KParts Plugins");
+    kDebug( 702 ) << "cfgGroup = " << &cfgGroup;
 
-    d->pluginModel->addPlugins(pluginInfoList, categoryName, categoryKey, *cfgGroup);
+    d->pluginModel->addPlugins(pluginInfoList, categoryName, categoryKey, cfgGroup);
 }
 
 void KPluginSelector::addPlugins(const KComponentData &instance,
@@ -326,10 +327,10 @@
     if (pluginInfoList.isEmpty())
         return;
 
-    KConfigGroup *cfgGroup = new KConfigGroup(config ? config : KGlobal::config(), "Plugins");
-    kDebug( 702 ) << "cfgGroup = " << cfgGroup;
+    KConfigGroup cfgGroup(config ? config : KGlobal::config(), "Plugins");
+    kDebug( 702 ) << "cfgGroup = " << &cfgGroup;
 
-    d->pluginModel->addPlugins(pluginInfoList, categoryName, categoryKey, *cfgGroup, pluginLoadMethod, true /* manually added */);
+    d->pluginModel->addPlugins(pluginInfoList, categoryName, categoryKey, cfgGroup, pluginLoadMethod, true /* manually added */);
 }
 
 void KPluginSelector::load()
Index: kutils/kemoticons/providers/adium/emoticonstheme_adium.desktop
===================================================================
--- kutils/kemoticons/providers/adium/emoticonstheme_adium.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kutils/kemoticons/providers/adium/emoticonstheme_adium.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -22,6 +22,7 @@
 Name[ga]=Téama Straoiseoga Adium
 Name[gl]=Tema de emotícones Adium
 Name[gu]=એડિયમ ઇમોકેશન થીમ
+Name[hne]=एडियम चेहराचिनहा थीम
 Name[hu]=Adium emotikon-téma
 Name[is]=Adium broskallaþema
 Name[it]=Tema faccine Adium
@@ -47,6 +48,7 @@
 Name[pt_BR]=Tema emoticons Adium
 Name[ro]=Tematică de emoticoni Adium
 Name[ru]=Набор смайликов Adium
+Name[se]=Adium mojánfáddá
 Name[sk]=Adium téma emotikonov
 Name[sr]=Адијумова тема емотикона
 Name[sr@latin]=Adiumova tema emotikona
@@ -81,6 +83,7 @@
 Comment[ga]=Leabharlann le húsáid téama straoiseog Adium
 Comment[gl]=Unha biblioteca para empregar o tema de emotícones Adium
 Comment[gu]=એડિયમ ઇમોકેશન થીમ ઉપયોગ કરવા માટેની લાઇબ્રેરી
+Comment[hne]=एडियम चेहराचिनहा थीम उपयोग करे बर लाइब्रेरी
 Comment[hsb]=Biblioteka za Adium emoticons theme
 Comment[hu]=Programkönyvtár az Adium emotikon-témához
 Comment[is]=Forritlingasafn til notkunar með Adium broskallaþema
@@ -107,6 +110,7 @@
 Comment[pt_BR]=Biblioteca para utilização do tema emoticons Adium
 Comment[ro]=Bibliotecă de utilizat tematica de emoticoni Adium
 Comment[ru]=Библиотека набора смайликов Adium
+Comment[se]=Bibliotehka mii dulko Adium mojánfáttáid
 Comment[sk]=Knižnica na použitie Adium témy emotikonov
 Comment[sr]=Библиотека за Адијумову тему емотикона
 Comment[sr@latin]=Biblioteka za Adiumovu temu emotikona
Index: kutils/kemoticons/providers/kde/emoticonstheme_kde.desktop
===================================================================
--- kutils/kemoticons/providers/kde/emoticonstheme_kde.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kutils/kemoticons/providers/kde/emoticonstheme_kde.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -22,6 +22,7 @@
 Name[ga]=Téama Straoiseoga KDE
 Name[gl]=Tema de emotícones de KDE
 Name[gu]=KDE ઇમોકેશન થીમ
+Name[hne]=केडीई चेहराचिनहा थीम
 Name[hu]=KDE emotikon-téma
 Name[is]=KDE broskallaþema
 Name[it]=Tema faccine di Kde
@@ -47,6 +48,7 @@
 Name[pt_BR]=Tema emoticons Adium
 Name[ro]=Tematică de emoticoni KDE
 Name[ru]=Набор смайликов KDE
+Name[se]=KDE mojánfáddá
 Name[sk]=Kde téma emotikonov
 Name[sr]=КДЕ‑ова тема емотикона
 Name[sr@latin]=KDE‑ova tema emotikona
@@ -81,6 +83,7 @@
 Comment[ga]=Leabharlann le húsáid téama straoiseog KDE
 Comment[gl]=Unha biblioteca para empregar temas de emotícones de KDE
 Comment[gu]=KDE ઇમોકેશન થીમ ઉપયોગ કરવા માટેની લાઇબ્રેરી
+Comment[hne]=केडीई चेहराचिनहा थीम ल उपयोग करे बर लाइब्रेरी
 Comment[hsb]=Biblioteka za KDE emoticons theme
 Comment[hu]=Programkönyvtár a KDE emotikon-témához
 Comment[is]=Forritlingasafn til notkunar með KDE broskallaþema
@@ -107,6 +110,7 @@
 Comment[pt_BR]=Biblioteca para utilização do tema emoticons Adium
 Comment[ro]=Bibliotecă de utilizat tematica de emoticoni KDE
 Comment[ru]=Библиотека набора смайликов KDE
+Comment[se]=Bibliotehka mii dulko KDE mojánfáttáid
 Comment[sk]=Knižnica na použitie KDE témy emotikonov
 Comment[sr]=Библиотека за КДЕ‑ову тему емотикона
 Comment[sr@latin]=Biblioteka za KDE‑ovu temu emotikona
Index: kutils/kemoticons/providers/xmpp/emoticonstheme_xmpp.desktop
===================================================================
--- kutils/kemoticons/providers/xmpp/emoticonstheme_xmpp.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kutils/kemoticons/providers/xmpp/emoticonstheme_xmpp.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -22,6 +22,7 @@
 Name[ga]=Téama Straoiseoga XMPP
 Name[gl]=Tema de emotícones de XMPP
 Name[gu]=XMPP ઇમોકેશન થીમ
+Name[hne]=एक्सएमपीपी चेहराचिनहा थीम
 Name[hu]=XMPP emotikon-téma
 Name[is]=XMPP broskallaþema
 Name[it]=Tema faccine XMPP
@@ -46,6 +47,7 @@
 Name[pt_BR]=Tema emoticons XMPP
 Name[ro]=Tematică de emoticoni XMPP
 Name[ru]=Набор смайликов XMPP
+Name[se]=XMPP mojánfáddá
 Name[sk]=XMPP téma emotikonov
 Name[sr]=ИксМПП тема емотикона
 Name[sr@latin]=XMPP tema emotikona
@@ -80,6 +82,7 @@
 Comment[ga]=Leabharlann le húsáid téama straoiseog XMPP
 Comment[gl]=Unha biblioteca para empregar temas de emotícones de XMPP
 Comment[gu]=XMPP ઇમોકેશન થીમ ઉપયોગ કરવા માટેની લાઇબ્રેરી
+Comment[hne]=एक्सएमपीपी चेहराचिनहा थीम ल उपयोग करे बर लाइब्रेरी
 Comment[hsb]=Biblioteka za XMPP emoticons theme
 Comment[hu]=Programkönyvtár az XMPP emotikon-témához
 Comment[is]=Forritlingasafn til notkunar með XMPP broskallaþema
@@ -106,6 +109,7 @@
 Comment[pt_BR]=Biblioteca para utilização do tema emoticons XMPP
 Comment[ro]=Bibliotecă de utilizat tematica de emoticoni XMPP
 Comment[ru]=Библиотека набора смайликов XMPP
+Comment[se]=Bibliotehka mii dulko XMPP mojánfáttáid
 Comment[sk]=Knižnica na použitie XMPP témy emotikonov
 Comment[sr]=Библиотека за ИксМПП тему емотикона
 Comment[sr@latin]=Biblioteka za XMPP temu emotikona
Index: kutils/kemoticons/providers/pidgin/emoticonstheme_pidgin.desktop
===================================================================
--- kutils/kemoticons/providers/pidgin/emoticonstheme_pidgin.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kutils/kemoticons/providers/pidgin/emoticonstheme_pidgin.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -22,6 +22,7 @@
 Name[ga]=Téama Straoiseoga Pidgin
 Name[gl]=Tema de emotícones de Pidgin
 Name[gu]=પીડગીન ઇમોકેશન થીમ ઉપયોગ કરવા માટેની લાઇબ્રેરી
+Name[hne]=पिडगिन चेहराचिनहा थीम
 Name[hu]=Pidgin emotikon-téma
 Name[is]=Pidgin broskallaþema
 Name[it]=Tema faccine Pidgin
@@ -47,6 +48,7 @@
 Name[pt_BR]=Tema emoticons do Pidgin
 Name[ro]=Tematică de emoticoni Pidgin
 Name[ru]=Набор смайликов Pidgin
+Name[se]=Piding mojánfáddá
 Name[sk]=Pidgin téma emotikonov
 Name[sr]=Пиџинова тема емотикона
 Name[sr@latin]=Pidginova tema emotikona
@@ -81,6 +83,7 @@
 Comment[ga]=Leabharlann le húsáid téama straoiseog Pidgin
 Comment[gl]=Unha biblioteca para empregar temas de emotícones de Pidgin
 Comment[gu]=પીડગીન ઇમોકેશન થીમ ઉપયોગ કરવા માટેની લાઇબ્રેરી
+Comment[hne]=पिडगिन चेहराचिनहा थीम ल उपयोग करे बर लाइब्रेरी
 Comment[hsb]=Biblioteka za Pidgin emoticons theme
 Comment[hu]=Programkönyvtár a Pidgin emotikon-témához
 Comment[is]=Forritlingasafn til notkunar með Pidgin broskallaþema
@@ -107,6 +110,7 @@
 Comment[pt_BR]=Biblioteca para utilização do tema emoticons do Pidgin
 Comment[ro]=Bibliotecă de utilizat tematica de emoticoni Pidgin
 Comment[ru]=Библиотека набора смайликов Pidgin
+Comment[se]=Bibliotehkta mii dulko Pidgin mojánfáttáid
 Comment[sk]=Knižnica na použitie Pidgin témy emotikonov
 Comment[sr]=Библиотека за Пиџинову тему емотикона
 Comment[sr@latin]=Biblioteka za Pidginovu temu emotikona
Index: kdecore/kernel/kglobal.cpp
===================================================================
--- kdecore/kernel/kglobal.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/kernel/kglobal.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -1,6 +1,7 @@
 /* This file is part of the KDE libraries
    Copyright (C) 1999 Sirtaj Singh Kanq <taj@kde.org>
    Copyright (C) 2007 Matthias Kretz <kretz@kde.org>
+   Copyright (C) 2009 Olivier Goffart <ogoffart@kde.org>
 
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
@@ -93,31 +94,44 @@
         KStringDict *stringDict;
         KLocale *locale;
         KCharsets *charsets;
+
+        /**
+         * This componenent may be used instead of the main component for application
+         * That doesn't have a main componennt such as pure Qt application.
+         */
+        static KComponentData initFakeComponent()
+        {
+            QString name = QCoreApplication::applicationName();
+            if(name.isEmpty())
+                name = qAppName();
+            if(name.isEmpty())
+                name = QString::fromLatin1("kde");
+            return KComponentData(name.toLatin1(), name.toLatin1(),
+                                  KComponentData::SkipMainComponentRegistration);
+        }
 };
 
 K_GLOBAL_STATIC(KGlobalPrivate, globalData)
+K_GLOBAL_STATIC_WITH_ARGS(KComponentData, fakeComponent, (KGlobalPrivate::initFakeComponent()))
 
 #define PRIVATE_DATA KGlobalPrivate *d = globalData
 
 KStandardDirs *KGlobal::dirs()
 {
     PRIVATE_DATA;
-    MYASSERT(d->mainComponent.isValid());
-    return d->mainComponent.dirs();
+    return d->mainComponent.isValid() ? d->mainComponent.dirs() : fakeComponent->dirs();
 }
 
 KSharedConfig::Ptr KGlobal::config()
 {
     PRIVATE_DATA;
-    MYASSERT(d->mainComponent.isValid());
-    return d->mainComponent.config();
+    return d->mainComponent.isValid() ? d->mainComponent.config() : fakeComponent->config();
 }
 
 const KComponentData &KGlobal::mainComponent()
 {
     PRIVATE_DATA;
-    MYASSERT(d->mainComponent.isValid());
-    return d->mainComponent;
+    return d->mainComponent.isValid() ? d->mainComponent : *fakeComponent;
 }
 
 bool KGlobal::hasMainComponent()
@@ -240,7 +254,7 @@
         return args->getOption("caption");
     } else {
         // We have some about data ?
-        if (d->mainComponent.aboutData()) {
+        if (d->mainComponent.isValid() && d->mainComponent.aboutData()) {
             return d->mainComponent.aboutData()->programName();
         } else {
             // Last resort : application name
Index: kdecore/sycoca/ksycocaentry_p.h
===================================================================
--- kdecore/sycoca/ksycocaentry_p.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/sycoca/ksycocaentry_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -23,7 +23,7 @@
 
 #define K_SYCOCATYPE( type, baseclass ) \
  virtual bool isType(KSycocaType t) const { if (t == type) return true; return baseclass::isType(t);} \
- virtual KSycocaType sycocaType() const { return type; } 
+ virtual KSycocaType sycocaType() const { return type; }
 
 
 class KSycocaEntryPrivate
@@ -68,6 +68,8 @@
 
     virtual QString name() const = 0;
 
+    virtual QString storageId() const { return name(); }
+
     int offset;
     bool deleted;
     QString path;
Index: kdecore/sycoca/ksycocaentry.cpp
===================================================================
--- kdecore/sycoca/ksycocaentry.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/sycoca/ksycocaentry.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -106,6 +106,12 @@
     return d->path;
 }
 
+QString KSycocaEntry::storageId() const
+{
+    Q_D(const KSycocaEntry);
+    return d->storageId();
+}
+
 bool KSycocaEntry::isDeleted() const
 {
     Q_D(const KSycocaEntry);
@@ -164,5 +170,3 @@
     Q_D(const KSycocaEntry);
     return d->property(name);
 }
-
-
Index: kdecore/sycoca/ksycocaentry.h
===================================================================
--- kdecore/sycoca/ksycocaentry.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/sycoca/ksycocaentry.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -86,6 +86,13 @@
    QString entryPath() const;
 
    /**
+    * @return the unique ID for this entry
+    * In practice, this is storageId() for KService and name() for everything else.
+    * \since 4.2.1
+    */
+   QString storageId() const;
+
+    /**
     * @return true if valid
     */
    bool isValid() const;
@@ -117,7 +124,7 @@
     */
    void setDeleted( bool deleted );
 
-   
+
    /*
     * @returns true, if this is a separator
     */
Index: kdecore/sycoca/ksycocafactory.cpp
===================================================================
--- kdecore/sycoca/ksycocafactory.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/sycoca/ksycocafactory.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -150,12 +150,8 @@
 
     if (!d->m_sycocaDict) return; // Error!
 
-    // Note that we use a QMultiHash since there can be several entries
-    // with the same name (e.g. kfmclient.desktop and konqbrowser.desktop both
-    // have Name=Konqueror).
-
-    const QString name = newEntry->name();
-    m_entryDict->insertMulti( name, newEntry );
+    const QString name = newEntry->storageId();
+    m_entryDict->insert( name, newEntry );
     d->m_sycocaDict->add( name, newEntry );
 }
 
Index: kdecore/sycoca/kprotocolinfo.cpp
===================================================================
--- kdecore/sycoca/kprotocolinfo.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/sycoca/kprotocolinfo.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -66,7 +66,7 @@
   m_defaultMimetype = config.readEntry( "defaultMimetype" );
   m_determineMimetypeFromExtension = config.readEntry( "determineMimetypeFromExtension", true );
   d->archiveMimetype = config.readEntry("archiveMimetype", QStringList());
-  m_icon = config.readEntry( "Icon", "unknown" );
+  m_icon = config.readEntry( "Icon" );
   m_config = config.readEntry( "config", m_name );
   m_maxSlaves = config.readEntry( "maxInstances", 1);
 
@@ -258,7 +258,7 @@
   // We call the findProtocol directly (not via KProtocolManager) to bypass any proxy settings.
   KProtocolInfo::Ptr prot = KProtocolInfoFactory::self()->findProtocol(_protocol);
   if ( !prot )
-    return QLatin1String("unknown");
+    return QString();
 
   return prot->m_icon;
 }
Index: kdecore/sycoca/ksycoca.cpp
===================================================================
--- kdecore/sycoca/ksycoca.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/sycoca/ksycoca.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -43,7 +43,7 @@
  * If the existing file is outdated, it will not get read
  * but instead we'll ask kded to regenerate a new one...
  */
-#define KSYCOCA_VERSION 130
+#define KSYCOCA_VERSION 131
 
 /**
  * Sycoca file name, used internally (by kbuildsycoca)
Index: kdecore/sycoca/kprotocolinfo.h
===================================================================
--- kdecore/sycoca/kprotocolinfo.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/sycoca/kprotocolinfo.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -187,7 +187,7 @@
    * This corresponds to the "Icon=" field in the protocol description file.
    *
    * @param protocol the protocol to check
-   * @return the icon of the protocol, or null if unknown
+   * @return the icon of the protocol, or an empty string if unknown
    */
   static QString icon( const QString& protocol );
 
@@ -200,7 +200,7 @@
    * The default is the protocol name, see name()
    *
    * @param protocol the protocol to check
-   * @return the config file, or null if unknown
+   * @return the config file, or an empty string if unknown
    */
   static QString config( const QString& protocol );
 
@@ -237,7 +237,7 @@
    * This corresponds to the "X-DocPath=" or "DocPath=" field in the protocol description file.
    *
    * @param protocol the protocol to check
-   * @return the docpath of the protocol, or null if unknown
+   * @return the docpath of the protocol, or an empty string if unknown
    */
   static QString docPath( const QString& protocol );
 
@@ -254,7 +254,7 @@
    * the protocols themselves.
    *
    * @param protocol the protocol to check
-   * @return the class of the protocol, or null if unknown
+   * @return the class of the protocol, or an empty string if unknown
    */
   static QString protocolClass( const QString& protocol );
 
Index: kdecore/services/kservice_p.h
===================================================================
--- kdecore/services/kservice_p.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/services/kservice_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -51,6 +51,13 @@
         return m_strName;
     }
 
+    virtual QString storageId() const
+    {
+        if (!menuId.isEmpty())
+            return menuId;
+        return path;
+    }
+
     virtual bool isValid() const
     {
         return m_bValid;
Index: kdecore/services/kplugininfo.desktop
===================================================================
--- kdecore/services/kplugininfo.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/services/kplugininfo.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -31,6 +31,7 @@
 Name[gu]=KDE પ્લગઈન જાણકારી
 Name[he]=מידע על תוסף של KDE
 Name[hi]=केडीई प्लगइन जानकारी
+Name[hne]=केडीई प्लगइन जानकारी
 Name[hr]=Podaci o KDE dodatku
 Name[hsb]=KDE Informacija wo zašćěpkach
 Name[hu]=A KDE bővítőmodulok áttekintése
Index: kdecore/services/kservice.cpp
===================================================================
--- kdecore/services/kservice.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/services/kservice.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -704,7 +704,7 @@
             return QString();
         }
     }
-    
+
     return it->toString();
 }
 
@@ -736,9 +736,7 @@
 QString KService::storageId() const
 {
     Q_D(const KService);
-    if (!d->menuId.isEmpty())
-        return d->menuId;
-    return entryPath();
+    return d->storageId();
 }
 
 QString KService::locateLocal() const
Index: kdecore/services/kservicegroup.cpp
===================================================================
--- kdecore/services/kservicegroup.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/services/kservicegroup.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -1,4 +1,3 @@
-// -*- c-basic-offset: 3 -*-
 /*  This file is part of the KDE libraries
  *  Copyright (C) 2000 Waldo Bastian <bastian@kde.org>
  *
@@ -411,25 +410,28 @@
         else
           name = p->name() + ' ' + static_cast<KService *>(p.data())->genericName();
 
+        const QByteArray nameStr = name.toLocal8Bit();
+
         QByteArray key;
         // strxfrm() crashes on Solaris
 #ifndef USE_SOLARIS
         // maybe it'd be better to use wcsxfrm() where available
         key.resize( name.length() * 4 + 1 );
-        size_t ln = strxfrm( key.data(), name.toLocal8Bit().data(), key.size());
+        size_t ln = strxfrm(key.data(), nameStr.constData(), key.size());
         if( ln != size_t( -1 ))
         {
+            key.resize(ln);
             if( (int)ln >= key.size())
             { // didn't fit?
-                key.resize( ln + 1 );
-                if( strxfrm( key.data(), name.toLocal8Bit().data(), key.size()) == size_t( -1 ))
-                    key = name.toLocal8Bit();
+                ln = strxfrm( key.data(), nameStr.constData(), key.size());
+                if( ln == size_t( -1 ))
+                    key = nameStr;
             }
         }
         else
 #endif
         {
-            key = name.toLocal8Bit();
+            key = nameStr;
         }
         list.insert(key,KServiceGroup::SPtr(p));
     }
Index: kdecore/kdebugrc
===================================================================
--- kdecore/kdebugrc	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/kdebugrc	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -72,10 +72,6 @@
 [1002]
 InfoOutput=4
 
-# KDesktop icons
-[1214]
-InfoOutput=4
-
 # KHotKeys
 [1217]
 InfoOutput=4
@@ -108,6 +104,10 @@
 [5901]
 InfoOutput=4
 
+# KDirWatch is quite verbose
+[7001]
+InfoOutput=4
+
 # kio_http_debug debug info off
 [7113]
 InfoOutput=4
Index: kdecore/localization/ktranscript.cpp
===================================================================
--- kdecore/localization/ktranscript.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/localization/ktranscript.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -711,7 +711,7 @@
 
 KJS_DEFINE_PROTOTYPE(ScriptfaceProto)
 KJS_IMPLEMENT_PROTOFUNC(ScriptfaceProtoFunc)
-KJS_IMPLEMENT_PROTOTYPE("Scriptface", ScriptfaceProto, ScriptfaceProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("Scriptface", ScriptfaceProto, ScriptfaceProtoFunc, ObjectPrototype)
 
 const ClassInfo Scriptface::info = {"Scriptface", 0, &ScriptfaceTable, 0};
 
Index: kdecore/localization/klocale.cpp
===================================================================
--- kdecore/localization/klocale.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/localization/klocale.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -1658,7 +1658,7 @@
     case 'b':
     case 'B':
 
-            error = true;
+      error = true;
       if (d->dateMonthNamePossessive) {
         j = 1;
         while (error && (j < 13)) {
@@ -1670,9 +1670,9 @@
           }
           int len = s.length();
           if (str.mid(strpos, len) == s) {
-            month = j;
-            strpos += len;
-                  error = false;
+              month = j;
+              strpos += len;
+              error = false;
           }
           j++;
         }
@@ -1687,9 +1687,9 @@
         }
         int len = s.length();
         if (str.mid(strpos, len) == s) {
-          month = j;
-          strpos += len;
-                error = false;
+            month = j;
+            strpos += len;
+            error = false;
         }
         j++;
       }
@@ -1714,6 +1714,8 @@
     case 'y':
       year = calendar()->yearStringToInteger(str.mid(strpos), iLength);
       strpos += iLength;
+      if (c == 'y' && year < 100)
+        year += 2000; // QDate assumes 19xx by default, but this isn't what users want...
 
       error = iLength <= 0;
       break;
Index: kdecore/localization/klocale.h
===================================================================
--- kdecore/localization/klocale.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/localization/klocale.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -430,9 +430,9 @@
 
   /**
    * Given a number of milliseconds, converts that to a pretty string containing
-   * the localized equivalent. 
+   * the localized equivalent.
    *
-   * e.g. given prettyFormatDuration(60001) returns "1 minute" 
+   * e.g. given prettyFormatDuration(60001) returns "1 minute"
    *      given prettyFormatDuration(62005) returns "1 minute and 2 seconds"
    *      given prettyFormatDuration(90060000) returns "1 day and 1 hour"
    *
@@ -784,12 +784,12 @@
    *
    * The format of the date is a string which contains variables that will
    * be replaced:
-   * @li %Y with the whole year (e.g. "1984" for "1984")
-   * @li %y with the lower 2 digits of the year (e.g. "84" for "1984")
+   * @li %Y with the whole year (e.g. "2004" for "2004")
+   * @li %y with the lower 2 digits of the year (e.g. "04" for "2004")
    * @li %n with the month (January="1", December="12")
    * @li %m with the month with two digits (January="01", December="12")
    * @li %e with the day of the month (e.g. "1" on the first of march)
-   * @li %d with the day of the month with two digits(e.g. "01" on the first of march)
+   * @li %d with the day of the month with two digits (e.g. "01" on the first of march)
    * @li %b with the short form of the month (e.g. "Jan" for January)
    * @li %B with the long form of the month (e.g. "January")
    * @li %a with the short form of the weekday (e.g. "Wed" for Wednesday)
@@ -1205,7 +1205,7 @@
    * @return @c true on success, @c false on failure
    */
   bool setCountry(const QString & country, KConfig *config);
- 
+
   /**
    * Changes the current language. The current language will be left
    * unchanged if failed. It will force a reload of the country specific
Index: kdecore/localization/kuitsemantics.cpp
===================================================================
--- kdecore/localization/kuitsemantics.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/localization/kuitsemantics.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -1287,18 +1287,20 @@
             }
         }
         else if (xml.isCharacters()) {
-            // Stream reader will automatically reslove entities, which is
-            // not desired in this case, as the final text may be rich.
-            // The text element will be broken at the resolved entity, so
-            // the first character may be one of those resolved.
-            // Convert it back into an entity.
+            // Stream reader will automatically resolve default XML entities,
+            // which is not desired in this case, as the final text may
+            // be rich. Convert them back into entities.
             QString text = xml.text().toString();
-            QString firstChar = text.left(1);
-            if (s->xmlEntitiesInverse.contains(firstChar)) {
-                QString entname = s->xmlEntitiesInverse[firstChar];
-                text = '&' + entname + ';' + text.mid(1);
+            QString ntext;
+            foreach (const QChar &c, text) {
+                if (s->xmlEntitiesInverse.contains(c)) {
+                    QString entname = s->xmlEntitiesInverse[c];
+                    ntext += '&' + entname + ';';
+                } else {
+                    ntext += c;
+                }
             }
-            openEls.top().formattedText += text;
+            openEls.top().formattedText += ntext;
         }
     }
 
Index: kdecore/localization/kcatalog.cpp
===================================================================
--- kdecore/localization/kcatalog.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/localization/kcatalog.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -37,6 +37,10 @@
 # endif
 #endif
 
+static char *langenv = 0;
+static const int langenvMaxlen = 42;
+// = "LANGUAGE=" + 32 chars for language code + terminating zero
+
 class KCatalogPrivate
 {
 public:
@@ -82,6 +86,15 @@
 
   // Invalidate current language, to trigger binding at next translate call.
   KCatalogPrivate::currentLanguage.clear();
+
+  if (!langenv) {
+    // Call putenv only here, to initialize LANGUAGE variable.
+    // Later only change langenv to what is currently needed.
+    langenv = new char[langenvMaxlen];
+    QByteArray lang = qgetenv("LANGUAGE");
+    snprintf(langenv, langenvMaxlen, "LANGUAGE=%s", lang.constData());
+    putenv(langenv);
+  }
 }
 
 KCatalog::KCatalog(const KCatalog & rhs)
@@ -136,7 +149,9 @@
   // Point Gettext to current language, recording system value for recovery.
   systemLanguage = qgetenv("LANGUAGE");
   if (systemLanguage != language) {
-    qputenv("LANGUAGE", language);
+    // putenv has been called in the constructor,
+    // it is enough to change the string set there.
+    snprintf(langenv, langenvMaxlen, "LANGUAGE=%s", language.constData());
   }
 
   // Rebind text domain if language actually changed from the last time,
@@ -160,7 +175,7 @@
 void KCatalogPrivate::resetSystemLanguage ()
 {
   if (language != systemLanguage) {
-    qputenv("LANGUAGE", systemLanguage);
+    snprintf(langenv, langenvMaxlen, "LANGUAGE=%s", systemLanguage.constData());
   }
 }
 
Index: kdecore/jobs/kjob.cpp
===================================================================
--- kdecore/jobs/kjob.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/jobs/kjob.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -192,7 +192,7 @@
              &loop, SLOT( quit() ) );
     start();
     if( !d->isFinished ) {
-        loop.exec();
+        loop.exec(QEventLoop::ExcludeUserInputEvents);
     }
 
     return ( d->error == NoError );
Index: kdecore/tests/kservicetest.cpp
===================================================================
--- kdecore/tests/kservicetest.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/tests/kservicetest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -29,6 +29,7 @@
 
 #include <kprotocolinfo.h>
 #include <kdebug.h>
+#include <kservicegroup.h>
 #include <kservicetypetrader.h>
 #include <kservicetype.h>
 #include <kservicetypeprofile.h>
@@ -390,3 +391,24 @@
     QCOMPARE(loadedService.exec(), service.exec());
     QCOMPARE(loadedService.actions().count(), 3);
 }
+
+void KServiceTest::testServiceGroups()
+{
+    KServiceGroup::Ptr root = KServiceGroup::root();
+    QVERIFY(root);
+    qDebug() << root->groupEntries().count();
+
+    KServiceGroup::Ptr group = root;
+    QVERIFY(group);
+    const KServiceGroup::List list = group->entries(true /* sorted */,
+                                                   true /* exclude no display entries */,
+                                                   false /* allow separators */,
+                                                   true /* sort by generic name */);
+
+    kDebug() << list.count();
+    Q_FOREACH(KServiceGroup::SPtr s, list) {
+        qDebug() << s->name() << s->entryPath();
+    }
+
+    // No unit test here yet, but at least this can be valgrinded for errors.
+}
Index: kdecore/tests/klocaletest.cpp
===================================================================
--- kdecore/tests/klocaletest.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/tests/klocaletest.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -35,7 +35,7 @@
 KLocaleTest::initTestCase()
 {
     KGlobal::setLocale(new KLocale(QString(), QLatin1String("en_US"), QLatin1String("C")));
-	KGlobal::locale()->setThousandsSeparator(QLatin1String(","));
+    KGlobal::locale()->setThousandsSeparator(QLatin1String(","));
 }
 
 void
@@ -161,7 +161,11 @@
 	locale.readDate(date.toString(full), KLocale::ShortFormat, &ok);
 	QVERIFY(!ok);
 
-	date = QDate::currentDate();
+        QString twoDigitYear("dd-MM-yy");
+        QCOMPARE(date.toString(twoDigitYear), QString("03-05-02"));
+        QCOMPARE(locale.readDate("03-05-02", "%d-%m-%y"), date);
+
+        date = QDate::currentDate();
 	QCOMPARE(locale.readDate(date.toString(small)), date);
 	QCOMPARE(locale.readDate(date.toString(full)), date);
 	locale.readDate(date.toString(small), KLocale::NormalFormat, &ok);
Index: kdecore/tests/kservicetest.h
===================================================================
--- kdecore/tests/kservicetest.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/tests/kservicetest.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -39,6 +39,7 @@
     void testDBUSStartupType();
     void testByStorageId();
     void testActionsAndDataStream();
+    void testServiceGroups();
 
 private:
     QString m_firstOffer;
Index: kdecore/config/kconfiggroup.h
===================================================================
--- kdecore/config/kconfiggroup.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/config/kconfiggroup.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -121,7 +121,11 @@
      */
     bool exists() const;
 
-    /// @reimp
+    /**
+     * @reimp
+     *
+     * Syncs the parent config.
+     */
     void sync();
 
     /// @reimp
@@ -654,6 +658,17 @@
 "The Qt MetaObject system does not seem to know about \"" ENUM \
 "\" please use Q_ENUMS or Q_FLAGS to register it."
 
+/**
+ * To add support for your own enums in KConfig, you can declare them with Q_ENUMS()
+ * in a QObject subclass (which will make moc generate the code to turn the
+ * enum into a string and vice-versa), and then (in the cpp code)
+ * use the macro
+ * <code>KCONFIGGROUP_DECLARE_ENUM_QOBJECT(MyClass, MyEnum)</code>
+ *
+ * After that, you can use readEntry(group, key, value) and writeEntry(group, key, value[, flags]).
+ * Note that those are global functions, NOT member functions of KConfigGroup.
+ *
+ */
 #define KCONFIGGROUP_DECLARE_ENUM_QOBJECT(Class, Enum)                     \
 inline Class::Enum readEntry(const KConfigGroup& group, const char* key, const Class::Enum& def) \
 {                                                                          \
@@ -673,6 +688,10 @@
 group.writeEntry(key, QByteArray(M_enum.valueToKey(value)), flags);              \
 }
 
+/**
+ * Similar to KCONFIGGROUP_DECLARE_ENUM_QOBJECT but for flags declared with Q_FLAGS()
+ * (where multiple values can be set at the same time)
+ */
 #define KCONFIGGROUP_DECLARE_FLAGS_QOBJECT(Class, Flags)                    \
 inline Class::Flags readEntry(const KConfigGroup& group, const char* key, const Class::Flags& def) \
 {                                                                           \
Index: kdecore/config/kconfigbackend.desktop
===================================================================
--- kdecore/config/kconfigbackend.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/config/kconfigbackend.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -24,6 +24,7 @@
 Comment[gl]=Infraestrutura de almacenaxe para KConfig
 Comment[gu]=KConfig માટે સંગ્રહ પાશ્ર્વભાગ
 Comment[he]=מנוע שמירה עבור KConfig
+Comment[hne]=के-कानफिग बर भंडार बैकएण्ड
 Comment[hsb]=składowanski backend za KConfig
 Comment[hu]=Tároló a KConfighoz
 Comment[is]=Geymslubakendi fyrir KConfig
@@ -50,6 +51,7 @@
 Comment[pt_BR]=Infraestrutura de armazenamento para o KConfig
 Comment[ro]=Suport de stocare pentru KConfig
 Comment[ru]=Модуль хранения параметров KConfig
+Comment[se]=KConfig vurkenduogáš
 Comment[sk]=Úložisko backendu KConfig
 Comment[sl]=Ozadje za shranjevanje v KConfigu
 Comment[sr]=Складишна позадина за К‑конфиг
Index: kdecore/all_languages.desktop
===================================================================
--- kdecore/all_languages.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/all_languages.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -17,6 +17,7 @@
 Name[gu]=અફર
 Name[he]=אפאר
 Name[hi]=अफ्र
+Name[hne]=अफ्र
 Name[hr]=Afarski
 Name[ja]=アファル語
 Name[kk]=Афарша
@@ -79,6 +80,7 @@
 Name[gu]=અબ્ખાઝીઅન
 Name[he]=אבחזית
 Name[hi]=अबकाजियन
+Name[hne]=अबकाजियन
 Name[hr]=Abhaški
 Name[hsb]=Abchazisce
 Name[hu]=Abház
@@ -151,6 +153,7 @@
 Name[gu]=અવેસ્ટાન
 Name[he]=אווסטית
 Name[hi]=अवेस्तन
+Name[hne]=अवेस्तन
 Name[hr]=Avestanski
 Name[hsb]=Awestisce
 Name[hu]=Avesztáni
@@ -216,6 +219,7 @@
 Name[gu]=આફ્રિકાન્સ
 Name[he]=אפריקנס
 Name[hi]=अफ्रीकी
+Name[hne]=अफ्रीकी
 Name[ja]=アフリカーンス語
 Name[kk]=Аафрикаанс
 Name[km]=អាហ្វ្រីកាអាន
@@ -285,6 +289,7 @@
 Name[gu]=અમ્હારિક
 Name[he]=אמהרית
 Name[hi]=अम्हारिक
+Name[hne]=अम्हारिक
 Name[hr]=Amarski
 Name[hsb]=Amharisce
 Name[hu]=Amhár
@@ -366,6 +371,7 @@
 Name[gu]=અરેબિક
 Name[he]=ערבית
 Name[hi]=अरबी
+Name[hne]=अरबी
 Name[hr]=Arapski
 Name[hsb]=Arabsce
 Name[hu]=Arab
@@ -445,6 +451,7 @@
 Name[gu]=આસામીઝ
 Name[he]=אסאמית
 Name[hi]=असमी
+Name[hne]=असमी
 Name[hr]=Asamski
 Name[hsb]=Asamezisce
 Name[hu]=Asszámi
@@ -510,6 +517,7 @@
 Name[gu]=અયમારા
 Name[he]=איימרה
 Name[hi]=अयमारा
+Name[hne]=अयमारा
 Name[hr]=Ajmarski
 Name[hu]=Ajmara
 Name[ja]=アイマラ語
@@ -575,6 +583,7 @@
 Name[gu]=અઝરબાયજાની
 Name[he]=אזרית
 Name[hi]=अजरबेजानी
+Name[hne]=अजरबेजानी
 Name[hr]=Azerbejdžanski
 Name[hsb]=Azerbajdźansce
 Name[hu]=Azerbajdzsán
@@ -653,6 +662,7 @@
 Name[gu]=બાસ્કિર
 Name[he]=בשקירית
 Name[hi]=बाशकिर
+Name[hne]=बासकिर
 Name[hr]=Baškirski
 Name[hsb]=Baškirsce
 Name[hu]=Baskír
@@ -727,6 +737,7 @@
 Name[gu]=બેલારશિયન
 Name[he]=בלרוסית
 Name[hi]=बेलारूसी
+Name[hne]=बेलारूसी
 Name[hr]=Bjeloruski
 Name[hsb]=Běłorusce
 Name[hu]=Belorusz
@@ -798,9 +809,11 @@
 Name[fi]=Valkovenäjä (Latin)
 Name[fr]=Biélorusse (Latin)
 Name[fy]=Wyt-Russysk (latynsk)
+Name[ga]=Bealarúisis (aibítir Laidineach)
 Name[gl]=Bielorruso (Latino)
 Name[gu]=બેલારશિયન (લેટિન)
 Name[he]=בלרוסית (לטינית)
+Name[hne]=बेलारूसी (लेटिन)
 Name[hsb]=Běłorusce (z łaćonskim pismom)
 Name[hu]=Belorusz (latin betűs)
 Name[is]=Hvít-Rússneska latnesk
@@ -825,6 +838,7 @@
 Name[pt_BR]=Bielorrusso (latino)
 Name[ro]=Bielorusă (latin)
 Name[ru]=Белорусский (латиница)
+Name[se]=Vilgesruoššagiella (Latiidna)
 Name[sk]=Bieloruský (Latinský)
 Name[sl]=Belorusko (latinica)
 Name[sr]=белоруски (латиница)
@@ -869,6 +883,7 @@
 Name[gu]=બલ્ગેરીયન
 Name[he]=בולגרית
 Name[hi]=बुल्गारियाई
+Name[hne]=बुल्गारियाई
 Name[hr]=Bugarski
 Name[hsb]=Bołharsce
 Name[hu]=Bolgár
@@ -938,6 +953,7 @@
 Name[gu]=બિહારી
 Name[he]=ביהרי
 Name[hi]=बिहारी
+Name[hne]=बिहारी
 Name[hr]=Biharski
 Name[hsb]=Biharisce
 Name[ja]=ビハール語
@@ -988,6 +1004,7 @@
 Name[gu]=બિસલામા
 Name[he]=ביסלמה
 Name[hi]=बिस्लामा
+Name[hne]=बिस्लामा
 Name[hr]=Bislamski
 Name[hsb]=Bislamisce
 Name[hu]=Biszlama
@@ -1047,6 +1064,7 @@
 Name[gu]=બંગાળી
 Name[he]=בנגלית
 Name[hi]=बंगाली
+Name[hne]=बंगाली
 Name[hr]=Bengalski
 Name[hsb]=Bengalsce
 Name[hu]=Bengáli
@@ -1116,6 +1134,7 @@
 Name[gu]=બંગાળી (ભારત)
 Name[he]=בנגלית (הודו)
 Name[hi]=बंगाली (भारत)
+Name[hne]=बंगाली (भारत)
 Name[hsb]=Bengalsce (Indiska)
 Name[hu]=Bengáli (India)
 Name[is]=Bengalst (Indland)
@@ -1185,6 +1204,7 @@
 Name[gu]=તિબેટીયન
 Name[he]=טיבטית
 Name[hi]=तिब्बती
+Name[hne]=तिब्बती
 Name[hr]=Tibetanski
 Name[hsb]=Tibetisce
 Name[hu]=Tibeti
@@ -1264,6 +1284,7 @@
 Name[gu]=બ્રેટોન
 Name[he]=ברטונית
 Name[hi]=ब्रेटन
+Name[hne]=ब्रेटन
 Name[hr]=Bretonski
 Name[hsb]=Bretonisce
 Name[is]=Bretánska
@@ -1344,6 +1365,7 @@
 Name[gu]=બોસ્નીયન
 Name[he]=בוסנית
 Name[hi]=बोस्नियाई
+Name[hne]=बोस्नियाई
 Name[hr]=Bošnjački
 Name[hsb]=Bosnisce
 Name[hu]=Bosnyák
@@ -1426,6 +1448,7 @@
 Name[gu]=કેટેલાન
 Name[he]=קטלונית
 Name[hi]=केटेलन
+Name[hne]=केटेलन
 Name[hr]=Katalonski
 Name[hsb]=Katalansce
 Name[hu]=Katalán
@@ -1502,6 +1525,7 @@
 Name[gu]=ચેચેન
 Name[he]=צ'צ'נית
 Name[hi]=चेचेन
+Name[hne]=चेचेन
 Name[hr]=Čečenski
 Name[hsb]=Čečenisce
 Name[hu]=Csecsen
@@ -1568,6 +1592,7 @@
 Name[gu]=ચામોરો
 Name[he]=צ'מורו
 Name[hi]=केमोरो
+Name[hne]=केमोरो
 Name[hr]=Čamorski
 Name[hsb]=Chamorrisce
 Name[is]=Chamorró
@@ -1633,6 +1658,7 @@
 Name[gu]=કોર્સિકન
 Name[he]=קורסיקנית
 Name[hi]=कॉर्सियन
+Name[hne]=कार्सियन
 Name[hr]=Korzikanski
 Name[hsb]=Korsisce
 Name[hu]=Korzikai
@@ -1707,6 +1733,7 @@
 Name[gl]=Tártaro da Crimea
 Name[gu]=ક્રિમીઅન તાતાર
 Name[hi]=क्रिमियन तातर
+Name[hne]=क्रिमियन तातर
 Name[hsb]=Krimtatarsce
 Name[hu]=Krími tatár
 Name[is]=Tataríska frá Krím
@@ -1733,6 +1760,7 @@
 Name[pt_BR]=Tártaros da Criméia
 Name[ro]=Tătară din Crimeea
 Name[ru]=Крымско-татарский
+Name[se]=Krimtataralašgiella
 Name[sk]=Krimeánsky tatársky
 Name[sl]=Krimsko tatarsko
 Name[sr]=кримски татарски
@@ -1776,6 +1804,7 @@
 Name[gu]=ચેક
 Name[he]=צ'כית
 Name[hi]=चेक
+Name[hne]=चेक
 Name[hr]=Češki
 Name[hsb]=Čěsce
 Name[hu]=Cseh
@@ -1852,6 +1881,7 @@
 Name[gu]=કોસુબિન
 Name[he]=קאשובית
 Name[hi]=काशुबियन
+Name[hne]=कासुबियन
 Name[hsb]=Kašubsce
 Name[hu]=Kasub
 Name[it]=Casciubico
@@ -1916,6 +1946,7 @@
 Name[gu]=ચર્ચ સાલ્વિક
 Name[he]=סלבית כנסייתית
 Name[hi]=चर्च स्लाविक
+Name[hne]=चर्च स्लाविक
 Name[hr]=Crkveni pravoslavni
 Name[hsb]=Cyrkwinosłowjansce
 Name[hu]=Szláv (egyházi)
@@ -1988,6 +2019,7 @@
 Name[gu]=ચુવાસ
 Name[he]=צ'ובשית
 Name[hi]=चाउवेश
+Name[hne]=चाउवेस
 Name[hr]=Čuvaški
 Name[hsb]=Čuwašisce
 Name[hu]=Csuvas
@@ -2065,6 +2097,7 @@
 Name[gu]=વેલ્સ
 Name[he]=וולשית
 Name[hi]=वेल्श
+Name[hne]=वेल्स
 Name[hr]=Velški
 Name[hsb]=Kymrisce
 Name[hu]=Velszi
@@ -2147,6 +2180,7 @@
 Name[gu]=ડેનિશ
 Name[he]=דנית
 Name[hi]=दानिश
+Name[hne]=दानिस
 Name[hr]=Danski
 Name[hsb]=Dansce
 Name[hu]=Dán
@@ -2229,6 +2263,7 @@
 Name[gu]=જર્મન
 Name[he]=גרמנית
 Name[hi]=जर्मन
+Name[hne]=जर्मन
 Name[hr]=Njemački
 Name[hsb]=Němsce
 Name[hu]=Német
@@ -2302,9 +2337,11 @@
 Name[fi]=Alasorbi
 Name[fr]=Bas-Sorabe
 Name[fy]=Leech Sorbysk
+Name[ga]=Sorbais Íochtarach
 Name[gl]=Baixo sórabo
 Name[gu]=લોઅર સોર્બિયન
 Name[he]=סורבית תחתית
+Name[hne]=लोअर सार्बियाई
 Name[hu]=Alsó szorb
 Name[is]=Lág-sorbian
 Name[it]=Basso sorabo
@@ -2326,6 +2363,7 @@
 Name[pt_BR]=Baixo Sorábio
 Name[ro]=Sîrbă de Jos
 Name[ru]=Нижнелужицкий
+Name[se]=Vuolle Sorbiagiella
 Name[sk]=Lužickosrbský
 Name[sl]=Zgornjesorbijsko
 Name[sr]=доњолужичкосрпски
@@ -2354,6 +2392,7 @@
 Name[gu]=ઝોન્ખા
 Name[he]=ג'ונקה
 Name[hi]=झोंखा
+Name[hne]=झोंखा
 Name[hsb]=Dzongkhisce
 Name[ja]=ゾンカ語
 Name[kk]=(Дзонгха) Бутанша
@@ -2417,6 +2456,7 @@
 Name[gu]=ગ્રીક
 Name[he]=יוונית
 Name[hi]=यूनानी
+Name[hne]=यूनानी
 Name[hr]=Grčki
 Name[hsb]=Grjeksce
 Name[hu]=Görög
@@ -2501,6 +2541,7 @@
 Name[gu]=અંગ્રેજી
 Name[he]=אנגלית
 Name[hi]=अंग्रेज़ी
+Name[hne]=अंगरेजी
 Name[hr]=Engleski
 Name[hsb]=Jendźelsce
 Name[hu]=Angol
@@ -2586,6 +2627,7 @@
 Name[gu]=બ્રિટિશ અંગ્રેજી
 Name[he]=אנגלית בריטית
 Name[hi]=ब्रितानी अंग्रेज़ी
+Name[hne]=ब्रितानी अंगरेजी
 Name[hr]=Britanski Engleski
 Name[hsb]=Jendźelsce (WB)
 Name[hu]=Angol (brit)
@@ -2668,6 +2710,7 @@
 Name[gu]=અમેરિકન અંગ્રેજી
 Name[he]=אנגלית ארה"ב
 Name[hi]=अमरीकी अंग्रेज़ी
+Name[hne]=अमरीकी अंगरेजी
 Name[hr]=Američki Engleski
 Name[hsb]=Jendźelsce (USA)
 Name[hu]=Angol (amerikai)
@@ -2736,6 +2779,7 @@
 Name[gu]=એસ્પ્રાન્ટો
 Name[he]=אספרנטו
 Name[hi]=एस्परेन्तो
+Name[hne]=एस्परेन्तो
 Name[hsb]=Esperantisce
 Name[hu]=Eszperantó
 Name[hy]=Էսպերանտո
@@ -2797,6 +2841,7 @@
 Name[gu]=સ્પેનીશ
 Name[he]=ספרדית
 Name[hi]=स्पेनी
+Name[hne]=स्पेनी
 Name[hr]=Španjolski
 Name[hsb]=Španisce
 Name[hu]=Spanyol
@@ -2882,6 +2927,7 @@
 Name[gu]=ઇસ્ટોનિઅન
 Name[he]=אסטונית
 Name[hi]=एस्तोनियाई
+Name[hne]=एस्तोनियाई
 Name[hr]=Estonski
 Name[hsb]=Estnisce
 Name[hu]=Észt
@@ -2963,6 +3009,7 @@
 Name[gu]=બાસ્ક
 Name[he]=בסקית
 Name[hi]=बास्क
+Name[hne]=बास्क
 Name[hr]=Baskijski
 Name[hsb]=Baskisce
 Name[hu]=Baszk
@@ -3045,6 +3092,7 @@
 Name[gu]=ફારસી (પર્શીયન)
 Name[he]=פרסית
 Name[hi]=फारसी (पर्सियाई)
+Name[hne]=फारसी (पर्सियाई)
 Name[hr]=Farsi (Perzijski)
 Name[hsb]=Farsisce (Persisce)
 Name[hu]=Fárszi (perzsa)
@@ -3127,6 +3175,7 @@
 Name[gu]=ફિનિશ
 Name[he]=פינית
 Name[hi]=फिनिश
+Name[hne]=फिनिस
 Name[hr]=Finski
 Name[hsb]=Finsce
 Name[hu]=Finn
@@ -3208,6 +3257,7 @@
 Name[gu]=ફિજીઅન
 Name[he]=פיגי'ת
 Name[hi]=फिज़ी
+Name[hne]=फिजी
 Name[hr]=Fidžijski
 Name[hsb]=Fidźisce
 Name[hu]=Fidzsi
@@ -3285,6 +3335,7 @@
 Name[gu]=ફોરોસી
 Name[he]=פארואית
 Name[hi]=फारसी
+Name[hne]=फारसी
 Name[hr]=Farski
 Name[hsb]=Ferejsce
 Name[hu]=Faröei
@@ -3363,6 +3414,7 @@
 Name[gu]=ફ્રેંચ
 Name[he]=צרפתית
 Name[hi]=फ्रांसीसी
+Name[hne]=फ्रांसीसी
 Name[hr]=Francuski
 Name[hsb]=Francosce
 Name[hu]=Francia
@@ -3446,6 +3498,7 @@
 Name[gu]=ફ્રિસિયન
 Name[he]=פריזית
 Name[hi]=फ्रिसियन
+Name[hne]=फ्रिसियन
 Name[hr]=Frizijski
 Name[hsb]=Frizisce
 Name[hu]=Fríz
@@ -3525,6 +3578,7 @@
 Name[gu]=આઈરીશ ગેલિક
 Name[he]=גאלית אירית
 Name[hi]=आइरिश गैलिक
+Name[hne]=आइरिस गैलिक
 Name[hr]=Irski Galski
 Name[hsb]=Gaelisce (Irska)
 Name[hu]=Gall (ír)
@@ -3598,6 +3652,7 @@
 Name[gu]=ગેલિક
 Name[he]=גאלית
 Name[hi]=गैलिक
+Name[hne]=गैलिक
 Name[hr]=Galski
 Name[hsb]=Gaelisce
 Name[hu]=Gall
@@ -3676,6 +3731,7 @@
 Name[gu]=ગેલિસીયન
 Name[he]=גליסית
 Name[hi]=गैलिसियाई
+Name[hne]=गैलिसियाई
 Name[hr]=Galicijski
 Name[hsb]=Galicisce
 Name[hu]=Galíciai
@@ -3746,6 +3802,7 @@
 Name[gu]=ગુઆરાની
 Name[he]=גוארני
 Name[hi]=गौरानी
+Name[hne]=गौरानी
 Name[hr]=Gvaranski
 Name[it]=Guaraní
 Name[ja]=グァラニ語
@@ -3801,6 +3858,7 @@
 Name[gu]=ગુજરાતી 
 Name[he]=גוג'ראטית
 Name[hi]=गुजराती
+Name[hne]=गुजराती
 Name[hr]=Gudžaratski
 Name[hu]=Gudzsarati
 Name[ja]=グジャラート語
@@ -3857,6 +3915,7 @@
 Name[gu]=માન્ક્ષ
 Name[he]=מאנית
 Name[hi]=मांक्स
+Name[hne]=मांक्स
 Name[hsb]=Manxowsce
 Name[it]=Mannese
 Name[ja]=マン島語
@@ -3910,6 +3969,7 @@
 Name[gu]=હુસા
 Name[he]=האוסה
 Name[hi]=हौसा
+Name[hne]=हौसा
 Name[hsb]=Hausasce
 Name[ja]=ハウサ語
 Name[kk]=Хауса
@@ -3977,9 +4037,10 @@
 Name[gu]=હિબ્રુ
 Name[he]=עברית
 Name[hi]=हिब्रू
+Name[hne]=हिब्रू
 Name[hr]=Hebrejski
 Name[hsb]=Hebrejsce
-Name[hu]=héber
+Name[hu]=Héber
 Name[is]=Hebreska
 Name[it]=Ebraico
 Name[ja]=ヘブライ語
@@ -4047,6 +4108,7 @@
 Name[gu]=હિન્દી
 Name[he]=הינדית
 Name[hi]=हिन्दी
+Name[hne]=हिन्दी
 Name[hr]=Hinduski
 Name[hsb]=Hindisce
 Name[hy]=Հինդի
@@ -4086,6 +4148,12 @@
 Name[zh_CN]=印度语
 Name[zh_HK]=北印度語
 Name[zh_TW]=北印度語
+[hne]
+Name=Chhattisgarhi
+Name[ca]=Chattisgarbi
+Name[es]=Chhattisgarhí
+Name[hu]=Cshattíszgarhi
+Name[uk]=Чхатісгархі
 [ho]
 Name=Hiri Motu
 Name[ar]=هيري موتو
@@ -4102,6 +4170,7 @@
 Name[gu]=હીરી મોટુ
 Name[he]=הירי מוטו
 Name[hi]=हिरी मोतू
+Name[hne]=हिरी मोतू
 Name[hsb]=Hiri Motusce
 Name[hu]=Hiri motu
 Name[it]=Hiri motu
@@ -4171,6 +4240,7 @@
 Name[gu]=ક્રોએશિયન
 Name[he]=קרואטית
 Name[hi]=क्रोएशियाई
+Name[hne]=क्रोएसियाई
 Name[hr]=Hrvatski
 Name[hsb]=Chorwatsce
 Name[hu]=Horvát
@@ -4253,6 +4323,7 @@
 Name[gu]=અપર સોર્બિયન
 Name[he]=סורבית עילית
 Name[hi]=ऊपरी सॉर्बियाई
+Name[hne]=ऊपरी सार्बियाई
 Name[hr]=Gornjosrpski
 Name[hsb]=Hornjoserbsce
 Name[hu]=Felső szorb
@@ -4331,6 +4402,7 @@
 Name[gu]=હંગેરિયન
 Name[he]=הונגרית
 Name[hi]=हंगेरियाई
+Name[hne]=हंगेरियाई
 Name[hr]=Mađarski
 Name[hsb]=Madźarsce
 Name[hu]=Magyar
@@ -4414,6 +4486,7 @@
 Name[gu]=અર્મેનિયન
 Name[he]=ארמנית
 Name[hi]=आर्मेनियाई
+Name[hne]=आर्मेनियाई
 Name[hr]=Armenski
 Name[hsb]=Armensce
 Name[hu]=Örmény
@@ -4481,6 +4554,7 @@
 Name[gu]=હિરેરો
 Name[he]=הררו
 Name[hi]=हेरेरो
+Name[hne]=हेरेरो
 Name[hsb]=Hererosce
 Name[hu]=Hereró
 Name[ja]=ヘレロ語
@@ -4530,6 +4604,7 @@
 Name[gu]=ઈન્ટરલીગુઆ
 Name[he]=אינטרלינגואָה
 Name[hi]=अंतरभाषी
+Name[hne]=इंटरलिंगुआ
 Name[ja]=インターリンガ
 Name[kk]=Интерлингва
 Name[km]=អ៊ីងតឺលីងគ័រ
@@ -4593,6 +4668,7 @@
 Name[gu]=ઈન્ડોનેશિયન
 Name[he]=אינדונזית
 Name[hi]=इंडोनेशियाई
+Name[hne]=इंडोनेसियाई
 Name[hr]=Indonezijski
 Name[hsb]=Indonezisce
 Name[hu]=Indonéz
@@ -4662,6 +4738,7 @@
 Name[gu]=ઈન્ટરલીંગ
 Name[he]=אינטרלינגואֶה
 Name[hi]=इंटरलिंग
+Name[hne]=इंटरलिंग
 Name[ja]=インターリング
 Name[kk]=Интерлигве
 Name[km]=អ៊ីងតឺលីង
@@ -4707,6 +4784,7 @@
 Name[gu]=ઇનુપીઆક
 Name[he]=אינופיאק
 Name[hi]=इनुपिआक
+Name[hne]=इनुपिआक
 Name[hsb]=Inupiaksce
 Name[hu]=Inupiak
 Name[it]=Inupiak
@@ -4756,6 +4834,7 @@
 Name[gu]=ઈડો
 Name[he]=אידו
 Name[hi]=इदो
+Name[hne]=इदो
 Name[hsb]=Idosce
 Name[ja]=イド語
 Name[kk]=Идо
@@ -4817,6 +4896,7 @@
 Name[gu]=આઈલેન્ડિક
 Name[he]=איסלנדית
 Name[hi]=आइसलैंडिक
+Name[hne]=आइसलैंडिक
 Name[hr]=Islandski
 Name[hsb]=Islandsce
 Name[hu]=Izlandi
@@ -4899,6 +4979,7 @@
 Name[gu]=ઈટાલીયન
 Name[he]=איטלקית
 Name[hi]=इतालवी
+Name[hne]=इतालवी
 Name[hr]=Talijanski
 Name[hsb]=Italsce
 Name[hu]=Olasz
@@ -4966,6 +5047,7 @@
 Name[gu]=ઈનુક્ટિટુટ
 Name[he]=אינוקטיטוט
 Name[hi]=इनुक्तितुत
+Name[hne]=इनुक्तितुत
 Name[hsb]=Inuktitutsce
 Name[ja]=イヌイット語
 Name[kk]=Инуктиут
@@ -5028,6 +5110,7 @@
 Name[gu]=જાપાનીઝ
 Name[he]=יפנית
 Name[hi]=जापानी
+Name[hne]=जापानी
 Name[hr]=Japanski
 Name[hsb]=Japansce
 Name[hu]=Japán
@@ -5111,6 +5194,7 @@
 Name[gu]=જાવાનીઝ
 Name[he]=ג'אווה
 Name[hi]=जावानी
+Name[hne]=जावानी
 Name[hr]=Javanski
 Name[hsb]=Jawanisce
 Name[hu]=Jávai
@@ -5192,6 +5276,7 @@
 Name[gu]=જ્યોર્જિયન
 Name[he]=גאורגית
 Name[hi]=ज्यॉर्जियाई
+Name[hne]=ज्यार्जियाई
 Name[hr]=Gruzijski
 Name[hsb]=Georgisce
 Name[hu]=Grúz
@@ -5259,6 +5344,7 @@
 Name[gu]=કિકુયુ
 Name[he]=קיקויו
 Name[hi]=किकूयू
+Name[hne]=किकूयू
 Name[hu]=Kikuju
 Name[ja]=キクユ語
 Name[kk]=Кикую
@@ -5316,6 +5402,7 @@
 Name[gu]=કઝાખ
 Name[he]=קזחית
 Name[hi]=कज़ाख
+Name[hne]=कजाख
 Name[hr]=Kazački
 Name[hsb]=Kazachisce
 Name[hu]=Kazah
@@ -5379,6 +5466,7 @@
 Name[gu]=કાલાલ્લિસુટ
 Name[he]=קלאליסוט
 Name[hi]=कलालिसुत
+Name[hne]=कलालिसुत
 Name[hu]=Kalaalliszut
 Name[it]=Groenlandese
 Name[ja]=グリーンランド語
@@ -5434,6 +5522,7 @@
 Name[gu]=ખ્મેર
 Name[he]=חמר
 Name[hi]=ख्मेर
+Name[hne]=ख्मेर
 Name[hr]=Kmerski
 Name[ja]=クメール語
 Name[kk]=Кхмерше
@@ -5489,6 +5578,7 @@
 Name[gu]=કન્નડ
 Name[he]=קנאדה
 Name[hi]=कन्नड
+Name[hne]=कन्नड
 Name[ja]=カンナダ語
 Name[kk]=Каннада
 Name[km]=កាណាដា
@@ -5553,6 +5643,7 @@
 Name[gu]=કોરીયન
 Name[he]=קוריאנית
 Name[hi]=कोरियाई
+Name[hne]=कोरियाई
 Name[hr]=Korejski
 Name[hsb]=Koreansce
 Name[hu]=Koreai
@@ -5629,6 +5720,7 @@
 Name[gu]=કાશ્મીરી
 Name[he]=קשמירית
 Name[hi]=कश्मीरी
+Name[hne]=कस्मीरी
 Name[hr]=Kašmirski
 Name[hsb]=Kašmirsce
 Name[hu]=Kasmír
@@ -5703,6 +5795,7 @@
 Name[gu]=કુર્દીશ
 Name[he]=כורדית
 Name[hi]=कुर्दिश
+Name[hne]=कुर्दिस
 Name[hr]=Kurdski
 Name[hsb]=Kurdisce
 Name[hu]=Kurd
@@ -5770,6 +5863,7 @@
 Name[gu]=કોમી
 Name[he]=קומי
 Name[hi]=कोमी
+Name[hne]=कोमी
 Name[ja]=コミ語
 Name[kk]=Коми
 Name[km]=កូមី
@@ -5830,6 +5924,7 @@
 Name[gu]=કોર્નિશ
 Name[he]=קורנית
 Name[hi]=कॉर्निश
+Name[hne]=कार्निस
 Name[hr]=Kornski
 Name[hsb]=Kornisce
 Name[hu]=Korn
@@ -5905,6 +6000,7 @@
 Name[gu]=કિર્ગીઝ
 Name[he]=קירגיזית
 Name[hi]=किर्गिज
+Name[hne]=किर्गिज
 Name[hr]=Kirgiški
 Name[hsb]=Kirgisce
 Name[hu]=Kirgiz
@@ -5983,6 +6079,7 @@
 Name[gu]=લેટિન
 Name[he]=לטינית
 Name[hi]=लातिन
+Name[hne]=लातिन
 Name[hr]=Latinski
 Name[hsb]=Łaćonsce
 Name[hy]=Լատիներեն
@@ -6058,6 +6155,7 @@
 Name[gu]=લક્ઝેમ્બર્ગીઝ
 Name[he]=לוקסמבורגית
 Name[hi]=लक्जमबर्गिश
+Name[hne]=लक्जमबर्गिस
 Name[hr]=Luksemburški
 Name[hsb]=Luksemburgsce
 Name[hu]=Luxemburgi
@@ -6135,6 +6233,7 @@
 Name[gu]=લિમ્બુર્ગી
 Name[he]=לימבורגית
 Name[hi]=लिम्बर्गन
+Name[hne]=लिम्बर्गन
 Name[hr]=Limburški
 Name[hsb]=Limburgsce
 Name[hu]=Limburgi
@@ -6192,6 +6291,7 @@
 Name[gu]=લિંગાલા
 Name[he]=לינגאלה
 Name[hi]=लिंगला
+Name[hne]=लिंगला
 Name[hr]=Lingalski
 Name[ja]=リンガラ語
 Name[kk]=Лингата
@@ -6244,6 +6344,7 @@
 Name[gu]=લાઓ
 Name[he]=לאו
 Name[hi]=लाओ
+Name[hne]=लाओ
 Name[ja]=ラオ語
 Name[kk]=Лаосша
 Name[km]=ឡាវ
@@ -6314,6 +6415,7 @@
 Name[gu]=લિથુઆનિઅન
 Name[he]=ליטאית
 Name[hi]=लिथुआनियाई
+Name[hne]=लिथुआनियाई
 Name[hr]=Litvanski
 Name[hsb]=Litawsce
 Name[hu]=Litván
@@ -6397,6 +6499,7 @@
 Name[gu]=લેટવિયન
 Name[he]=לטבית
 Name[hi]=लातवियाई
+Name[hne]=लातवियाई
 Name[hr]=Latvijski
 Name[hsb]=Letisce
 Name[hu]=Lett
@@ -6460,6 +6563,7 @@
 Name[el]=Μαϊθίλι
 Name[eu]=Maithiliera
 Name[fr]=Maïthili
+Name[ga]=Maitilis
 Name[gu]=મૈથિલિ
 Name[ja]=マイティリー語
 Name[kk]=Майтили
@@ -6469,6 +6573,7 @@
 Name[ml]=മൈഥിലി
 Name[pa]=ਮੈਥਲੀ
 Name[ru]=Майтхили
+Name[se]=Maitiligiella
 Name[sk]=Marathi
 Name[sr]=маитхили
 Name[sr@latin]=maithili
@@ -6505,6 +6610,7 @@
 Name[gu]=માલાગાસી
 Name[he]=מלגשית
 Name[hi]=मलागासी
+Name[hne]=मलागासी
 Name[hr]=Malagaski
 Name[hu]=Malagazi
 Name[it]=Malgascio
@@ -6579,6 +6685,7 @@
 Name[gu]=માર્શલીઝ
 Name[he]=מרשלית
 Name[hi]=मार्शलीज
+Name[hne]=मार्सलीज
 Name[hr]=Maršaleski
 Name[hsb]=Maršalesce
 Name[hu]=Marsalli
@@ -6651,6 +6758,7 @@
 Name[gu]=માઓરી
 Name[he]=מאורית
 Name[hi]=माओरी
+Name[hne]=माओरी
 Name[ja]=マオリ語
 Name[kk]=Маори
 Name[km]=ម៉ោរី
@@ -6720,6 +6828,7 @@
 Name[gu]=મેસેડોનિયન
 Name[he]=מקדונית
 Name[hi]=मकदूनियाई
+Name[hne]=मकदूनियाई
 Name[hr]=Makedonski
 Name[hsb]=Makedonsce
 Name[hu]=Macedón
@@ -6791,6 +6900,7 @@
 Name[gu]=મલયાલમ
 Name[he]=מליאלאם
 Name[hi]=मलयालम
+Name[hne]=मलयालम
 Name[hr]=Malajamski
 Name[hu]=Malajalam
 Name[ja]=マラヤーラム語
@@ -6859,6 +6969,7 @@
 Name[gu]=મોંગોલિયન
 Name[he]=מונגולית
 Name[hi]=मंगोलियन
+Name[hne]=मंगोलियन
 Name[hr]=Mongolski
 Name[hsb]=Mongolsce
 Name[hu]=Mongol
@@ -6940,6 +7051,7 @@
 Name[gu]=મોલ્ડેવિયન
 Name[he]=מולדבית
 Name[hi]=मोल्दावियन
+Name[hne]=मोल्दावियन
 Name[hr]=Moldavski
 Name[hsb]=Moldawsce
 Name[hu]=Moldáv
@@ -7012,6 +7124,7 @@
 Name[gu]=મરાઠી
 Name[he]=מאראתי
 Name[hi]=मराठी
+Name[hne]=मराठी
 Name[hsb]=Marati
 Name[hu]=Marati
 Name[ja]=マラーティー語
@@ -7077,6 +7190,7 @@
 Name[gu]=મલય
 Name[he]=מלאית
 Name[hi]=मलय
+Name[hne]=मलय
 Name[hr]=Malajski
 Name[hsb]=Malajsce
 Name[hu]=Maláj
@@ -7155,6 +7269,7 @@
 Name[gu]=માલ્ટીઝ
 Name[he]=מלטזית
 Name[hi]=माल्टी
+Name[hne]=माल्टी
 Name[hr]=Malteški
 Name[hsb]=Maltesce
 Name[hu]=Máltai
@@ -7235,6 +7350,7 @@
 Name[gu]=બર્મીઝ
 Name[he]=בורמזית
 Name[hi]=बर्मी
+Name[hne]=बर्मी
 Name[hr]=Burmanski
 Name[hsb]=Burmesce
 Name[hu]=Burmai
@@ -7307,6 +7423,7 @@
 Name[gu]=નાઉરુ
 Name[he]=נאורו
 Name[hi]=नौरू
+Name[hne]=नौरू
 Name[it]=Nauruano
 Name[ja]=ナウル語
 Name[kk]=Науру
@@ -7373,6 +7490,7 @@
 Name[gu]=નોર્વેયન બોકમલ
 Name[he]=נורבגית Bokmål
 Name[hi]=नार्वेजियाई बोकमाल
+Name[hne]=नार्वेजियाई बोकमाल
 Name[hr]=Norveški Bokmål
 Name[hsb]=Norwegsce (Bokmål)
 Name[hu]=Norvég (bokmal)
@@ -7453,6 +7571,7 @@
 Name[gu]=ડેબેલે, ઉત્તરી
 Name[he]=נדבלה צפונית
 Name[hi]=नेदेबेले, उत्तर
+Name[hne]=नेदेबेले, उत्तर
 Name[hr]=Ndebele, Sjeverni
 Name[hsb]=Ndebele, Sewjerne
 Name[hu]=Ndebele (északi)
@@ -7532,6 +7651,7 @@
 Name[gu]=નીચું સેક્સોન
 Name[he]=סקסונית תחתית
 Name[hi]=लो सेक्सन
+Name[hne]=लो सेक्सन
 Name[hr]=Donjosaksonski
 Name[hsb]=Delnjosaksce
 Name[hu]=Alsószász
@@ -7606,6 +7726,7 @@
 Name[gu]=નેપાળી
 Name[he]=נפאלית
 Name[hi]=नेपाली
+Name[hne]=नेपाली
 Name[hr]=Nepalski
 Name[hsb]=Nepalesce
 Name[hu]=Nepáli
@@ -7665,6 +7786,7 @@
 Name[gu]=ડોંગા
 Name[he]=נדונגה
 Name[hi]=नदोन्गा
+Name[hne]=नदोन्गा
 Name[ja]=ンドゥンガ語
 Name[kk]=Ндонга
 Name[km]=អ៊ែនដុងហ្កា
@@ -7725,6 +7847,7 @@
 Name[gu]=ડચ
 Name[he]=הולנדית
 Name[hi]=डच
+Name[hne]=डच
 Name[hr]=Nizozemski
 Name[hsb]=Nižozemsce
 Name[hu]=Holland
@@ -7809,6 +7932,7 @@
 Name[gu]=નોર્વેયન નોર્સક
 Name[he]=נורבגית Nynorsk
 Name[hi]=नारवेजियाई नायनोर्सक
+Name[hne]=नारवेजियाई नायनोर्सक
 Name[hr]=Norveški Nynorsk
 Name[hsb]=Norwegsce (Nynorsk)
 Name[hu]=Norvég (nynorsk)
@@ -7890,6 +8014,7 @@
 Name[gu]=ડેબેલે, દક્ષિણી
 Name[he]=נדבלה דרומית
 Name[hi]=नेदेबेले,दक्षिण
+Name[hne]=नेदेबेले,दक्छिन
 Name[hr]=Ndebele, Južni
 Name[hsb]=Ndebele, Južne
 Name[hu]=Ndebele (déli)
@@ -7969,6 +8094,7 @@
 Name[gu]=ઉત્તરી સોથો
 Name[he]=סותו צפונית
 Name[hi]=उत्तरी सोथो
+Name[hne]=उत्तरी सोथो
 Name[hr]=Sjeverni Sotho
 Name[hsb]=Sewjerne Sotho
 Name[hu]=Északi sotho
@@ -8037,6 +8163,7 @@
 Name[gu]=નાવાજો
 Name[he]=נבאחו
 Name[hi]=नवाजो
+Name[hne]=नवाजो
 Name[hr]=Navaho
 Name[ja]=ナバホ語
 Name[kk]=Навахо
@@ -8088,6 +8215,7 @@
 Name[gu]=ચિકેવા
 Name[he]=צ'יצ'ווה
 Name[hi]=चिचेवा
+Name[hne]=चिचेवा
 Name[hu]=Csicseva
 Name[ja]=チェワ語
 Name[kk]=Чичева
@@ -8153,6 +8281,7 @@
 Name[gu]=ઓશિન
 Name[he]=אוקסיטנית
 Name[hi]=ओकितन
+Name[hne]=ओकितन
 Name[hsb]=Okcitansce
 Name[hu]=Okcitán
 Name[it]=Occitano
@@ -8212,6 +8341,7 @@
 Name[gu]=ઓરોમો
 Name[he]=אורומו
 Name[hi]=ओरोमो
+Name[hne]=ओरोमो
 Name[hr]=Oromski
 Name[ja]=オロモ語
 Name[kk]=Оромо
@@ -8260,6 +8390,7 @@
 Name[gu]=ઓરીયા
 Name[he]=אורייה
 Name[hi]=उड़िया
+Name[hne]=उड़िया
 Name[hu]=Orija
 Name[ja]=オリヤー語
 Name[kk]=Ория
@@ -8322,6 +8453,7 @@
 Name[gu]=ઓસેશિયન
 Name[he]=אוסטית
 Name[hi]=ओसेशियन
+Name[hne]=ओसेसियन
 Name[hr]=Osetski
 Name[hsb]=Osetisce
 Name[hu]=Oszét
@@ -8395,6 +8527,7 @@
 Name[gu]=પંજાબી/પંજાબી
 Name[he]=פנג'אבית
 Name[hi]=पंजाबी
+Name[hne]=पंजाबी
 Name[hu]=Pandzsabi
 Name[it]=Panjabi
 Name[ja]=パンジャーブ語
@@ -8450,6 +8583,7 @@
 Name[gu]=પાલી
 Name[he]=פאלי
 Name[hi]=पाली
+Name[hne]=पाली
 Name[ja]=パーリ語
 Name[kk]=Пали
 Name[km]=ប៉ាលី
@@ -8513,6 +8647,7 @@
 Name[gu]=પોલિશ
 Name[he]=פולנית
 Name[hi]=पोलिश
+Name[hne]=पोलिस
 Name[hr]=Poljski
 Name[hsb]=Pólsce
 Name[hu]=Lengyel
@@ -8584,6 +8719,7 @@
 Name[gu]=પુશ્ટો
 Name[he]=פאשטו
 Name[hi]=पश्तो
+Name[hne]=पस्तो
 Name[hsb]=Pušto
 Name[hu]=Pusto
 Name[it]=Paštu
@@ -8657,6 +8793,7 @@
 Name[gu]=પોર્ટુગીઝ
 Name[he]=פורטוגזית
 Name[hi]=पुर्तगाली
+Name[hne]=पुर्तगाली
 Name[hr]=Portugalski
 Name[hsb]=Portugalsce
 Name[hu]=Portugál
@@ -8739,6 +8876,7 @@
 Name[gu]=બ્રાઝીલીયન પોર્ટુગીઝ
 Name[he]=פורטוגזית ברזילאית
 Name[hi]=पुर्तगाली (ब्राजीलीयाई)
+Name[hne]=पुर्तगाली (ब्राजीलीयाई)
 Name[hr]=Brazilski portugalski
 Name[hsb]=Portugalsce (Brazilska)
 Name[hu]=Portugál (brazil)
@@ -8811,6 +8949,7 @@
 Name[gu]=ક્વેચા
 Name[he]=קצ'ואה
 Name[hi]=क्वेचुआ
+Name[hne]=क्वेचुआ
 Name[hu]=Kecsua
 Name[ja]=ケチュア語
 Name[kk]=Кечуа
@@ -8864,6 +9003,7 @@
 Name[gu]=રુન્ડી
 Name[he]=רונדי
 Name[hi]=रून्डी
+Name[hne]=रून्डी
 Name[it]=Kirundi
 Name[ja]=ルンディ語
 Name[kk]=Рунди
@@ -8928,6 +9068,7 @@
 Name[gu]=રોમેનિયન
 Name[he]=רומנית
 Name[hi]=रोमानियाई
+Name[hne]=रोमानियाई
 Name[hr]=Rumunjski
 Name[hsb]=Rumunsce
 Name[hu]=Román
@@ -9006,6 +9147,7 @@
 Name[gu]=રોમાનિ
 Name[he]=צוענית
 Name[hi]=रोमन
+Name[hne]=रोमन
 Name[hr]=Romanski
 Name[hu]=Lovári cigány
 Name[is]=Rúmenía
@@ -9084,6 +9226,7 @@
 Name[gu]=રશિયન
 Name[he]=רוסית
 Name[hi]=रूसी
+Name[hne]=रूसी
 Name[hr]=Ruski
 Name[hsb]=Rusce
 Name[hu]=Orosz
@@ -9157,6 +9300,7 @@
 Name[gu]=કિન્યારવાન્ડા
 Name[he]=קיניירואנדה
 Name[hi]=किन्यारवान्डा
+Name[hne]=किन्यारवान्डा
 Name[hr]=Kinidžaruandski
 Name[hu]=Kinjarvanda
 Name[ja]=ルワンダ語
@@ -9218,6 +9362,7 @@
 Name[gu]=સંસ્કૃત
 Name[he]=סנסקריט
 Name[hi]=संस्कृत
+Name[hne]=संस्कृत
 Name[hu]=Szanszkrit
 Name[is]=Sanskrít
 Name[it]=Sanscrito
@@ -9287,6 +9432,7 @@
 Name[gu]=સાર્ડિનિયન
 Name[he]=סרדינית
 Name[hi]=सारदिनी
+Name[hne]=सारदिनी
 Name[hr]=Sardinijski
 Name[hsb]=Sardisce
 Name[hu]=Szardíniai
@@ -9352,6 +9498,7 @@
 Name[gu]=સિંધી
 Name[he]=סינדהי
 Name[hi]=सिंधी
+Name[hne]=सिंधी
 Name[hu]=Szindi
 Name[is]=Shindi
 Name[ja]=シンド語
@@ -9419,6 +9566,7 @@
 Name[gu]=ઉત્તરી સામી
 Name[he]=סאמית צפונית
 Name[hi]=उत्तरी सामी
+Name[hne]=उत्तरी सामी
 Name[hr]=Sjeverni Sami
 Name[hsb]=Sewjernosamisce
 Name[hu]=Északi szami
@@ -9484,6 +9632,7 @@
 Name[gu]=સાન્ગો
 Name[he]=סאנגו
 Name[hi]=सैन्गो
+Name[hne]=सैन्गो
 Name[hu]=Szangó
 Name[ja]=サンゴ語
 Name[kk]=Санго
@@ -9545,6 +9694,7 @@
 Name[gu]=સિંહાલી
 Name[he]=סינהלזית
 Name[hi]=सिंहली
+Name[hne]=सिंहली
 Name[hr]=Sinhalski
 Name[hsb]=Singalsce
 Name[hu]=Szingaléz
@@ -9625,6 +9775,7 @@
 Name[gu]=સ્લોવેક
 Name[he]=סלובקית
 Name[hi]=स्लोवाक
+Name[hne]=स्लोवाक
 Name[hr]=Slovački
 Name[hsb]=Słowaksce
 Name[hu]=Szlovák
@@ -9708,6 +9859,7 @@
 Name[gu]=સ્લોવેનિયન
 Name[he]=סלובנית
 Name[hi]=स्लोवेनियाई
+Name[hne]=स्लोवेनियाई
 Name[hr]=Slovenski
 Name[hsb]=Słowjensce
 Name[hu]=Szlovén
@@ -9788,6 +9940,7 @@
 Name[gu]=સામોન
 Name[he]=סמואית
 Name[hi]=सामोन
+Name[hne]=सामोन
 Name[hr]=Samoanski
 Name[hsb]=Samoasce
 Name[hu]=Szamoai
@@ -9852,6 +10005,7 @@
 Name[gu]=શોના
 Name[he]=שונה
 Name[hi]=शोना
+Name[hne]=सोना
 Name[hu]=Sona
 Name[ja]=ショナ語
 Name[kk]=Схона
@@ -9914,6 +10068,7 @@
 Name[gu]=સોમાલી
 Name[he]=סומלית
 Name[hi]=सोमाली
+Name[hne]=सोमाली
 Name[hr]=Somalijski
 Name[hsb]=Somalisce
 Name[hu]=Szomáli
@@ -9990,6 +10145,7 @@
 Name[gu]=અલ્બેનિયન
 Name[he]=אלבנית
 Name[hi]=अल्बानियाई
+Name[hne]=अल्बानियाई
 Name[hr]=Albanski
 Name[hsb]=Albansce
 Name[hu]=Albán
@@ -10072,6 +10228,7 @@
 Name[gu]=સર્બિયન
 Name[he]=סרבית
 Name[hi]=सर्बियाई
+Name[hne]=सर्बियाई
 Name[hr]=Srpski
 Name[hsb]=Serbisce
 Name[hu]=Szerb
@@ -10153,6 +10310,7 @@
 Name[gu]=સર્બિયન લેટિન
 Name[he]=סרבית לטינית
 Name[hi]=सर्बियाई लातिनी
+Name[hne]=सर्बियाई लातिनी
 Name[hr]=Srpski latinica
 Name[hsb]=Serbisce (z łaćonskim pismom)
 Name[hu]=Szerb (latin betűs)
@@ -10219,6 +10377,7 @@
 Name[gu]=સ્વાતિ
 Name[he]=סוואטי
 Name[hi]=स्वाती
+Name[hne]=स्वाती
 Name[hu]=Szvati
 Name[ja]=スワティ語
 Name[kk]=Свати
@@ -10287,6 +10446,7 @@
 Name[gu]=સોથા, દક્ષિણી
 Name[he]=סותו דרומית
 Name[hi]=सोथो, दक्षिणी
+Name[hne]=सोथो, दक्छिनी
 Name[hr]=Sotho, Južni
 Name[hsb]=Sotho (juh)
 Name[hu]=Sotho (déli)
@@ -10367,6 +10527,7 @@
 Name[gu]=સુદાનિઝ
 Name[he]=סודנית
 Name[hi]=सूडानी
+Name[hne]=सूडानी
 Name[hsb]=Sundanesce
 Name[hu]=Szundanéz
 Name[it]=Sondanese
@@ -10445,6 +10606,7 @@
 Name[gu]=સ્વિડિશ
 Name[he]=שבדית
 Name[hi]=स्वीडिश
+Name[hne]=स्वीडिस
 Name[hr]=Švedski
 Name[hsb]=Šwedsce
 Name[hu]=Svéd
@@ -10518,6 +10680,7 @@
 Name[gu]=સ્વાહિલિ
 Name[he]=סוואהילי
 Name[hi]=स्वाहिली
+Name[hne]=स्वाहिली
 Name[hr]=Svahili
 Name[hu]=Szvahili
 Name[ja]=スワヒリ語
@@ -10580,6 +10743,7 @@
 Name[gu]=તમિલ
 Name[he]=טמילית
 Name[hi]=तमिल
+Name[hne]=तमिल
 Name[hr]=Tamilski
 Name[hsb]=Tamilsce
 Name[is]=Tamílska
@@ -10639,6 +10803,7 @@
 Name[gu]=તેલુગુ
 Name[he]=טלוגו
 Name[hi]=तेलुगु
+Name[hne]=तेलुगु
 Name[ja]=テルグ語
 Name[kk]=Телугу
 Name[km]=តេលូហ្គូ
@@ -10698,6 +10863,7 @@
 Name[gu]=તાજીક
 Name[he]=טג'יקית
 Name[hi]=ताजिक
+Name[hne]=ताजिक
 Name[hr]=Tadžik
 Name[hsb]=Tadźikisce
 Name[hu]=Tadzsik
@@ -10775,6 +10941,7 @@
 Name[gu]=થાઈ
 Name[he]=תאילנדית
 Name[hi]=थाई
+Name[hne]=थाई
 Name[hr]=Tajlandski
 Name[is]=Tælenska
 Name[it]=Thailandese
@@ -10839,6 +11006,7 @@
 Name[gu]=તીજ્રીન્યા
 Name[he]=טיגרינית
 Name[hi]=टिग्रिन्या
+Name[hne]=टिग्रिन्या
 Name[hu]=Tigrinja
 Name[it]=Tigrino
 Name[ja]=ティグリニア語
@@ -10905,6 +11073,7 @@
 Name[gu]=તુર્કમેન
 Name[he]=טורקמנית
 Name[hi]=तुर्कमेन
+Name[hne]=तुर्कमेन
 Name[hr]=Turkmenski
 Name[hsb]=Turkmensce
 Name[hu]=Türkmén
@@ -10971,6 +11140,7 @@
 Name[gu]=ત્સવાના
 Name[he]=צוואנה
 Name[hi]=तस्वाना
+Name[hne]=तस्वाना
 Name[hu]=Tszvana
 Name[ja]=ツワナ語
 Name[kk]=Тсвана
@@ -11023,6 +11193,7 @@
 Name[gu]=ટોન્ગા
 Name[he]=טונגה
 Name[hi]=टोन्गा
+Name[hne]=टोन्गा
 Name[ja]=トンガ語
 Name[kk]=Тонга
 Name[km]=តុងហ្គា
@@ -11087,6 +11258,7 @@
 Name[gu]=તુર્કી
 Name[he]=טורקית
 Name[hi]=तुर्की
+Name[hne]=तुर्की
 Name[hr]=Turski
 Name[hsb]=Turkowsce
 Name[hu]=Török
@@ -11156,6 +11328,7 @@
 Name[gu]=સોંગા
 Name[he]=צונגה
 Name[hi]=त्सोन्गा
+Name[hne]=त्सोन्गा
 Name[ja]=ツォンガ語
 Name[kk]=Тсонга
 Name[km]=សុងហ្កា
@@ -11212,6 +11385,7 @@
 Name[gu]=તાતાર
 Name[he]=טאטרית
 Name[hi]=तातार
+Name[hne]=तातार
 Name[hr]=Tatarski
 Name[hsb]=Tatarsce
 Name[hu]=Tatár
@@ -11271,6 +11445,7 @@
 Name[gu]=ત્વી
 Name[he]=צ'ווי
 Name[hi]=त्वी
+Name[hne]=त्वी
 Name[hu]=Tvi
 Name[ja]=チュイ語
 Name[kk]=Тви
@@ -11333,6 +11508,7 @@
 Name[gu]=તાહિટિયન
 Name[he]=טהיטית
 Name[hi]=ताहितियन
+Name[hne]=ताहितियन
 Name[hr]=Tahićanski
 Name[hsb]=Tahitisce
 Name[hu]=Tahiti
@@ -11402,6 +11578,7 @@
 Name[gu]=યિગુર
 Name[he]=אויגורית
 Name[hi]=उइघुर
+Name[hne]=उइघुर
 Name[hr]=Ujgurski
 Name[hsb]=Ujgursce
 Name[hu]=Ujgur
@@ -11478,6 +11655,7 @@
 Name[gu]=યુક્રેનિયન
 Name[he]=אוקראינית
 Name[hi]=उक्रेनियाई
+Name[hne]=उक्रेनियाई
 Name[hr]=Ukrajinski
 Name[hsb]=Ukrainsce
 Name[hu]=Ukrán
@@ -11548,6 +11726,7 @@
 Name[gu]=ઉર્દુ
 Name[he]=אורדו
 Name[hi]=उर्दू
+Name[hne]=उर्दू
 Name[ja]=ウルドゥー語
 Name[kk]=Урду
 Name[km]=អ៊ូរ្ឌូ
@@ -11607,6 +11786,7 @@
 Name[gu]=ઉઝબેક
 Name[he]=אוזבקית
 Name[hi]=उज्बेक
+Name[hne]=उज्बेक
 Name[hr]=Uzbečki
 Name[hsb]=Uzbekisce
 Name[hu]=Üzbég
@@ -11683,6 +11863,7 @@
 Name[gu]=ઉઝબેક (સિરીલિક)
 Name[he]=אוזבקית (קירילית)
 Name[hi]=उज़बैक (सिरिलिक)
+Name[hne]=उजबैक (सिरिलिक)
 Name[hsb]=Uzbekisce (z kyriliskim pismom)
 Name[hu]=Üzbég (cirill)
 Name[is]=Úsbekíska (Kyrilísk)
@@ -11711,6 +11892,7 @@
 Name[pt_BR]=Uzbeque (Cirílico)
 Name[ro]=Uzbekă (Chirilic)
 Name[ru]=Узбекский (Кириллица)
+Name[se]=Usbekalaš (Kyrillalaš)
 Name[sk]=Uzbecký (Cyrillic)
 Name[sl]=Uzbeško (cirilica)
 Name[sr]=узбечки (ћирилица)
@@ -11739,6 +11921,7 @@
 Name[gu]=વેન્ડા
 Name[he]=ונדה
 Name[hi]=वेंदा
+Name[hne]=वेंदा
 Name[ja]=ベンダ語
 Name[kk]=Венда
 Name[km]=វង់ដា
@@ -11798,6 +11981,7 @@
 Name[gu]=વિયેટનામીઝ
 Name[he]=וייטנאמית
 Name[hi]=विएतनामी
+Name[hne]=विएतनामी
 Name[hr]=Vijetnamski
 Name[hsb]=Vietnamsce
 Name[hu]=Vietnami
@@ -11866,6 +12050,7 @@
 Name[gu]=વોલ્પુક
 Name[he]=וולאפיק
 Name[hi]=वोलापक
+Name[hne]=वोलापक
 Name[ja]=ボラピューク語
 Name[kk]=Волапюк
 Name[km]=វ៉ូឡាភូក
@@ -11924,6 +12109,7 @@
 Name[gu]=વોલુન
 Name[he]=וולונית
 Name[hi]=वालून
+Name[hne]=वालून
 Name[hr]=Valonski
 Name[hu]=Vallon
 Name[is]=Vallónska
@@ -11991,6 +12177,7 @@
 Name[gu]=વોલોફ
 Name[he]=וולוף
 Name[hi]=वालाफ़
+Name[hne]=वालाफ
 Name[hr]=Volofski
 Name[hu]=Volof
 Name[ja]=ウォロフ語
@@ -12042,6 +12229,7 @@
 Name[gu]=હોસા
 Name[he]=קוזה
 Name[hi]=झ़ोसा
+Name[hne]=झ़ोसा
 Name[hu]=Xhosza
 Name[ja]=コサ語
 Name[kk]=Кхоса
@@ -12100,6 +12288,7 @@
 Name[gu]=યિદ્દિશ
 Name[he]=יידיש
 Name[hi]=यिड्डिष
+Name[hne]=यिड्डिस
 Name[hr]=Jidiš
 Name[hsb]=Jidisce
 Name[hu]=Jiddis
@@ -12162,6 +12351,7 @@
 Name[gu]=યોરુબા
 Name[he]=יורובה
 Name[hi]=योरुबा
+Name[hne]=योरुबा
 Name[hu]=Joruba
 Name[ja]=ヨルバ語
 Name[kk]=Йоруба
@@ -12213,6 +12403,7 @@
 Name[gu]=હુઆંગ
 Name[he]=ג'ואנג
 Name[hi]=झुआंग
+Name[hne]=झुआंग
 Name[ja]=チュワン語
 Name[kk]=Зуангша
 Name[km]=ចួង
@@ -12273,6 +12464,7 @@
 Name[gu]=ચાઇનિઝ
 Name[he]=סינית
 Name[hi]=चीनी
+Name[hne]=चीनी
 Name[hr]=Kineski
 Name[hsb]=Chinsce
 Name[hu]=Kínai
@@ -12357,6 +12549,7 @@
 Name[gu]=સરળ ચાઇનિઝ
 Name[he]=סינית מפושטת
 Name[hi]=चीनी सरल
+Name[hne]=चीनी सरल
 Name[hr]=Kineski pojednostavljen
 Name[hsb]=Chinsce (zjednorjene)
 Name[hu]=Kínai (egyszerűsített)
@@ -12438,6 +12631,7 @@
 Name[gu]=ચાઇનિઝ (હોંગ કોંગ)
 Name[he]=סינית (הונג קונג)
 Name[hi]=चीनी (हांग कांग)
+Name[hne]=चीनी (हांग कांग)
 Name[hr]=Kineski (Hong Kong)
 Name[hsb]=Chinsce (Hong Kong)
 Name[hu]=Kínai (hongkongi)
@@ -12520,6 +12714,7 @@
 Name[gu]=પરંપરાગત ચાઇનિઝ
 Name[he]=סינית מסורתית
 Name[hi]=चीनी परम्परिक
+Name[hne]=चीनी परम्परिक
 Name[hr]=Kineski tradicionalan
 Name[hsb]=Chinsce (tradicionalnje)
 Name[hu]=Kínai (hagyományos)
@@ -12593,6 +12788,7 @@
 Name[gu]=ઝુલુ
 Name[he]=זולו
 Name[hi]=ज़ुलु
+Name[hne]=जुलु
 Name[is]=Zúlú
 Name[ja]=ズールー語
 Name[kk]=Зулу
Index: kdecore/sonnet/sonnetspeller.desktop
===================================================================
--- kdecore/sonnet/sonnetspeller.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/sonnet/sonnetspeller.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -28,6 +28,7 @@
 Comment[gu]=સોન્નેટ સ્પેલ ક્લાઈન્ટ
 Comment[he]=תוכנית בדיקת איות Sonnet
 Comment[hi]=सोनेट स्पैल क्लाएंट
+Comment[hne]=सोनेट स्पैल क्लायंट
 Comment[hsb]=Sonnet prawopisny program
 Comment[hu]=Sonnet helyesírás-ellenőrző
 Comment[is]=Sonnet stafsetningarbiðlarinn
Index: kdecore/io/kautosavefile.cpp
===================================================================
--- kdecore/io/kautosavefile.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/io/kautosavefile.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -106,9 +106,9 @@
 {
     if (d->lock && d->lock->isLocked()) {
         d->lock.clear();
-    }
-    if (!fileName().isEmpty()) {
+        if (!fileName().isEmpty()) {
         remove();
+        }
     }
 }
 
@@ -179,6 +179,8 @@
 
     // contruct a KAutoSaveFile for each stale file
     foreach(const QString &file, files) {
+        if (file.endsWith(".lock"))
+            continue;
         // sets managedFile
         asFile = new KAutoSaveFile(filename);
         asFile->setFileName(file);
@@ -209,6 +211,8 @@
 
     // contruct a KAutoSaveFile for each stale file
     foreach(file, files) {
+        if (file.endsWith(".lock"))
+            continue;
         sep = file.right(3);
         file.chop(KAutoSaveFilePrivate::padding);
 
Index: kdecore/io/klockfile_unix.cpp
===================================================================
--- kdecore/io/klockfile_unix.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/io/klockfile_unix.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -230,13 +230,16 @@
       linkCountSupport = testLinkCountSupport(tmpFile);
    }
 
-   if (!linkCountSupport &&
-       (KDE_lstat(lckFile, &st_buf2) == 0) && st_buf == st_buf2)
+   if (!linkCountSupport)
    {
       // Without support for link counts we will have a little race condition
       qWarning("WARNING: deleting stale lockfile %s", lckFile.data());
-      ::unlink(lckFile);
       ::unlink(tmpFile);
+      if (::unlink(lckFile) < 0) {
+          qWarning("WARNING: Problem deleting stale lockfile %s: %s", lckFile.data(),
+                  strerror(errno));
+          return KLockFile::LockFail;
+      }
       return KLockFile::LockOK;
    }
 
@@ -272,54 +275,13 @@
            break;
         }
      }
-     else // KLockFile::Fail
+     else // KLockFile::Fail -- there is already such a file present (e.g. left by a crashed app)
      {
         if (!d->staleTimer.isNull() && d->statBuf != st_buf)
            d->staleTimer = QTime();
 
-        if (!d->staleTimer.isNull())
+        if (d->staleTimer.isNull())
         {
-           bool isStale = false;
-           if ((d->pid > 0) && !d->hostname.isEmpty())
-           {
-              // Check if hostname is us
-              char hostname[256];
-              hostname[0] = 0;
-              gethostname(hostname, 255);
-              hostname[255] = 0;
-
-              if (d->hostname == QLatin1String(hostname))
-              {
-                 // Check if pid still exists
-                 int res = ::kill(d->pid, 0);
-                 if ((res == -1) && (errno == ESRCH))
-                    isStale = true;
-              }
-           }
-           if (d->staleTimer.elapsed() > (d->staleTime*1000))
-              isStale = true;
-
-           if (isStale)
-           {
-              if ((options & ForceFlag) == 0)
-                 return KLockFile::LockStale;
-
-              result = deleteStaleLock(d->file, d->statBuf, d->linkCountSupport, d->componentData);
-
-              if (result == KLockFile::LockOK)
-              {
-                 // Lock deletion successful
-                 d->staleTimer = QTime();
-                 continue; // Now try to get the new lock
-              }
-              else if (result != KLockFile::LockFail)
-              {
-                 return result;
-              }
-           }
-        }
-        else
-        {
            memcpy(&(d->statBuf), &st_buf, sizeof(KDE_struct_stat));
            d->staleTimer.start();
 
@@ -339,9 +301,48 @@
                  d->hostname = ts.readLine();
            }
         }
+
+        bool isStale = false;
+        if ((d->pid > 0) && !d->hostname.isEmpty())
+        {
+           // Check if hostname is us
+           char hostname[256];
+           hostname[0] = 0;
+           gethostname(hostname, 255);
+           hostname[255] = 0;
+
+           if (d->hostname == QLatin1String(hostname))
+           {
+              // Check if pid still exists
+              int res = ::kill(d->pid, 0);
+              if ((res == -1) && (errno == ESRCH))
+                 isStale = true;
+           }
+        }
+        if (d->staleTimer.elapsed() > (d->staleTime*1000))
+           isStale = true;
+
+        if (isStale)
+        {
+           if ((options & ForceFlag) == 0)
+              return KLockFile::LockStale;
+
+           result = deleteStaleLock(d->file, d->statBuf, d->linkCountSupport, d->componentData);
+
+           if (result == KLockFile::LockOK)
+           {
+              // Lock deletion successful
+              d->staleTimer = QTime();
+              continue; // Now try to get the new lock
+           }
+           else if (result != KLockFile::LockFail)
+           {
+              return result;
+           }
+        }
      }
 
-     if ((options & NoBlockFlag) != 0)
+     if (options & NoBlockFlag)
         break;
 
      struct timeval tv;
Index: kdecore/io/kurl.cpp
===================================================================
--- kdecore/io/kurl.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ kdecore/io/kurl.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -380,9 +380,9 @@
       // remember the possible query using _setEncodedUrl(), then set up the correct path without query protocol part
       int index = pathToSet.lastIndexOf('?');
       if (index == -1)
-        setPath( QDir::fromNativeSeparators( pathToSet ) );
+        setPath( pathToSet );
       else {
-        setPath( QDir::fromNativeSeparators( pathToSet.left( index ) ) );
+        setPath( pathToSet.left( index ) );
         _setQuery( pathToSet.mid( index + 1 ) );
       }
     }
@@ -1323,6 +1323,13 @@
     return result;
   }
 
+#ifdef Q_WS_WIN
+  if ( i == 2 && result[1] == QLatin1Char(':') )
+  {
+    return result.left(3);
+  }
+#endif
+
   if ( options & AppendTrailingSlash )
     result = result.left( i + 1 );
   else
Index: plasma/dataengine.cpp
===================================================================
--- plasma/dataengine.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/dataengine.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -636,9 +636,10 @@
 void DataEnginePrivate::trimQueue()
 {
     uint queueCount = sourceQueue.count();
-    while (queueCount >= limit) {
+    while (queueCount >= limit && !sourceQueue.isEmpty()) {
         DataContainer *punted = sourceQueue.dequeue();
         q->removeSource(punted->objectName());
+        queueCount = sourceQueue.count();
     }
 }
 
Index: plasma/servicetypes/plasma-packagestructure.desktop
===================================================================
--- plasma/servicetypes/plasma-packagestructure.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-packagestructure.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -15,9 +15,11 @@
 Comment[eu]=Plassma paketearen egituraren definizioa
 Comment[fi]=Plasma-pakettirakenteen määritelmä
 Comment[fr]=Définition de la structure des paquetages Plasma
+Comment[ga]=Sainmhíniú ar struchtúr pacáiste Plasma
 Comment[gl]=Definición da estrutura do paquete de Plasma
 Comment[gu]=પ્લાઝમા પેકેજ માળખાંની વ્યાખ્યા
 Comment[he]=הגדרת מבנה של חבילת Plasma
+Comment[hne]=प्लाज्मा पैकेज स्ट्रक्चर परिभासा
 Comment[hsb]=Strukturna definicija Plasma-pakćika
 Comment[hu]=Struktúraleíró Plasma-csomagokhoz
 Comment[is]=Skilgreiningar Plasma pakkauppbyggingar
@@ -40,6 +42,7 @@
 Comment[pt_BR]=Definição de estrutura de pacote do Plasma
 Comment[ro]=Definiție de structură a pachetului Plasma
 Comment[ru]=Определение структуры пакета Plasma
+Comment[se]=Plasma-páhkkaráhkadusdefinišuvdna
 Comment[sk]=Balík definícii štruktúry plasmy 
 Comment[sl]=Definicija strukture paketa za Plasmo
 Comment[sr]=Дефиниција структуре плазма пакета
Index: plasma/servicetypes/plasma-containment.desktop
===================================================================
--- plasma/servicetypes/plasma-containment.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-containment.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -16,9 +16,11 @@
 Comment[eu]=Plasma appletaren edukontzia eta atzeko planoaren margolaria
 Comment[fi]=Plasma sovelmasisällyttäjä ja taustapiirtäjä
 Comment[fr]=Conteneur d'applet Plasma et affichage d'arrière-plan
+Comment[ga]=Coimeádán feidhmchláiríní Plasma agus péintéir cúlra
 Comment[gl]=Un contedor de applet de Plasma e pintor do fondo
 Comment[gu]=પ્લાઝમા એપ્લેટ ધરાવનાર અને પાશ્ચભાગ રંગનાર
 Comment[he]=תוחם של יישומון Plasma וצובע הרקע
+Comment[hne]=प्लाज्मा एपलेट कंटेनर अउ पिछोत पुतइया
 Comment[hsb]=Plasma-container za applet a molowadło pozadka
 Comment[hu]=Tartóelem és háttérrajzoló Plasma-kisalkalmazásokhoz
 Comment[is]=Grunnur fyrir Plasma smáforrit og bakgrunnslitun
@@ -26,6 +28,7 @@
 Comment[ja]=Plasma アプレットの入れ物、背景の描画
 Comment[km]=ឧបករណ៍​ផ្ទុក​អាប់ភ្លេត​ប្លាស្មា និង​កម្មវិធី​គូរ​ផ្ទៃខាងក្រោយ
 Comment[ku]=Embarvanê sepanoka Plasma û nexşevanê rûerdê
+Comment[lt]=Plasma įskiepio dėklas ir fono paišiklis
 Comment[lv]=Plasma apletu turis un fona zīmētājs
 Comment[mai]=प्लाजमा एप्पलेट कंटेनर आओर पृष्ठभूमि पेंटर
 Comment[ml]=പ്ലാസ്മ ലഘുപ്രയോഗം കണ്ടൈനറും പശ്ചാത്തല പെയിന്ററും
@@ -38,7 +41,8 @@
 Comment[pt]=Contentor de 'applets' do Plasma e pintor do fundo
 Comment[pt_BR]=Recipiente de miniaplicativos do Plasma e pintor de plano de fundo
 Comment[ro]=Container de miniaplicații Plasma și desenator de fundal
-Comment[ru]=Контейнер виджета Plasma
+Comment[ru]=Контейнер и модуль отрисовки виджета Plasma
+Comment[se]=Plasma-prográmmašlihtti ja -duogášmálejeaddji
 Comment[sk]=Plasma applet kontajner a popisovať na pozadí
 Comment[sl]=Vsebnik programčkov in izrisovalnik ozadja za Plasmo
 Comment[sr]=Садржалац плазма аплетâ и исцртавач позадине
Index: plasma/servicetypes/plasma-dataengine.desktop
===================================================================
--- plasma/servicetypes/plasma-dataengine.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-dataengine.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -17,9 +17,11 @@
 Comment[eu]=Plasma datu motorra
 Comment[fi]=Plasma-tietomoottori
 Comment[fr]=Moteur de données Plasma
+Comment[ga]=Inneall Sonraí Plasma
 Comment[gl]=Motor de dados de plasma
 Comment[gu]=પ્લાઝમા માહિતી એન્જિન
 Comment[he]=מנוע מידע עבור Plasma
+Comment[hne]=प्लाज्मा डाटा इंजिन
 Comment[hsb]=Datowa engine za Plasma
 Comment[hu]=Plasma adatkezelő
 Comment[is]=Plasma gagnavél
@@ -41,7 +43,8 @@
 Comment[pt]=Motor de Dados do Plasma
 Comment[pt_BR]=Mecanismo de dados do Plasma
 Comment[ro]=Motor de date Plasma
-Comment[ru]=Движок Plasma для работы с данными
+Comment[ru]=Источник данных Plasma
+Comment[se]=Plasma-dáhtamohtor
 Comment[sl]=Podatkovni pogon za Plasmo
 Comment[sr]=Плазма датомотор
 Comment[sr@latin]=Plasma datomotor
Index: plasma/servicetypes/plasma-applet.desktop
===================================================================
--- plasma/servicetypes/plasma-applet.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-applet.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -19,9 +19,11 @@
 Comment[fi]=Plasma-sovelma
 Comment[fr]=Applet Plasma
 Comment[fy]=Plasma Applet
+Comment[ga]=Feidhmchláirín Plasma
 Comment[gl]=Applet de Plasma
 Comment[gu]=પ્લાઝમા એપ્લેટ
 Comment[he]=יישומון של Plasma
+Comment[hne]=प्लाज्मा एपलेट
 Comment[hu]=Plasma-kisalkalmazás
 Comment[is]=Plasma smáforrit
 Comment[it]=Applet Plasma
@@ -29,6 +31,7 @@
 Comment[km]=អាប់ភ្លេត​ប្លាស្មា
 Comment[ko]=Plasma 애플릿
 Comment[ku]=Sepanoka Plasma
+Comment[lt]=Plasma įskiepis
 Comment[lv]=Plasma aplets
 Comment[mai]=प्लाजमा एप्पलेट
 Comment[ml]=പ്ലാസ്മ ലഘുപ്രയോഗം
@@ -42,6 +45,7 @@
 Comment[pt_BR]=Miniaplicativo do Plasma
 Comment[ro]=Miniaplicație Plasma
 Comment[ru]=Виджет Plasma
+Comment[se]=Plasma-prográmmaš
 Comment[sl]=Plasma programček
 Comment[sr]=Плазма аплет
 Comment[sr@latin]=Plasma aplet
Index: plasma/servicetypes/plasma-applet-extenderapplet.desktop
===================================================================
--- plasma/servicetypes/plasma-applet-extenderapplet.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-applet-extenderapplet.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -11,9 +11,11 @@
 Name[eu]=Barne edukiontzia hedatua
 Name[fi]=Sisäinen laajennussisällyttäjä
 Name[fr]=Extenseur de conteneur interne
+Name[ga]=Gabhdán Sínteoirí Inmheánacha
 Name[gl]=Continente de extensor interno
 Name[gu]=આંતરિક વિસ્તારક ધરાવનાર
 Name[he]=תוחם מרחיב פנימי
+Name[hne]=इंटरनल एक्सटेंडर कंटेनर
 Name[hu]=Tartóelem belső kiegészítésekhez
 Name[is]=Útvíkkaður innbyggður grunnur
 Name[it]=Contenitore di estensione interno
@@ -31,7 +33,8 @@
 Name[pt]=Contentor de Extensão Interno
 Name[pt_BR]=Recipiente de extensão interna
 Name[ro]=Container extensibil intern
-Name[ru]=Внутренний расширенный контейнер
+Name[ru]=Внутренний контейнер
+Name[se]=Siskkáldas viiddáduslihtti
 Name[sk]=Vnútorný predlžovací kontajner
 Name[sl]=Notranji razširitveni vsebovalnik
 Name[sr]=унутрашњи садржалац проширивача
Index: plasma/servicetypes/plasma-wallpaper.desktop
===================================================================
--- plasma/servicetypes/plasma-wallpaper.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-wallpaper.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -18,9 +18,11 @@
 Comment[eu]=Plasma horma papera
 Comment[fi]=Plasma-taustakuva
 Comment[fr]=Fond d'écran Plasma
+Comment[ga]=Cúlbhrat Plasma
 Comment[gl]=Fondo de escritorio de Plasma
 Comment[gu]=પ્લાઝમા વોલપેપર
 Comment[he]=תמונת רקע של Plasma
+Comment[hne]=प्लाज्मा वालपेपर
 Comment[hsb]=Tapeta za Plasma
 Comment[hu]=Plasma háttérkép
 Comment[is]=Plasma veggfóður
@@ -29,6 +31,7 @@
 Comment[km]=ផ្ទាំង​រូបភាព​ប្លាស្មា
 Comment[ko]=Plasma 배경 그림
 Comment[ku]=Wêne-rûerdê Plasma 
+Comment[lt]=Plasma apmušalas
 Comment[lv]=Plasma ekrāntapete
 Comment[mai]=प्लाजमा वालपेपर
 Comment[ml]=പ്ലാസ്മ ചുമര്‍ച്ചിത്രം
@@ -42,6 +45,7 @@
 Comment[pt_BR]=Papel de parede do Plasma
 Comment[ro]=Fundal Plasma
 Comment[ru]=Обои Plasma
+Comment[se]=Plasma-duogášgovva
 Comment[sk]=Plasma Pozadie
 Comment[sl]=Tapeta za Plasmo
 Comment[sr]=Плазма тапет
Index: plasma/servicetypes/plasma-runner.desktop
===================================================================
--- plasma/servicetypes/plasma-runner.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-runner.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -19,9 +19,11 @@
 Comment[eu]=KRnner plugin-a
 Comment[fi]=KRunner-liitännäinen
 Comment[fr]=Module KRunner
+Comment[ga]=Breiseán KRunner
 Comment[gl]=Extensión KFileWrite
 Comment[gu]=KRunner પ્લગઈન
 Comment[he]=תוסף KRunner
+Comment[hne]=के-रनरइट प्लगइन
 Comment[hu]=KRunner-bővítmény
 Comment[is]=KRunner íforrit
 Comment[it]=Plugin KRunner
@@ -44,6 +46,7 @@
 Comment[pt_BR]=Plug-in do KRunner
 Comment[ro]=Modul KRunner
 Comment[ru]=Расширение KRunner
+Comment[se]=KRunner-lassemodula
 Comment[sk]=KRunner rozšírenie
 Comment[sl]=Vstavek za KRunner
 Comment[sr]=Прикључак за К‑извођач
Index: plasma/servicetypes/plasma-animator.desktop
===================================================================
--- plasma/servicetypes/plasma-animator.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-animator.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -17,9 +17,11 @@
 Comment[eu]=Plasma animazio motorra
 Comment[fi]=Plasma-animointimoottori
 Comment[fr]=Moteur d'animation Plasma
+Comment[ga]=Inneall Beochana Plasma
 Comment[gl]=Motor de animación de Plasma
 Comment[gu]=પ્લાઝમા એનિમેશન એન્જિન
 Comment[he]=מנוע אנימציה של Plasma
+Comment[hne]=प्लाज्मा एनिमेशन इंजिन
 Comment[hsb]=Plasma-engine za animacije
 Comment[hu]=Plasma animációkezelő
 Comment[is]=Plasma hreyfingastjóri
@@ -41,7 +43,8 @@
 Comment[pt]=Motor de Animação do Plasma
 Comment[pt_BR]=Mecanismo de animação do Plasma
 Comment[ro]=Motor de animație Plasma
-Comment[ru]=Движок анимации Plasma
+Comment[ru]=Движок анимации для Plasma
+Comment[se]=Plasma-animerenmohtor
 Comment[sk]=Engine animácii plasmy
 Comment[sl]=Animacijski pogon za Plasmo
 Comment[sr]=Плазма мотор анимација
Index: plasma/servicetypes/plasma-scriptengine.desktop
===================================================================
--- plasma/servicetypes/plasma-scriptengine.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/servicetypes/plasma-scriptengine.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -16,9 +16,11 @@
 Comment[eu]=Plasmarako script lengoaien gehigarria
 Comment[fi]=Skriptauskielituki Plasmalle
 Comment[fr]=Langage de script d'extension pour Plasma
+Comment[ga]=Eisínteacht teanga scriptithe le haghaidh Plasma
 Comment[gl]=Extensicón de linguaxe de scripting para Plasma
 Comment[gu]=પ્લાઝમા માટે સ્ક્રિપ્ટીંગ ભાષા એક્સટેન્શન
 Comment[he]=הרחבת שפת תסריטים של Plasma
+Comment[hne]=प्लाज्मा बर स्क्रिप्टिंग भाखा
 Comment[hsb]=Skriptowa rěč jako Plasma-ekstensija
 Comment[hu]=Szkriptkezelő bővítmény a Plasmához
 Comment[is]=Framlenging á skriftunarmál fyrir Plasma
@@ -27,6 +29,7 @@
 Comment[km]=ផ្នែក​បន្ថែម​ភាសា​ស្គ្រីប​សម្រាប់​ប្លាស្មា
 Comment[ko]=Plasma 스크립트 언어 확장
 Comment[ku]=Pêveka zimanê skrîpt kirinê ji bo Plasma
+Comment[lt]=Scenarijų kalbos praplėtimas, skirtas Plasma
 Comment[lv]=Skriptēšanas valodu Plasma paplašinājums
 Comment[mai]=प्लाजमाक लेल स्क्रिप्टिंग भाषाक विस्तार
 Comment[ml]=പ്ലാസ്മയ്ക്കുള്ള സ്ക്രിപ്റ്റിങ്ങ് ഭാഷാ എക്സ്റ്റന്‍ഷന്‍
@@ -40,6 +43,7 @@
 Comment[pt_BR]=Extensão de linguagem de script do Plasma
 Comment[ro]=Extensie de limbaj pentru scripturi Plasma
 Comment[ru]=Поддержка скриптовых языков для Plasma
+Comment[se]=Skriptagiellaviiddádus Plasmai
 Comment[sk]=Rozšírenie skryptovacieho jazyku pre Plasmu
 Comment[sl]=Razširitev s skriptnim jezikom za Plasmo
 Comment[sr]=Проширење Плазме за скриптне језике
Index: plasma/extender.cpp
===================================================================
--- plasma/extender.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/extender.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -467,6 +467,9 @@
 
 void ExtenderPrivate::adjustSizeHints()
 {
+#if (QT_VERSION >= QT_VERSION_CHECK(4, 90, 0))
+    return;
+#endif
     //FIXME: what happens in this function are some nasty workarounds for a bug in qt4.4's QGL.
     //Alexis has told me they are working on a fix for qt4.5, so this can be removed once the bug
     //has been fixed in Qt.
Index: plasma/corona.cpp
===================================================================
--- plasma/corona.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/corona.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -152,9 +152,10 @@
             containment->setFormFactor(Plasma::Planar);
         }
 
-        static_cast<Applet*>(containment)->d->setIsContainment(true);
+        static_cast<Applet*>(containment)->d->isContainment = true;
+        q->addItem(containment);
+        static_cast<Applet*>(containment)->d->setIsContainment(true, true);
         containments.append(containment);
-        q->addItem(containment);
 
         if (!delayedInit) {
             containment->init();
@@ -300,7 +301,6 @@
             continue;
         }
 
-        //addItem(c);
         c->init();
         c->restore(containmentConfig);
     }
Index: plasma/applet.h
===================================================================
--- plasma/applet.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/applet.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -609,6 +609,11 @@
          */
         void activate();
 
+        /**
+         * Emitted when the applet is deleted
+         */
+        void appletDestroyed(Plasma::Applet *applet);
+
     public Q_SLOTS:
         /**
          * Sets the immutability type for this applet (not immutable,
Index: plasma/popupapplet.cpp
===================================================================
--- plasma/popupapplet.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/popupapplet.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -131,14 +131,6 @@
 
 void PopupAppletPrivate::popupConstraintsEvent(Plasma::Constraints constraints)
 {
-    if (constraints & Plasma::StartupCompletedConstraint) {
-        startupComplete = true;
-    }
-
-    if (!startupComplete) {
-        return;
-    }
-
     Plasma::FormFactor f = q->formFactor();
 
     if (constraints & Plasma::LocationConstraint) {
@@ -435,7 +427,7 @@
 
 bool PopupApplet::isPopupShowing() const
 {
-    return !d->dialog || d->dialog->isVisible();
+    return d->dialog && d->dialog->isVisible();
 }
 
 PopupAppletPrivate::PopupAppletPrivate(PopupApplet *applet)
@@ -446,7 +438,6 @@
           popupPlacement(Plasma::FloatingPopup),
           savedAspectRatio(Plasma::InvalidAspectRatioMode),
           timer(0),
-          startupComplete(false),
           popupLostFocus(false),
           passive(false)
 {
Index: plasma/widgets/busywidget.cpp
===================================================================
--- plasma/widgets/busywidget.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/widgets/busywidget.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -36,7 +36,9 @@
 public:
     BusyWidgetPrivate()
         : svg(0),
-          timerId(0)
+          timerId(0),
+          rotationAngle(0),
+          rotation(0)
     {
     }
 
Index: plasma/widgets/webview.cpp
===================================================================
--- plasma/widgets/webview.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/widgets/webview.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -232,9 +232,16 @@
 
     QContextMenuEvent ce(static_cast<QContextMenuEvent::Reason>(event->reason()),
                          event->pos().toPoint(), event->screenPos());
-    d->page->event(&ce);
-    if (ce.isAccepted()) {
+
+    if (d->page->swallowContextMenuEvent(&ce)) {
         event->accept();
+    } else {
+        d->page->updatePositionDependentActions(event->pos().toPoint());
+
+        d->page->event(&ce);
+        if (ce.isAccepted()) {
+            event->accept();
+        }
     }
 }
 
Index: plasma/widgets/tabbar.cpp
===================================================================
--- plasma/widgets/tabbar.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/widgets/tabbar.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -360,18 +360,23 @@
         return;
     }
 
-    int currentIndex = d->tabProxy->native->currentIndex();
-
+    int oldCurrentIndex = d->tabProxy->native->currentIndex();
     d->tabProxy->native->removeTab(index);
     QGraphicsWidget *page = d->pages.takeAt(index);
 
-    if (index == currentIndex) {
-        setCurrentIndex(currentIndex);
+    int currentIndex = d->tabProxy->native->currentIndex();
+
+    if (oldCurrentIndex == index) {
+        d->tabWidgetLayout->removeAt(1);
     }
 
     scene()->removeItem(page);
     page->deleteLater();
 
+    if (oldCurrentIndex != currentIndex) {
+        setCurrentIndex(currentIndex);
+    }
+
     d->updateTabWidgetMode();
     d->tabProxy->setPreferredSize(d->tabProxy->native->sizeHint());
 }
Index: plasma/applet.cpp
===================================================================
--- plasma/applet.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/applet.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -133,6 +133,9 @@
 
 Applet::~Applet()
 {
+    //let people know that i will die
+    emit appletDestroyed(this);
+
     if (d->transient) {
         d->resetConfigurationObject();
     } else if (d->extender) {
@@ -1766,9 +1769,9 @@
     setZValue(--AppletPrivate::s_minZValue);
 }
 
-void AppletPrivate::setIsContainment(bool nowIsContainment)
+void AppletPrivate::setIsContainment(bool nowIsContainment, bool forceUpdate)
 {
-    if (isContainment == nowIsContainment) {
+    if (isContainment == nowIsContainment && !forceUpdate) {
         return;
     }
 
Index: plasma/private/containment_p.h
===================================================================
--- plasma/private/containment_p.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/private/containment_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -75,7 +75,7 @@
     void positionContainments();
     void setLockToolText();
     void handleDisappeared(AppletHandle *handle);
-    void appletDestroyed(QObject*);
+    void appletDestroyed(Plasma::Applet*);
     void containmentAppletAnimationComplete(QGraphicsItem *item, Plasma::Animator::Animation anim);
     void zoomIn();
     void zoomOut();
Index: plasma/private/applet_p.h
===================================================================
--- plasma/private/applet_p.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/private/applet_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -58,7 +58,7 @@
     /**
      * Sets whether or not this Applet is acting as a Containment
      */
-    void setIsContainment(bool isContainment);
+    void setIsContainment(bool isContainment, bool forceUpdate = false);
 
     QString globalName() const;
     QString instanceName();
Index: plasma/private/popupapplet_p.h
===================================================================
--- plasma/private/popupapplet_p.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/private/popupapplet_p.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -46,7 +46,6 @@
     Plasma::AspectRatioMode savedAspectRatio;
     QTimer *timer;
     QPoint clicked;
-    bool startupComplete : 1;
     bool popupLostFocus : 1;
     bool passive : 1;
 };
Index: plasma/extenderitem.cpp
===================================================================
--- plasma/extenderitem.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/extenderitem.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -449,10 +449,12 @@
 
 void ExtenderItem::returnToSource()
 {
-    if (!d->sourceApplet) {
+    if (!d || !d->sourceApplet) {
         return;
     }
-    setExtender(d->sourceApplet->d->extender);
+    if (d->sourceApplet->d) {
+        setExtender(d->sourceApplet->d->extender);
+    }
 }
 
 void ExtenderItem::paint(QPainter *painter, const QStyleOptionGraphicsItem *option,
Index: plasma/tests/packagemetadatatest.desktop
===================================================================
--- plasma/tests/packagemetadatatest.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/tests/packagemetadatatest.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -11,9 +11,11 @@
 Name[et]=Plasma metaandmete testfail
 Name[eu]=Paketeen metadatuen proba fitxategia
 Name[fr]=Fichier de test des métadonnées de paquetage
+Name[ga]=Comhad tástála le haghaidh PackageMetaData
 Name[gl]=Ficheiro de proba de metadatos de paquete
 Name[gu]=પેકેજ મેટાડેટા ચકાસણી ફાઇલ
 Name[he]=חבילת בדיקה של מטה־מידע
+Name[hne]=पैकेज मेटाडाटा जांच फाइल
 Name[hsb]=Testowa dataja za metadata pakćika
 Name[hu]=PackageMetaData tesztfájl
 Name[is]=Package metagagna prófunarskrá
@@ -21,6 +23,7 @@
 Name[km]=ឯកសារ​សាកល្បង​ទិន្នន័យ​មេតា​កញ្ចប់
 Name[ko]=패키지 메타데이터 테스트 파일
 Name[ku]=Pela ceribandinê ya serdana yê pakêtê 
+Name[lt]=Paketo metaduomenų bandomasis failas
 Name[lv]=Pakotņu metadatu testa fails
 Name[mai]=संकुलक मेटाडाटा जाँचि फाइल
 Name[ml]=പാക്കേജ് മെറ്റാഡാറ്റാ പരിശോധനാ ഫയല്‍
@@ -33,7 +36,8 @@
 Name[pt]=Ficheiro de testes de meta-dados dos pacotes
 Name[pt_BR]=Arquivo de teste dos metadados do pacote
 Name[ro]=Fișier de testat metadatele pachetelor
-Name[ru]=Тестовый файл пакета с метаданными 
+Name[ru]=Тестовый файл метаданных пакета
+Name[se]=Páhkametedáhtaid geahččalanfiila
 Name[sk]=Balík metadát testovacieho súboru
 Name[sl]=Datoteka za test metapodatkov paketa
 Name[sr]=Пробни фајл метаподатака пакета
@@ -59,9 +63,11 @@
 Comment[et]=Testtöölauafail klassi PackageMetaData testimiseks.
 Comment[eu]=PackageMetaData klasea probatzeko probako mahaigain fitxategia.
 Comment[fr]=Un fichier de bureau de démonstration pour tester la classe PackageMetaData.
+Comment[ga]=Comhad tástála deisce a úsáidtear chun aicme PackageMetaData a thástáil.
 Comment[gl]=Un ficheiro de escritorio de proba para probar a clase PackageMetaData.
 Comment[gu]=પેકેજમેટાડેટા વર્ગ ચકાસવા માટે ચકાસણી ડેસ્કટોપ ફાઇલ.
 Comment[he]=קובץ desktop לבדיקה של מחלקה PackageMetaData.
+Comment[hne]=पैकेज मेटाडाटा क्लास ल जांचे बर जांच डेस्कटाप फाइल
 Comment[hsb]=Testowa dataja za dźěłowy powjerch za testowanje klasy PackageMetaData.
 Comment[hu]=Tesztfájl a PackageMetaData osztályhoz.
 Comment[is]=Skjáborðsskrá til prófunar á PackageMetaData class
@@ -81,7 +87,8 @@
 Comment[pt]=Um ficheiro 'desktop' de testes da classe PackageMetaData.
 Comment[pt_BR]=Um arquivo desktop de testes para a classe PackageMetaData.
 Comment[ro]=Un fișier de probă pentru a verifica clasa PackageMetadata.
-Comment[ru]=Тестовый файл .desktop для проверки класса PackageMetaData
+Comment[ru]=Тестовый файл .desktop для проверки класса PackageMetaData.
+Comment[se]=Geahččalan desktop-fiilla mainna geahččala PackageMeta-luohká.
 Comment[sk]=Testovací súbor na ploche na testovanie PackageMetaData triedy.
 Comment[sl]=Namizna datoteka za test razreda PackageMetaData.
 Comment[sr]=Пробни .десктоп фајл за класу PackageMetaData.
Index: plasma/tests/testengine/plasma-dataengine-testengine.desktop
===================================================================
--- plasma/tests/testengine/plasma-dataengine-testengine.desktop	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/tests/testengine/plasma-dataengine-testengine.desktop	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -6,6 +6,7 @@
 Name[bn]=টেস্ট ডাটা ইঞ্জিন
 Name[bn_IN]=টেস্ট ডাটা ইঞ্জিন
 Name[ca]=Motor de dades de prova
+Name[cs]=Testovací datový nástroj
 Name[da]=Test datamotor
 Name[de]=Test-Datentreiber
 Name[el]=Μηχανή δεδομένων ελέγχου
@@ -14,15 +15,18 @@
 Name[eu]=Proba datuen motorra
 Name[fi]=Testitietomoottori
 Name[fr]=Moteur de données de test
+Name[ga]=Inneall Sonraí Tástála
 Name[gl]=Motor de datos de probas
 Name[gu]=ચકાસણી માહિતી એન્જિન
 Name[he]=בדיקה למנוע מידע
+Name[hne]=जांच डाटा इंजिन
 Name[hu]=Az adatkezelő modul tesztje
 Name[is]=Gagnaprófunarvél
 Name[it]=Motore dati di prova
 Name[km]=សាកល្បង​ម៉ាស៊ីន​ទិន្នន័យ
 Name[ko]=테스트 데이터 엔진
 Name[ku]=Motora Dane Ceribandinê
+Name[lt]=Bandomasis duomenų variklis
 Name[lv]=Testēšanas datu dzinējs
 Name[mai]=जाँचि डाटा इंडन
 Name[ml]=പരിശോധനാ ഡാറ്റാ എഞ്ചിന്‍
@@ -35,7 +39,8 @@
 Name[pt]=Motor de Dados de Teste
 Name[pt_BR]=Mecanismo de dados de teste
 Name[ro]=Motor de date pentru teste
-Name[ru]=Тестовый движок для работы с данными
+Name[ru]=Тестовый источник данных
+Name[se]=Geahččalandáhtamohtor
 Name[sk]=Engine testovacích dát
 Name[sl]=Preizkusni pogon s podatki
 Name[sr]=пробни датомотор података
Index: plasma/containment.h
===================================================================
--- plasma/containment.h	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/containment.h	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -507,7 +507,7 @@
         const QGraphicsItem *toolBoxItem() const;
 
     private:
-        Q_PRIVATE_SLOT(d, void appletDestroyed(QObject*))
+        Q_PRIVATE_SLOT(d, void appletDestroyed(Plasma::Applet*))
         Q_PRIVATE_SLOT(d, void containmentAppletAnimationComplete(QGraphicsItem *item,
                                                                   Plasma::Animator::Animation anim))
         Q_PRIVATE_SLOT(d, void triggerShowAddWidgets())
Index: plasma/containment.cpp
===================================================================
--- plasma/containment.cpp	(.../tags/KDE/4.2.0/kdelibs)	(wersja 929211)
+++ plasma/containment.cpp	(.../branches/KDE/4.2/kdelibs)	(wersja 929211)
@@ -742,7 +742,7 @@
 
     connect(applet, SIGNAL(configNeedsSaving()), this, SIGNAL(configNeedsSaving()));
     connect(applet, SIGNAL(releaseVisualFocus()), this, SIGNAL(releaseVisualFocus()));
-    connect(applet, SIGNAL(destroyed(QObject*)), this, SLOT(appletDestroyed(QObject*)));
+    connect(applet, SIGNAL(appletDestroyed(Plasma::Applet*)), this, SLOT(appletDestroyed(Plasma::Applet*)));
 
     if (pos != QPointF(-1, -1)) {
         applet->setPos(pos);
@@ -1071,6 +1071,19 @@
 void Containment::resizeEvent(QGraphicsSceneResizeEvent *event)
 {
     Applet::resizeEvent(event);
+
+    if (!ContainmentPrivate::s_positioning) {
+        switch (d->type) {
+            case Containment::PanelContainment:
+            case Containment::CustomPanelContainment:
+                d->positionPanel();
+                break;
+            default:
+                d->positionContainments();
+                break;
+        }
+    }
+
     if (d->wallpaper) {
         d->wallpaper->setBoundingRect(boundingRect());
     }
@@ -1639,18 +1652,6 @@
         }
     }
 
-    if (constraints & Plasma::SizeConstraint && !ContainmentPrivate::s_positioning) {
-        switch (q->containmentType()) {
-            case Containment::PanelContainment:
-            case Containment::CustomPanelContainment:
-                positionPanel();
-                break;
-            default:
-                positionContainments();
-                break;
-        }
-    }
-
     if (toolBox && (constraints & Plasma::SizeConstraint ||
                     constraints & Plasma::FormFactorConstraint ||
                     constraints & Plasma::ScreenConstraint ||
@@ -1709,16 +1710,8 @@
     return true;
 }
 
-void ContainmentPrivate::appletDestroyed(QObject *object)
+void ContainmentPrivate::appletDestroyed(Plasma::Applet *applet)
 {
-    // we do a static_cast here since it really isn't an Applet by this
-    // point anymore since we are in the qobject dtor. we don't actually
-    // try and do anything with it, we just need the value of the pointer
-    // so this unsafe looking code is actually just fine.
-    //
-    // NOTE: DO NOT USE THE applet VARIABLE FOR ANYTHING OTHER THAN COMPARING
-    //       THE ADDRESS! ACTUALLY USING THE OBJECT WILL RESULT IN A CRASH!!!
-    Applet *applet = static_cast<Plasma::Applet*>(object);
     applets.removeAll(applet);
     if (focusedApplet == applet) {
         focusedApplet = 0;
@@ -1834,6 +1827,7 @@
     // we position panels in negative coordinates, and stack all horizontal
     // and all vertical panels with each other.
 
+
     const QPointF p = q->pos();
 
     if (!force &&

Zmiany atrybutw dla: .
___________________________________________________________________
Dodane: svn:externals
   + 


